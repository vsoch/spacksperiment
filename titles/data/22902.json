{
    "url": "https://api.github.com/repos/spack/spack/issues/22902",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/22902/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/22902/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/22902/events",
    "html_url": "https://github.com/spack/spack/issues/22902",
    "id": 854532127,
    "node_id": "MDU6SXNzdWU4NTQ1MzIxMjc=",
    "number": 22902,
    "title": "Installation issue: quantum espresso does not build correctly with OpenMP threading",
    "user": {
        "login": "MartinHilgeman",
        "id": 14805200,
        "node_id": "MDQ6VXNlcjE0ODA1MjAw",
        "avatar_url": "https://avatars.githubusercontent.com/u/14805200?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MartinHilgeman",
        "html_url": "https://github.com/MartinHilgeman",
        "followers_url": "https://api.github.com/users/MartinHilgeman/followers",
        "following_url": "https://api.github.com/users/MartinHilgeman/following{/other_user}",
        "gists_url": "https://api.github.com/users/MartinHilgeman/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/MartinHilgeman/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MartinHilgeman/subscriptions",
        "organizations_url": "https://api.github.com/users/MartinHilgeman/orgs",
        "repos_url": "https://api.github.com/users/MartinHilgeman/repos",
        "events_url": "https://api.github.com/users/MartinHilgeman/events{/privacy}",
        "received_events_url": "https://api.github.com/users/MartinHilgeman/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2021-04-09T13:35:24Z",
    "updated_at": "2021-04-30T06:17:02Z",
    "closed_at": "2021-04-30T06:17:02Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "$ spack install quantum-espresso %gcc@10.2.0 +openmp ^fftw@3:+openmp ^openblas threads=openmp\r\n..\r\n     2767    /nvme/martinh/work/spack/opt/spack/linux-centos8-broadwell/gcc-10.2.0/openmpi-4.0.5-wb\r\n             hohbw6htvmkj4qgo5qtvmtzpcqdydi/bin/mpif90 -g -pthread -fopenmp -o pw.x \\\r\n     2768       pwscf.o  libpw.a ../../Modules/libqemod.a ../../KS_Solvers/libks_solvers.a ../../up\r\n             flib/libupf.a ../../FFTXlib/libqefft.a ../../LAXlib/libqela.a ../../UtilXlib/libutil.a\r\n              ../../dft-d3/libdftd3qe.a /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-l\r\n             o637bp5qaoqb37i6hoygwdfzcozrxmj/spack-src//clib/clib.a /tmp/martinh/spack-stage/spack-\r\n             stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcozrxmj/spack-src//LIBBEEF/libbeef\r\n             .a   -L/nvme/martinh/work/spack/opt/spack/linux-centos8-broadwell/gcc-10.2.0/netlib-sc\r\n             alapack-2.1.0-wp57p2d4eg3z36ldyrj7ontpgtak5hen/lib -lscalapack -L/usr/local/lib -L/nvm\r\n             e/martinh/work/spack/opt/spack/linux-centos8-broadwell/gcc-10.2.0/openblas-0.3.14-y7hg\r\n             6m6qiqejzywdrjfmlyfqaxcheqmg/lib -lopenblas -L/tmp/martinh/spack-stage/spack-stage-qua\r\n             ntum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcozrxmj/spack-src//FoX/lib  -lFoX_dom -lFoX\r\n             _sax -lFoX_wxml -lFoX_common -lFoX_utils -lFoX_fsys  -L/nvme/martinh/work/spack/opt/sp\r\n             ack/linux-centos8-broadwell/gcc-10.2.0/fftw-3.3.9-zfbeifj7jv4tx4ospgbppinlo27x2um6/lib\r\n              -lfftw3 -L/nvme/martinh/work/spack/opt/spack/linux-centos8-broadwell/gcc-10.2.0/openb\r\n             las-0.3.14-y7hg6m6qiqejzywdrjfmlyfqaxcheqmg/lib -lopenblas\r\n     2769    ../../FFTXlib/libqefft.a(fft_scalar.FFTW3.o): In function `init_plan':\r\n  >> 2770    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:631: undefined reference to `dfftw_cleanup\r\n             _threads_'\r\n  >> 2771    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:632: undefined reference to `fftw_init_thr\r\n             eads'\r\n  >> 2772    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:633: undefined reference to `dfftw_plan_wi\r\n             th_nthreads_'\r\n  >> 2773    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:447: undefined reference to `dfftw_cleanup\r\n             _threads_'\r\n  >> 2774    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:448: undefined reference to `fftw_init_thr\r\n             eads'\r\n  >> 2775    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:449: undefined reference to `dfftw_plan_wi\r\n             th_nthreads_'\r\n  >> 2776    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:301: undefined reference to `dfftw_cleanup\r\n             _threads_'\r\n  >> 2777    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:302: undefined reference to `fftw_init_thr\r\n             eads'\r\n  >> 2778    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:303: undefined reference to `dfftw_plan_wi\r\n             th_nthreads_'\r\n  >> 2779    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:148: undefined reference to `dfftw_cleanup\r\n             _threads_'\r\n  >> 2780    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:149: undefined reference to `fftw_init_thr\r\n             eads'\r\n  >> 2781    /tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-lo637bp5qaoqb37i6hoygwdfzcoz\r\n             rxmj/spack-src/FFTXlib/fft_scalar.FFTW3.f90:150: undefined reference to `dfftw_plan_wi\r\n             th_nthreads_'\r\n  >> 2782    collect2: error: ld returned 1 exit status\r\n     2783    make[2]: *** [Makefile:262: pw.x] Error 1\r\n     2784    make[2]: Leaving directory '/tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-\r\n             lo637bp5qaoqb37i6hoygwdfzcozrxmj/spack-src/PW/src'\r\n     2785    make[1]: *** [Makefile:9: pw] Error 1\r\n     2786    make[1]: Leaving directory '/tmp/martinh/spack-stage/spack-stage-quantum-espresso-6.7-\r\n             lo637bp5qaoqb37i6hoygwdfzcozrxmj/spack-src/PW'\r\n     2787    make: *** [Makefile:66: pw] Error 1\r\n\r\n\r\n\r\n### Information on your system\r\n\r\n$ spack debug report\r\n* **Spack:** 0.16.1-2129-5500eed60c\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-centos8-broadwell\r\n* **Concretizer:** original\r\n\r\n@naromero77 \r\n\r\n### General information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [x] I have uploaded the build log and environment files\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n\r\n### Resolution\r\nThe following patch fixes the problem:\r\n\r\n```\r\n--- a/var/spack/repos/builtin/packages/quantum-espresso/package.py      2021-04-09 15:21:39.628603709 +0200\r\n+++ b/var/spack/repos/builtin/packages/quantum-espresso/package.py      2021-04-09 15:21:56.060603484 +0200\r\n@@ -204,6 +204,13 @@\r\n     conflicts('@6.5:', when='+environ',\r\n               msg='6.4.x is the latest QE series supported by Environ')\r\n \r\n+    # Need OpenMP threaded FFTW and BLAS libraries when configured \r\n+    # with OpenMP support\r\n+    conflicts('^fftw~openmp', when='+openmp')\r\n+    conflicts('^amdfftw~openmp', when='+openmp')\r\n+    conflicts('^openblas threads=none', when='+openmp')\r\n+    conflicts('^openblas threads=pthreads', when='+openmp')\r\n+\r\n     # 6.4.1\r\n     patch_url = 'https://raw.githubusercontent.com/QMCPACK/qmcpack/develop/external_codes/quantum_espresso/add_pw2qmcpack_to_qe-6.4.1.diff'\r\n     patch_checksum = '57cb1b06ee2653a87c3acc0dd4f09032fcf6ce6b8cbb9677ae9ceeb6a78f85e2'\r\n@@ -346,7 +353,10 @@\r\n         if '^fftw@3:' in spec:\r\n             fftw_prefix = spec['fftw'].prefix\r\n             options.append('FFTW_INCLUDE={0}'.format(fftw_prefix.include))\r\n-            fftw_ld_flags = spec['fftw'].libs.ld_flags\r\n+            if '+openmp' in spec:\r\n+                fftw_ld_flags = spec['fftw:openmp'].libs.ld_flags\r\n+            else:\r\n+                fftw_ld_flags = spec['fftw'].libs.ld_flags\r\n             options.append('FFT_LIBS={0}'.format(fftw_ld_flags))\r\n \r\n         if '^amdfftw' in spec:\r\n```\r\n[spack-build-env.txt](https://github.com/spack/spack/files/6286053/spack-build-env.txt)\r\n[spack-build-out.txt](https://github.com/spack/spack/files/6286055/spack-build-out.txt)\r\n\r\n",
    "performed_via_github_app": null
}