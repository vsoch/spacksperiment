{
    "url": "https://api.github.com/repos/spack/spack/issues/10990",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/10990/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/10990/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/10990/events",
    "html_url": "https://github.com/spack/spack/issues/10990",
    "id": 423984288,
    "node_id": "MDU6SXNzdWU0MjM5ODQyODg=",
    "number": 10990,
    "title": "Rust-built package depends on python2",
    "user": {
        "login": "hartzell",
        "id": 312978,
        "node_id": "MDQ6VXNlcjMxMjk3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/312978?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hartzell",
        "html_url": "https://github.com/hartzell",
        "followers_url": "https://api.github.com/users/hartzell/followers",
        "following_url": "https://api.github.com/users/hartzell/following{/other_user}",
        "gists_url": "https://api.github.com/users/hartzell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hartzell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hartzell/subscriptions",
        "organizations_url": "https://api.github.com/users/hartzell/orgs",
        "repos_url": "https://api.github.com/users/hartzell/repos",
        "events_url": "https://api.github.com/users/hartzell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hartzell/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446630669,
            "node_id": "MDU6TGFiZWw0NDY2MzA2Njk=",
            "url": "https://api.github.com/repos/spack/spack/labels/dependencies",
            "name": "dependencies",
            "color": "c2e0c6",
            "default": false,
            "description": null
        },
        {
            "id": 446632829,
            "node_id": "MDU6TGFiZWw0NDY2MzI4Mjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/modules",
            "name": "modules",
            "color": "fef2c0",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "becker33",
        "id": 13971568,
        "node_id": "MDQ6VXNlcjEzOTcxNTY4",
        "avatar_url": "https://avatars.githubusercontent.com/u/13971568?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/becker33",
        "html_url": "https://github.com/becker33",
        "followers_url": "https://api.github.com/users/becker33/followers",
        "following_url": "https://api.github.com/users/becker33/following{/other_user}",
        "gists_url": "https://api.github.com/users/becker33/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/becker33/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/becker33/subscriptions",
        "organizations_url": "https://api.github.com/users/becker33/orgs",
        "repos_url": "https://api.github.com/users/becker33/repos",
        "events_url": "https://api.github.com/users/becker33/events{/privacy}",
        "received_events_url": "https://api.github.com/users/becker33/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "becker33",
            "id": 13971568,
            "node_id": "MDQ6VXNlcjEzOTcxNTY4",
            "avatar_url": "https://avatars.githubusercontent.com/u/13971568?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/becker33",
            "html_url": "https://github.com/becker33",
            "followers_url": "https://api.github.com/users/becker33/followers",
            "following_url": "https://api.github.com/users/becker33/following{/other_user}",
            "gists_url": "https://api.github.com/users/becker33/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/becker33/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/becker33/subscriptions",
            "organizations_url": "https://api.github.com/users/becker33/orgs",
            "repos_url": "https://api.github.com/users/becker33/repos",
            "events_url": "https://api.github.com/users/becker33/events{/privacy}",
            "received_events_url": "https://api.github.com/users/becker33/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2019-03-21T23:26:22Z",
    "updated_at": "2019-07-22T21:37:25Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I'm working on a package for building [bat](https://github.com/sharkdp/bat).  It's a rust package, I've discussed issues that I've bumped up against in #10837 and #10845.\r\n\r\nI've hacked up the Lmod module generator to support flat modules (towards helping out with the issues above and #10946).\r\n\r\nNow I'm running into weirdness where loading my `bat` Lmod module causes Lmod to swap a previously loaded python3 module for python2.\r\n\r\nIt turns out that my statically compiled/RPATH'ed rust binary for `bat` has a dependency on python2. \r\n\r\nI was surprised and confused, since I use my `packages.yaml` file to pin python to `3.6.5`.\r\n\r\nIt seems that what's happening is that `bat` needs `rust`, which needs `llvm`, which needs `py-lit`, which needs `python`.\r\n\r\nI believe what's happening is that `llvm`'s run-time dependency on python is being percolated *through* it to `rust` and then on to `bat`, even though `llvm` and `rust` are **bl**.\r\n\r\n```console\r\n[ghartzell@bifx1n03 spack]$ spack spec -t bat\r\nInput spec\r\n--------------------------------\r\n[    ]  bat\r\n\r\nConcretized\r\n--------------------------------\r\n[    ]  bat@0.10.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n[bl  ]      ^rust@1.32.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        [...]\r\n[bl  ]          ^llvm@7.0.1%gcc@8.2.0+all_targets build_type=Release +clang+compiler-rt+gold+internal_unwind+libcxx~link_dylib+lld+lldb+polly~python~shared_libs arch=linux-centos7-x86_64\r\n        [...]\r\n[b r ]              ^py-lit@0.7.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        [...]\r\n[blr ]                      ^python@2.7.16%gcc@8.2.0+bz2+ctypes+dbm+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tkinter~ucs4~uuid+zlib arch=linux-centos7-x86_64\r\n        [...]\r\n\r\n[ghartzell@bifx1n03 spack]$\r\n```\r\n\r\n**Problem 1**: It seems like there's a problem with how the graph is being walked here.  Perhaps this is an Lmod modulefile generation issue?\r\n\r\n**Problem 2**: I'm also confused (details in the background below) about why it's depending on python2 *at all*.    I could live with loading the python module if it was the same one that the rest of my world used.  This might just be my inability to understand what the `spack spec ...` command is trying to tell me below.\r\n\r\n## Background\r\n\r\nIn case you want to try it yourself, here's the `bat` package.py file from #10837 (pull-request TBD):\r\n\r\n```python\r\n from spack import *\r\n\r\n\r\n class Bat(Package):\r\n     \"\"\"A cat(1) clone with wings.\"\"\"\r\n\r\n     homepage = \"https://github.com/sharkdp/bat\"\r\n     url      = \"https://github.com/sharkdp/bat/archive/v0.10.0.tar.gz\"\r\n\r\n     version('0.10.0', sha256='54dd396e8f20d44c6032a32339f45eab46a69b6134e74a704f8d4a27c18ddc3e')\r\n\r\n     depends_on('rust')\r\n\r\n     def install(self, spec, prefix):\r\n         cargo = which('cargo')\r\n         cargo('install', '--root', prefix, '--path', '.')\r\n```\r\n\r\nOn it's own, spec'ing `llvm` uses python3:\r\n\r\n```console\r\n[ghartzell@bifx1n03 spack]$ spack spec llvm\r\nInput spec\r\n--------------------------------\r\nllvm\r\n\r\nConcretized\r\n--------------------------------\r\nllvm@7.0.1%gcc@8.2.0+all_targets build_type=Release +clang+compiler-rt+gold+internal_unwind+libcxx~link_dylib+lld+lldb+polly~python~shared_libs arch=linux-centos7-x86_64\r\n    ^binutils@2.31.1%gcc@8.2.0+gold~headers~libiberty+nls~plugins arch=linux-centos7-x86_64\r\n        ^gettext@0.19.8.1%gcc@8.2.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64\r\n            ^bzip2@1.0.6%gcc@8.2.0+shared arch=linux-centos7-x86_64\r\n                ^diffutils@3.7%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^libxml2@2.9.8%gcc@8.2.0~python arch=linux-centos7-x86_64\r\n                ^libiconv@1.15%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^pkgconf@1.6.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^xz@5.2.4%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^zlib@1.2.11%gcc@8.2.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n            ^ncurses@6.1%gcc@8.2.0~symlinks~termlib arch=linux-centos7-x86_64\r\n            ^tar@1.31%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^cmake@3.14.0%gcc@8.2.0~doc+ncurses+openssl~ownlibs~qt arch=linux-centos7-x86_64\r\n        ^curl@7.63.0%gcc@8.2.0~darwinssl~libssh~libssh2~nghttp2 arch=linux-centos7-x86_64\r\n            ^openssl@1.1.1b%gcc@8.2.0+systemcerts arch=linux-centos7-x86_64\r\n                ^perl@5.26.2%gcc@8.2.0+cpanm patches=0eac10ed90aeb0459ad8851f88081d439a4e41978e586ec743069e8b059370ac +shared+threads arch=linux-centos7-x86_64\r\n                    ^gdbm@1.18.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                        ^readline@7.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^expat@2.2.5%gcc@8.2.0+libbsd arch=linux-centos7-x86_64\r\n            ^libbsd@0.9.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^libarchive@3.3.2%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^lz4@1.8.1.2%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^lzo@2.09%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^nettle@3.4%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^gmp@6.1.2%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^autoconf@2.69%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                        ^m4@1.4.18%gcc@8.2.0 patches=3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00,c0a408fbffb7255fcc75e26bd8edab116fc81d216bfd18b473668b7739a4158e,fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8 +sigsegv arch=linux-centos7-x86_64\r\n                            ^libsigsegv@2.11%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^automake@1.16.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^libtool@2.4.6%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^libuv@1.25.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^rhash@1.3.5%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^libedit@3.1-20170329%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^perl-data-dumper@2.173%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^py-lit@0.7.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^py-setuptools@40.8.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^python@3.6.5%gcc@8.2.0+bz2+ctypes+dbm+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tkinter~ucs4~uuid+zlib arch=linux-centos7-x86_64\r\n                ^libffi@3.2.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^sqlite@3.26.0%gcc@8.2.0~functions arch=linux-centos7-x86_64\r\n    ^swig@3.0.12%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^pcre@8.42%gcc@8.2.0+jit+multibyte+utf arch=linux-centos7-x86_64\r\n\r\n[ghartzell@bifx1n03 spack]$\r\n```\r\n\r\nBut spec'ing rust constrains it to python2:\r\n\r\n```console\r\nInput spec\r\n--------------------------------\r\nrust\r\n\r\nConcretized\r\n--------------------------------\r\nrust@1.32.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^binutils@2.31.1%gcc@8.2.0+gold~headers~libiberty+nls~plugins arch=linux-centos7-x86_64\r\n        ^gettext@0.19.8.1%gcc@8.2.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64\r\n            ^bzip2@1.0.6%gcc@8.2.0+shared arch=linux-centos7-x86_64\r\n                ^diffutils@3.7%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^libxml2@2.9.8%gcc@8.2.0~python arch=linux-centos7-x86_64\r\n                ^libiconv@1.15%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^pkgconf@1.6.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^xz@5.2.4%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^zlib@1.2.11%gcc@8.2.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n            ^ncurses@6.1%gcc@8.2.0~symlinks~termlib arch=linux-centos7-x86_64\r\n            ^tar@1.31%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^cmake@3.14.0%gcc@8.2.0~doc+ncurses+openssl~ownlibs~qt arch=linux-centos7-x86_64\r\n        ^curl@7.63.0%gcc@8.2.0~darwinssl~libssh~libssh2~nghttp2 arch=linux-centos7-x86_64\r\n            ^openssl@1.1.1b%gcc@8.2.0+systemcerts arch=linux-centos7-x86_64\r\n                ^perl@5.26.2%gcc@8.2.0+cpanm patches=0eac10ed90aeb0459ad8851f88081d439a4e41978e586ec743069e8b059370ac +shared+threads arch=linux-centos7-x86_64\r\n                    ^gdbm@1.18.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                        ^readline@7.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^expat@2.2.5%gcc@8.2.0+libbsd arch=linux-centos7-x86_64\r\n            ^libbsd@0.9.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^libarchive@3.3.2%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^lz4@1.8.1.2%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^lzo@2.09%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^nettle@3.4%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^gmp@6.1.2%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^autoconf@2.69%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                        ^m4@1.4.18%gcc@8.2.0 patches=3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00,c0a408fbffb7255fcc75e26bd8edab116fc81d216bfd18b473668b7739a4158e,fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8 +sigsegv arch=linux-centos7-x86_64\r\n                            ^libsigsegv@2.11%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^automake@1.16.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^libtool@2.4.6%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^libuv@1.25.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^rhash@1.3.5%gcc@8.2.0 arch=linux-centos7-x86_64\r\n    ^git@2.21.0%gcc@8.2.0~tcltk arch=linux-centos7-x86_64\r\n        ^pcre@8.42%gcc@8.2.0+jit+multibyte+utf arch=linux-centos7-x86_64\r\n    ^llvm@7.0.1%gcc@8.2.0+all_targets build_type=Release +clang+compiler-rt+gold+internal_unwind+libcxx~link_dylib+lld+lldb+polly~python~shared_libs arch=linux-centos7-x86_64\r\n        ^libedit@3.1-20170329%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^perl-data-dumper@2.173%gcc@8.2.0 arch=linux-centos7-x86_64\r\n        ^py-lit@0.7.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n            ^py-setuptools@40.8.0%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                ^python@2.7.16%gcc@8.2.0+bz2+ctypes+dbm+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tkinter~ucs4~uuid+zlib arch=linux-centos7-x86_64\r\n                    ^libffi@3.2.1%gcc@8.2.0 arch=linux-centos7-x86_64\r\n                    ^sqlite@3.26.0%gcc@8.2.0~functions arch=linux-centos7-x86_64\r\n        ^swig@3.0.12%gcc@8.2.0 arch=linux-centos7-x86_64\r\n```\r\n\r\nTrying to force it to use python@3 leads to a conflict, but I can't figure out why.\r\n\r\n(**I'd be a better Spacker if someone could explain how to interpret what the spec command is trying to tell me here...**)\r\n\r\n```console\r\n[ghartzell@bifx1n03 spack]$ spack spec rust ^ python@3:\r\nInput spec\r\n--------------------------------\r\nrust\r\n    ^python@3:\r\n\r\nConcretized\r\n--------------------------------\r\n==> Error: An unsatisfiable version constraint has been detected for spec:\r\n\r\n    python@3.4:\r\n        ^pkgconfig@0.9.0:\r\n\r\n\r\nwhile trying to concretize the partial spec:\r\n\r\n    rust\r\n        ^binutils\r\n            ^zlib\r\n        ^cmake@3.4.3:\r\n        ^curl\r\n        ^git\r\n            ^autoconf\r\n                ^m4@1.4.6:\r\n                ^perl@5.14.0:\r\n                    ^gdbm\r\n                        ^readline\r\n                            ^ncurses\r\n                                ^pkgconfig@0.9.0:\r\n            ^automake\r\n            ^expat\r\n            ^gettext\r\n            ^libiconv\r\n            ^libtool\r\n            ^openssl\r\n        ^llvm\r\n            ^perl-data-dumper\r\n            ^py-lit\r\n                ^py-setuptools\r\n                    ^python@3.4:\r\n\r\n\r\nrust requires python version :2.8, but spec asked for 3.4:\r\n```\r\n\r\n",
    "performed_via_github_app": null
}