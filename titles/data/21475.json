{
    "url": "https://api.github.com/repos/spack/spack/issues/21475",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/21475/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/21475/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/21475/events",
    "html_url": "https://github.com/spack/spack/issues/21475",
    "id": 800880739,
    "node_id": "MDU6SXNzdWU4MDA4ODA3Mzk=",
    "number": 21475,
    "title": "`spack add` fails when Python is in environment view",
    "user": {
        "login": "timmoon10",
        "id": 4406448,
        "node_id": "MDQ6VXNlcjQ0MDY0NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4406448?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/timmoon10",
        "html_url": "https://github.com/timmoon10",
        "followers_url": "https://api.github.com/users/timmoon10/followers",
        "following_url": "https://api.github.com/users/timmoon10/following{/other_user}",
        "gists_url": "https://api.github.com/users/timmoon10/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/timmoon10/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/timmoon10/subscriptions",
        "organizations_url": "https://api.github.com/users/timmoon10/orgs",
        "repos_url": "https://api.github.com/users/timmoon10/repos",
        "events_url": "https://api.github.com/users/timmoon10/events{/privacy}",
        "received_events_url": "https://api.github.com/users/timmoon10/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 4,
    "created_at": "2021-02-04T02:54:13Z",
    "updated_at": "2021-02-05T01:39:59Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "<!-- Explain, in a clear and concise way, the command you ran and the result you were trying to achieve.\r\nExample: \"I ran `spack find` to list all the installed packages and ...\" -->\r\n\r\nI'd like to get Spack to build Python and install it to an environment. However, I run into errors when I try adding any other packages to the environment.\r\n\r\nAs far as I can tell, the problem is that the main Spack driver uses the Python that has been installed to the environment. However, adding a package to the environment involves moving the environment view to a temporary directory. Thus, the Python executable is trying to move/delete itself. This is exacerbated when I run on Lassen since the environment view and temporary directory are on different file systems (NFS vs. local memory).\r\n\r\nI can work around this issue, and PR https://github.com/spack/spack/pull/21222 will make it nicer. However, it will not be obvious for other users when they run into this problem.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\nspack env rm --yes-to-all myenv\r\nspack env create myenv\r\nspack env activate myenv\r\nspack add python@3.9.1\r\nspack install\r\nspack --debug add py-numpy\r\n```\r\n\r\nI can hack around this by changing the last line to:\r\n```console\r\n/path/to/external/python $(which spack) add py-numpy\r\n```\r\n\r\nI've been running on a Lassen compute node.\r\n\r\n### Error Message\r\n\r\n<!-- If Spack reported an error, provide the error message. If it did not report an error but the output appears incorrect, provide the incorrect output. If there was no error message and no output but the result is incorrect, describe how it does not match what you expect. -->\r\n\r\n<details> \r\n\r\n```console\r\n==> Successfully removed environment 'myenv'\r\n==> Updating view at /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view\r\n==> Created environment 'myenv' in /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv\r\n==> You can activate this environment with:\r\n==>   spack env activate myenv\r\n==> Adding python@3.9.1 to environment myenv\r\n==> Updating view at /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view\r\n==> Concretized python@3.9.1\r\n[+]  gh6tpuo  python@3.9.1%gcc@7.3.1+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4\\\r\n+uuid+zlib patches=0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87 arch=linux-rhel7-power9le\r\n[+]  kredonm      ^bzip2@1.0.8%gcc@7.3.1+shared arch=linux-rhel7-power9le\r\n[+]  n3rvht5          ^diffutils@3.7%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  4b7rg3o              ^libiconv@1.16%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  dxieubm      ^expat@2.2.10%gcc@7.3.1+libbsd arch=linux-rhel7-power9le\r\n[+]  6huorkj          ^libbsd@0.10.0%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  inn3u4z      ^gdbm@1.18.1%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  h4hkrjm          ^readline@8.0%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  dzfasfw              ^ncurses@6.2%gcc@7.3.1~symlinks+termlib arch=linux-rhel7-power9le\r\n[+]  dpi7vke                  ^pkgconf@1.7.3%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  yh4ybey      ^gettext@0.21%gcc@7.3.1+bzip2+curses+git~libunistring+libxml2+tar+xz arch=linux-rhel7-power9le\r\n[+]  kxsi6md          ^libxml2@2.9.10%gcc@7.3.1~python arch=linux-rhel7-power9le\r\n[+]  bspsrxj              ^xz@5.2.5%gcc@7.3.1~pic arch=linux-rhel7-power9le\r\n[+]  wup2hw6              ^zlib@1.2.11%gcc@7.3.1+optimize+pic+shared arch=linux-rhel7-power9le\r\n[+]  fodcl7k          ^tar@1.32%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  ly5lkdk      ^libffi@3.3%gcc@7.3.1 patches=26f26c6f29a7ce9bf370ad3ab2610f99365b4bdd7b82e7c31df41a3370d685c0 arch=linux-rhel7-power9le\r\n[+]  dc5d6iz      ^openssl@1.1.1i%gcc@7.3.1+systemcerts arch=linux-rhel7-power9le\r\n[+]  7xiufol          ^perl@5.32.1%gcc@7.3.1+cpanm+shared+threads arch=linux-rhel7-power9le\r\n[+]  marvz4h              ^berkeley-db@18.1.40%gcc@7.3.1 arch=linux-rhel7-power9le\r\n[+]  tgpbfrk      ^sqlite@3.34.0%gcc@7.3.1+column_metadata+fts~functions~rtree arch=linux-rhel7-power9le\r\n[+]  feekvth      ^util-linux-uuid@2.36%gcc@7.3.1 arch=linux-rhel7-power9le\r\n\r\n==> Installing environment myenv\r\n==> All of the packages are already installed\r\n==> Updating view at /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view\r\n==> [2021-02-03-18:19:19.457666] Imported add from built-in commands\r\n==> [2021-02-03-18:19:19.458542] Imported add from built-in commands\r\n==> [2021-02-03-18:19:19.568315] Reading config file /usr/WS1/moon13/temp/20210201_build/spack/etc/spack/defaults/repos.yaml\r\n==> [2021-02-03-18:19:19.572223] Reading config file /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/spack.yaml\r\n==> [2021-02-03-18:19:20.968699] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-02-03-18:19:20.968767] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-02-03-18:19:21.168633] TEMPORARY DIRECTORY CREATED [/var/tmp/tmpy2_svkw9]\r\n==> [2021-02-03-18:19:20.938898] Adding py-numpy to environment myenv\r\nTraceback (most recent call last):\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view/lib/python3.9/shutil.py\", line 806, in move\r\nOSError: [Errno 18] Invalid cross-device link: '/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view' -> '/var/tmp/tmpy2_\\\r\nsvkw9/view'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/bin/spack\", line 68, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/spack/cmd/add.py\", line 35, in add\r\n    env.write()\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/spack/environment.py\", line 1677, in write\r\n    self.regenerate_views()\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/spack/environment.py\", line 1229, in regenerate_views\r\n    view.regenerate(specs, self.roots())\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/spack/environment.py\", line 563, in regenerate\r\n    with fs.replace_directory_transaction(root):\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view/lib/python3.9/contextlib.py\", line 117, in __enter__\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/lib/spack/llnl/util/filesystem.py\", line 687, in replace_directory_transaction\r\n    shutil.move(src=directory_name, dst=tmp_dir)\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view/lib/python3.9/shutil.py\", line 818, in move\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view/lib/python3.9/shutil.py\", line 718, in rmtree\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view/lib/python3.9/shutil.py\", line 659, in _rmtree_safe_fd\r\n  File \"/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view/lib/python3.9/shutil.py\", line 657, in _rmtree_safe_fd\r\nOSError: [Errno 39] Directory not empty: 'bin'\r\n```\r\n\r\n</details>\r\n\r\nThe error seems to arise at:\r\nhttps://github.com/spack/spack/blob/457fc4c095c6d06cfdaa6634f81dfd4044cb4eab/lib/spack/llnl/util/filesystem.py#L687\r\n\r\n@becker33  suggested running with PR https://github.com/spack/spack/pull/20720 (https://github.com/spack/spack/pull/20720/commits/83c9a32032891305aeff9a8293321860b8691baa), but that produced a different error:\r\n\r\n<details> \r\n\r\n```\r\n==> Successfully removed environment 'myenv'\r\n==> Updating view at /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view\r\n==> Created environment 'myenv' in /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv\r\n==> You can activate this environment with:\r\n==>   spack env activate myenv\r\n==> Adding python@3.9.1 to environment myenv\r\n==> Updating view at /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view\r\n==> Error: /g/g17/moon13/.spack/packages.yaml:3: Additional properties are not allowed ('externals' was unexpected)\r\n==> [2021-02-03-18:42:48.656908] Imported add from built-in commands\r\n==> [2021-02-03-18:42:48.657789] Imported add from built-in commands\r\n==> [2021-02-03-18:42:48.664475] Reading config file /usr/WS1/moon13/temp/20210201_build/spack/etc/spack/defaults/repos.yaml\r\n==> [2021-02-03-18:42:48.668425] Reading config file /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/spack.yaml\r\n==> [2021-02-03-18:42:48.832976] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-02-03-18:42:48.833039] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-02-03-18:42:48.848939] TEMPORARY DIRECTORY CREATED [/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/tmpa9maeavk\\\r\n]\r\n==> [2021-02-03-18:42:48.850036] DIRECTORY MOVED [src=/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view, dest=/usr/WS1\\\r\n/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/tmpa9maeavk]\r\n==> [2021-02-03-18:42:48.852826] TEMPORARY DIRECTORY DELETED [/usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/tmpa9maeavk\\\r\n]\r\n==> [2021-02-03-18:42:48.820224] Adding py-numpy to environment myenv\r\n==> [2021-02-03-18:42:48.850473] Updating view at /usr/WS1/moon13/temp/20210201_build/spack/var/spack/environments/myenv/.spack-env/view\r\n```\r\n\r\n</details>\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\n\r\n```\r\n* **Spack:** 0.16.0-1102-040204c261\r\n* **Python:** 3.7.2\r\n* **Platform:** linux-rhel7-power9le\r\n* **Concretizer:** original\r\n ```\r\n\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n<!-- We encourage you to try, as much as possible, to reduce your problem to the minimal example that still reproduces the issue. That would help us a lot in fixing it quickly and effectively!\r\n\r\nIf you want to ask a question about the tool (how to use it, what it can currently do, etc.), try the `#general` channel on our Slack first. We have a welcoming community and chances are you'll get your reply faster and without opening an issue.\r\n\r\nOther than that, thanks for taking the time to contribute to Spack! -->\r\n",
    "performed_via_github_app": null
}