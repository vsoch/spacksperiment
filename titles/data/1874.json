{
    "url": "https://api.github.com/repos/spack/spack/issues/1874",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/1874/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/1874/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/1874/events",
    "html_url": "https://github.com/spack/spack/issues/1874",
    "id": 179968462,
    "node_id": "MDU6SXNzdWUxNzk5Njg0NjI=",
    "number": 1874,
    "title": "macOS Sierra load commands size limit due to extra unused LC_RPATH in a big DAG",
    "user": {
        "login": "davydden",
        "id": 8023934,
        "node_id": "MDQ6VXNlcjgwMjM5MzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8023934?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davydden",
        "html_url": "https://github.com/davydden",
        "followers_url": "https://api.github.com/users/davydden/followers",
        "following_url": "https://api.github.com/users/davydden/following{/other_user}",
        "gists_url": "https://api.github.com/users/davydden/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/davydden/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/davydden/subscriptions",
        "organizations_url": "https://api.github.com/users/davydden/orgs",
        "repos_url": "https://api.github.com/users/davydden/repos",
        "events_url": "https://api.github.com/users/davydden/events{/privacy}",
        "received_events_url": "https://api.github.com/users/davydden/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446645732,
            "node_id": "MDU6TGFiZWw0NDY2NDU3MzI=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-environment",
            "name": "build-environment",
            "color": "bfdadc",
            "default": false,
            "description": null
        },
        {
            "id": 446614839,
            "node_id": "MDU6TGFiZWw0NDY2MTQ4Mzk=",
            "url": "https://api.github.com/repos/spack/spack/labels/macOS",
            "name": "macOS",
            "color": "c5def5",
            "default": false,
            "description": null
        },
        {
            "id": 446779717,
            "node_id": "MDU6TGFiZWw0NDY3Nzk3MTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/rpath",
            "name": "rpath",
            "color": "bfdadc",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 8,
    "created_at": "2016-09-29T07:05:12Z",
    "updated_at": "2016-10-04T16:40:28Z",
    "closed_at": "2016-10-04T16:40:28Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "i recently hit an error when trying to run my application linked against `deal.II` built by `Spack`:\n\n```\n36: dyld: Library not loaded: /dealii-develop-cymbkwb6lxj7ttkk3vfdfuua3oto5tlv/lib/libdeal_II.8.5.0-pre.dylib\n36:   Referenced from: /blabla/executable.release\n36:   Reason: no suitable image found.  Did find:\n36:     /dealii-develop-cymbkwb6lxj7ttkk3vfdfuua3oto5tlv/lib/libdeal_II.8.5.0-pre.dylib: malformed mach-o: load commands size (34832) > 32768\n```\n\nSimilar issues are mentioned here http://stackoverflow.com/questions/39646221/stack-gives-dyld-malformed-mach-o . \n\nFrom https://github.com/commercialhaskell/stack/issues/2577#issuecomment-247859070\n\n> Sierra has a new limit on the \"load commands size\" of a shared library (that you can see mentioned in the error message) which includes the paths to its dependencies, and Stack's many dependencies and long directory paths exceed this limit.\n\nBy comparing `otool -l libdeal_II.8.5.0-pre.dylib` for Spack's build of deal.II and the manual build with `filesystem views` with all dependencies build by Spack, i found out that the number of load commands is significantly different: 149 (manual build) vs 196 (Spack's build). More precisely, Spack's build contain a lot of **non-needed LC_RPATH load commands for the whole DAG**:\n\n```\nLoad command 147\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/dealii-develop-t4bhfdej7uvwxtptd7aqiwbt2vy5s4vg/lib64 (offset 12)\nLoad command 148\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/matio-1.5.2-qhiecti6wjjyhpvxu6arihvtjg64vbjp/lib (offset 12)\nLoad command 149\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/glm-0.9.7.1-cho3xqsfqgjqgeixk3dm4wsu6zvybd3d/lib (offset 12)\nLoad command 150\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/trilinos-12.8.1-wysvnbzxvfs4d7w7ykf5tnn7abn3o54y/lib (offset 12)\nLoad command 151\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/suite-sparse-4.5.3-puw3cvbgsogepjhte6rxbv2kllpfqw3l/lib (offset 12)\nLoad command 152\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/slepc-3.7.1-i4ohv53ekcjvk6xf757sjzk7v57fd7ff/lib (offset 12)\nLoad command 153\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/superlu-dist-5.0.0-drwk4u6f45fbsg7t56whtwb7zjiwgbjt/lib (offset 12)\nLoad command 154\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/parmetis-4.0.3-dzk264ptt7botxjxsk5k76y3s4gbb6tl/lib (offset 12)\nLoad command 155\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/netlib-scalapack-2.0.2-doua7ojkqkesi7jct6wlur53r4uw7lkw/lib (offset 12)\nLoad command 156\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/mumps-5.0.1-6646z4abavd4lxrhjb3wxe2r3eyyaxwy/lib (offset 12)\nLoad command 157\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/hypre-2.10.1-yhulamj2l3tddpijnn3opxzu6gyx2lso/lib (offset 12)\nLoad command 158\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/petsc-3.7.2-tyvehbbwmne2e65rhc62vgnk2toybcvw/lib (offset 12)\nLoad command 159\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/lua-5.3.2-gskrogb6mzyq6ji2am6j5gpsdpzeclcn/lib (offset 12)\nLoad command 160\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/p4est-1.1-a3bmrr2m3m7yngrjpxlo7gmy53k3u7d3/lib (offset 12)\nLoad command 161\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/gettext-0.19.8.1-7pquryskg4iowtdu2qvjhgftsr2ndohj/lib (offset 12)\nLoad command 162\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/netcdf-cxx-4.2-hs3x65yhlbc4j6uhwwee4rj2jpbk7anb/lib (offset 12)\nLoad command 163\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/netcdf-4.4.1-g7xfv2hylaxbkfsdm5a3bsxadnzenr76/lib (offset 12)\nLoad command 164\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/muparser-2.2.5-amdu7v5ogbithg7kj4iaefox5zmrshjr/lib (offset 12)\nLoad command 165\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/metis-5.1.0-d5se4hgztkzjueyr55sl4tthuxhrfysg/lib (offset 12)\nLoad command 166\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/hdf5-1.10.0-patch1-gjsz6n5uxyzxrtzr5vcefrdmga5hpqas/lib (offset 12)\nLoad command 167\n          cmd LC_RPATH\n      cmdsize 128\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/gsl-2.1-2aofnwvdsvvvm63qfeafems2udotouzt/lib (offset 12)\nLoad command 168\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/sqlite-3.8.5-wbrfqaigms2fpt36rijhfh3xvmjcptu6/lib (offset 12)\nLoad command 169\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/readline-6.3-o7fyvnwa3cyg3ndcg4nwwvvcivwf5qhh/lib (offset 12)\nLoad command 170\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/python-2.7.12-rol3whbb472kx3xpjtiog7s2575lihqd/lib (offset 12)\nLoad command 171\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/boost-1.61.0-nud3yn3vs7smers3owoaeh5toma7u5ae/lib (offset 12)\nLoad command 172\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/libtool-2.4.6-7x6h7cfe5k3bi56k2jnecqkpa7dtp6w7/lib (offset 12)\nLoad command 173\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/libpciaccess-0.13.4-4wd7llktkvcziobu72c7zaevnojssvbh/lib (offset 12)\nLoad command 174\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/hwloc-1.11.4-6m3qkszjq2vtfrdo23hauwpza4tpybmb/lib (offset 12)\nLoad command 175\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/openmpi-2.0.1-ee4uix6ycr3lpermorwskgr7y6w4kayl/lib (offset 12)\nLoad command 176\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/openblas-0.2.19-7qdxwznmqzlbqtusssagtxkypivod6ct/lib (offset 12)\nLoad command 177\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/ncurses-6.0-sflzz4eoc2zxhxje5z3rtcbylrujuu4h/lib (offset 12)\nLoad command 178\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/libsigsegv-2.10-cotbexnf4mm6u2eueit5uorf3xtvxbpw/lib (offset 12)\nLoad command 179\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/gmp-6.1.1-vj3e2ygpbbbo2mmyomdzuizeboramub7/lib (offset 12)\nLoad command 180\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/nettle-3.2-fioxw3hgk3gp57os6sxqfvmmlijad6al/lib (offset 12)\nLoad command 181\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/lzo-2.09-2dk4mx6m2kg65y34ndw6t3eh2iq7glkx/lib (offset 12)\nLoad command 182\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/lzma-4.32.7-2ka7vkselplzy5hj3iyvquej7frhidjk/lib (offset 12)\nLoad command 183\n          cmd LC_RPATH\n      cmdsize 128\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/lz4-131-e6cru3imydxci7aaskrssjo6vjya55qy/lib (offset 12)\nLoad command 184\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/xz-5.2.2-l3ntfowzw5tk2zbs3bmuy2nei4i3rqzc/lib (offset 12)\nLoad command 185\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/libxml2-2.9.4-id5me6ic2r5eqcozfuhfg2pbyx4txgd6/lib (offset 12)\nLoad command 186\n          cmd LC_RPATH\n      cmdsize 144\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/libarchive-3.2.1-a6vndqjqcae2rtj7tk4qcvqoaiin3nfr/lib (offset 12)\nLoad command 187\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/expat-2.2.0-lmk3zwfdwzemdjrrkrehldzjpuvmkbxe/lib (offset 12)\nLoad command 188\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/zlib-1.2.8-yefo4t2eiiwps7wrbvvgauo2z4ozxlyg/lib (offset 12)\nLoad command 189\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/openssl-1.0.2j-k6g3fa3rrglj5wenvowtaruuvb6nmn6t/lib (offset 12)\nLoad command 190\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/curl-7.50.3-ktu7vhoi6p4fmbldeapjqzvkvct6z6dk/lib (offset 12)\nLoad command 191\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/arpack-ng-3.4.0-pu5wkjbz4hbozonicrjrys4dwjkkdciv/lib (offset 12)\nLoad command 192\n          cmd LC_RPATH\n      cmdsize 136\n         path /Users/davydden/spack/opt/spack/darwin-sierra-x86_64/clang-8.0.0-apple/tbb-4.4.4-s7sej2p65l4a5jzdmp5hwm6bn4pwzf35/lib (offset 12)\n```\n\nNote that many of those are coming from dependencies of dependencies like `libpciaccess` or `libtool` or `lua` etc.\n\nAt this point my best bet is that it is related to compiler wrappers. The quick solution would be to have a global flag which can be used to control whether those things are added or not by Spack. In case of deal.II which configures with `cmake`, those `LC_RPATH` are not needed and make the build broken on macOS Sierra (and potentially on any other OS with similar limits).\n\np.s. attached is the output of `otool -l` for Spack's build deal.II and manually built one.\n[dealii_manual.txt](https://github.com/LLNL/spack/files/499953/dealii_manual.txt)\n[dealii_spack.txt](https://github.com/LLNL/spack/files/499954/dealii_spack.txt)\n\np.p.s. useful info https://www.reinterpretcast.com/hello-world-mach-o\n",
    "performed_via_github_app": null
}