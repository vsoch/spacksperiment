{
    "url": "https://api.github.com/repos/spack/spack/issues/21215",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/21215/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/21215/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/21215/events",
    "html_url": "https://github.com/spack/spack/issues/21215",
    "id": 791891654,
    "node_id": "MDU6SXNzdWU3OTE4OTE2NTQ=",
    "number": 21215,
    "title": "ASP solver: two unit tests failing on MacOS",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446623646,
            "node_id": "MDU6TGFiZWw0NDY2MjM2NDY=",
            "url": "https://api.github.com/repos/spack/spack/labels/concretization",
            "name": "concretization",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 512483297,
            "node_id": "MDU6TGFiZWw1MTI0ODMyOTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/impact-low",
            "name": "impact-low",
            "color": "fef2c0",
            "default": false,
            "description": ""
        },
        {
            "id": 446614839,
            "node_id": "MDU6TGFiZWw0NDY2MTQ4Mzk=",
            "url": "https://api.github.com/repos/spack/spack/labels/macOS",
            "name": "macOS",
            "color": "c5def5",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2021-01-22T10:33:13Z",
    "updated_at": "2021-01-25T20:25:40Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "Running the unit test suite reports two failures, both related to pickling objects, when testing with the new concretizer. The errors do not occur with the original concretizer.\r\n\r\n### Steps to reproduce the issue\r\nSetup `clingo` to be able to test the new concretizer. Then:\r\n```console\r\n$ SPACK_TEST_SOLVER=clingo spack unit-test lib/spack/spack/test/cmd/deprecate.py::test_deprecate_install lib/spack/spack/test/install.py::test_installed_upstream\r\n```\r\n\r\n### Error Message\r\n\r\nThe error message is the following:\r\n\r\n<details>\r\n\r\n<summary>SPACK_TEST_SOLVER=clingo spack unit-test ... </summary>\r\n\r\n```\r\n% SPACK_TEST_SOLVER=clingo spack unit-test lib/spack/spack/test/cmd/deprecate.py::test_deprecate_install lib/spack/spack/test/install.py::test_installed_upstream\r\n=========================================================================================== test session starts ============================================================================================\r\nplatform darwin -- Python 3.8.5, pytest-3.2.5, py-1.4.34, pluggy-0.4.0\r\nrootdir: /Users/culpo/PycharmProjects/spack, inifile: pytest.ini\r\ncollected 2 items                                                                                                                                                                                           \r\n\r\nlib/spack/spack/test/cmd/deprecate.py F\r\nlib/spack/spack/test/install.py F\r\n========================================================================================= short test summary info ==========================================================================================\r\nFAIL lib/spack/spack/test/cmd/deprecate.py::test_deprecate_install[mock_archive0]\r\nFAIL lib/spack/spack/test/install.py::test_installed_upstream[mock_archive0]\r\n\r\n======================================================================================== slowest 20 test durations =========================================================================================\r\n1.78s call     lib/spack/spack/test/cmd/deprecate.py::test_deprecate_install[mock_archive0]\r\n0.34s call     lib/spack/spack/test/install.py::test_installed_upstream[mock_archive0]\r\n0.31s setup    lib/spack/spack/test/cmd/deprecate.py::test_deprecate_install[mock_archive0]\r\n0.01s setup    lib/spack/spack/test/install.py::test_installed_upstream[mock_archive0]\r\n0.01s teardown lib/spack/spack/test/cmd/deprecate.py::test_deprecate_install[mock_archive0]\r\n0.00s teardown lib/spack/spack/test/install.py::test_installed_upstream[mock_archive0]\r\n================================================================================================= FAILURES =================================================================================================\r\n__________________________________________________________________________________ test_deprecate_install[mock_archive0] ___________________________________________________________________________________\r\n\r\nmock_packages = <spack.repo.RepoPath object at 0x102249220>\r\nmock_archive = Archive(url='file:///private/var/folders/gy/g0z3m6dn0nz53nsttz2q0flm0000gn/T/pytest-of-culpo/pytest-84/mock-archive-di...sttz2q0flm0000gn/T/pytest-of-culpo/pytest-84/mock-archive-dir0/spack-src.tar.gz', expanded_archive_basedir='spack-src')\r\nmock_fetch = None, install_mockery = None\r\n\r\n    def test_deprecate_install(mock_packages, mock_archive, mock_fetch,\r\n                               install_mockery):\r\n        \"\"\"Tests that the ```-i`` option allows us to deprecate in favor of a spec\r\n        that is not yet installed.\"\"\"\r\n        install('libelf@0.8.10')\r\n    \r\n        to_deprecate = spack.store.db.query()\r\n        assert len(to_deprecate) == 1\r\n    \r\n>       deprecate('-y', '-i', 'libelf@0.8.10', 'libelf@0.8.13')\r\n\r\nlib/spack/spack/test/cmd/deprecate.py:58: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\nlib/spack/spack/main.py:545: in __call__\r\n    self.returncode = _invoke_command(\r\nlib/spack/spack/main.py:490: in _invoke_command\r\n    return_val = command(parser, args)\r\nlib/spack/spack/cmd/deprecate.py:129: in deprecate\r\n    dcate.package.do_deprecate(dcator, link_fn)\r\nlib/spack/spack/package.py:2229: in do_deprecate\r\n    deprecator.package.do_install()\r\nlib/spack/spack/package.py:1697: in do_install\r\n    builder.install()\r\nlib/spack/spack/installer.py:1534: in install\r\n    self._install_task(task)\r\nlib/spack/spack/installer.py:1122: in _install_task\r\n    spack.build_environment.start_build_process(\r\nlib/spack/spack/build_environment.py:945: in start_build_process\r\n    serialized_pkg = spack.subprocess_context.PackageInstallContext(pkg)\r\nlib/spack/spack/subprocess_context.py:69: in __init__\r\n    self.serialized_pkg = serialize(pkg)\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n\r\nobj = <spack.pkg.builtin.mock.libelf.Libelf object at 0x102c253d0>\r\n\r\n    def serialize(obj):\r\n        serialized_obj = io.BytesIO()\r\n>       pickle.dump(obj, serialized_obj)\r\nE       _pickle.PicklingError: Can't pickle <class 'llnl.util.lang.Spec'>: attribute lookup Spec on llnl.util.lang failed\r\n\r\nlib/spack/spack/subprocess_context.py:43: PicklingError\r\n------------------------------------------------------------------------------------------- Captured stdout call -------------------------------------------------------------------------------------------\r\n==> Fetching file:///private/var/folders/gy/g0z3m6dn0nz53nsttz2q0flm0000gn/T/pytest-of-culpo/pytest-84/mock-archive-dir0/spack-src.tar.gz\r\n==> libelf: Executing phase: 'install'\r\n==> libelf: Successfully installed libelf-0.8.10-gstytvv2sv35kdf6yw2uhg4wcankkprh\r\n  Fetch: 0.02s.  Build: 0.47s.  Total: 0.49s.\r\n[+] /private/var/folders/gy/g0z3m6dn0nz53nsttz2q0flm0000gn/T/pytest-of-culpo/pytest-84/test_deprecate_install_mock_ar0/opt/test-debian6-core2/gcc-4.5.0/libelf-0.8.10-gstytvv2sv35kdf6yw2uhg4wcankkprh\r\n------------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------------\r\n/Users/culpo/PycharmProjects/spack/lib/spack/spack/solver/concretize.lp:153:42-77: info: atom does not occur in any rule head:\r\n  possible_provider(Package,Virtual)\r\n\r\n/Users/culpo/PycharmProjects/spack/lib/spack/spack/solver/concretize.lp:153:42-77: info: atom does not occur in any rule head:\r\n  possible_provider(Package,Virtual)\r\n\r\n__________________________________________________________________________________ test_installed_upstream[mock_archive0] __________________________________________________________________________________\r\n\r\ntmpdir_factory = <_pytest.tmpdir.TempdirFactory object at 0x101fefb20>, install_mockery = None, mock_fetch = None, gen_mock_layout = <function gen_mock_layout.<locals>.create_layout at 0x1021b73a0>\r\nmonkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x102970730>\r\n\r\n    def test_installed_upstream(tmpdir_factory, install_mockery, mock_fetch,\r\n                                gen_mock_layout, monkeypatch):\r\n        \"\"\"Check that when a dependency package is recorded as installed in\r\n           an upstream database that it is not reinstalled.\r\n        \"\"\"\r\n        mock_db_root = str(tmpdir_factory.mktemp('mock_db_root'))\r\n        prepared_db = spack.database.Database(mock_db_root)\r\n    \r\n        upstream_layout = gen_mock_layout('/a/')\r\n    \r\n        dependency = spack.spec.Spec('dependency-install')\r\n        dependency.concretize()\r\n        prepared_db.add(dependency, upstream_layout)\r\n    \r\n        downstream_db_root = str(\r\n            tmpdir_factory.mktemp('mock_downstream_db_root'))\r\n        db_for_test = spack.database.Database(\r\n            downstream_db_root, upstream_dbs=[prepared_db])\r\n        monkeypatch.setattr(spack.store, 'db', db_for_test)\r\n        dependent = spack.spec.Spec('dependent-install')\r\n        dependent.concretize()\r\n    \r\n        new_dependency = dependent['dependency-install']\r\n        assert new_dependency.package.installed_upstream\r\n        assert (new_dependency.prefix ==\r\n                upstream_layout.path_for_spec(dependency))\r\n    \r\n>       dependent.package.do_install()\r\n\r\nlib/spack/spack/test/install.py:246: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\nlib/spack/spack/package.py:1697: in do_install\r\n    builder.install()\r\nlib/spack/spack/installer.py:1534: in install\r\n    self._install_task(task)\r\nlib/spack/spack/installer.py:1122: in _install_task\r\n    spack.build_environment.start_build_process(\r\nlib/spack/spack/build_environment.py:945: in start_build_process\r\n    serialized_pkg = spack.subprocess_context.PackageInstallContext(pkg)\r\nlib/spack/spack/subprocess_context.py:69: in __init__\r\n    self.serialized_pkg = serialize(pkg)\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n\r\nobj = <spack.pkg.builtin.mock.dependent-install.DependentInstall object at 0x1020ce1f0>\r\n\r\n    def serialize(obj):\r\n        serialized_obj = io.BytesIO()\r\n>       pickle.dump(obj, serialized_obj)\r\nE       _pickle.PicklingError: Can't pickle <class 'llnl.util.lang.Spec'>: attribute lookup Spec on llnl.util.lang failed\r\n\r\nlib/spack/spack/subprocess_context.py:43: PicklingError\r\n------------------------------------------------------------------------------------------- Captured stdout call -------------------------------------------------------------------------------------------\r\n[+] /private/var/folders/gy/g0z3m6dn0nz53nsttz2q0flm0000gn/T/pytest-of-culpo/pytest-84/test_installed_upstream_mock_a0/a/dependency-install\r\n==> Installing dependent-install-2.0-erjlafcwgpyioat5tfiedpy6nu3ohp5h\r\n==> No binary for dependent-install-2.0-erjlafcwgpyioat5tfiedpy6nu3ohp5h found: installing from source\r\n------------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------------\r\n/Users/culpo/PycharmProjects/spack/lib/spack/spack/solver/concretize.lp:153:42-77: info: atom does not occur in any rule head:\r\n  possible_provider(Package,Virtual)\r\n\r\n/Users/culpo/PycharmProjects/spack/lib/spack/spack/solver/concretize.lp:153:42-77: info: atom does not occur in any rule head:\r\n  possible_provider(Package,Virtual)\r\n\r\n==> Error: Failed to install dependent-install due to PicklingError: Can't pickle <class 'llnl.util.lang.Spec'>: attribute lookup Spec on llnl.util.lang failed\r\n========================================================================================= 2 failed in 2.84 seconds =========================================================================================\r\n```\r\n\r\n</details>\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.0-918-ec7caefc69\r\n* **Python:** 3.8.5\r\n* **Platform:** darwin-bigsur-cannonlake\r\n* **Concretizer:** clingo\r\n\r\nThe exact version of the OS is 11.1 (20C69)\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "performed_via_github_app": null
}