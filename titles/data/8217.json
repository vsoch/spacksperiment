{
    "url": "https://api.github.com/repos/spack/spack/issues/8217",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/8217/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/8217/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/8217/events",
    "html_url": "https://github.com/spack/spack/issues/8217",
    "id": 324728596,
    "node_id": "MDU6SXNzdWUzMjQ3Mjg1OTY=",
    "number": 8217,
    "title": "`install --use-cache` fails when installing into original location",
    "user": {
        "login": "hartzell",
        "id": 312978,
        "node_id": "MDQ6VXNlcjMxMjk3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/312978?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hartzell",
        "html_url": "https://github.com/hartzell",
        "followers_url": "https://api.github.com/users/hartzell/followers",
        "following_url": "https://api.github.com/users/hartzell/following{/other_user}",
        "gists_url": "https://api.github.com/users/hartzell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hartzell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hartzell/subscriptions",
        "organizations_url": "https://api.github.com/users/hartzell/orgs",
        "repos_url": "https://api.github.com/users/hartzell/repos",
        "events_url": "https://api.github.com/users/hartzell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hartzell/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 759411369,
            "node_id": "MDU6TGFiZWw3NTk0MTEzNjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/buildcache",
            "name": "buildcache",
            "color": "bf354c",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 9,
    "created_at": "2018-05-20T18:03:26Z",
    "updated_at": "2018-05-31T23:01:33Z",
    "closed_at": "2018-05-31T23:01:33Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I created a buildcache from things built in `~/spack` (aka `/home/hartzell/spack/opt/spack`).\r\n\r\nThen I removed the package and tried to re-install it (simulating an install into my home directory on another machine).\r\n\r\nEvery package I tried (`tmux`, `the-silver-searcher`, `tree`) failed, complaining (details below in the \"recreate\" section):\r\n\r\n```console\r\n==> Relocating package from\r\n  /home/hartzell/spack/opt/spack to /home/hartzell/spack/opt/spack.\r\n==> Error:\r\n /tmp/tmpxEG6CD/tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl/bin/tmux\r\ncontains string\r\n /home/hartzell/spack/opt/spack\r\nafter replacing it in rpaths.\r\nPackage should not be relocated.\r\n Use -a to override.\r\n```\r\n\r\nI expected it to work.\r\n\r\nThe error message is mis-leading, there doesn't seem to be any place to specify the `-a` arg to `spack install`.\r\n\r\nIf I moved my spack tree to `~/foo/spack` I was able to install `tmux` from the buildcache:\r\n\r\n```console\r\n[hartzell@bunny ~]$ mkdir foo\r\n[hartzell@bunny ~]$ mv spack foo\r\n[hartzell@bunny ~]$ cd foo\r\n[hartzell@bunny foo]$ cd spack/\r\n[hartzell@bunny spack]$ . share/spack/setup-env.sh\r\n[hartzell@bunny spack]$ which spack\r\n~/foo/spack/bin/spack\r\n[hartzell@bunny spack]$ spack uninstall tmux\r\n==> The following packages will be uninstalled:\r\n\r\n-- linux-centos7-x86_64 / gcc@5.5.0 -----------------------------\r\nszc3vlr tmux@2.7%gcc\r\n\r\n==> Do you want to proceed? [y/N] y\r\n==> Successfully uninstalled tmux@2.7%gcc@5.5.0 arch=linux-centos7-x86_64 /szc3vlr\r\n[hartzell@bunny spack]$ spack install --use-cache tmux\r\n==> zlib is already installed in /home/hartzell/foo/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/zlib-1.2.11-ijtgxbh42fcxbwklab6vdvmlrjadep56\r\n==> openssl is already installed in /home/hartzell/foo/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/openssl-1.0.2n-xduivakzy6qkikvpdwad4cndjrxxjrtm\r\n==> libevent is already installed in /home/hartzell/foo/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/libevent-2.0.21-eb6ntdlm3v63a2yhrpxk3cobbrvttep4\r\n==> pkgconf is already installed in /home/hartzell/foo/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/pkgconf-1.4.0-oq27yb7w5zuwmhkozaepre2g6qsh7fcm\r\n==> ncurses is already installed in /home/hartzell/foo/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/ncurses-6.0-cknorkglnsg7wwc6txojd67o6ryvujmt\r\n==> Installing tmux\r\n==> Searching for binary cache of tmux\r\n==> Finding buildcaches in /tmp/mirror//build_cache\r\n==> Installing tmux from binary cache\r\n==> Already downloaded /home/hartzell/foo/spack/var/spack/stage/build_cache/linux-centos7-x86_64-gcc-5.5.0-tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl.spack\r\ngpg: Signature made Sun 20 May 2018 03:16:18 AM UTC using RSA key ID 2BD81240\r\ngpg: Good signature from \"George Hartzell (GPG created for Spack) <hartzell@alerce.com>\"\r\n==> Relocating package from\r\n  /home/hartzell/spack/opt/spack to /home/hartzell/foo/spack/opt/spack.\r\n==> Successfully installed tmux from binary cache\r\n[+] /home/hartzell/foo/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl\r\n[hartzell@bunny spack]$\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n[hartzell@bunny spack]$ spack install tmux\r\n==> zlib is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/zlib-1.2.11-ijtgxbh42fcxbwklab6vdvmlrjadep56\r\n==> openssl is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/openssl-1.0.2n-xduivakzy6qkikvpdwad4cndjrxxjrtm\r\n==> libevent is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/libevent-2.0.21-eb6ntdlm3v63a2yhrpxk3cobbrvttep4\r\n==> pkgconf is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/pkgconf-1.4.0-oq27yb7w5zuwmhkozaepre2g6qsh7fcm\r\n==> ncurses is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/ncurses-6.0-cknorkglnsg7wwc6txojd67o6ryvujmt\r\n==> Installing tmux\r\n==> Using cached archive: /home/hartzell/spack/var/spack/cache/tmux/tmux-2.7.tar.gz\r\n==> Staging archive: /home/hartzell/spack/var/spack/stage/tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl/tmux-2.7.tar.gz\r\n==> Created stage in /home/hartzell/spack/var/spack/stage/tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl\r\n==> No patches needed for tmux\r\n==> Building tmux [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Executing phase: 'configure'\r\n==> Executing phase: 'build'\r\n==> Executing phase: 'install'\r\n==> Successfully installed tmux\r\n  Fetch: 0.01s.  Build: 34.25s.  Total: 34.27s.\r\n[+] /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl\r\n[hartzell@bunny spack]$ spack buildcache create -r -a -f -d /tmp/mirror tmux\r\n==> adding matching spec tmux@2.7%gcc@5.5.0 arch=linux-centos7-x86_64\r\n==> recursing dependencies\r\n==> adding dependency zlib@1.2.11%gcc@5.5.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n==> adding dependency openssl@1.0.2n%gcc@5.5.0+systemcerts arch=linux-centos7-x86_64\r\n==> adding dependency libevent@2.0.21%gcc@5.5.0+openssl arch=linux-centos7-x86_64\r\n==> adding dependency ncurses@6.0%gcc@5.5.0 patches=4110a40613b800da2b2888c352b64c75a82809d48341061e4de5861e8b28423f,f84b2708a42777aadcc7f502a261afe10ca5646a51c1ef8b5e60d2070d926b57 ~symlinks~termlib arch=linux-centos7-x86_64\r\n==> adding dependency tmux@2.7%gcc@5.5.0 arch=linux-centos7-x86_64\r\n==> writing tarballs to /tmp/mirror/build_cache\r\n==> creating binary cache file for package zlib@1.2.11%gcc@5.5.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n==> creating binary cache file for package openssl@1.0.2n%gcc@5.5.0+systemcerts arch=linux-centos7-x86_64\r\n==> creating binary cache file for package tmux@2.7%gcc@5.5.0 arch=linux-centos7-x86_64\r\n==> creating binary cache file for package libevent@2.0.21%gcc@5.5.0+openssl arch=linux-centos7-x86_64\r\n==> creating binary cache file for package ncurses@6.0%gcc@5.5.0 patches=4110a40613b800da2b2888c352b64c75a82809d48341061e4de5861e8b28423f,f84b2708a42777aadcc7f502a261afe10ca5646a51c1ef8b5e60d2070d926b57 ~symlinks~termlib arch=linux-centos7-x86_64\r\n[hartzell@bunny spack]$ spack uninstall tmux\r\n==> The following packages will be uninstalled:\r\n\r\n-- linux-centos7-x86_64 / gcc@5.5.0 -----------------------------\r\nszc3vlr tmux@2.7%gcc\r\n\r\n==> Do you want to proceed? [y/N] y\r\n==> Successfully uninstalled tmux@2.7%gcc@5.5.0 arch=linux-centos7-x86_64 /szc3vlr\r\n[hartzell@bunny spack]$ spack install --use-cache tmux\r\n==> zlib is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/zlib-1.2.11-ijtgxbh42fcxbwklab6vdvmlrjadep56\r\n==> openssl is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/openssl-1.0.2n-xduivakzy6qkikvpdwad4cndjrxxjrtm\r\n==> libevent is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/libevent-2.0.21-eb6ntdlm3v63a2yhrpxk3cobbrvttep4\r\n==> pkgconf is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/pkgconf-1.4.0-oq27yb7w5zuwmhkozaepre2g6qsh7fcm\r\n==> ncurses is already installed in /home/hartzell/spack/opt/spack/linux-centos7-x86_64/gcc-5.5.0/ncurses-6.0-cknorkglnsg7wwc6txojd67o6ryvujmt\r\n==> Installing tmux\r\n==> Searching for binary cache of tmux\r\n==> Finding buildcaches in /tmp/mirror//build_cache\r\n==> Installing tmux from binary cache\r\n==> Already downloaded /home/hartzell/spack/var/spack/stage/build_cache/linux-centos7-x86_64-gcc-5.5.0-tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl.spack\r\ngpg: Signature made Sun 20 May 2018 03:16:18 AM UTC using RSA key ID 2BD81240\r\ngpg: Good signature from \"George Hartzell (GPG created for Spack) <hartzell@alerce.com>\"\r\n==> Relocating package from\r\n  /home/hartzell/spack/opt/spack to /home/hartzell/spack/opt/spack.\r\n==> Error:\r\n /tmp/tmpxEG6CD/tmux-2.7-szc3vlr7qwrr5d6vpv4qmnnifrqj4zyl/bin/tmux\r\ncontains string\r\n /home/hartzell/spack/opt/spack\r\nafter replacing it in rpaths.\r\nPackage should not be relocated.\r\n Use -a to override.\r\n[hartzell@bunny spack]$\r\n```\r\n\r\n### Information on your system\r\n\r\nCentOS 7 on a Digital Ocean droplet.\r\n\r\nMy spack tree was populated with the following script (apologies in advance for the bits of cruft that are still in there...):\r\n\r\n```sh\r\n#!/bin/sh\r\nset -e\r\n\r\n# export TMPDIR=/data/hartzell/tmp\r\nSPACK=\"${SPACK:-${HOME}/spack}\"\r\n\r\n# having an app tree set up messes up the build.  Clear the field.\r\nif [[ $(type -t module) == \"function\" ]]; then\r\n    module purge\r\nfi\r\n\r\n# this host has an antique set of certificates, which prevents spack\r\n# (curl) from fetching some applications tarballs.  This grabs a good one.\r\n# if [[ ! -d ~/tmp/cert ]]; then\r\n#     mkdir -p ~/tmp/cert\r\n# fi\r\n# if [[ -f ~/tmp/cert/cacert.pem ]]; then\r\n#     rm ~/tmp/cert/cacert.pem\r\n# fi\r\n\r\n# wget -O ~/tmp/cert/cacert.pem http://curl.haxx.se/ca/cacert.pem\r\n# export CURL_CA_BUNDLE=~/tmp/cert/cacert.pem\r\n\r\ncat << \"EOYAML\" > ${SPACK}/etc/spack/config.yaml\r\n# -------------------------------------------------------------------------\r\n# This is the project specific spack configuration file.\r\n# -------------------------------------------------------------------------\r\nconfig:\r\n  # Temporary locations Spack can try to use for builds.\r\n  #\r\n  # A value of $spack/var/spack/stage indicates that Spack should run\r\n  # builds directly inside its install directory without staging them in\r\n  # temporary space.\r\n  #\r\n  # The build stage can be purged with `spack purge --stage`.\r\n  build_stage:\r\n    - $spack/var/spack/stage\r\nEOYAML\r\n\r\ncat << \"EOYAML\" > ${SPACK}/etc/spack/packages.yaml\r\npackages:\r\n  all:\r\n    compiler: [gcc@5.5.0, gcc@4.8.5, gcc@4.8.3]\r\nEOYAML\r\n\r\ncat << \"EOYAML\" > ${SPACK}/etc/spack/modules.yaml\r\nmodules:\r\n  enable::\r\n    - lmod\r\n    - tcl\r\n  tcl:\r\n    hash_length: 0\r\n    all:\r\n      suffixes:\r\n        '+jit': jit\r\n    naming_scheme: '${PACKAGE}/${VERSION}'\r\n  lmod:\r\n    core_compilers:\r\n      - 'gcc@4.8.5'\r\n      - 'gcc@4.8.2'\r\n      - 'gcc@4.8'\r\n    hash_length: 0\r\n    whitelist:\r\n      - gcc\r\n    blacklist:\r\n      - '%gcc@4.8.2'\r\n      - '%gcc@4.8.5'\r\n    verbose_autoload: false\r\n    all:\r\n      suffixes:\r\n        '+jit': jit\r\n      filter:\r\n        environment_blacklist: ['CPATH', 'LIBRARY_PATH', 'LD_LIBRARY_PATH']\r\n      #environment:\r\n      #  set:\r\n      #    '${PACKAGE}_ROOT': '${PREFIX}'\r\n    ^python:\r\n      autoload:  'direct'\r\n      filter:\r\n        environment_whitelist: ['LD_LIBRARY_PATH']\r\nEOYAML\r\n\r\nmy_compiler=gcc@5.5.0\r\n\r\nif ! spack location -i ${my_compiler} > /dev/null 2>&1; then\r\n    # Compiler\r\n\r\n    ## HEADS UP: This is a bit fragile.  Make sure that you don't have\r\n    ## a ~/.spack/.../compilers.yaml file that defines a 5.4.0,\r\n    ## otherwise you're likely to build \"my_compiler\" with that one\r\n    ## and lmod won't generate a set of Core modules.  Alt, we could\r\n    ## grab the version from the system compiler and specify it here\r\n    ## explicitly.  More work than it's worth for now.\r\n    spack install ${my_compiler}\r\n\r\n    # This might not do what you want if there's already\r\n    # a 5.4.0 on the system....\r\n    # Now all of the things will be built with %gcc@5.4.0\r\n    spack compiler add --scope site $(spack location -i ${my_compiler})\r\nfi\r\n\r\nspack install aspell6-en; spack activate aspell6-en\r\nspack install cask\r\nspack install direnv\r\nspack install emacs\r\nspack install git\r\nspack install htop\r\nspack install httpie\r\nspack install jq\r\nspack install lmod\r\nspack install perl\r\nspack install the-silver-searcher\r\nspack install tree\r\nspack install tmux\r\n```\r\n\r\nI added a mirror entry to my personal (unintentionally) spack with:\r\n\r\n```\r\nspack mirror add mypkgs /tmp/mirror/\r\n```\r\n\r\n",
    "performed_via_github_app": null
}