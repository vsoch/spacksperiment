{
    "url": "https://api.github.com/repos/spack/spack/issues/9083",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/9083/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/9083/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/9083/events",
    "html_url": "https://github.com/spack/spack/issues/9083",
    "id": 353501603,
    "node_id": "MDU6SXNzdWUzNTM1MDE2MDM=",
    "number": 9083,
    "title": "correct way to leverage pre-existing, external modules?",
    "user": {
        "login": "koomie",
        "id": 889417,
        "node_id": "MDQ6VXNlcjg4OTQxNw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/889417?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/koomie",
        "html_url": "https://github.com/koomie",
        "followers_url": "https://api.github.com/users/koomie/followers",
        "following_url": "https://api.github.com/users/koomie/following{/other_user}",
        "gists_url": "https://api.github.com/users/koomie/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/koomie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/koomie/subscriptions",
        "organizations_url": "https://api.github.com/users/koomie/orgs",
        "repos_url": "https://api.github.com/users/koomie/repos",
        "events_url": "https://api.github.com/users/koomie/events{/privacy}",
        "received_events_url": "https://api.github.com/users/koomie/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 455855856,
            "node_id": "MDU6TGFiZWw0NTU4NTU4NTY=",
            "url": "https://api.github.com/repos/spack/spack/labels/external-packages",
            "name": "external-packages",
            "color": "c5def5",
            "default": false,
            "description": null
        },
        {
            "id": 446632829,
            "node_id": "MDU6TGFiZWw0NDY2MzI4Mjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/modules",
            "name": "modules",
            "color": "fef2c0",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 7,
    "created_at": "2018-08-23T18:31:43Z",
    "updated_at": "2018-09-13T01:30:07Z",
    "closed_at": "2018-09-13T01:15:32Z",
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "##### Background\r\n\r\nOver in openhpc land we were recently talking about possibly providing users a mechanism to register ohpc-style packages they may have installed with spack to avoid rebuilding items already present.  I've tried to do this using the `modules` capability mentioned in the docs (https://spack.readthedocs.io/en/latest/build_settings.html), but seem to missing something. Not sure if it's a bug or if I just don't have the config right, but submitting per request and will highlight below what I tried.\r\n\r\nBelow is an example config for `packages.yaml` where I am trying to have spack know about the openhpc `autotools` module which provides access to autoconf, automake, and libtool binaries via standard PATH settings.\r\n\r\n```\r\n autoconf:\r\n    modules:\r\n       autoconf@2.69: autotools\r\n       buildable: False\r\n```\r\n\r\nI found a spec package in spack (libconfig) which has a dependency on these tools, so I have been using it as a quick litmus test. When I try to build the package, it builds a few dependencies and then errors off on the external autoconf config:\r\n\r\n```\r\n# spack -k build libconfig\r\n==> Warning: You asked for --insecure. Will NOT check SSL certificates.\r\n==> Checking dependencies for libconfig\r\n==> Installing libsigsegv\r\n==> Fetching https://ftp.gnu.org/gnu/libsigsegv/libsigsegv-2.11.tar.gz\r\n######################################################################## 100.0%\r\n==> Staging archive: /opt/ohpc/admin/spack/0.11.2/var/spack/stage/libsigsegv-2.11-nwbx3xloeloijlyclcpkhaffbhcv4ac2/libsigsegv-2.11.tar.gz\r\n==> Created stage in /opt/ohpc/admin/spack/0.11.2/var/spack/stage/libsigsegv-2.11-nwbx3xloeloijlyclcpkhaffbhcv4ac2\r\n==> No patches needed for libsigsegv\r\n==> Building libsigsegv [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Executing phase: 'configure'\r\n==> Executing phase: 'build'\r\n==> Executing phase: 'install'\r\n==> Successfully installed libsigsegv\r\n  Fetch: 5.00s.  Build: 8.87s.  Total: 13.88s.\r\n[+] /opt/ohpc/admin/spack/0.11.2/opt/spack/linux-centos7-x86_64/gcc-7.3.0/libsigsegv-2.11-nwbx3xloeloijlyclcpkhaffbhcv4ac2\r\n==> Installing m4\r\n==> Fetching https://ftp.gnu.org/gnu/m4/m4-1.4.18.tar.gz\r\n######################################################################## 100.0%\r\n==> Staging archive: /opt/ohpc/admin/spack/0.11.2/var/spack/stage/m4-1.4.18-l5ndpki5yduibmsz7dywpopnlx2s7sxr/m4-1.4.18.tar.gz\r\n==> Created stage in /opt/ohpc/admin/spack/0.11.2/var/spack/stage/m4-1.4.18-l5ndpki5yduibmsz7dywpopnlx2s7sxr\r\n==> Applied patch gnulib-pgi.patch\r\n==> Building m4 [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Executing phase: 'configure'\r\n==> Executing phase: 'build'\r\n==> Executing phase: 'install'\r\n==> Successfully installed m4\r\n  Fetch: 0.67s.  Build: 45.24s.  Total: 45.92s.\r\n[+] /opt/ohpc/admin/spack/0.11.2/opt/spack/linux-centos7-x86_64/gcc-7.3.0/m4-1.4.18-l5ndpki5yduibmsz7dywpopnlx2s7sxr\r\n==> autoconf@2.69 : has external module in autotools\r\n==> autoconf@2.69 : is actually installed in \"/opt/ohpc/admin/spack/0.11.2/modules:/opt/ohpc/pub/moduledeps/gnu7-openmpi3:/opt/ohpc/pub/moduledeps/gnu7:/opt/ohpc/admin/modulefiles:/opt/ohpc/pub/modulefiles\"\r\n==> autoconf@2.69 : generating module file\r\n==> Warning: Module file already exists : skipping creation\r\nfile : /opt/ohpc/admin/spack/0.11.2/share/spack/dotkit/linux-centos7-x86_64/autoconf-2.69-gcc-7.3.0-5czm2l2.dk\r\nspec : autoconf@2.69%gcc@7.3.0 arch=linux-centos7-x86_64\r\n==> autoconf@2.69 : registering into DB\r\n==> libtool@2.4.6 : externally installed in /opt/ohpc/pub/utils/autotools\r\n==> libtool@2.4.6 : generating module file\r\n==> libtool@2.4.6 : registering into DB\r\n==> automake@1.15 : externally installed in /opt/ohpc/pub/utils/autotools\r\n==> automake@1.15 : generating module file\r\n==> automake@1.15 : registering into DB\r\n==> Installing libconfig\r\n==> Fetching https://github.com/hyperrealm/libconfig/archive/v1.5.tar.gz\r\n######################################################################## 100.0%\r\n==> Staging archive: /opt/ohpc/admin/spack/0.11.2/var/spack/stage/libconfig-1.5-vfqtajwumv2zuoc7umupu7xwmk5bjeoh/v1.5.tar.gz\r\n==> Created stage in /opt/ohpc/admin/spack/0.11.2/var/spack/stage/libconfig-1.5-vfqtajwumv2zuoc7umupu7xwmk5bjeoh\r\n==> No patches needed for libconfig\r\n==> Building libconfig [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Error: ProcessError: /opt/ohpc/admin/spack/0.11.2/opt/spack/\"/opt/ohpc/admin/spack/0.11.2/modules:/opt/ohpc/pub/moduledeps/gnu7-openmpi3:/opt/ohpc/pub/moduledeps/gnu7:/opt/ohpc/admin/modulefiles:/opt/ohpc/pub/modulefiles\"/bin/autoreconf: No such file or directory\r\n    Command: '/opt/ohpc/admin/spack/0.11.2/opt/spack/\"/opt/ohpc/admin/spack/0.11.2/modules:/opt/ohpc/pub/moduledeps/gnu7-openmpi3:/opt/ohpc/pub/moduledeps/gnu7:/opt/ohpc/admin/modulefiles:/opt/ohpc/pub/modulefiles\"/bin/autoreconf' '-ivf'\r\nSee build log for details:\r\n  /opt/ohpc/admin/spack/0.11.2/var/spack/stage/libconfig-1.5-vfqtajwumv2zuoc7umupu7xwmk5bjeoh/libconfig-1.5/spack-build.out\r\n```\r\n\r\nLooking at the output, it seems to me that it registers autoconf as coming from an external module, but somehow uses the path provided by MODULEPATH instead of PATH when it tries to run `bin/autoreconf`.  Interestingly, spack does call out the correct (sub)path to other binaries visible in this \u201cautotools\u201d module like `libtool` and `automake` in the trace output above. \r\n\r\nHere is the resolution of the desired binaries from the autotools module\r\n\r\n```\r\n# module list\r\n\r\nCurrently Loaded Modules:\r\n  1) autotools   2) prun/1.2   3) gnu7/7.3.0   4) openmpi3/3.1.0   5) ohpc   6) spack/0.11.2\r\n\r\n# which autoreconf autoconf automake libtool\r\n/opt/ohpc/pub/utils/autotools/bin/autoreconf\r\n/opt/ohpc/pub/utils/autotools/bin/autoconf\r\n/opt/ohpc/pub/utils/autotools/bin/automake\r\n/opt/ohpc/pub/utils/autotools/bin/libtool\r\n\r\n```\r\n\r\nAnd here is the MODULEPATH from my env which is curiously related to the path above being used to try and run autoreconf. \r\n\r\n```\r\n# echo $MODULEPATH\r\n/opt/ohpc/admin/spack/0.11.2/modules:/opt/ohpc/pub/moduledeps/gnu7-openmpi3:/opt/ohpc/pub/moduledeps/gnu7:/opt/ohpc/admin/modulefiles:/opt/ohpc/pub/modulefiles\r\n```\r\n\r\nHere is the module config (we use Lmod):\r\n\r\n```\r\n# module show autotools\r\n--------------------------------------------------------------------------------------------------------------------\r\n   /opt/ohpc/pub/modulefiles/autotools:\r\n--------------------------------------------------------------------------------------------------------------------\r\nwhatis(\"Name: GNU Autotools \")\r\nwhatis(\"Version: 1.0 \")\r\nwhatis(\"Category: utility, developer support \")\r\nwhatis(\"Keywords: System, Utility \")\r\nwhatis(\"Description: Developer utilities \")\r\nprepend_path(\"PATH\",\"/opt/ohpc/pub/utils/autotools/bin\")\r\nprepend_path(\"MANPATH\",\"/opt/ohpc/pub/utils/autotools/share/man\")\r\nhelp([[This module loads the autotools collection to provide recent\r\nversions of autoconf, automake, and libtool.\r\n \r\n]])\r\n\r\n```\r\n\r\nThanks for any pointers/tips.",
    "performed_via_github_app": null
}