{
    "url": "https://api.github.com/repos/spack/spack/issues/14346",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/14346/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/14346/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/14346/events",
    "html_url": "https://github.com/spack/spack/issues/14346",
    "id": 544661254,
    "node_id": "MDU6SXNzdWU1NDQ2NjEyNTQ=",
    "number": 14346,
    "title": "buildcache create: S3 push fails when binary already exists at mirror w/ same dag hash, different full hash",
    "user": {
        "login": "eugeneswalker",
        "id": 38933153,
        "node_id": "MDQ6VXNlcjM4OTMzMTUz",
        "avatar_url": "https://avatars.githubusercontent.com/u/38933153?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/eugeneswalker",
        "html_url": "https://github.com/eugeneswalker",
        "followers_url": "https://api.github.com/users/eugeneswalker/followers",
        "following_url": "https://api.github.com/users/eugeneswalker/following{/other_user}",
        "gists_url": "https://api.github.com/users/eugeneswalker/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/eugeneswalker/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/eugeneswalker/subscriptions",
        "organizations_url": "https://api.github.com/users/eugeneswalker/orgs",
        "repos_url": "https://api.github.com/users/eugeneswalker/repos",
        "events_url": "https://api.github.com/users/eugeneswalker/events{/privacy}",
        "received_events_url": "https://api.github.com/users/eugeneswalker/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 880675484,
            "node_id": "MDU6TGFiZWw4ODA2NzU0ODQ=",
            "url": "https://api.github.com/repos/spack/spack/labels/binary-packages",
            "name": "binary-packages",
            "color": "fc5fb3",
            "default": false,
            "description": ""
        },
        {
            "id": 759411369,
            "node_id": "MDU6TGFiZWw3NTk0MTEzNjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/buildcache",
            "name": "buildcache",
            "color": "bf354c",
            "default": false,
            "description": null
        },
        {
            "id": 446756736,
            "node_id": "MDU6TGFiZWw0NDY3NTY3MzY=",
            "url": "https://api.github.com/repos/spack/spack/labels/mirrors",
            "name": "mirrors",
            "color": "ade2f2",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2020-01-02T17:00:14Z",
    "updated_at": "2020-01-07T18:41:02Z",
    "closed_at": "2020-01-07T18:41:02Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "Using branch `develop` at commit `7a97dc3770d` , I have a `spec.yaml` for a package that needs updating at the build cache due to differing full hashes, where the DAG hash is the same:\r\n\r\n```\r\n[lpeyrala@login1.ascent ~]$ spack buildcache check --rebuild-on-error -y libxml2.spec.yaml\r\n==> Checking for built specs at s3://olcf/ascent\r\n==> Rebuilding libxml2@2.9.9%gcc@8.1.1~python arch=linux-rhel7-ppc64le/djuj3kq, reason: hash mismatch, remote = ivtxx4ldakqe4jxqt7cdfe7ezr5fm7d6, local = rscoqyv5fkuyzqqddmhzvkojdtledket\r\n==> libxml2@2.9.9%gcc@8.1.1~python arch=linux-rhel7-ppc64le\r\n    ^libiconv@1.16%gcc@8.1.1 arch=linux-rhel7-ppc64le\r\n    ^pkgconf@1.6.3%gcc@8.1.1 arch=linux-rhel7-ppc64le\r\n    ^xz@5.2.4%gcc@8.1.1 arch=linux-rhel7-ppc64le\r\n    ^zlib@1.2.11%gcc@8.1.1+optimize+pic+shared arch=linux-rhel7-ppc64le\r\n```\r\n\r\nBut `buildcache create` does not update the cache entry, giving the message `Warning: 'ParseResult' object has no attribute 's3_bucket'` shown at the bottom of this log output:\r\n```\r\n[lpeyrala@login1.ascent ~]$ spack -d buildcache create -afr --key prl --no-deps -d s3 -y libxml2.spec.yaml\r\n==> [2020-01-02-11:42:34.640621] Imported buildcache from built-in commands\r\n==> [2020-01-02-11:42:34.643427] Imported buildcache from built-in commands\r\n==> [2020-01-02-11:42:34.644611] createtarball read spec yaml:\r\n==> [2020-01-02-11:42:34.644644] spec:\r\n- libxml2:\r\n    version: 2.9.9\r\n    arch:\r\n      platform: linux\r\n      platform_os: rhel7\r\n      target: ppc64le\r\n    compiler:\r\n      name: gcc\r\n      version: 8.1.1\r\n    namespace: builtin\r\n    parameters:\r\n      python: false\r\n      cflags: []\r\n      cppflags: []\r\n      cxxflags: []\r\n      fflags: []\r\n      ldflags: []\r\n      ldlibs: []\r\n    dependencies:\r\n      libiconv:\r\n        hash: mxze6sfv3o6eq4z72r674npudztt6usx\r\n        type:\r\n        - build\r\n        - link\r\n      pkgconf:\r\n        hash: cg4qsfky7scgezvxkcdekfupatg56ues\r\n        type:\r\n        - build\r\n      xz:\r\n        hash: alc3lzqqk7zxiw7lhdgsclg5glbhxwfm\r\n        type:\r\n        - build\r\n        - link\r\n      zlib:\r\n        hash: fmat344iyue2sfzerpscwg4lpnvg7eha\r\n        type:\r\n        - build\r\n        - link\r\n    hash: djuj3kqlwsn3t56w4dbuqcmc2zggdyyx\r\n    build_hash: 3xjq4soyxpkw6wtep3pqvfnlf2qk2xae\r\n- libiconv:\r\n    version: '1.16'\r\n    arch:\r\n      platform: linux\r\n      platform_os: rhel7\r\n      target: ppc64le\r\n    compiler:\r\n      name: gcc\r\n      version: 8.1.1\r\n    namespace: builtin\r\n    parameters:\r\n      cflags: []\r\n      cppflags: []\r\n      cxxflags: []\r\n      fflags: []\r\n      ldflags: []\r\n      ldlibs: []\r\n    hash: mxze6sfv3o6eq4z72r674npudztt6usx\r\n    build_hash: mxze6sfv3o6eq4z72r674npudztt6usx\r\n- pkgconf:\r\n    version: 1.6.3\r\n    arch:\r\n      platform: linux\r\n      platform_os: rhel7\r\n      target: ppc64le\r\n    compiler:\r\n      name: gcc\r\n      version: 8.1.1\r\n    namespace: builtin\r\n    parameters:\r\n      cflags: []\r\n      cppflags: []\r\n      cxxflags: []\r\n      fflags: []\r\n      ldflags: []\r\n      ldlibs: []\r\n    hash: cg4qsfky7scgezvxkcdekfupatg56ues\r\n    build_hash: cg4qsfky7scgezvxkcdekfupatg56ues\r\n- xz:\r\n    version: 5.2.4\r\n    arch:\r\n      platform: linux\r\n      platform_os: rhel7\r\n      target: ppc64le\r\n    compiler:\r\n      name: gcc\r\n      version: 8.1.1\r\n    namespace: builtin\r\n    parameters:\r\n      cflags: []\r\n      cppflags: []\r\n      cxxflags: []\r\n      fflags: []\r\n      ldflags: []\r\n      ldlibs: []\r\n    hash: alc3lzqqk7zxiw7lhdgsclg5glbhxwfm\r\n    build_hash: alc3lzqqk7zxiw7lhdgsclg5glbhxwfm\r\n- zlib:\r\n    version: 1.2.11\r\n    arch:\r\n      platform: linux\r\n      platform_os: rhel7\r\n      target: ppc64le\r\n    compiler:\r\n      name: gcc\r\n      version: 8.1.1\r\n    namespace: builtin\r\n    parameters:\r\n      optimize: true\r\n      pic: true\r\n      shared: true\r\n      cflags: []\r\n      cppflags: []\r\n      cxxflags: []\r\n      fflags: []\r\n      ldflags: []\r\n      ldlibs: []\r\n    hash: fmat344iyue2sfzerpscwg4lpnvg7eha\r\n    build_hash: fmat344iyue2sfzerpscwg4lpnvg7eha\r\n==> [2020-01-02-11:42:34.666718] Reading config file /ccsopen/home/lpeyrala/.spack/linux/mirrors.yaml\r\n==> [2020-01-02-11:42:34.668600] find_matching_specs: about to parse specs for {'/djuj3kqlwsn3t56w4dbuqcmc2zggdyyx'}\r\n==> [2020-01-02-11:42:34.668799] Reading config file /autofs/nccsopen-svm1_home/lpeyrala/spack/etc/spack/defaults/config.yaml\r\n==> [2020-01-02-11:42:34.686282] DATABASE LOCK TIMEOUT: 120s\r\n==> [2020-01-02-11:42:34.686320] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2020-01-02-11:42:34.686557] READ LOCK: /autofs/nccsopen-svm1_home/lpeyrala/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\n==> [2020-01-02-11:42:34.689721] READ LOCK: /autofs/nccsopen-svm1_home/lpeyrala/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\n==> [2020-01-02-11:42:34.695831] READ LOCK: /autofs/nccsopen-svm1_home/lpeyrala/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\n==> [2020-01-02-11:42:34.696722] READ LOCK: /autofs/nccsopen-svm1_home/lpeyrala/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\n==> [2020-01-02-11:42:34.699118] READ LOCK: /autofs/nccsopen-svm1_home/lpeyrala/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\n==> [2020-01-02-11:42:34.704870] READ LOCK: /autofs/nccsopen-svm1_home/lpeyrala/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\n==> [2020-01-02-11:42:34.705769] Found at least one matching spec\r\n==> [2020-01-02-11:42:34.706267] examining match libxml2@2.9.9%gcc@8.1.1~python arch=linux-rhel7-ppc64le\r\n==> [2020-01-02-11:42:34.706346] Reading config file /autofs/nccsopen-svm1_home/lpeyrala/spack/etc/spack/defaults/repos.yaml\r\n==> [2020-01-02-11:42:34.773120] adding matching spec libxml2@2.9.9%gcc@8.1.1~python arch=linux-rhel7-ppc64le\r\n==> [2020-01-02-11:42:34.773208] writing tarballs to s3://olcf/ascent/build_cache\r\n==> [2020-01-02-11:42:35.624513] Warning: 'ParseResult' object has no attribute 's3_bucket'\r\n==> [2020-01-02-11:42:34.644080] createtarball, reading spec from libxml2.spec.yaml\r\n==> [2020-01-02-11:42:34.773490] creating binary cache file for package libxml2@2.9.9%gcc@8.1.1~python arch=linux-rhel7-ppc64le\r\n```\r\n\r\nThe `ParseResult` error traces to function `remove_url` defined in `spack/lib/spack/spack/util/web.py:266` . The function `remove_url` is called on lines 327 and 344 of `binary_distribution.py` . It looks to me like the purpose here is to clean up existing, identically named binaries in the build cache, before saving the new items. If I comment out the two code blocks which attempt to preliminarily delete the existing buildcache items, and just allow the overwrite to occur, the buildcache is updated just fine, with the caveat that no attempt is made to catch NoOverwriteException. Although that works, not sure this is the best way to go about it. ",
    "performed_via_github_app": null
}