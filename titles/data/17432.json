{
    "url": "https://api.github.com/repos/spack/spack/issues/17432",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/17432/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/17432/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/17432/events",
    "html_url": "https://github.com/spack/spack/issues/17432",
    "id": 653707811,
    "node_id": "MDU6SXNzdWU2NTM3MDc4MTE=",
    "number": 17432,
    "title": "spack rebuild seems to use wrong python version when it is in the environment",
    "user": {
        "login": "haampie",
        "id": 194764,
        "node_id": "MDQ6VXNlcjE5NDc2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/194764?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/haampie",
        "html_url": "https://github.com/haampie",
        "followers_url": "https://api.github.com/users/haampie/followers",
        "following_url": "https://api.github.com/users/haampie/following{/other_user}",
        "gists_url": "https://api.github.com/users/haampie/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/haampie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/haampie/subscriptions",
        "organizations_url": "https://api.github.com/users/haampie/orgs",
        "repos_url": "https://api.github.com/users/haampie/repos",
        "events_url": "https://api.github.com/users/haampie/events{/privacy}",
        "received_events_url": "https://api.github.com/users/haampie/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2020-07-09T02:10:27Z",
    "updated_at": "2020-07-09T10:31:03Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "### Steps to reproduce the issue\r\nHave a spack.yaml + .gitlab-ci.yml file like https://gitlab.com/cscs-ci/ci-testing/spack-ci/-/tree/839a2aa3794865671060c8431175f01bae8ba4b8.\r\n\r\n- This builds `hpx`. \r\n- `hpx` has down the line a dependency on Python\r\n- I believe this confuses spack in the `spack rebuild` step, making it fail to locate the `botocore` module and error next as follows\r\n\r\nTo isolate the problem further, please check out [this minimal setup](https://gitlab.com/cscs-ci/ci-testing/spack-ci/-/blob/84cbc5a7c0821d4d0f8d9cdb66f0a3a6e6128c98/.gitlab-ci.yml) with just the failing job, and check out the pipeline logs: https://cscs-ci.gitlab.io/-/ci-testing/spack-ci/-/jobs/630250913/artifacts/jobs_scratch_dir/logs/pipeline_log.txt.\r\n\r\n### Error Message\r\n\r\n```\r\n==> [2020-07-09-03:55:46.206507, 568] Error: ModuleNotFoundError: No module named 'botocore'\r\n\r\n/opt/spack/lib/spack/spack/package.py:1149, in do_fetch:\r\n       1146                raise FetchError(\"Will not fetch %s\" %\r\n       1147                                 self.spec.format('{name}{@version}'), ck_msg)\r\n       1148\r\n  >>   1149        self.stage.create()\r\n       1150        self.stage.fetch(mirror_only)\r\n       1151        self._fetch_time = time.time() - start_time\r\n       1152\r\n\r\n\r\nTraceback (most recent call last):\r\n  File \"/opt/spack/lib/spack/spack/build_environment.py\", line 838, in child_process\r\n    return_value = function()\r\n  File \"/opt/spack/lib/spack/spack/installer.py\", line 1073, in build_process\r\n    pkg.do_patch()\r\n  File \"/opt/spack/lib/spack/spack/package.py\", line 1189, in do_patch\r\n    self.do_stage()\r\n  File \"/opt/spack/lib/spack/spack/package.py\", line 1174, in do_stage\r\n    self.do_fetch(mirror_only)\r\n  File \"/opt/spack/lib/spack/spack/package.py\", line 1150, in do_fetch\r\n    self.stage.fetch(mirror_only)\r\n  File \"/opt/spack/lib/spack/spack/util/pattern.py\", line 68, in getter\r\n    getattr(item, self.name)(*args, **kwargs)\r\n  File \"/opt/spack/lib/spack/spack/stage.py\", line 464, in fetch\r\n    self.fetcher.fetch()\r\n  File \"/opt/spack/lib/spack/spack/fetch_strategy.py\", line 72, in wrapper\r\n    return fun(self, *args, **kwargs)\r\n  File \"/opt/spack/lib/spack/spack/fetch_strategy.py\", line 1146, in fetch\r\n    _, headers, stream = web_util.read_from_url(self.url)\r\n  File \"/opt/spack/lib/spack/spack/util/web.py\", line 128, in read_from_url\r\n    response = _urlopen(req, timeout=_timeout, context=context)\r\n  File \"/opt/spack/lib/spack/spack/util/web.py\", line 476, in _urlopen\r\n    return opener(req, *args, **kwargs)\r\n  File \"/scratch/snx3000/jenkssl/gitlab-runner-daint/builds/txUXd4Wq/0/cscs-ci-ci-testing-spack-ci/cscs-ci/ci-testing/spack-ci/.spack-env/view/lib/python3.7/urllib/request.py\", line 525, in open\r\n    response = self._open(req, data)\r\n  File \"/scratch/snx3000/jenkssl/gitlab-runner-daint/builds/txUXd4Wq/0/cscs-ci-ci-testing-spack-ci/cscs-ci/ci-testing/spack-ci/.spack-env/view/lib/python3.7/urllib/request.py\", line 543, in _open\r\n    '_open', req)\r\n  File \"/scratch/snx3000/jenkssl/gitlab-runner-daint/builds/txUXd4Wq/0/cscs-ci-ci-testing-spack-ci/cscs-ci/ci-testing/spack-ci/.spack-env/view/lib/python3.7/urllib/request.py\", line 503, in _call_chain\r\n    result = func(*args)\r\n  File \"/opt/spack/lib/spack/spack/s3_handler.py\", line 64, in s3_open\r\n    from botocore.exceptions import ClientError\r\nModuleNotFoundError: No module named 'botocore'\r\n```\r\n\r\nNote the paths to `spack-ci/.spack-env/view/lib/python3.7/urllib/request.py`, it's probably using the wrong python version.\r\n\r\n### Information on your system\r\n\r\nI can't really provide this, it's running in CI.\r\n\r\n### Additional information\r\n\r\n- [ ] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n",
    "performed_via_github_app": null
}