{
    "url": "https://api.github.com/repos/spack/spack/issues/24811",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24811/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24811/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24811/events",
    "html_url": "https://github.com/spack/spack/pull/24811",
    "id": 941041406,
    "node_id": "MDExOlB1bGxSZXF1ZXN0Njg3MDE5MTgy",
    "number": 24811,
    "title": "Ensure consistency of buildcache spec.yaml files and buildcache index",
    "user": {
        "login": "scottwittenburg",
        "id": 6527504,
        "node_id": "MDQ6VXNlcjY1Mjc1MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6527504?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scottwittenburg",
        "html_url": "https://github.com/scottwittenburg",
        "followers_url": "https://api.github.com/users/scottwittenburg/followers",
        "following_url": "https://api.github.com/users/scottwittenburg/following{/other_user}",
        "gists_url": "https://api.github.com/users/scottwittenburg/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scottwittenburg/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scottwittenburg/subscriptions",
        "organizations_url": "https://api.github.com/users/scottwittenburg/orgs",
        "repos_url": "https://api.github.com/users/scottwittenburg/repos",
        "events_url": "https://api.github.com/users/scottwittenburg/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scottwittenburg/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 880675484,
            "node_id": "MDU6TGFiZWw4ODA2NzU0ODQ=",
            "url": "https://api.github.com/repos/spack/spack/labels/binary-packages",
            "name": "binary-packages",
            "color": "fc5fb3",
            "default": false,
            "description": ""
        },
        {
            "id": 456341797,
            "node_id": "MDU6TGFiZWw0NTYzNDE3OTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/tests",
            "name": "tests",
            "color": "b60205",
            "default": false,
            "description": "General test capability(ies)"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "becker33",
        "id": 13971568,
        "node_id": "MDQ6VXNlcjEzOTcxNTY4",
        "avatar_url": "https://avatars.githubusercontent.com/u/13971568?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/becker33",
        "html_url": "https://github.com/becker33",
        "followers_url": "https://api.github.com/users/becker33/followers",
        "following_url": "https://api.github.com/users/becker33/following{/other_user}",
        "gists_url": "https://api.github.com/users/becker33/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/becker33/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/becker33/subscriptions",
        "organizations_url": "https://api.github.com/users/becker33/orgs",
        "repos_url": "https://api.github.com/users/becker33/repos",
        "events_url": "https://api.github.com/users/becker33/events{/privacy}",
        "received_events_url": "https://api.github.com/users/becker33/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "becker33",
            "id": 13971568,
            "node_id": "MDQ6VXNlcjEzOTcxNTY4",
            "avatar_url": "https://avatars.githubusercontent.com/u/13971568?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/becker33",
            "html_url": "https://github.com/becker33",
            "followers_url": "https://api.github.com/users/becker33/followers",
            "following_url": "https://api.github.com/users/becker33/following{/other_user}",
            "gists_url": "https://api.github.com/users/becker33/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/becker33/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/becker33/subscriptions",
            "organizations_url": "https://api.github.com/users/becker33/orgs",
            "repos_url": "https://api.github.com/users/becker33/repos",
            "events_url": "https://api.github.com/users/becker33/events{/privacy}",
            "received_events_url": "https://api.github.com/users/becker33/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 3,
    "created_at": "2021-07-09T20:18:10Z",
    "updated_at": "2021-07-10T06:49:09Z",
    "closed_at": "2021-07-10T06:49:09Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/24811",
        "html_url": "https://github.com/spack/spack/pull/24811",
        "diff_url": "https://github.com/spack/spack/pull/24811.diff",
        "patch_url": "https://github.com/spack/spack/pull/24811.patch"
    },
    "body": "The process of updating the index of a binary mirror involves iterating over the spec.yaml files in the mirror and adding each one to a temporary database, then writing out the database using db._write_to_file(). There has been an issue observed when updating the index of binary mirrors which was only reproducible with a large mirror with a lot of versions of the various specs in the environment. The issue resulted in the regenerated index having full hash values on specs not matching the full hashes in the individual spec.yaml files from which the index was built.\r\n\r\nDebugging the problem indicated that a spec could be added to the db as a dependency of something else (possibly an old or out of date spec.yaml), and then when it's again encountered directly (not as a dependency, but because we read its spec.yaml and added it explicitly), the database code would find the dag hash already present and not overwrite it.\r\n\r\nThis PR changes how `spack buildcache update-index` works by checking each spec.yaml to see if it's dependencies' full hashes were changed (the spec.yaml for the dependency is considered to be the source of truth regarding the full hash of the dependency).  If we find any mismatches between the full hash of  a dependency in a parent spec.yaml and the full hash in the dependency spec.yaml, we fix up the parent by splicing in the correct dependency specs, and then push the spliced parent spec.yaml to the mirror.  Once we have fixed up all the spec yamls on the mirror, we then update the buildcache index.  The end result is that the full hash of the root spec in each spec.yaml matches the full hash of the corresponding dag hash in the index.\r\n\r\nThis depends on #24795",
    "performed_via_github_app": null
}