{
    "url": "https://api.github.com/repos/spack/spack/issues/19879",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/19879/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/19879/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/19879/events",
    "html_url": "https://github.com/spack/spack/issues/19879",
    "id": 741641720,
    "node_id": "MDU6SXNzdWU3NDE2NDE3MjA=",
    "number": 19879,
    "title": "Installation issue: llvm +cuda openmp and nvptx should probably be conditional",
    "user": {
        "login": "svenevs",
        "id": 5871461,
        "node_id": "MDQ6VXNlcjU4NzE0NjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5871461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/svenevs",
        "html_url": "https://github.com/svenevs",
        "followers_url": "https://api.github.com/users/svenevs/followers",
        "following_url": "https://api.github.com/users/svenevs/following{/other_user}",
        "gists_url": "https://api.github.com/users/svenevs/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/svenevs/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/svenevs/subscriptions",
        "organizations_url": "https://api.github.com/users/svenevs/orgs",
        "repos_url": "https://api.github.com/users/svenevs/repos",
        "events_url": "https://api.github.com/users/svenevs/events{/privacy}",
        "received_events_url": "https://api.github.com/users/svenevs/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 618601843,
            "node_id": "MDU6TGFiZWw2MTg2MDE4NDM=",
            "url": "https://api.github.com/repos/spack/spack/labels/cuda",
            "name": "cuda",
            "color": "85b737",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2020-11-12T14:22:48Z",
    "updated_at": "2020-11-30T22:46:04Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "### Steps to reproduce the issue\r\n\r\n<!-- Fill in the exact spec you are trying to build and the relevant part of the error message -->\r\n```console\r\n# mine is an external install but irrelevant\r\n$ spack install cuda@11.1.0\r\n\r\n$ spack install llvm@11.0.0 build_type=Release +clang~code_signing+cuda cuda_arch=61 +gold+internal+unwind~ipo+libcxx+lld+lldb~mlir~omp_debug~omp_tsan+polly+python~shared_libs~split_dwarf\r\n```\r\n\r\n### Discussion\r\n\r\nhttps://github.com/spack/spack/blob/527a81b469cf3df12e4b8c3bcd8609b2d55db2f3/var/spack/repos/builtin/packages/llvm/package.py#L524-L526\r\n\r\n**Important note**: I'm using CUDA 11.1 which they aren't ready for yet (10.2 latest \"supported\").\r\n\r\nRefs:\r\n\r\n- [Options for `NVPTX device RTL`](https://github.com/llvm/llvm-project/tree/llvmorg-11.0.0/openmp#options-for-nvptx-device-rtl)\r\n- [D47394](https://reviews.llvm.org/D47394)\r\n    - [Static only](https://stackoverflow.com/questions/35897002/cuda-nvcc-building-chain-of-libraries)?\r\n\r\nFailure message something like (sorry, lost the logs in rebuild):\r\n\r\n```\r\n-- Performing Test LIBOMPTARGET_NVPTX_CUDA_COMPILER_SUPPORTS_FLAGS_REQUIRED\r\n-- Performing Test LIBOMPTARGET_NVPTX_CUDA_COMPILER_SUPPORTS_FLAGS_REQUIRED - Failed\r\n```\r\n\r\nThis one is quite entrenched, mostly posting issue so if other users hit this they know that they just need to edit the package and set this to false:\r\n\r\n```diff\r\n@@ -521,8 +539,11 @@ def post_install(self):\r\n                     \"-DCMAKE_INSTALL_PREFIX:PATH={0}\".format(spec.prefix),\r\n                 ]\r\n                 cmake_args.extend(self.cmake_args())\r\n+                # NOTE: line numbers wrong!!! i have other patches, look in post_install\r\n                 cmake_args.append(\r\n-                    \"-DLIBOMPTARGET_NVPTX_ENABLE_BCLIB:BOOL=TRUE\"\r\n+                    \"-DLIBOMPTARGET_NVPTX_ENABLE_BCLIB:BOOL=FALSE\"\r\n                 )\r\n```\r\n\r\nIt's possible that using `sm_35` could cause this for me in [their detection code (see `FIXME`)](https://github.com/llvm/llvm-project/blob/llvmorg-11.0.0/openmp/libomptarget/cmake/Modules/LibomptargetNVPTXBitcodeLibrary.cmake), but more likely it's because I'm using CUDA 11.1 and the provided `libdevice.bc` is unusable for them.  We're having electrical issues and had to shut down the rigs I usually test build issues on so I can't do additional testing right now (need to finish tooling up this one...).  This build error raises a couple of questions:\r\n\r\n1. Should `LIBOMPTARGET_NVPTX_ENABLE_BCLIB` be disabled if `+shared`?\r\n2. It doesn't look like there's a way to disable openmp nvptx target, should there be?  (Couldn't see an obvious way to disable it in their cmake options either).  Some kind of `variant(\"omp_nvptx\", ...)`?\r\n3. Hypothesis: would not have this error using CUDA 10.2.  Should LLVM package start tracking officially supported versions and possibly disable this automatically instead of (2)?\r\n    - Other than this build error and possibly switching off `LIBOMPTARGET_NVPTX_ENABLE_BCLIB`, newer CUDA is usually not an issue.  It just means you use an additional flag to squash some warnings, and you won't get any optimizations for the newer CUDA toolkit.  But presumably CUDA 11 and all the new goodies is making this specific component very difficult for them.\r\n    - Theoretically, since we're in `post_install`, we could with a small amount of effort actually run [`LibomptargetNVPTXBitcodeLibrary.cmake`](https://github.com/llvm/llvm-project/blob/llvmorg-11.0.0/openmp/libomptarget/cmake/Modules/LibomptargetNVPTXBitcodeLibrary.cmake) to see if it can actually be used.\r\n    - If this is done, what to do about `llvm@master`?\r\n\r\nAgain, only really posting to raise awareness of issue and temporary solution.  I will not be able to keep up with the discussion.\r\n\r\nCC:\r\n- LLVM maintainers: @trws @naromero77\r\n- CUDA maintainers: @ax3l @Rombur ",
    "performed_via_github_app": null
}