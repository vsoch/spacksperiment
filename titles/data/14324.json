{
    "url": "https://api.github.com/repos/spack/spack/issues/14324",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/14324/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/14324/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/14324/events",
    "html_url": "https://github.com/spack/spack/issues/14324",
    "id": 544023671,
    "node_id": "MDU6SXNzdWU1NDQwMjM2NzE=",
    "number": 14324,
    "title": "Installation issue: intel mkl / mpi when using external modules or paths with multiple versions",
    "user": {
        "login": "mkiernan",
        "id": 24193619,
        "node_id": "MDQ6VXNlcjI0MTkzNjE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/24193619?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mkiernan",
        "html_url": "https://github.com/mkiernan",
        "followers_url": "https://api.github.com/users/mkiernan/followers",
        "following_url": "https://api.github.com/users/mkiernan/following{/other_user}",
        "gists_url": "https://api.github.com/users/mkiernan/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mkiernan/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mkiernan/subscriptions",
        "organizations_url": "https://api.github.com/users/mkiernan/orgs",
        "repos_url": "https://api.github.com/users/mkiernan/repos",
        "events_url": "https://api.github.com/users/mkiernan/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mkiernan/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 477156668,
            "node_id": "MDU6TGFiZWw0NzcxNTY2Njg=",
            "url": "https://api.github.com/repos/spack/spack/labels/intel",
            "name": "intel",
            "color": "127cc1",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2019-12-30T21:59:11Z",
    "updated_at": "2021-03-15T09:55:01Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I've been running into multiple issues while attempting to use system installed/external intel  libraries.  I'm currently leaning towards dropping this approach and instead installing all the intel compilers + libraries with spack, but thought I should record this as it's likely others will run into it when attempting to use system installed intel libraries, particularly when there are multiple versions installed. \r\n\r\nA typical example: \r\n```\r\n[mk@buildhb azure-spack]$ spack install --show-log-on-error --verbose intel-mpi@2018.4.274%gcc@9.2.0\r\n==> intel-mpi@2018.4.274 : has external module in mpi/impi_2018.4.274\r\n==> intel-mpi@2018.4.274 : is actually installed in /opt/intel/impi/2018.4.274/intel64\r\n==> intel-mpi@2018.4.274 : generating module file\r\n==> Warning: cannot perform the requested write operation on module files [Trying to source non-existing file: /opt/intel/impi/2018.4.274/intel64/compilers_and_libraries/linux/mpi/intel64/bin/mpivars.sh]\r\n==> intel-mpi@2018.4.274 : registering into DB\r\n```\r\nThe problem is that the compilers_and_libraries is being inserted at the wrong level. The correct path would be: /opt/intel/compilers_and_libraries_2018.5.274/linux/mpi/intel64/lib or /opt/intel/impi/2018.4.274/intel64/lib/\r\n\r\nThe intel installers all consolidate the packages into the same /opt/intel (or other) root and so you end up with all versions crammed into the same folder, which is what seems to be triggering some of the problems; \r\n```\r\n[mk@buildhb spack]$ ls -la /opt/intel/\r\ntotal 4\r\ndrwxr-xr-x. 19 root root 4096 Dec 26 20:59 .\r\ndrwxr-xr-x. 12 root root  225 Oct 25 17:49 ..\r\ndrwxr-xr-x.  2 root root   53 Oct 25 17:52 bin\r\nlrwxrwxrwx.  1 root root   28 Oct 25 17:47 compilers_and_libraries -> compilers_and_libraries_2019\r\ndrwxr-xr-x.  3 root root   19 Oct 25 17:49 compilers_and_libraries_2018\r\ndrwxr-xr-x.  4 root root   36 Sep 28  2018 compilers_and_libraries_2018.5.274\r\ndrwxr-xr-x.  3 root root   19 Oct 25 17:47 compilers_and_libraries_2019\r\ndrwxr-xr-x.  4 root root   36 Aug 19 14:37 compilers_and_libraries_2019.5.281\r\n```\r\n\r\nIf instead I try with path instead of module:\r\n```\r\n  intel-mpi:\r\n#    modules:\r\n#      intel-mpi@2018.4.274%gcc@9.2.0: mpi/impi_2018.4.274\r\n#      intel-mpi@2019.5.281%gcc@9.2.0: mpi/impi_2019.5.281\r\n    paths:\r\n      intel-mpi@2018.4.274%gcc@9.2.0: /opt/intel/impi/2018.4.274\r\n```\r\nIt also fails with the wrong path: \r\n```\r\n[mk@buildhb azure-spack]$ spack install intel-mpi@2018.4.274\r\n==> intel-mpi@2018.4.274 : externally installed in /opt/intel/impi/2018.4.274\r\n==> intel-mpi@2018.4.274 : generating module file\r\n==> Warning: cannot perform the requested write operation on module files [Trying to source non-existing file: /opt/intel/impi/2018.4.274/compilers_and_libraries/linux/mpi/intel64/bin/mpivars.sh]\r\n==> intel-mpi@2018.4.274 : registering into DB\r\n[mk@buildhb azure-spack]$\r\n```\r\nIf instead I use /opt/intel only, then it follows the 2019 (latest) link and picks up the wrong version : \r\n```\r\n[mk@buildhb azure-spack]$ spack install intel-mpi@2018.4.274\r\n==> intel-mpi@2018.4.274 : externally installed in /opt/intel\r\n==> intel-mpi@2018.4.274 : generating module file\r\n==> Warning: Quotes in command arguments can confuse scripts like configure.\r\n  The following arguments may cause problems when executed:\r\n      source /opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/bin/mpivars.sh intel64 &> /dev/null && /usr/bin/python -c \"import os, json; print(json.dumps(dict(os.environ)))\"\r\n  Quotes aren't needed because spack doesn't use a shell.\r\n  Consider removing them\r\n==> intel-mpi@2018.4.274 : registering into DB\r\n```\r\nAnd you can see the paths are all set to 2019 instead of 2018: \r\n```\r\n[mk@buildhb azure-spack]$ spack load intel-mpi@2018.4.274\r\n[mk@buildhb azure-spack]$ env | grep -i mpi\r\nMANPATH=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/man:/shared/home/mk/perl5/man:/usr/share/man/overrides:/opt/ibutils/share/man:/usr/share/man:/usr/local/share/man\r\nLIBRARY_PATH=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/libfabric/lib:/opt/intel/lib\r\nLD_LIBRARY_PATH=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/libfabric/lib:/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/lib/release:/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/lib:/opt/intel/lib\r\nFI_PROVIDER_PATH=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/libfabric/lib/prov\r\nPATH=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/libfabric/bin:/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/bin:/opt/intel/bin:/shared/home/mk/azure-spack/spack/bin:/shared/home/mk/perl5/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/opt/ibutils/bin:/shared/home/mk/.local/bin:/shared/home/mk/bin\r\n_LMFILES_=/shared/home/mk/azure-spack/spack/share/spack/modules/linux-centos7-zen/intel-mpi-2018.4.274-gcc-9.2.0-kwtc2jw\r\nLOADEDMODULES=intel-mpi-2018.4.274-gcc-9.2.0-kwtc2jw\r\nCLASSPATH=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi/intel64/lib/mpi.jar\r\nI_MPI_ROOT=/opt/intel/compilers_and_libraries_2019.5.281/linux/mpi\r\n```\r\n\r\n",
    "performed_via_github_app": null
}