{
    "url": "https://api.github.com/repos/spack/spack/issues/15670",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/15670/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/15670/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/15670/events",
    "html_url": "https://github.com/spack/spack/issues/15670",
    "id": 587438707,
    "node_id": "MDU6SXNzdWU1ODc0Mzg3MDc=",
    "number": 15670,
    "title": "Installation issue: petsc with intel-mkl~shared",
    "user": {
        "login": "he-b",
        "id": 10837193,
        "node_id": "MDQ6VXNlcjEwODM3MTkz",
        "avatar_url": "https://avatars.githubusercontent.com/u/10837193?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/he-b",
        "html_url": "https://github.com/he-b",
        "followers_url": "https://api.github.com/users/he-b/followers",
        "following_url": "https://api.github.com/users/he-b/following{/other_user}",
        "gists_url": "https://api.github.com/users/he-b/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/he-b/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/he-b/subscriptions",
        "organizations_url": "https://api.github.com/users/he-b/orgs",
        "repos_url": "https://api.github.com/users/he-b/repos",
        "events_url": "https://api.github.com/users/he-b/events{/privacy}",
        "received_events_url": "https://api.github.com/users/he-b/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2020-03-25T04:45:03Z",
    "updated_at": "2020-03-25T04:45:03Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "<!--*Thanks for taking the time to report this build failure. To proceed with the\r\nreport please:*\r\n1. Title the issue \"Installation issue: <name-of-the-package>\".\r\n2. Provide the information required below.\r\n\r\nWe encourage you to try, as much as possible, to reduce your problem to the minimal example that still reproduces the issue. That would help us a lot in fixing it quickly and effectively!\r\n-->\r\nHi Spack Experts!\r\n\r\nThanks for such a nice tool!\r\n\r\nHere is the info requested:\r\n\r\n### Spack version\r\n<!-- Add the output to the command below -->\r\n```console\r\n$ spack --version\r\n0.14.1-344-1a5e4232e\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack spec petsc\r\nInput spec\r\n--------------------------------\r\npetsc\r\n\r\nConcretized\r\n--------------------------------\r\npetsc@3.12.4%gcc@9.2.0~X~batch clanguage=C ~complex+debug+double~fftw~hdf5+hypre~int64~knl+metis+mpi~mumps~shared~suite-sparse~superlu-dist~trilinos+valgrind arch=linux-archrolling-zen\r\n    ^hypre@2.18.2%gcc@9.2.0~complex~debug~int64~internal-superlu~mixedint+mpi~openmp~shared~superlu-dist arch=linux-archrolling-zen\r\n        ^intel-mkl@2020.0.166%gcc@9.2.0~ilp64~shared threads=none arch=linux-archrolling-zen\r\n            ^cpio@2.13%gcc@9.2.0 arch=linux-archrolling-zen\r\n        ^openmpi@4.0.2%gcc@9.2.0~cuda+cxx_exceptions fabrics=none ~java~legacylaunchers~memchecker patches=073477a76bba780c67c36e959cd3ee6910743e2735c7e76850ffba6791d498e4 ~pmi schedulers=none ~sqlite3~thread_multiple+vt arch=linux-archrolling-zen\r\n            ^hwloc@1.11.11%gcc@9.2.0~cairo~cuda~gl+libxml2~nvml+pci+shared arch=linux-archrolling-zen\r\n                ^libpciaccess@0.13.5%gcc@9.2.0 arch=linux-archrolling-zen\r\n                    ^libtool@2.4.6%gcc@9.2.0 arch=linux-archrolling-zen\r\n                        ^m4@1.4.18%gcc@9.2.0 patches=3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00,fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8 +sigsegv arch=linux-archrolling-zen\r\n                            ^libsigsegv@2.12%gcc@9.2.0 arch=linux-archrolling-zen\r\n                    ^pkgconf@1.6.3%gcc@9.2.0 arch=linux-archrolling-zen\r\n                    ^util-macros@1.19.1%gcc@9.2.0 arch=linux-archrolling-zen\r\n                ^libxml2@2.9.9%gcc@9.2.0~python arch=linux-archrolling-zen\r\n                    ^libiconv@1.16%gcc@9.2.0 arch=linux-archrolling-zen\r\n                    ^xz@5.2.4%gcc@9.2.0 arch=linux-archrolling-zen\r\n                    ^zlib@1.2.11%gcc@9.2.0+optimize+pic+shared arch=linux-archrolling-zen\r\n                ^numactl@2.0.12%gcc@9.2.0 arch=linux-archrolling-zen\r\n                    ^autoconf@2.69%gcc@9.2.0 arch=linux-archrolling-zen\r\n                        ^perl@5.30.1%gcc@9.2.0+cpanm+shared+threads arch=linux-archrolling-zen\r\n                            ^gdbm@1.18.1%gcc@9.2.0 arch=linux-archrolling-zen\r\n                                ^readline@8.0%gcc@9.2.0 arch=linux-archrolling-zen\r\n                                    ^ncurses@6.2%gcc@9.2.0~symlinks+termlib arch=linux-archrolling-zen\r\n                    ^automake@1.16.2%gcc@9.2.0 arch=linux-archrolling-zen\r\n    ^metis@5.1.0%gcc@9.2.0 build_type=Release ~gdb~int64 patches=4991da938c1d3a1d3dea78e49bbebecba00273f98df2a656e38b83d55b281da1,b1225da886605ea558db7ac08dd8054742ea5afe5ed61ad4d0fe7a495b1270d2 ~real64~shared arch=linux-archrolling-zen\r\n        ^cmake@3.16.5%gcc@9.2.0~doc+ncurses+openssl+ownlibs~qt arch=linux-archrolling-zen\r\n            ^openssl@1.1.1e%gcc@9.2.0+systemcerts arch=linux-archrolling-zen\r\n    ^parmetis@4.0.3%gcc@9.2.0 build_type=RelWithDebInfo ~gdb patches=4f892531eb0a807eb1b82e683a416d3e35154a455274cf9b162fb02054d11a5b,50ed2081bc939269689789942067c58b3e522c269269a430d5d34c00edbc5870,704b84f7c7444d4372cb59cca6e1209df4ef3b033bc4ee3cf50f369bce972a9d ~shared arch=linux-archrolling-zen\r\n    ^python@2.7.17%gcc@9.2.0+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4~uuid+zlib arch=linux-archrolling-zen\r\n    ^valgrind@3.15.0%gcc@9.2.0+boost+mpi+only64bit+ubsan arch=linux-archrolling-zen\r\n        ^boost@1.72.0%gcc@9.2.0+atomic+chrono~clanglibcpp~container~context~coroutine cxxstd=98 +date_time~debug+exception~fiber+filesystem+graph~icu+iostreams+locale+log+math~mpi+multithreaded~numpy~pic+program_options~python+random+regex+serialization+shared+signals~singlethreaded+system~taggedlayout+test+thread+timer~versionedlayout visibility=hidden +wave arch=linux-archrolling-zen\r\n            ^bzip2@1.0.8%gcc@9.2.0+shared arch=linux-archrolling-zen\r\n                ^diffutils@3.7%gcc@9.2.0 arch=linux-archrolling-zen\r\n```\r\nOutput from `spack-build-out.txt`\r\n```\r\nTESTING: checkDependencies from config.packages.BlasLapack(/tmp/hector/spack-stage/spack-stage-petsc-3.12.4-xtxv54xqoxn5h6ywakwjq5eoreckxodu/spack-src/config/BuildSystem/config/package.py:834)\r\nTESTING: configureLibrary from config.packages.BlasLapack(/tmp/hector/spack-stage/spack-stage-petsc-3.12.4-xtxv54xqoxn5h6ywakwjq5eoreckxodu/spack-src/config/BuildSystem/config/packages/BlasLapack.py:451)\r\nTESTING: checkLib from config.packages.BlasLapack(/tmp/hector/spack-stage/spack-stage-petsc-3.12.4-xtxv54xqoxn5h6ywakwjq5eoreckxodu/spack-src/config/BuildSystem/config/packages/BlasLapack.py:120)\r\n*******************************************************************************\r\n         UNABLE to CONFIGURE with GIVEN OPTIONS    (see configure.log for details):\r\n-------------------------------------------------------------------------------\r\nYou set a value for --with-blaslapack-lib=<lib>, but ['/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64/libmkl_intel_lp64.a', '/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64/libmkl_sequential.a', '/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64/libmkl_core.a', '/lib64/libpthread.a', '/lib64/libm.a', '/lib64/libdl.a'] cannot be used\r\n*******************************************************************************\r\n```\r\nThe problem is that `intel-mkl` is adding non-necessary system libraries (from `petsc` `configure.log`):\r\n\r\n```\r\n/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/openmpi-4.0.2-kqq3t5uljzbtyfgim3mtniscgugt6e3b/bin/mpicc  -o /tmp/petsc-gy_F60/config.libraries/conftest    -g3 /tmp/petsc-gy_F60/config.libraries/conftest.o  -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64 -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64 -lmkl_intel_lp64 -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64 -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64 -lmkl_sequential -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64 -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/intel-mkl-2020.0.166-32l2kwuqgh2je3schhvfz27w7yeulfl7/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64 -lmkl_core /lib64/libpthread.a /lib64/libm.a /lib64/libdl.a -lm -lstdc++ -ldl -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/hwloc-1.11.11-mg5iga6qg6xhevgdqkb2xribfpi5a6zh/lib -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/zlib-1.2.11-2gu5xaflkhb3vxz5k2v2aoyduixaywdp/lib -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/openmpi-4.0.2-kqq3t5uljzbtyfgim3mtniscgugt6e3b/lib -lmpi_usempif08 -lmpi_usempi_ignore_tkr -lmpi_mpifh -lmpi -lgfortran -lm -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.3.0/gcc-9.2.0-ykr4pyenctsqf6jxfpdsbicv3toleq5g/lib:/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.3.0/gcc-9.2.0-ykr4pyenctsqf6jxfpdsbicv3toleq5g/lib64 -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.3.0/gcc-9.2.0-ykr4pyenctsqf6jxfpdsbicv3toleq5g/lib/gcc/x86_64-pc-linux-gnu/9.2.0 -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.3.0/gcc-9.2.0-ykr4pyenctsqf6jxfpdsbicv3toleq5g/lib64 -L/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.3.0/gcc-9.2.0-ykr4pyenctsqf6jxfpdsbicv3toleq5g/lib -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/hwloc-1.11.11-mg5iga6qg6xhevgdqkb2xribfpi5a6zh/lib -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/zlib-1.2.11-2gu5xaflkhb3vxz5k2v2aoyduixaywdp/lib -Wl,-rpath,/home/hector/UT/Work/spack/opt/spack/linux-archrolling-zen/gcc-9.2.0/openmpi-4.0.2-kqq3t5uljzbtyfgim3mtniscgugt6e3b/lib -lgfortran -lm -lgcc_s -lquadmath -lpthread -lquadmath -lstdc++ -ldl \r\n\r\n/usr/bin/ld: /usr/lib/libm-2.31.a(s_ceil.o): in function `__ceil_ifunc':\r\n(.text+0x6): undefined reference to `_dl_x86_cpu_features'\r\n/usr/bin/ld: /usr/lib/libm-2.31.a(s_sin.o): in function `__sin_ifunc':\r\n(.text+0x1356): undefined reference to `_dl_x86_cpu_features'\r\n/usr/bin/ld: /usr/lib/libm-2.31.a(s_sin.o): in function `__cos_ifunc':\r\n(.text+0x13b6): undefined reference to `_dl_x86_cpu_features'\r\n/usr/bin/ld: /usr/lib/libm-2.31.a(e_expf.o): in function `__expf_ifunc':\r\n(.text+0x136): undefined reference to `_dl_x86_cpu_features'\r\n/usr/bin/ld: /usr/lib/libm-2.31.a(e_logf.o): in function `__logf_ifunc':\r\n(.text+0x146): undefined reference to `_dl_x86_cpu_features'\r\n/usr/bin/ld: /usr/lib/libm-2.31.a(e_asin.o):(.text+0x2366): more undefined references to `_dl_x86_cpu_features' follow\r\n```\r\n\r\nIf `/lib64/libm.a` is removed from the command, the problem disappears.\r\n\r\n\r\n### Platform and user environment\r\n\r\n<!-- Please report your OS here:\r\n```commandline\r\n$ uname -a \r\nLinux nuvolari 4.15.0-29-generic #31-Ubuntu SMP Tue Jul 17 15:39:52 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n$ lsb_release -d\r\nDescription:\tUbuntu 18.04.1 LTS\r\n``` \r\nand, if relevant, post or attach:\r\n\r\n- `packages.yaml`\r\n- `compilers.yaml`\r\n\r\nto the issue\r\n-->\r\n```commandline\r\n$ uname -a \r\nLinux 5.2.0-git #1 SMP PREEMPT Mon Mar 16 13:49:14 CDT 2020 x86_64 GNU/Linux\r\n\r\n$ lsb_release -d\r\nDescription:    Arch Linux\r\n``` \r\n\r\n### Additional information\r\n\r\n<!--Sometimes the issue benefits from additional details. In these cases there are\r\na few things we can suggest doing. First of all, you can post the full output of:\r\n```console\r\n$ spack spec --install-status <spec>\r\n...\r\n```\r\nto show people whether Spack installed a faulty software or if it was not able to\r\nbuild it at all. \r\n\r\nIf your build didn't make it past the configure stage, Spack as also commands to parse \r\nlogs and report error and warning messages:\r\n```console\r\n$ spack log-parse --show=errors,warnings <file-to-parse>\r\n```\r\nYou might want to run this command on the `config.log` or any other similar file\r\nfound in the stage directory: \r\n```console\r\n$ spack location -s <spec>\r\n```\r\nIn case in `config.log` there are other settings that you think might be the cause \r\nof the build failure, you can consider attaching the file to this issue.\r\n\r\nRebuilding the package with the following options:\r\n```console\r\n$ spack -d install -j 1 <spec>\r\n...\r\n```\r\nwill provide additional debug information. After the failure you will find two files in the current directory:\r\n\r\n1. `spack-cc-<spec>.in`, which contains details on the command given in input \r\n    to Spack's compiler wrapper  \r\n1. `spack-cc-<spec>.out`, which contains the command used to compile / link the \r\n    failed object after Spack's compiler wrapper did its processing \r\n\r\nYou can post or attach those files to provide maintainers with more information on what\r\nis causing the failure.-->\r\n\r\nContents of `spack.yaml`\r\n```yaml\r\nspack:\r\n  packages:\r\n    openmpi:\r\n      version: [4.0.2]\r\n      target: []\r\n      modules: {}\r\n      compiler: []\r\n      buildable: true\r\n      providers: {}\r\n      paths: {}\r\n    python:\r\n      paths:\r\n        python@2.7.17: /usr/\r\n      buildable: false\r\n    intel-mkl:\r\n      variants: ~shared\r\n      target: []\r\n      modules: {}\r\n      compiler: []\r\n      buildable: true\r\n      version: []\r\n      providers: {}\r\n      paths: {}\r\n   petsc:\r\n      variants: +debug +valgrind ~hdf5 ~shared ~superlu-dist +metis +mpi +hypre\r\n      target: []\r\n      modules: {}\r\n      compiler: []\r\n      buildable: true\r\n      version: []\r\n      providers: {}\r\n      paths: {}\r\n    all:\r\n      compiler: [gcc@9.2.0]\r\n      providers:\r\n        mpi: [openmpi]\r\n        blas: [intel-mkl]\r\n        lapcak: [intel-mkl]\r\n        scalapack: [intel-mkl]\r\n      target: []\r\n      modules: {}\r\n      buildable: true\r\n      version: []\r\n      paths: {}\r\n```\r\n### Workaround\r\nI obtained a workaround by modifying `lib/spack/spack/build_systems/intel.py` as follows:\r\n\r\n```diff\r\ndiff --git a/lib/spack/spack/build_systems/intel.py b/lib/spack/spack/build_systems/intel.py\r\nindex 4017f2e52..77ff2a1b1 100644\r\n--- a/lib/spack/spack/build_systems/intel.py\r\n+++ b/lib/spack/spack/build_systems/intel.py\r\n@@ -791,6 +791,8 @@ def blas_libs(self):\r\n         system_libs = find_system_libraries(\r\n             'libpthread libm libdl'.split(),\r\n             shared=('+shared' in self.spec))\r\n+        if '-shared' in self.spec:\r\n+            system_libs = ''\r\n         debug_print(system_libs)\r\n \r\n         return mkl_libs + threading_engine_libs + system_libs\r\n```\r\n\r\n### General information\r\n\r\n- [x] I have run `spack --version` and reported the version of Spack\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n\r\n\r\nThanks for your help!",
    "performed_via_github_app": null
}