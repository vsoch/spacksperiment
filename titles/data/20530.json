{
    "url": "https://api.github.com/repos/spack/spack/issues/20530",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/20530/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/20530/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/20530/events",
    "html_url": "https://github.com/spack/spack/issues/20530",
    "id": 773637709,
    "node_id": "MDU6SXNzdWU3NzM2Mzc3MDk=",
    "number": 20530,
    "title": "enable spack core code to depend on the output of a spack build",
    "user": {
        "login": "cosmicexplorer",
        "id": 1305167,
        "node_id": "MDQ6VXNlcjEzMDUxNjc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1305167?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/cosmicexplorer",
        "html_url": "https://github.com/cosmicexplorer",
        "followers_url": "https://api.github.com/users/cosmicexplorer/followers",
        "following_url": "https://api.github.com/users/cosmicexplorer/following{/other_user}",
        "gists_url": "https://api.github.com/users/cosmicexplorer/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/cosmicexplorer/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cosmicexplorer/subscriptions",
        "organizations_url": "https://api.github.com/users/cosmicexplorer/orgs",
        "repos_url": "https://api.github.com/users/cosmicexplorer/repos",
        "events_url": "https://api.github.com/users/cosmicexplorer/events{/privacy}",
        "received_events_url": "https://api.github.com/users/cosmicexplorer/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2542559486,
            "node_id": "MDU6TGFiZWwyNTQyNTU5NDg2",
            "url": "https://api.github.com/repos/spack/spack/labels/bootstrap",
            "name": "bootstrap",
            "color": "743ec4",
            "default": false,
            "description": "Issues occurring while spack builds its own dependencies."
        },
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1445245539,
            "node_id": "MDU6TGFiZWwxNDQ1MjQ1NTM5",
            "url": "https://api.github.com/repos/spack/spack/labels/build",
            "name": "build",
            "color": "a83f25",
            "default": false,
            "description": "General build capability"
        },
        {
            "id": 446645732,
            "node_id": "MDU6TGFiZWw0NDY2NDU3MzI=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-environment",
            "name": "build-environment",
            "color": "bfdadc",
            "default": false,
            "description": null
        },
        {
            "id": 1893105003,
            "node_id": "MDU6TGFiZWwxODkzMTA1MDAz",
            "url": "https://api.github.com/repos/spack/spack/labels/concretizer-use-case",
            "name": "concretizer-use-case",
            "color": "1d76db",
            "default": false,
            "description": "interesting dependency hierarchy that would challenge the current concretizer"
        },
        {
            "id": 73908756,
            "node_id": "MDU6TGFiZWw3MzkwODc1Ng==",
            "url": "https://api.github.com/repos/spack/spack/labels/feature",
            "name": "feature",
            "color": "84b6eb",
            "default": false,
            "description": null
        },
        {
            "id": 1029761810,
            "node_id": "MDU6TGFiZWwxMDI5NzYxODEw",
            "url": "https://api.github.com/repos/spack/spack/labels/vendored-dependencies",
            "name": "vendored-dependencies",
            "color": "b1fc49",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2020-12-23T10:04:50Z",
    "updated_at": "2020-12-27T04:04:58Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "<!--*Please add a concise summary of your suggestion here.*-->\r\n\r\nSpack doesn't seem to have a concept of \"detecting\" or \"installing\" binaries (like `xz`) that it assumes are available on the PATH in the interstitial code that runs before and after package build steps. This means that it fails with very opaque error messages in situations that Spack itself can fix!\r\n\r\nThis ticket would likely be a good prequel to #20523, because this ticket focuses more on fixing a weird inconsistency than trying to develop an alternative model for types of dependencies as in #20523.\r\n\r\n### Rationale\r\n\r\nSpack isn't currently able to detect that it needs to build `xz` when pulling down a `.tar.xz` package if it's being run on e.g. a bare centos6. On our `spack/centos6` container, I can get the following error message (for a different missing executable: `bzip2`), which is remarkably opaque if you haven't seen it before:\r\n```bash\r\n> spack --debug --stacktrace install -y -n --fail-fast -j 12 --verbose nim@0.20.0\r\n...\r\nlib/spack/spack/fetch_strategy.py:336 ==> [2020-12-22-02:28:58.024604] Fetching https://spack-llnl-mirror.s3-us-west-2.amazonaws.com/_source-cache/archive/19/19108658b23b3ec5058edc9f66ac545ea19f9537234be1ec62b714c84399366d.tar.bz2\r\nlib/spack/spack/util/executable.py:162 ==> [2020-12-22-02:28:58.025649] '/usr/bin/curl' '-C' '-' '-o' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2.part' '-f' '-D' '-' '-L' 'https://spack-llnl-mirror.s3-us-west-2.amazonaws.com/_source-cache/archive/19/19108658b23b3ec5058edc9f66ac545ea19f9537234be1ec62b714c84399366d.tar.bz2' '-#' '--connect-timeout' '10'\r\n######################################################################## 100.0%\r\nlib/spack/spack/fetch_strategy.py:445 ==> [2020-12-22-02:28:58.665538] Staging archive: /tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2\r\nlib/spack/spack/util/executable.py:162 ==> [2020-12-22-02:28:58.668826] '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\ntar (child): lbzip2: Cannot exec: No such file or directory\r\ntar (child): Error is not recoverable: exiting now\r\n/usr/bin/tar: Child returned status 2\r\n/usr/bin/tar: Error is not recoverable: exiting now\r\nlib/spack/spack/error.py:55 ==> [2020-12-22-02:28:58.688234] Error: ProcessError: Command exited with status 2:\r\n    '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\nTraceback (most recent call last):\r\n  File \"/h/tools/spack/lib/spack/spack/build_environment.py\", line 851, in _setup_pkg_and_run\r\n    return_value = function(pkg, kwargs)\r\n  File \"/h/tools/spack/lib/spack/spack/installer.py\", line 1641, in build_process\r\n    pkg.do_patch()\r\n  File \"/h/tools/spack/lib/spack/spack/package.py\", line 1368, in do_patch\r\n    self.do_stage()\r\n  File \"/h/tools/spack/lib/spack/spack/package.py\", line 1354, in do_stage\r\n    self.stage.expand_archive()\r\n  File \"/h/tools/spack/lib/spack/spack/util/pattern.py\", line 18, in __call__\r\n    for item in self.container]\r\n  File \"/h/tools/spack/lib/spack/spack/stage.py\", line 590, in expand_archive\r\n    self.fetcher.expand()\r\n  File \"/h/tools/spack/lib/spack/spack/fetch_strategy.py\", line 72, in wrapper\r\n    return fun(self, *args, **kwargs)\r\n  File \"/h/tools/spack/lib/spack/spack/fetch_strategy.py\", line 468, in expand\r\n    decompress(self.archive_file)\r\n  File \"/h/tools/spack/lib/spack/spack/util/executable.py\", line 198, in __call__\r\n    proc.returncode, long_msg)\r\nProcessError: Command exited with status 2:\r\n    '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\nlib/spack/spack/installer.py:1301 ==> [2020-12-22-02:28:58.689396] Flagging pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff as failed: ProcessError: Command exited with status 2:\r\n    '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\nlib/spack/spack/installer.py:1311 ==> [2020-12-22-02:28:58.694483] Warning: Skipping build of nim-0.20.0-wb5pmjyo7qxcdcqcisch2d3hd6tjgt3u since pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff failed\r\nlib/spack/spack/installer.py:1301 ==> [2020-12-22-02:28:58.694691] Flagging nim-0.20.0-wb5pmjyo7qxcdcqcisch2d3hd6tjgt3u as failed\r\nlib/spack/spack/main.py:765 ==> [2020-12-22-02:28:58.708811] InstallError: Terminating after first install failure: ProcessError: Command exited with status 2:\r\n    '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\nlib/spack/spack/error.py:55 ==> [2020-12-22-02:28:58.709064] Error: Terminating after first install failure: ProcessError: Command exited with status 2:\r\n    '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\nTraceback (most recent call last):\r\n  File \"/h/tools/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/h/tools/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/h/tools/spack/lib/spack/spack/cmd/install.py\", line 371, in install\r\n    install_specs(args, kwargs, zip(abstract_specs, specs))\r\n  File \"/h/tools/spack/lib/spack/spack/cmd/install.py\", line 213, in install_specs\r\n    builder.install()\r\n  File \"/h/tools/spack/lib/spack/spack/installer.py\", line 1582, in install\r\n    .format(fail_fast_err, str(exc)))\r\nspack.installer.InstallError: Terminating after first install failure: ProcessError: Command exited with status 2:\r\n    '/usr/bin/tar' '-oxf' '/tmp/root/spack-stage/spack-stage-pcre-8.44-aek3wkf4dpptjoxzc5x456w4naiaggff/pcre-8.44.tar.bz2'\r\n```\r\n\r\n<!--*Is your feature request related to a problem? Please describe it!*-->\r\n\r\n### Description\r\n\r\n<!--*Describe the solution you'd like and the alternatives you have considered.*-->\r\n\r\nChronologically, this is how I approached the issue:\r\n1. *problem:* spack seems to require several unannounced dependencies that screwed me up when i had a working empty centos6, most notably `git`, `xz`, `bz2`, `gcc{,-c++}`, `python{,-devel}`, a couple more? -- i am pretty sure it failed on `make` because `make` wasn't a high enough version.\r\n2. *partial solution:* in that case, i was able to install `git` and then use spack to install the rest.\r\n3. *proposal:* i would _like_ to say **\"why can't we make spack automagically install each dependency it uses itself?\"**\r\n\r\n# Implementation\r\n\r\nImplementing this might take the form of:\r\n1. Determine all of spack's *actual* required dependencies from a centos 6 machine by running it until it succeeds.\r\n    - Use a special wrapper method when invoking a subprocess anywhere in spack core code.\r\n2. Determine whether to:\r\n    - add a check to `setup-env.sh` which may run another spack instance?\r\n    - add those tools to some sort of bootstrap image as per #20123 and/or #20430?",
    "performed_via_github_app": null
}