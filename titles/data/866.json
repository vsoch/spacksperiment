{
    "url": "https://api.github.com/repos/spack/spack/issues/866",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/866/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/866/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/866/events",
    "html_url": "https://github.com/spack/spack/pull/866",
    "id": 151847784,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NjgzNTkyOTk=",
    "number": 866,
    "title": "feature : finer locking of the db",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 17,
    "created_at": "2016-04-29T11:43:05Z",
    "updated_at": "2016-08-19T21:37:22Z",
    "closed_at": "2016-08-19T16:18:59Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/866",
        "html_url": "https://github.com/spack/spack/pull/866",
        "diff_url": "https://github.com/spack/spack/pull/866.diff",
        "patch_url": "https://github.com/spack/spack/pull/866.patch"
    },
    "body": "##### Modifications\n- [x] removed global db locks from `install`, `uninstall` and `diy`\n- [x] added lock for stage directory (an exclusive lock is taken as part of the `Stage` context manager)\n- [x] added lock for prefix directory (an exclusive lock is taken during `Package.do_install`)\n- [x] debug output shows locks acquire and release\n##### Install and uninstall are not mutually exclusive\n\nThis means that if : \n\n```\nspack uninstall ...\n```\n\nis run concurrently with \n\n```\nspack install ...\n```\n\nthe former command may cause the latter to fail (the same way an administrator can `sudo rm ...` something that another admin is about to use)\n##### Debug output shows acquire and release\n\n```\n$ spack -d install  python@3:\n==> Reading config file /home/mculpo/.spack/compilers.yaml\n==> TOUCH FILE : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2 [Acquiring]\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2 [Released]\n==> Installing python\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/bzip2-1.0.6-i6a7grcnt5wwn6i3rjh2al25ypwtlyhz [Acquiring]\n==> bzip2 is already installed in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/bzip2-1.0.6-i6a7grcnt5wwn6i3rjh2al25ypwtlyhz\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/bzip2-1.0.6-i6a7grcnt5wwn6i3rjh2al25ypwtlyhz [Released]\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/ncurses-6.0-faybomf54bbh376q54ztgfsrqxa7vavk [Acquiring]\n==> ncurses is already installed in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/ncurses-6.0-faybomf54bbh376q54ztgfsrqxa7vavk\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/ncurses-6.0-faybomf54bbh376q54ztgfsrqxa7vavk [Released]\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/zlib-1.2.8-rv427lhuk7qeq5fh67f36dxq3z22bpu4 [Acquiring]\n==> zlib is already installed in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/zlib-1.2.8-rv427lhuk7qeq5fh67f36dxq3z22bpu4\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/zlib-1.2.8-rv427lhuk7qeq5fh67f36dxq3z22bpu4 [Released]\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/openssl-1.0.2h-d7ykxud2ghnusqhwdzagnpx7inboix75 [Acquiring]\n==> openssl is already installed in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/openssl-1.0.2h-d7ykxud2ghnusqhwdzagnpx7inboix75\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/openssl-1.0.2h-d7ykxud2ghnusqhwdzagnpx7inboix75 [Released]\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/sqlite-3.8.5-5ivjx67knpt477vxen6p6xc73fdq22na [Acquiring]\n==> sqlite is already installed in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/sqlite-3.8.5-5ivjx67knpt477vxen6p6xc73fdq22na\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/sqlite-3.8.5-5ivjx67knpt477vxen6p6xc73fdq22na [Released]\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/readline-6.3-ie3abif7kh64o7it4lntlcj2wkygqxvf [Acquiring]\n==> readline is already installed in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/readline-6.3-ie3abif7kh64o7it4lntlcj2wkygqxvf\n==> READ LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/readline-6.3-ie3abif7kh64o7it4lntlcj2wkygqxvf [Released]\n==> Reading config file /home/mculpo/.spack/mirrors.yaml\n==> Trying to fetch from file:///home/mculpo/production/spack-mirror/python/python-3.5.1.tgz\n==> /usr/bin/curl -C - -o /home/mculpo/PycharmProjects/spack/var/spack/stage/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/python-3.5.1.tgz.part -f -D - -L file:///home/mculpo/production/spack-mirror/python/python-3.5.1.tgz -#\n######################################################################## 100,0%\n==> Staging archive: /home/mculpo/PycharmProjects/spack/var/spack/stage/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/python-3.5.1.tgz\n==> /bin/tar -xf /home/mculpo/PycharmProjects/spack/var/spack/stage/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/python-3.5.1.tgz\n==> Created stage in /home/mculpo/PycharmProjects/spack/var/spack/stage/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2\n==> No patches needed for python\n==> Building python\n==> WRITE LOCK : /home/mculpo/PycharmProjects/spack/var/spack/stage/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2.lock [Acquiring]\n==> WRITE LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2 [Acquiring]\n==> Installing /tmp/mculpo/spack-stage/spack-stage-_bO_kd/Python-3.5.1/spack-build.out to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/build.out\n==> Installing /tmp/mculpo/spack-stage/spack-stage-_bO_kd/Python-3.5.1/spack-build.env to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/build.env\n==> Installing /home/mculpo/PycharmProjects/spack/var/spack/repos/builtin/packages/python/package.py to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/python\n==> Installing /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/bzip2-1.0.6-i6a7grcnt5wwn6i3rjh2al25ypwtlyhz/.spack/repos/builtin/packages/bzip2 to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/bzip2\n==> Installing /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/ncurses-6.0-faybomf54bbh376q54ztgfsrqxa7vavk/.spack/repos/builtin/packages/ncurses to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/ncurses\n==> Installing /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/openssl-1.0.2h-d7ykxud2ghnusqhwdzagnpx7inboix75/.spack/repos/builtin/packages/openssl to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/openssl\n==> Installing /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/zlib-1.2.8-rv427lhuk7qeq5fh67f36dxq3z22bpu4/.spack/repos/builtin/packages/zlib to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/zlib\n==> Installing /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/readline-6.3-ie3abif7kh64o7it4lntlcj2wkygqxvf/.spack/repos/builtin/packages/readline to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/readline\n==> Installing /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/sqlite-3.8.5-5ivjx67knpt477vxen6p6xc73fdq22na/.spack/repos/builtin/packages/sqlite to /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/.spack/repos/builtin/packages/sqlite\n==> Warning: Patched overly long shebang in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/bin/idle3.5\n==> Warning: Patched overly long shebang in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/bin/pyvenv-3.5\n==> Warning: Patched overly long shebang in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/bin/pydoc3.5\n==> Warning: Patched overly long shebang in /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2/bin/2to3-3.5\n==> WRITE LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/.locks/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2 [Released]\n==> WRITE LOCK : /home/mculpo/PycharmProjects/spack/var/spack/stage/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2.lock [Released]\n==> Successfully installed python\n  Fetch: 0.06s.  Build: 2m 33.03s.  Total: 2m 33.08s.\n[+] /home/mculpo/PycharmProjects/spack/opt/spack/linux-x86_64/gcc-6.1.0/python-3.5.1-wxwrgojeiacr4ckh3jnrqrsi4o5a7jg2\n==> WRITE LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/.spack-db/lock [Acquiring]\n==> WRITE LOCK : /home/mculpo/PycharmProjects/spack/opt/spack/.spack-db/lock [Released]\n```\n\n---\n\n@tgamblin @adamjstewart @hegner As we need this with high priority, and there's much request for this feature (see #636), I thought it was better to share what I am doing early in the development to avoid duplicate work.\n",
    "performed_via_github_app": null
}