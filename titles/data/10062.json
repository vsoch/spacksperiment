{
    "url": "https://api.github.com/repos/spack/spack/issues/10062",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/10062/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/10062/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/10062/events",
    "html_url": "https://github.com/spack/spack/issues/10062",
    "id": 388910548,
    "node_id": "MDU6SXNzdWUzODg5MTA1NDg=",
    "number": 10062,
    "title": "Issue with buildcache and intel package (symlinks)",
    "user": {
        "login": "pramodk",
        "id": 666852,
        "node_id": "MDQ6VXNlcjY2Njg1Mg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/666852?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pramodk",
        "html_url": "https://github.com/pramodk",
        "followers_url": "https://api.github.com/users/pramodk/followers",
        "following_url": "https://api.github.com/users/pramodk/following{/other_user}",
        "gists_url": "https://api.github.com/users/pramodk/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/pramodk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/pramodk/subscriptions",
        "organizations_url": "https://api.github.com/users/pramodk/orgs",
        "repos_url": "https://api.github.com/users/pramodk/repos",
        "events_url": "https://api.github.com/users/pramodk/events{/privacy}",
        "received_events_url": "https://api.github.com/users/pramodk/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 759411369,
            "node_id": "MDU6TGFiZWw3NTk0MTEzNjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/buildcache",
            "name": "buildcache",
            "color": "bf354c",
            "default": false,
            "description": null
        },
        {
            "id": 477156668,
            "node_id": "MDU6TGFiZWw0NzcxNTY2Njg=",
            "url": "https://api.github.com/repos/spack/spack/labels/intel",
            "name": "intel",
            "color": "127cc1",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2018-12-08T10:48:00Z",
    "updated_at": "2020-02-24T14:28:47Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "While using intel package installed via buildcache, I see : \r\n\r\n```\r\n$ /gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/bin/icc --vers\r\nion\r\n/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/bin/icc: error while loading shared libraries: libintelremotemon.so: cannot open shared object file: No such file or directory\r\n```\r\n\r\nHere is what happening : \r\n\r\nIntel compiler package has (many) symlinks:\r\n\r\n```\r\n$ ll /gpfs/bbp.cscs.ch/apps/compilers/install/intel-18.0.1/bin\r\ntotal 64\r\ndrwxrwxr-x+  2 kumbhar bbp  4096 Aug 14 15:38 ./\r\ndrwxrwxr-x+ 11 kumbhar bbp 32768 Aug 14 15:38 ../\r\nlrwxrwxrwx   1 kumbhar bbp    57 Aug 14 15:38 codecov -> ../compilers_and_libraries_2018/linux/bin/intel64/codecov*\r\nlrwxrwxrwx   1 kumbhar bbp    58 Aug 14 15:38 compilervars.csh -> ../compilers_and_libraries_2018/linux/bin/compilervars.csh*\r\nlrwxrwxrwx   1 kumbhar bbp    57 Aug 14 15:38 compilervars.sh -> ../compilers_and_libraries_2018/linux/bin/compilervars.sh*\r\nlrwxrwxrwx   1 kumbhar bbp    53 Aug 14 15:38 fpp -> ../compilers_and_libraries_2018/linux/bin/intel64/fpp*\r\nlrwxrwxrwx   1 kumbhar bbp    53 Aug 14 15:38 icc -> ../compilers_and_libraries_2018/linux/bin/intel64/icc*\r\n```\r\n\r\nThe `bin` directory itself has `.so` files:\r\n\r\n```\r\n$ ll /gpfs/bbp.cscs.ch/apps/compilers/install/intel-18.0.1/compilers_and_libraries_2018.1.163/linux/bin/intel64/\r\ntotal 128960\r\ndrwxr-xr-x+ 2 kumbhar bbp     4096 Sep 26 21:54 ./\r\n.....\r\n-rwxr-xr-x+ 1 kumbhar bbp  4009096 Aug 14 15:38 icc*\r\n-rwxr-xr-x+ 1 kumbhar bbp   315667 Aug 14 15:38 libcilkrts.so.5*\r\n-rwxr-xr-x+ 1 kumbhar bbp  1915896 Aug 14 15:38 libintelremotemon.so*\r\n```\r\n\r\nThe compiler binary has RPATH entry as:\r\n\r\n```\r\n$ objdump -x /gpfs/bbp.cscs.ch/apps/compilers/install/intel-18.0.1/bin/icc | grep RPATH\r\n  RPATH                $ORIGIN\r\n```\r\n\r\nwhich helps to link those libraries : \r\n\r\n```\r\n$ ldd /gpfs/bbp.cscs.ch/apps/compilers/install/intel-18.0.1/compilers_and_libraries_2018.1.163/linux/bin/intel64/icc\r\n\tlinux-vdso.so.1 =>  (0x00007fffedb05000)\r\n\tlibintelremotemon.so => /gpfs/bbp.cscs.ch/apps/compilers/install/intel-18.0.1/compilers_and_libraries_2018.1.163/linux/bin/intel64/libintelremotemon.so (0x00007fffed730000)\r\n\tlibdl.so.2 => /usr/lib64/libdl.so.2 (0x00007fffed4f7000)\r\n```  \r\n\r\nBut when we create buildcache tarball, the symlinks are replaced with actual content:\r\n\r\n```\r\n$ ll intel-18.0.3-kwbptw7qxxylgkaoj5nm4cmn2nfwq4hw/bin/\r\ntotal 29184\r\ndrwxr-x---+  2 kumbhar bbp    4096 Dec  8 11:14 ./\r\ndrwxr-x---+ 22 kumbhar bbp    4096 Dec  8 11:14 ../\r\n-rwxr-x---+  1 kumbhar bbp 1929456 Dec  8 11:14 codecov*\r\n-rwxr-x---+  1 kumbhar bbp    5157 Dec  8 11:14 compilervars.csh*\r\n-rwxr-x---+  1 kumbhar bbp    4830 Dec  8 11:14 compilervars.sh*\r\n-rwxr-x---+  1 kumbhar bbp 1736696 Dec  8 11:14 fpp*\r\n-rwxr-x---+  1 kumbhar bbp 4026824 Dec  8 11:14 icc*\r\n-rwxr-x---+  1 kumbhar bbp    5157 Dec  8 11:14 iccvars.csh*\r\n-rwxr-x---+  1 kumbhar bbp    4830 Dec  8 11:14 iccvars.sh*\r\n-rwxr-x---+  1 kumbhar bbp 4026824 Dec  8 11:14 icpc*\r\n```\r\nand then if we try to use `icc`, we don't have `libintelremotemon.so` in `$ORIGIN`.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install intel@18.0.3 %gcc\r\n$ spack buildcache create -r -d home intel@18.0.3 %gcc\r\n$ tar -xvf home/build_cache/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3/linux-rhel7-x86_64-gcc-4.8.5-intel-18.0.3-kwbptw7qxxylgkaoj5nm4cmn2nfwq4hw.spack\r\n$ tar -xvzf linux-rhel7-x86_64-gcc-4.8.5-intel-18.0.3-kwbptw7qxxylgkaoj5nm4cmn2nfwq4hw.tar.gz\r\n$ intel-18.0.3-kwbptw7qxxylgkaoj5nm4cmn2nfwq4hw/bin/icc\r\nintel-18.0.3-kwbptw7qxxylgkaoj5nm4cmn2nfwq4hw/bin/icc: error while loading shared libraries: libintelremotemon.so: cannot open shared object file: No such file or directory\r\n```\r\n\r\nI wonder if its safe to preserve relative symlinks within the install prefix in buildcache.\r\n\r\nAlso, note that the module file generated is different : \r\n\r\n```\r\n# 1999-10-01 is built from buildcahce while 1999-10-02 from source\r\n\r\n$ diff /gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/modules/tcl/linux-rhel7-x86_64/intel/18.0.3 /gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/modules/tcl/linux-rhel7-x86_64/intel/18.0.3\r\n2c2\r\n< ## Module file created by spack (https://github.com/spack/spack) on 2018-12-08 08:47:50.902149\r\n---\r\n> ## Module file created by spack (https://github.com/spack/spack) on 2018-12-08 09:42:46.868419\r\n15,21c15,24\r\n< prepend-path PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/bin\"\r\n< prepend-path MANPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/man\"\r\n< prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/lib\"\r\n< prepend-path CMAKE_PREFIX_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/\"\r\n< prepend-path CLASSPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/intel64/lib/mpi.jar\"\r\n< setenv I_MPI_ROOT \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi\"\r\n< setenv PSTLROOT \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/pstl\"\r\n---\r\n> prepend-path PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/bin\"\r\n> prepend-path MANPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/man\"\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/lib\"\r\n> prepend-path CMAKE_PREFIX_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/\"\r\n> prepend-path CLASSPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/intel64/lib/mpi.jar\"\r\n> prepend-path INTEL_LICENSE_FILE \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/licenses:/opt/intel/licenses:/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/data/intel/licenses\"\r\n> setenv I_MPI_ROOT \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi\"\r\n> prepend-path NLSPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64/locale/%l_%t/%N\"\r\n> setenv PSTLROOT \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/pstl\"\r\n> setenv TBBROOT \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/tbb\"\r\n24,25c27,32\r\n< prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/mic/lib\"\r\n< prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/intel64/lib\"\r\n---\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/tbb/lib/intel64/gcc4.7\"\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/tbb/lib/intel64/gcc4.7\"\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/mic/lib\"\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/intel64/lib\"\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64_lin\"\r\n> prepend-path LD_LIBRARY_PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64\"\r\n28c35,36\r\n< prepend-path MANPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/man\"\r\n---\r\n> prepend-path MANPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/man\"\r\n> prepend-path MANPATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/man/common\"\r\n35c43,44\r\n< prepend-path PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-01/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin\"\r\n---\r\n> prepend-path PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin\"\r\n> prepend-path PATH \"/gpfs/bbp.cscs.ch/apps/hpc/test/jenkins/deployment/install/compilers/1999-10-02/linux-rhel7-x86_64/gcc-4.8.5/intel-18.0.3-kwbptw7qxx/compilers_and_libraries_2018.3.222/linux/bin/intel64\"\r\n```\r\n@gartung  : thoughts?\r\n\r\nfyi : @matz-e  ",
    "performed_via_github_app": null
}