{
    "url": "https://api.github.com/repos/spack/spack/issues/17992",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/17992/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/17992/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/17992/events",
    "html_url": "https://github.com/spack/spack/issues/17992",
    "id": 677000192,
    "node_id": "MDU6SXNzdWU2NzcwMDAxOTI=",
    "number": 17992,
    "title": "Included configs in env spack.yaml ignored if basename matches previously included config",
    "user": {
        "login": "payerle",
        "id": 19287807,
        "node_id": "MDQ6VXNlcjE5Mjg3ODA3",
        "avatar_url": "https://avatars.githubusercontent.com/u/19287807?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/payerle",
        "html_url": "https://github.com/payerle",
        "followers_url": "https://api.github.com/users/payerle/followers",
        "following_url": "https://api.github.com/users/payerle/following{/other_user}",
        "gists_url": "https://api.github.com/users/payerle/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/payerle/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/payerle/subscriptions",
        "organizations_url": "https://api.github.com/users/payerle/orgs",
        "repos_url": "https://api.github.com/users/payerle/repos",
        "events_url": "https://api.github.com/users/payerle/events{/privacy}",
        "received_events_url": "https://api.github.com/users/payerle/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446615135,
            "node_id": "MDU6TGFiZWw0NDY2MTUxMzU=",
            "url": "https://api.github.com/repos/spack/spack/labels/configuration",
            "name": "configuration",
            "color": "bfd4f2",
            "default": false,
            "description": null
        },
        {
            "id": 537065486,
            "node_id": "MDU6TGFiZWw1MzcwNjU0ODY=",
            "url": "https://api.github.com/repos/spack/spack/labels/environments",
            "name": "environments",
            "color": "d4c5f9",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2020-08-11T16:01:49Z",
    "updated_at": "2020-09-14T22:00:35Z",
    "closed_at": "2020-09-11T23:45:37Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "When using the include: field inside a spack.yaml for an environment, it appears that if two of the included configurations have the same basename (i.e. same name but in different directories), only the first file with the same basename is \"included\".  I would have expected both to be included.\r\n\r\n### Steps to reproduce the issue\r\n\r\n1) Clone a new spack install, copy *.yaml from ../etc/spack/defaults to ../etc/spack, and create a compilers.yaml with system compiler.\r\n\r\n2) spack env create test\r\n\r\n3) Edit the spack.yaml for the newly created test environment to be\r\n```yaml\r\n# This is a Spack Environment file.\r\n#\r\n# It describes a set of packages to be installed, along with\r\n# configuration settings.\r\nspack:\r\n  # add package specs to the `specs` list\r\n  specs: []\r\n  view: true\r\n  include: \r\n    - /homes/payerle/spacktest/A/test.yaml\r\n    - /homes/payerle/spacktest/B/test.yaml\r\n```\r\n4) Create /homes/payerle/spacktest/A/test.yaml with contents:\r\n```yaml\r\npackages:\r\n  libiconv:\r\n    version: [1.15]\r\n```\r\n5) Create  /homes/payerle/spacktest/B/test.yaml with contents:\r\n```yaml\r\npackages:\r\n  pkg-config:\r\n    version: [0.28]\r\n```\r\n6) Run the following spack spec commands:\r\n6a) spack  spec libiconv\r\nReturns libiconv@1.16 as expected (no env specified, latest version of libiconv)\r\n6b) spack  spec pkg-config\r\nReturns pkg-config@0.29.2 as expected (no env specified, latest version of pkg-config)\r\n6c) spack  --env test spec libiconv\r\nReturns libiconv@1.15 (env test via A/test.yaml says to use 1.15)\r\n6d) spack --env test spec pkg-config\r\nReturns pkg-config@0.29.2\r\nI expect it to return pkg-config@0.28 as is using env test and B/test.yaml says to use 0.28\r\n\r\nIf one reverses the order of the two include lines in spack.yaml for test env (so B precedes A),\r\nthen 6d returns pkg-config@0.28 as expected, but 6c returns libiconv@1.16, not as expected.\r\n\r\nIndeed, if I add the line 'xxx' before the 'packages:' in either A/test.yaml or B/test.yaml (making it\r\nsyntactically invalid), an error is only reported when the invalid test.yaml is first in the include list.\r\nI.e., if using the original order (A/test.yaml then B/test.yaml), adding a syntax error to B/test.yaml\r\ndoes not cause spack to report an error (but adding to A/test.yaml does).  This seems to indicate that the second file is not even being parsed.\r\n\r\nIf I rename B/test.yaml to B/testb.yaml (and change the the include line accordingly), things work as expected (specs of both libiconv and pkg-config return the expected version with the test env).\r\n\r\n\r\n\r\n```console\r\n$ spack <command1> <spec>\r\n$ spack <command2> <spec>\r\n...\r\n```\r\nspack debug report\r\n* **Spack:** 0.15.3-488-313511b\r\n* **Python:** 2.7.5\r\n* **Platform:** linux-rhel7-skylake\r\n\r\n### Additional information\r\n\r\nRunning the command from 6d in debug mode (with the original settings:\r\nA/test.yaml then B/test.yaml in the include list returns:\r\n```console\r\n$ spack  --debug  --env test spec pkg-config\r\n==> [2020-08-11-11:58:43.867071] Imported spec from built-in commands\r\n==> [2020-08-11-11:58:43.867622] Imported spec from built-in commands\r\nInput spec\r\n--------------------------------\r\npkg-config\r\n\r\nConcretized\r\n--------------------------------\r\n==> [2020-08-11-11:58:43.868596] Reading config file /homes/payerle/spacktest/A/test.yaml\r\n==> [2020-08-11-11:58:43.871876] Reading config file /export/data/localhome/home/payerle/git/spack.test/var/spack/environments/test/spack.yaml\r\n==> [2020-08-11-11:58:43.873922] Reading config file /export/data/localhome/home/payerle/git/spack.test/etc/spack/defaults/repos.yaml\r\n==> [2020-08-11-11:58:43.875212] Reading config file /export/data/localhome/home/payerle/git/spack.test/etc/spack/repos.yaml\r\n==> [2020-08-11-11:58:43.905672] Reading config file /export/data/localhome/home/payerle/git/spack.test/etc/spack/defaults/packages.yaml\r\n==> [2020-08-11-11:58:43.921249] Reading config file /export/data/localhome/home/payerle/git/spack.test/etc/spack/packages.yaml\r\n==> [2020-08-11-11:58:43.938180] Reading config file /export/data/localhome/home/payerle/git/spack.test/etc/spack/compilers.yaml\r\n==> [2020-08-11-11:58:43.942277] Reading config file /homes/payerle/.spack/linux/compilers.yaml\r\n==> [2020-08-11-11:58:43.953119] '/usr/bin/gcc' '-dumpversion'\r\n==> [2020-08-11-11:58:43.955920] '/usr/bin/gcc' '-dumpversion'\r\n==> [2020-08-11-11:58:43.958114] '/usr/bin/gcc' '-dumpversion'\r\n==> [2020-08-11-11:58:43.960050] Warning: gcc@rh7-4.8.5 cannot build optimized binaries for \"skylake\". Using best target possible: \"haswell\"\r\n==> [2020-08-11-11:58:43.967341] DATABASE LOCK TIMEOUT: 3s\r\n==> [2020-08-11-11:58:43.967411] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2020-08-11-11:58:43.970835] '/usr/bin/gcc' '-dumpversion'\r\npkg-config@0.29.2%gcc@rh7-4.8.5+internal_glib arch=linux-rhel7-haswell\r\n```\r\n\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x ] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n",
    "performed_via_github_app": null
}