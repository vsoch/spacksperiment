{
    "url": "https://api.github.com/repos/spack/spack/issues/10705",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/10705/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/10705/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/10705/events",
    "html_url": "https://github.com/spack/spack/issues/10705",
    "id": 414355466,
    "node_id": "MDU6SXNzdWU0MTQzNTU0NjY=",
    "number": 10705,
    "title": "\"shared\" variant in netcdf incorrectly assumes fPIC",
    "user": {
        "login": "anderbubble",
        "id": 350294,
        "node_id": "MDQ6VXNlcjM1MDI5NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/350294?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/anderbubble",
        "html_url": "https://github.com/anderbubble",
        "followers_url": "https://api.github.com/users/anderbubble/followers",
        "following_url": "https://api.github.com/users/anderbubble/following{/other_user}",
        "gists_url": "https://api.github.com/users/anderbubble/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/anderbubble/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/anderbubble/subscriptions",
        "organizations_url": "https://api.github.com/users/anderbubble/orgs",
        "repos_url": "https://api.github.com/users/anderbubble/repos",
        "events_url": "https://api.github.com/users/anderbubble/events{/privacy}",
        "received_events_url": "https://api.github.com/users/anderbubble/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 10,
    "created_at": "2019-02-25T23:22:47Z",
    "updated_at": "2021-05-25T14:59:17Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "When installing netcdf with pgi, pgi exits with an error about fPIC. (See below.)\r\n\r\nThe package sets fPIC if the shared variant is *excluded*\r\n\r\n```\r\n    variant('shared', default=True, description='Enable shared library')\r\n```\r\n\r\n```\r\n        if '~shared' in self.spec:\r\n            # We don't have shared libraries but we still want it to be\r\n            # possible to use this library in shared builds\r\n            cflags.append(self.compiler.pic_flag)\r\n```\r\n\r\nBut this assumes that fPIC is set by `--shared`, which it appears to not be. (See the error below.)\r\n\r\nI propose an explicit fpic variant, like is seen in some other packages. I've prototyped this, and plan to submit a PR.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```\r\nConcretized\r\n--------------------------------\r\nnetcdf@4.6.1%pgi@18.4~dap~hdf4 maxdims=1024 maxvars=8192 +mpi~parallel-netcdf+shared arch=linux-rhel7-x86_64 \r\n    ^hdf5@1.10.4%pgi@18.4~cxx~debug~fortran+hl+mpi+pic+shared~szip~threadsafe arch=linux-rhel7-x86_64 \r\n        ^openmpi@3.1.3%pgi@18.4~cuda+cxx_exceptions fabrics=libfabric,psm2,ucx,verbs ~java~legacylaunchers~memchecker+pmi schedulers=slurm ~sqlite3~thread_multiple+vt arch=linux-rhel7-x86_64 \r\n            ^hwloc@1.11.9%gcc@8.2.0~cairo~cuda+libxml2+pci+shared arch=linux-rhel7-x86_64 \r\n                ^libpciaccess@0.13.5%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                ^libxml2@2.9.8%gcc@8.2.0~python arch=linux-rhel7-x86_64 \r\n                    ^xz@5.2.4%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                    ^zlib@1.2.11%gcc@8.2.0+optimize+pic+shared arch=linux-rhel7-x86_64 \r\n                ^numactl@2.0.11%gcc@8.2.0 patches=592f30f7f5f757dfc239ad0ffd39a9a048487ad803c26b419e0f96b8cda08c1a arch=linux-rhel7-x86_64 \r\n                    ^m4@1.4.18%gcc@8.2.0 patches=3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00,c0a408fbffb7255fcc75e26bd8edab116fc81d216bfd18b473668b7739a4158e,fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8 +sigsegv arch=linux-rhel7-x86_64 \r\n                        ^libsigsegv@2.11%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n            ^libfabric@1.6.1%gcc@8.2.0 fabrics=sockets arch=linux-rhel7-x86_64 \r\n            ^slurm@17-11-9-2%gcc@8.2.0~gtk~hdf5~hwloc~mariadb+readline arch=linux-rhel7-x86_64 \r\n                ^curl@7.60.0%gcc@8.2.0~darwinssl~libssh~libssh2~nghttp2 arch=linux-rhel7-x86_64 \r\n                    ^openssl@1.0.2o%gcc@8.2.0+systemcerts arch=linux-rhel7-x86_64 \r\n                        ^perl@5.26.2%gcc@8.2.0+cpanm patches=0eac10ed90aeb0459ad8851f88081d439a4e41978e586ec743069e8b059370ac +shared+threads arch=linux-rhel7-x86_64 \r\n                            ^gdbm@1.14.1%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                                ^readline@7.0%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                                    ^ncurses@6.1%gcc@8.2.0~symlinks~termlib arch=linux-rhel7-x86_64 \r\n                ^glib@2.56.2%gcc@8.2.0~libmount patches=c325997b72a205ad1638bb3e3ba0e5b73e3d32ce63b2d0d3282f3e3a2ff4663c tracing= arch=linux-rhel7-x86_64 \r\n                    ^gettext@0.19.8.1%gcc@8.2.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-rhel7-x86_64 \r\n                        ^bzip2@1.0.6%gcc@8.2.0+shared arch=linux-rhel7-x86_64 \r\n                        ^tar@1.30%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                    ^libffi@3.2.1%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                    ^pcre@8.42%gcc@8.2.0~jit+utf arch=linux-rhel7-x86_64 \r\n                    ^python@2.7.15%gcc@8.2.0+dbm~optimizations patches=123082ab3483ded78e86d7c809e98a804b3465b4683c96bd79a2fd799f572244 +pic+pythoncmd+shared~tk~ucs4 arch=linux-rhel7-x86_64 \r\n                        ^sqlite@3.23.1%gcc@8.2.0~functions arch=linux-rhel7-x86_64 \r\n                ^json-c@0.13.1%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                ^lz4@1.8.1.2%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                ^munge@0.5.11%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                    ^libgcrypt@1.8.1%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                        ^libgpg-error@1.27%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n            ^ucx@1.3.1%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n                ^rdma-core@20%gcc@8.2.0 build_type=RelWithDebInfo arch=linux-rhel7-x86_64 \r\n                    ^libnl@3.3.0%gcc@8.2.0 arch=linux-rhel7-x86_64 \r\n```\r\n\r\n### Error Message\r\n\r\n```\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j24'\r\n\r\n4 errors found in build log:\r\n     742    PGC-W-0136-Function nc_finalize has non-prototype declaration in scope (nc_initialize.c: 114)\r\n     743    PGC/x86-64 Linux 18.4-0: compilation completed with warnings\r\n     744    libtool: compile:  /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/openmpi-3.1.3-afu27drj7suoqzmsx4rkvpgchbei4ms4/bin/mpicc -DHAVE_CONFIG_H -I. -I/curc/sw/spack/var/spack/stage/netcdf-4.6.1-a4a3afpyqydceqa3w72ks\r\n            trcahfybqgy/netcdf-4.6.1/liblib -I.. -I/curc/sw/spack/var/spack/stage/netcdf-4.6.1-a4a3afpyqydceqa3w72kstrcahfybqgy/netcdf-4.6.1/include -I/curc/sw/spack/var/spack/stage/netcdf-4.6.1-a4a3afpyqydceqa3w72kstrcahfybqgy/\r\n            netcdf-4.6.1/libsrc4 -I/curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34ycw6x73guf5mxno/include -c nc_initialize.c -MD -o libnetcdf_la-nc_initialize.o >/dev/null 2>&1\r\n     745    /bin/sh ../libtool  --tag=CC   --mode=link /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/openmpi-3.1.3-afu27drj7suoqzmsx4rkvpgchbei4ms4/bin/mpicc   -version-info 14:1:1 -L/curc/sw/spack/opt/spack/linux-rhel7-x\r\n            86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34ycw6x73guf5mxno/lib -o libnetcdf.la -rpath /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/netcdf-4.6.1-a4a3afpyqydceqa3w72kstrcahfybqgy/lib libnetcdf_la-nc_initialize\r\n            .lo ../libdispatch/libnetcdf2.la ../libdispatch/libdispatch.la ../libsrc/libnetcdf3.la     ../libsrc4/libnetcdf4.la -lhdf5_hl -lhdf5 -lm -lz\r\n     746    libtool: link: /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/openmpi-3.1.3-afu27drj7suoqzmsx4rkvpgchbei4ms4/bin/mpicc -shared  -DPIC  .libs/libnetcdf_la-nc_initialize.o  --whole-archive ../libdispatch/.libs/li\r\n            bnetcdf2.a ../libdispatch/.libs/libdispatch.a ../libsrc/.libs/libnetcdf3.a ../libsrc4/.libs/libnetcdf4.a --no-whole-archive  -rpath /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34yc\r\n            w6x73guf5mxno/lib -rpath /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34ycw6x73guf5mxno/lib -L/curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34ycw6x\r\n            73guf5mxno/lib -L/curc/sw/spack/opt/spack/linux-rhel7-x86_64/gcc-8.2.0/zlib-1.2.11-hyog4nvfq25emh5taua53slpjeplgwm2/lib /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34ycw6x73guf5mxn\r\n            o/lib/libhdf5_hl.so /curc/sw/spack/opt/spack/linux-rhel7-x86_64/pgi-18.4/hdf5-1.10.4-bikmj2dtqggayel34ycw6x73guf5mxno/lib/libhdf5.so -ldl -lm -lz -lc    -soname libnetcdf.so.13 -o .libs/libnetcdf.so.13.1.1\r\n     747    /usr/bin/ld: ../libdispatch/.libs/libnetcdf2.a(libnetcdf2_la-dv2i.o): relocation R_X86_64_32 against `.rodata' can not be used when making a shared object; recompile with -fPIC\r\n  >> 748    ../libdispatch/.libs/libnetcdf2.a(libnetcdf2_la-dv2i.o): error adding symbols: Bad value\r\n  >> 749    make[2]: *** [libnetcdf.la] Error 2\r\n     750    make[2]: Leaving directory `/pl/active/rcops/spack-build/joan5896/spack-stage/spack-stage-lc8Nhz/netcdf-4.6.1/liblib'\r\n  >> 751    make[1]: *** [all-recursive] Error 1\r\n     752    make[1]: Leaving directory `/pl/active/rcops/spack-build/joan5896/spack-stage/spack-stage-lc8Nhz/netcdf-4.6.1'\r\n  >> 753    make: *** [all] Error 2\r\n```\r\n\r\n### Information on your system\r\n\r\nRHEL7 using spack 0.12.1.",
    "performed_via_github_app": null
}