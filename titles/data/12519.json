{
    "url": "https://api.github.com/repos/spack/spack/issues/12519",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/12519/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/12519/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/12519/events",
    "html_url": "https://github.com/spack/spack/issues/12519",
    "id": 484165673,
    "node_id": "MDU6SXNzdWU0ODQxNjU2NzM=",
    "number": 12519,
    "title": "rpaths with `spack setup`",
    "user": {
        "login": "cdfh",
        "id": 825890,
        "node_id": "MDQ6VXNlcjgyNTg5MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/825890?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/cdfh",
        "html_url": "https://github.com/cdfh",
        "followers_url": "https://api.github.com/users/cdfh/followers",
        "following_url": "https://api.github.com/users/cdfh/following{/other_user}",
        "gists_url": "https://api.github.com/users/cdfh/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/cdfh/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cdfh/subscriptions",
        "organizations_url": "https://api.github.com/users/cdfh/orgs",
        "repos_url": "https://api.github.com/users/cdfh/repos",
        "events_url": "https://api.github.com/users/cdfh/events{/privacy}",
        "received_events_url": "https://api.github.com/users/cdfh/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2019-08-22T19:16:13Z",
    "updated_at": "2020-09-02T01:07:49Z",
    "closed_at": "2020-09-02T01:07:49Z",
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "I'm attempting to use `spack setup` to establish an out-of-stage build environment for cmake-based C++ projects, as described [here](https://spack.readthedocs.io/en/latest/workflows.html#build-with-spack). However, the binaries produced under this workflow have link errors for dependencies related to the compiler's runtime library.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack setup $SPEC && mkdir build && cd build && ../spconfig.py .. && make && ./the-binary\r\n```\r\n\r\n### Error description\r\n\r\n```console\r\n$ ldd the-binary\r\n...\r\nlibc++.so.1 => not found\r\nlibc++abi.so.1 => not found\r\n```\r\n\r\nThese dependencies are for clang's libc++ runtime, which are configured by the `extra_rpaths` variable in `compilers.yaml`.\r\n\r\n### Information on your system\r\n\r\n`compilers.yaml:`\r\n\r\n```yaml\r\ncompilers:\r\n- compiler:\r\n    environment: {}\r\n    extra_rpaths:\r\n    - /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/llvm-8.0.0-vcde4opt4xfhe5qcrktcagi6r7uhskgf/lib\r\n    flags: {}\r\n    modules:\r\n    - llvm-8.0.0-gcc-5.4.0-vcde4op\r\n    operating_system: ubuntu16.04\r\n    paths:\r\n      cc: /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/llvm-8.0.0-vcde4opt4xfhe5qcrktcagi6r7uhskgf/bin/clang\r\n      cxx: /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/llvm-8.0.0-vcde4opt4xfhe5qcrktcagi6r7uhskgf/bin/clang++\r\n      f77: /usr/bin/gfortran\r\n      fc: /usr/bin/gfortran\r\n    spec: clang@8.0.0\r\n    target: x86_64\r\n```\r\n\r\n### Additional Information\r\n\r\nMy `CMakeLists.txt` is correctly configured to use rpaths, and does so for all package-level dependencies (i.e., dependencies declared in the package's `package.py` file). However, the rpaths for the missing dependencies are defined by the `extra_rpaths` variable in the `compilers.yaml` file, and are completely absent from the generated `spconfig.py` file (attached). The bug as I understand it is that rpaths declared for the compiler with `extra_rpaths` are not encoded in the `CMAKE_INSTALL_RPATH` variable in the generated `spconfig.py` file.\r\n\r\n### Workarounds\r\n\r\nI know of two workarounds.\r\n\r\n**Loading the compiler's module**\r\n\r\nThe issue can be avoided by loading llvm (`spack load llvm`) prior to executing the binary (`./the-binary`). However, if the binary is installed with `make install`, then the issue will resurface.\r\n\r\n**Explicitly depending upon LLVM**\r\n\r\n@chuckatkins suggested in a [comment](https://github.com/spack/spack/issues/11582#issuecomment-500507309) regarding issue #11582 that it might be fitting to make the compiler a dependency of all packages that it builds (i.e., with `depends_on()` in the `package.py` file). I've tried this fix and can confirm that it works, but with the caveat that I have to hard-code a dependency on LLVM without knowledge of whether that's actually the compiler that the user is using. Is it possible to gain access to the spec (or the compiler) in the class definition of a package (i.e., outside of a method)? Additionally, this typically ends up reinstalling the compiler to satisfy the need for the compiler dependency to be compiled by itself.\r\n\r\n\r\n### Attachments\r\n\r\n`spconfig.py:`\r\n\r\n```python\r\n#!/usr/bin/python\r\n#\r\n\r\nimport sys\r\nimport os\r\nimport subprocess\r\n\r\ndef cmdlist(str):\r\n    return list(x.strip().replace(\"'\",'') for x in str.split('\\n') if x)\r\nenv = dict(os.environ)\r\nenv['CC'] = '/spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/llvm-8.0.0-vcde4opt4xfhe5qcrktcagi6r7uhskgf/bin/clang'\r\nenv['CMAKE_PREFIX_PATH'] = \":\".join(cmdlist(\"\"\"\r\n    /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/cmake-3.12.3-mt7wnhrl2gwab3qb3bll4nvo2pmj7idw\r\n\"\"\"))\r\nenv['CXX'] = '/spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/llvm-8.0.0-vcde4opt4xfhe5qcrktcagi6r7uhskgf/bin/clang++'\r\nenv['FC'] = '/usr/bin/gfortran'\r\nenv['PATH'] = \":\".join(cmdlist(\"\"\"\r\n    /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/cmake-3.12.3-mt7wnhrl2gwab3qb3bll4nvo2pmj7idw/bin\r\n    /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/cmake-3.12.3-mt7wnhrl2gwab3qb3bll4nvo2pmj7idw/bin\r\n    /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/llvm-8.0.0-vcde4opt4xfhe5qcrktcagi6r7uhskgf/bin\r\n    /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/environment-modules-3.2.10-mb3jzyhb6r5wkb64ojkr5porf2zxjie6/Modules/bin\r\n    /spack/bin\r\n    /usr/local/sbin\r\n    /usr/local/bin\r\n    /usr/sbin\r\n    /usr/bin\r\n    /sbin\r\n    /bin\r\n    /snap/bin\r\n\"\"\"))\r\nenv['SPACK_TRANSITIVE_INCLUDE_PATH'] = \";\".join(cmdlist(\"\"\"\r\n    /spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/cmake-3.12.3-mt7wnhrl2gwab3qb3bll4nvo2pmj7idw/include\r\n\"\"\"))\r\n\r\ncmd = cmdlist(\"\"\"\r\n/spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/cmake-3.12.3-mt7wnhrl2gwab3qb3bll4nvo2pmj7idw/bin/cmake\r\n    -G\r\n    Unix Makefiles\r\n    -DCMAKE_INSTALL_PREFIX:PATH=/spack/opt/spack/linux-ubuntu16.04-x86_64/clang-8.0.0/hdiagsutil-master-c5egaqfc2lvd4jl5ragshnp6edowy3hd\r\n    -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo\r\n    -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON\r\n    -DCMAKE_INSTALL_RPATH_USE_LINK_PATH:BOOL=FALSE\r\n    -DCMAKE_INSTALL_RPATH:STRING=/spack/opt/spack/linux-ubuntu16.04-x86_64/clang-8.0.0/hdiagsutil-master-c5egaqfc2lvd4jl5ragshnp6edowy3hd/lib;/spack/opt/spack/linux-ubuntu16.04-x86_64/clang-8.0.0/hdiagsutil-master-c5egaqfc2lvd4jl5ragshnp6edowy3hd/lib64\r\n    -DCMAKE_PREFIX_PATH:STRING=/spack/opt/spack/linux-ubuntu16.04-x86_64/gcc-5.4.0/cmake-3.12.3-mt7wnhrl2gwab3qb3bll4nvo2pmj7idw\r\n    -DCMAKE_C_FLAGS=\r\n    -DCMAKE_CXX_FLAGS= \r\n\"\"\") + sys.argv[1:]\r\n\r\nproc = subprocess.Popen(cmd, env=env)\r\nproc.wait()\r\n```",
    "performed_via_github_app": null
}