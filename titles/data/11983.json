{
    "url": "https://api.github.com/repos/spack/spack/issues/11983",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/11983/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/11983/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/11983/events",
    "html_url": "https://github.com/spack/spack/issues/11983",
    "id": 466731112,
    "node_id": "MDU6SXNzdWU0NjY3MzExMTI=",
    "number": 11983,
    "title": "Incomplete computation of installed dependents",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446630669,
            "node_id": "MDU6TGFiZWw0NDY2MzA2Njk=",
            "url": "https://api.github.com/repos/spack/spack/labels/dependencies",
            "name": "dependencies",
            "color": "c2e0c6",
            "default": false,
            "description": null
        },
        {
            "id": 512483390,
            "node_id": "MDU6TGFiZWw1MTI0ODMzOTA=",
            "url": "https://api.github.com/repos/spack/spack/labels/impact-medium",
            "name": "impact-medium",
            "color": "fef2c0",
            "default": false,
            "description": ""
        },
        {
            "id": 446630556,
            "node_id": "MDU6TGFiZWw0NDY2MzA1NTY=",
            "url": "https://api.github.com/repos/spack/spack/labels/specs",
            "name": "specs",
            "color": "b60205",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-07-11T08:06:31Z",
    "updated_at": "2021-02-15T13:42:32Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "Follow-up of https://github.com/spack/spack/issues/3690#issuecomment-510020811. Basically everything that relies on computing dependents is broken when a spec has more than one dependent with the same name.\r\n\r\n\r\n\r\n\r\n### Steps to reproduce the issue\r\nThe issue can be reproduced with e.g. Spack at d3be42fccaabbdc71c03da0886214b31a29921e5. Let's start by installing 2 different versions of `hdf5` depending on the same `zlib`:\r\n```console\r\n$ spack install --fake hdf5~mpi+fortran hdf5~mpi~fortran\r\n```\r\nLet's then check that they actually both depend on the same `zlib` and they have different hashes:\r\n```console\r\n$ spack find -ld hdf5\r\n==> 2 installed packages\r\n-- linux-ubuntu18.04-x86_64 / gcc@9.0.1 -------------------------\r\nxyhss36    hdf5@1.10.5\r\ntn4qvs7        ^zlib@1.2.11\r\n\r\n4f3j7km    hdf5@1.10.5\r\ntn4qvs7        ^zlib@1.2.11\r\n```\r\nAsking which are the installed dependents of `zlib` will give the wrong answer an **skip one of the two specs**:\r\n```console\r\n$ spack dependents -i zlib\r\n==> Dependents of zlib@1.2.11%gcc@9.0.1/tn4qvs7\r\n-- linux-ubuntu18.04-x86_64 / gcc@9.0.1 -------------------------\r\nxyhss36 hdf5@1.10.5\r\n```\r\nThis is ultimately due to how dependents are computed in `spack.spec.Spec`:\r\n\r\nhttps://github.com/spack/spack/blob/c2de2558b6423711e3b2cdbaaca1c0b0dfb61757/lib/spack/spack/spec.py#L1063-L1072\r\n\r\nby constructing a map **from the package name** to the branch connecting it to the current spec. When there is more than one dependent with the same name only the last dependent added will be recorded.\r\n\r\nThis might be fine if we are working on a single tree DAG (where we are ensured there's at most one spec with the same name), but it is not if we are analyzing the entire DAG of all the installed applications. For instance the method:\r\n\r\nhttps://github.com/spack/spack/blob/d3be42fccaabbdc71c03da0886214b31a29921e5/lib/spack/spack/database.py#L878-L911\r\n\r\nwill return wrong results when we ask to analyze in the `parents` direction.\r\n\r\n### Error Message\r\n\r\nThere's no error message, just the information on dependents of an installed spec is computed wrongly. This lead for instance to issues like #3690 or #5637.\r\n\r\n### Information on your system\r\n\r\nThe platform is not relevant for this bug.",
    "performed_via_github_app": null
}