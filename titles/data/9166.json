{
    "url": "https://api.github.com/repos/spack/spack/issues/9166",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/9166/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/9166/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/9166/events",
    "html_url": "https://github.com/spack/spack/issues/9166",
    "id": 356451148,
    "node_id": "MDU6SXNzdWUzNTY0NTExNDg=",
    "number": 9166,
    "title": "Locking problems",
    "user": {
        "login": "healther",
        "id": 4048699,
        "node_id": "MDQ6VXNlcjQwNDg2OTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4048699?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/healther",
        "html_url": "https://github.com/healther",
        "followers_url": "https://api.github.com/users/healther/followers",
        "following_url": "https://api.github.com/users/healther/following{/other_user}",
        "gists_url": "https://api.github.com/users/healther/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/healther/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/healther/subscriptions",
        "organizations_url": "https://api.github.com/users/healther/orgs",
        "repos_url": "https://api.github.com/users/healther/repos",
        "events_url": "https://api.github.com/users/healther/events{/privacy}",
        "received_events_url": "https://api.github.com/users/healther/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446780710,
            "node_id": "MDU6TGFiZWw0NDY3ODA3MTA=",
            "url": "https://api.github.com/repos/spack/spack/labels/locking",
            "name": "locking",
            "color": "e99695",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 19,
    "created_at": "2018-09-03T10:38:50Z",
    "updated_at": "2018-09-26T02:00:09Z",
    "closed_at": "2018-09-26T02:00:09Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "This is a fairly tricky problem to track down and I'm not particularly certain in what the actual problem is, so take this description with a grain of salt.\r\n\r\nOur CI regularly shows errors of this kind:\r\n```\r\n+ spack install --source --only dependencies --show-log-on-error -j4 <spec>\r\n==> Error: \r\n```\r\n\r\nThis is because either [this](https://github.com/spack/spack/blob/5e8a9ddaed478680dcd0607cfdafafa769ece6b3/lib/spack/llnl/util/lock.py#L266) or [this](https://github.com/spack/spack/blob/5e8a9ddaed478680dcd0607cfdafafa769ece6b3/lib/spack/llnl/util/lock.py#L289) assertion in `lib/spack/llnl/util/lock.py` being triggered (`spack -d` prints the stack trace to these lines). We suspect that we time out [here](https://github.com/spack/spack/blob/5e8a9ddaed478680dcd0607cfdafafa769ece6b3/lib/spack/llnl/util/lock.py#L221) due to the slow HDD.\r\n\r\nWe think the origin of this problem is the `finally` statement [here](https://github.com/spack/spack/blob/63004e3de1473254c3b2a75f1e06afaabdacd7dd/lib/spack/spack/database.py#L244) (for brevity here the copy of the function)\r\n```\r\n    @contextlib.contextmanager\r\n    def prefix_read_lock(self, spec):\r\n        prefix_lock = self.prefix_lock(spec)\r\n        try:\r\n            prefix_lock.acquire_read(60)\r\n            yield self\r\n        finally:\r\n            prefix_lock.release_read()\r\n```\r\nIf `prefix_lock.acquire_read` times out, this will not do `prefix_lock._reads += 1` and the `prefix_lock.release_read()` will run into `assert prefix_lock._reads > 0`. As I currently understand it, the code above seems wrong and I think the simplest solution would be to move the `prefix_lock.acquire_read(60)` out of the `try:` block. But I have no idea what kind of repercussions this would have (or even if our reasoning is solid). \r\n\r\nAny kind of feedback would be greatly appreciated, I'm certainly out of my depth here @tgamblin @scheibelp ",
    "performed_via_github_app": null
}