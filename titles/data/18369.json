{
    "url": "https://api.github.com/repos/spack/spack/issues/18369",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/18369/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/18369/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/18369/events",
    "html_url": "https://github.com/spack/spack/issues/18369",
    "id": 688370459,
    "node_id": "MDU6SXNzdWU2ODgzNzA0NTk=",
    "number": 18369,
    "title": "spack load with fish shell fails when package contains -h",
    "user": {
        "login": "wortiz",
        "id": 5240562,
        "node_id": "MDQ6VXNlcjUyNDA1NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5240562?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/wortiz",
        "html_url": "https://github.com/wortiz",
        "followers_url": "https://api.github.com/users/wortiz/followers",
        "following_url": "https://api.github.com/users/wortiz/following{/other_user}",
        "gists_url": "https://api.github.com/users/wortiz/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/wortiz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/wortiz/subscriptions",
        "organizations_url": "https://api.github.com/users/wortiz/orgs",
        "repos_url": "https://api.github.com/users/wortiz/repos",
        "events_url": "https://api.github.com/users/wortiz/events{/privacy}",
        "received_events_url": "https://api.github.com/users/wortiz/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 475435626,
            "node_id": "MDU6TGFiZWw0NzU0MzU2MjY=",
            "url": "https://api.github.com/repos/spack/spack/labels/shell-support",
            "name": "shell-support",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2020-08-28T21:42:44Z",
    "updated_at": "2020-09-10T15:01:45Z",
    "closed_at": "2020-09-10T15:01:45Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "<!-- Explain, in a clear and concise way, the command you ran and the result you were trying to achieve.\r\nExample: \"I ran `spack find` to list all the installed packages and ...\" -->\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n~> spack load omega-h\r\n==> This command works best with Spack's shell support\r\n  \r\n  To initialize spack's shell commands:\r\n  \r\n      # for bash and zsh\r\n      . /home/wortiz/spack/share/spack/setup-env.sh\r\n  \r\n      # for csh and tcsh\r\n      setenv SPACK_ROOT /home/wortiz/spack\r\n      source /home/wortiz/spack/share/spack/setup-env.csh\r\n  \r\n  Or, if you want to use `spack load` without initializing\r\n  shell support, you can run one of these:\r\n  \r\n      eval `spack load --sh omega-h`   # for bash/sh\r\n      eval `spack load --csh omega-h`  # for csh/tcsh\r\n\r\n```\r\n\r\n### Error Message\r\n\r\n<!-- If Spack reported an error, provide the error message. If it did not report an error but the output appears incorrect, provide the incorrect output. If there was no error message and no output but the result is incorrect, describe how it does not match what you expect. -->\r\n```console~> spack --debug --stacktrace load omega-h\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-08-28-15:31:53.406215] Imported load from built-in commands\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-08-28-15:31:53.407513] Imported load from built-in commands\r\nlib/spack/spack/config.py:835 ==> [2020-08-28-15:31:53.410728] Reading config file /home/wortiz/spack/etc/spack/defaults/config.yaml\r\nlib/spack/spack/database.py:361 ==> [2020-08-28-15:31:53.424942] DATABASE LOCK TIMEOUT: 3s\r\nlib/spack/spack/database.py:365 ==> [2020-08-28-15:31:53.425115] PACKAGE LOCK TIMEOUT: No timeout\r\nlib/spack/spack/config.py:835 ==> [2020-08-28-15:31:53.454480] Reading config file /home/wortiz/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/spack/config.py:835 ==> [2020-08-28-15:31:53.456232] Reading config file /home/wortiz/.spack/repos.yaml\r\nlib/spack/spack/cmd/load.py:76 ==> [2020-08-28-15:31:53.495821] This command works best with Spack's shell support\r\n  \r\n  To initialize spack's shell commands:\r\n  \r\n      # for bash and zsh\r\n      . /home/wortiz/spack/share/spack/setup-env.sh\r\n  \r\n      # for csh and tcsh\r\n      setenv SPACK_ROOT /home/wortiz/spack\r\n      source /home/wortiz/spack/share/spack/setup-env.csh\r\n  \r\n  Or, if you want to use `spack load` without initializing\r\n  shell support, you can run one of these:\r\n  \r\n      eval `spack load --sh omega-h`   # for bash/sh\r\n      eval `spack load --csh omega-h`  # for csh/tcsh\r\n\r\n```\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\n\r\n### Additional information\r\n\r\nWorkaround:\r\n```console\r\n~> eval (spack load --fish omega-h)\r\n```\r\n\r\nAppears to be caused by ` function check_env_activate_flags` being too lax when checking for -h\r\n\r\nCan be fixed with the following patch but I'm not sure if this is strict enough\r\n\r\n```patch\r\ndiff --git a/share/spack/setup-env.fish b/share/spack/setup-env.fish\r\nindex dd2a17f74..9200d7136 100755\r\n--- a/share/spack/setup-env.fish\r\n+++ b/share/spack/setup-env.fish\r\n@@ -258,7 +258,7 @@ function check_env_activate_flags -d \"check spack env subcommand flags for -h, -\r\n     # skip if called with blank input. Notes: [1] (cf. EOF)\r\n     if test -n \"$_a\"\r\n         # looks for a single `-h` (possibly surrounded by spaces)\r\n-        if echo $_a | string match -r -q \" *-h *\"\r\n+        if echo $_a | string match -r -q \" +-h *\"\r\n             return 0\r\n         end\r\n \r\n```\r\n\r\nI don't usually write fish programs so maybe someone more knowledgable knows of a better way to check args\r\n\r\n@JBlaschke  ",
    "performed_via_github_app": null
}