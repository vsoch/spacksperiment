{
    "url": "https://api.github.com/repos/spack/spack/issues/24540",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24540/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24540/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24540/events",
    "html_url": "https://github.com/spack/spack/pull/24540",
    "id": 930505082,
    "node_id": "MDExOlB1bGxSZXF1ZXN0Njc4MTgyNDY0",
    "number": 24540,
    "title": "Add host compiler compatibility check to CUDA package.",
    "user": {
        "login": "romerojosh",
        "id": 5974496,
        "node_id": "MDQ6VXNlcjU5NzQ0OTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5974496?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/romerojosh",
        "html_url": "https://github.com/romerojosh",
        "followers_url": "https://api.github.com/users/romerojosh/followers",
        "following_url": "https://api.github.com/users/romerojosh/following{/other_user}",
        "gists_url": "https://api.github.com/users/romerojosh/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/romerojosh/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/romerojosh/subscriptions",
        "organizations_url": "https://api.github.com/users/romerojosh/orgs",
        "repos_url": "https://api.github.com/users/romerojosh/repos",
        "events_url": "https://api.github.com/users/romerojosh/events{/privacy}",
        "received_events_url": "https://api.github.com/users/romerojosh/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 618601843,
            "node_id": "MDU6TGFiZWw2MTg2MDE4NDM=",
            "url": "https://api.github.com/repos/spack/spack/labels/cuda",
            "name": "cuda",
            "color": "85b737",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2021-06-25T21:11:26Z",
    "updated_at": "2021-06-28T22:45:02Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/24540",
        "html_url": "https://github.com/spack/spack/pull/24540",
        "diff_url": "https://github.com/spack/spack/pull/24540.diff",
        "patch_url": "https://github.com/spack/spack/pull/24540.patch"
    },
    "body": "`nvcc` only officially supports specific ranges of host compilers, with version ranges varied based on CUDA toolkit version. Currently, Spack does not consider these host compiler restrictions during concretization. This can result in cases where users go through a long build process, only to find out later on that the host compiler they are using is not supported by the CUDA toolkit version they've installed. \r\n\r\nThis PR introduces code into the CUDA package to add conflict statements to enforce host compiler dependencies based on CUDA version. To facilitate this, I've added a `_supported_compilers` dictionary that contains information on supported compilers based on CUDA version. I parsed this data directly from the `${CUDA_ROOT}/include/crt/host_config.h` header for each CUDA version listed (as old as 8.0). \r\n\r\nIt appears that the `conflicts` statement does not accept syntax like `conflicts('^%gcc@:10', when ='%gcc')` (i.e. conflicts with gcc versions greater than 10 when building with gcc). As a result, I had to add a helper function `invert_support_entry` to effectively perform this NOT operation, and then create `conflicts` using the inverted ranges. See the comment above the function for examples. If there is a better way to accomplish this without requiring this type of code, please let me know.\r\n\r\nWith these conflicts in place, the build will now error out during concretization. For example, trying to install CUDA 10.0 in a container with GCC 9 will now yield the following:\r\n```\r\n$ spack install cuda@10.0.130\r\n==> Error: Conflicts in concretized spec \"cuda@10.0.130%gcc@9.3.0~dev arch=linux-ubuntu20.04-broadwell/3flnvxz\"\r\nList of matching conflicts for spec:\r\n\r\n    cuda@10.0.130%gcc@9.3.0~dev arch=linux-ubuntu20.04-broadwell\r\n\r\n1. \"%gcc@8:\" conflicts with \"cuda@10.0\" [gcc version is not within supported range (:7) for CUDA 10.0.130.]\r\n```\r\nI'm not sure why the error reports `%gcc@8`, but maybe that is expected? On the other hand, when trying to install CUDA 10.2, the error reported shows `%gcc@9` which is more accurate:\r\n```\r\n$ spack install cuda@10.2.89\r\n==> Error: Conflicts in concretized spec \"cuda@10.2.89%gcc@9.3.0~dev arch=linux-ubuntu20.04-broadwell/367rjfk\"\r\nList of matching conflicts for spec:\r\n\r\n    cuda@10.2.89%gcc@9.3.0~dev arch=linux-ubuntu20.04-broadwell\r\n        ^libxml2@2.9.10%gcc@9.3.0~python arch=linux-ubuntu20.04-broadwell\r\n            ^libiconv@1.16%gcc@9.3.0 arch=linux-ubuntu20.04-broadwell\r\n            ^pkgconf@1.7.4%gcc@9.3.0 arch=linux-ubuntu20.04-broadwell\r\n            ^xz@5.2.5%gcc@9.3.0~pic libs=shared,static arch=linux-ubuntu20.04-broadwell\r\n            ^zlib@1.2.11%gcc@9.3.0+optimize+pic+shared arch=linux-ubuntu20.04-broadwell\r\n\r\n1. \"%gcc@9:\" conflicts with \"cuda@10.2\" [gcc version is not within supported range (:8) for CUDA 10.2.89.]\r\n```\r\nCC: @bvanessen ",
    "performed_via_github_app": null
}