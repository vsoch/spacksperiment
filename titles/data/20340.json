{
    "url": "https://api.github.com/repos/spack/spack/issues/20340",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/20340/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/20340/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/20340/events",
    "html_url": "https://github.com/spack/spack/issues/20340",
    "id": 762560103,
    "node_id": "MDU6SXNzdWU3NjI1NjAxMDM=",
    "number": 20340,
    "title": "Superfluous dependencies in spec matrix not ignored by ASP concretizer",
    "user": {
        "login": "mpbelhorn",
        "id": 1690817,
        "node_id": "MDQ6VXNlcjE2OTA4MTc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1690817?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mpbelhorn",
        "html_url": "https://github.com/mpbelhorn",
        "followers_url": "https://api.github.com/users/mpbelhorn/followers",
        "following_url": "https://api.github.com/users/mpbelhorn/following{/other_user}",
        "gists_url": "https://api.github.com/users/mpbelhorn/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mpbelhorn/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mpbelhorn/subscriptions",
        "organizations_url": "https://api.github.com/users/mpbelhorn/orgs",
        "repos_url": "https://api.github.com/users/mpbelhorn/repos",
        "events_url": "https://api.github.com/users/mpbelhorn/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mpbelhorn/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446623646,
            "node_id": "MDU6TGFiZWw0NDY2MjM2NDY=",
            "url": "https://api.github.com/repos/spack/spack/labels/concretization",
            "name": "concretization",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 1893105003,
            "node_id": "MDU6TGFiZWwxODkzMTA1MDAz",
            "url": "https://api.github.com/repos/spack/spack/labels/concretizer-use-case",
            "name": "concretizer-use-case",
            "color": "1d76db",
            "default": false,
            "description": "interesting dependency hierarchy that would challenge the current concretizer"
        },
        {
            "id": 512483390,
            "node_id": "MDU6TGFiZWw1MTI0ODMzOTA=",
            "url": "https://api.github.com/repos/spack/spack/labels/impact-medium",
            "name": "impact-medium",
            "color": "fef2c0",
            "default": false,
            "description": ""
        },
        {
            "id": 1491157493,
            "node_id": "MDU6TGFiZWwxNDkxMTU3NDkz",
            "url": "https://api.github.com/repos/spack/spack/labels/stacks",
            "name": "stacks",
            "color": "92d1db",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 3,
    "created_at": "2020-12-11T16:17:57Z",
    "updated_at": "2020-12-14T19:34:13Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "It was my understanding that explicit dependencies in a spec matrix which are not applicable to the root spec are supposed to be ignored during environment concretization. And this was the case using the original concretizer. For example, take the following simplified `spack.yaml` (full environment file will be attached below):\r\n\r\n```yaml\r\nspack:\r\n  definitions:\r\n  - xl_compilers:\r\n    - '%xl@16.1.1-8'\r\n    # - ... potentially many other XL compiler specs \r\n  - general_compute_packages:\r\n    - netlib-lapack\r\n    - boost ~mpi\r\n    - boost +mpi\r\n    - parallel-io\r\n    # - ... potentially many other target packages\r\n  - xl_specs:\r\n    - matrix:\r\n      - - $general_compute_packages\r\n        - parallel-io@2.3.0\r\n        - boost@1.62.0 ~mpi\r\n      - - $xl_compilers\r\n      - - ^numactl%gcc@8-os\r\n      - - ^libfabric%gcc@8-os\r\n      - - ^libzmq%gcc@8-os\r\n      - - ^cmake%gcc@8-os\r\n      - - ^automake%gcc@8-os\r\n      - - ^autoconf%gcc@8-os\r\n      - - ^m4%gcc@8-os\r\n      - - ^perl%gcc@8-os\r\n      - - ^pkgconf%gcc@8-os\r\n      exclude:\r\n      - boost@1.63.0:%xl\r\n      - 'parallel-io@2.4.4:'\r\n  specs:\r\n  - $xl_specs\r\n  compilers:\r\n  - compiler:\r\n      spec: gcc@8-os\r\n      operating_system: rhel8\r\n      modules: []\r\n      paths:\r\n        cc: /usr/bin/gcc\r\n        cxx: /usr/bin/g++\r\n        f77: /usr/bin/gfortran\r\n        fc: /usr/bin/gfortran\r\n      extra_rpaths: []\r\n      environment: {unset: []}\r\n      flags: {}\r\n  - compiler:\r\n      spec: xl@16.1.1-8\r\n      operating_system: rhel8\r\n      modules: [xl/16.1.1-8]\r\n      paths:\r\n        cc: /sw/peak/xl/16.1.1-8/xlC/16.1.1/bin/xlc_r\r\n        cxx: /sw/peak/xl/16.1.1-8/xlC/16.1.1/bin/xlc++_r\r\n        f77: /sw/peak/xl/16.1.1-8/xlf/16.1.1/bin/xlf_r\r\n        fc: /sw/peak/xl/16.1.1-8/xlf/16.1.1/bin/xlf2008_r\r\n      extra_rpaths:\r\n      - /sw/peak/xl/16.1.1-8/lib\r\n      - /sw/peak/xl/16.1.1-8/xlf/16.1.1/lib\r\n      - /sw/peak/xl/16.1.1-8/xlC/16.1.1/lib\r\n      environment: {}\r\n      flags: {}\r\n```\r\n\r\nThe matrix in this environment takes the outer product of\r\n- a list of target packages that we want to build with multiple toolchains\r\n- a list of different versions of a toolchain species with we want to build the packages with. Here, only XL is shown, but in general several other toolchain species such as GCC, PGI, etc. would be included as well.\r\n- and finally, within the context of a given toolchain species, a list of possible dependencies known to be unbuildable with the target toolchain that should instead be built with the OS-provided GCC toolchain.\r\n\r\nThis structure allows us to curate a simple list of root package specs that can be re-used to produce specs for a large number of compilers and handle the small number of exception specs on a toolchain-by-toolchain basis.\r\n\r\nThe original concretizer would expand the first `netlib-lapack` root spec in the matrix as  `netlib-lapack%xl@16.1.1-8 ^autoconf%gcc@8-os ^automake%gcc@8-os ^cmake%gcc@8-os ^libfabric%gcc@8-os ^libzmq%gcc@8-os ^m4%gcc@8-os ^numactl%gcc@8-os ^perl%gcc@8-os ^pkgconf%gcc@8-os`. But, since netlib-lapack depends only on `cmake` and `openssl` (external in our case), the original concretizer+matrix expansion would drop the inapplicable dependencies from the spec and effectively use only `netlib-lapack%xl@16.1.1-8 ^cmake%gcc@8-os` as the root spec.\r\n\r\nHowever, the new ASP concretizer looks at the whole input root spec and runs itself into an unresolvable corner:\r\n\r\n```console\r\n$ spack env st\r\n==> In environment /sw/.b2/facspack/peak/hosts/peak/envs/base\r\n\r\n$ spack --debug --stacktrace concretize -f                                                                                                                                                                                                     \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/cmd/__init__.py:122 ==> [2020-12-11-10:53:01.653270] Imported concretize from built-in commands                                                                                    \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/cmd/__init__.py:122 ==> [2020-12-11-10:53:01.654487] Imported concretize from built-in commands                                                                                    \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/config.py:907 ==> [2020-12-11-10:53:05.933371] Reading config file /autofs/nccs-svm1_sw/.b2/facspack/peak/spack/etc/spack/defaults/repos.yaml                                      \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/config.py:907 ==> [2020-12-11-10:53:05.937577] Reading config file /sw/.b2/facspack/peak/hosts/peak/envs/base/spack.yaml                                                           \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/config.py:907 ==> [2020-12-11-10:53:10.250519] Reading config file /autofs/nccs-svm1_sw/.b2/facspack/peak/spack/etc/spack/defaults/packages.yaml                                   \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.385782] version_weight(pgi, 1)                                                                                                         \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.386381] variant_not_default(pgi, managed, True, 1)                                                                                     \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.386670] variant_not_default(pgi, mpi, True, 1)                                                                                         \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.386953] variant_not_default(pgi, mpigpu, True, 1)                                                                                      \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.387235] variant_not_default(pgi, network, False, 1)                                                                                    \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.387515] variant_not_default(pgi, nvidia, True, 1)                                                                                      \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.387793] variant_not_default(pgi, single, True, 1)                                                                                      \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.388071] variant_not_default(pgi, amd, False, 0)                                                                                        \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.388347] variant_not_default(pgi, java, False, 0)                                                                                       \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.388696] node_target_weight(pgi, -30)                                                                                                   \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.388975] compiler_weight(pgi, 4)                                                                                                        \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.389254] compiler_version_match(pgi, 1)                                                                                                 \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/database.py:361 ==> [2020-12-11-10:53:10.392488] DATABASE LOCK TIMEOUT: 120s                                                                                                       \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/database.py:365 ==> [2020-12-11-10:53:10.392865] PACKAGE LOCK TIMEOUT: No timeout                                                                                                  \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.462234] version_weight(pgi, 0)                                                                                                         \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.462826] variant_not_default(pgi, managed, True, 1)                                                                                     \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.463120] variant_not_default(pgi, mpi, True, 1)                                                                                         \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.463407] variant_not_default(pgi, mpigpu, True, 1)                                                                                      \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.463691] variant_not_default(pgi, network, False, 1)                                                                                    \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.463977] variant_not_default(pgi, nvidia, True, 1)                                                                                      \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.464260] variant_not_default(pgi, single, True, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.464540] variant_not_default(pgi, amd, False, 0)                                                                                        \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.464823] variant_not_default(pgi, java, False, 0)                                                                                       \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.465175] node_target_weight(pgi, -30)                                                                                                   \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.465459] compiler_weight(pgi, 4)                                                                                                        \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.465740] compiler_version_match(pgi, 1)                                                                                                 \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.536927] version_weight(spectrum-mpi, -2)                                                                                               \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.537299] node_target_weight(spectrum-mpi, -30)                                                                                          \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.537587] compiler_weight(spectrum-mpi, -400)                                                                                            \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.537873] compiler_version_match(spectrum-mpi, 1)                                                                                        \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.602626] version_weight(spectrum-mpi, -2)                                                                                               \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.602993] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.603283] compiler_weight(spectrum-mpi, -500)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.603568] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.668123] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.668490] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.668781] compiler_weight(spectrum-mpi, -600)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.669070] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.733920] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.734285] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.734571] compiler_weight(spectrum-mpi, -700)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.734853] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.799836] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.800208] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.800497] compiler_weight(spectrum-mpi, -1400)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.800786] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.865046] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.865422] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.865712] compiler_weight(spectrum-mpi, -1300)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.865994] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.930582] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.930955] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.931245] compiler_weight(spectrum-mpi, -200)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.931532] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.996264] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.996627] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.996912] compiler_weight(spectrum-mpi, -800)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:10.997194] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.062148] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.062515] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.062802] compiler_weight(spectrum-mpi, -1100)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.063082] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.127824] version_weight(spectrum-mpi, -2)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.128190] node_target_weight(spectrum-mpi, -30)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.128478] compiler_weight(spectrum-mpi, -1200)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:1728 ==> [2020-12-11-10:53:11.128760] compiler_version_match(spectrum-mpi, 1)\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/solver/asp.py:229 ==> [2020-12-11-10:53:26.935514] The following constraints are unsatisfiable:\r\n#\r\n#\r\n# See `concretize_simplified_stacktrace_debug.log` below for output truncated here\r\n#\r\n#\r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/main.py:765 ==> [2020-12-11-10:53:27.007705] UnsatisfiableSpecError: netlib-lapack%xl@16.1.1-8 ^autoconf%gcc@8-os ^automake%gcc@8-os ^cmake%gcc@8-os ^libfabric%gcc@8-os ^libzmq%gc\r\nc@8-os ^m4%gcc@8-os ^numactl%gcc@8-os ^perl%gcc@8-os ^pkgconf%gcc@8-os does not satisfy unknown                                                                                                                                                \r\nautofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/error.py:55 ==> [2020-12-11-10:53:27.008401] Error: netlib-lapack%xl@16.1.1-8 ^autoconf%gcc@8-os ^automake%gcc@8-os ^cmake%gcc@8-os ^libfabric%gcc@8-os ^libzmq%gcc@8-os ^m4%gcc@8-\r\nos ^numactl%gcc@8-os ^perl%gcc@8-os ^pkgconf%gcc@8-os does not satisfy unknown                                                                                                                                                                 \r\nTraceback (most recent call last):                                                                                                                                                                                                             \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/main.py\", line 762, in main                                                                                                                                               \r\n    return _invoke_command(command, parser, args, unknown)                                                                                                                                                                                     \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/main.py\", line 490, in _invoke_command                                                                                                                                    \r\n    return_val = command(parser, args)                                                                                                                                                                                                         \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/cmd/concretize.py\", line 22, in concretize                                                                                                                                \r\n    concretized_specs = env.concretize(force=args.force)                                                                                                                                                                                       \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/environment.py\", line 1083, in concretize                                                                                                                                 \r\n    return self._concretize_separately()                                                                                                                                                                                                       \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/environment.py\", line 1151, in _concretize_separately                                                                                                                     \r\n    concrete = _concretize_from_constraints(uspec_constraints)                                                                                                                                                                                 \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/environment.py\", line 1848, in _concretize_from_constraints                                                                                                               \r\n    return s.concretized()                                                                                                                                                                                                                     \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/spec.py\", line 2490, in concretized                                                                                                                                       \r\n    clone.concretize()                                                                                                                                                                                                                         \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/spec.py\", line 2469, in concretize                                                                                                                                        \r\n    self._new_concretize(tests)                                                                                                                                                                                                                \r\n  File \"/autofs/nccs-svm1_sw/.b2/facspack/peak/spack/lib/spack/spack/spec.py\", line 2448, in _new_concretize                                                                                                                                   \r\n    raise spack.error.UnsatisfiableSpecError(                                                                                                                                                                                                  \r\nspack.error.UnsatisfiableSpecError: netlib-lapack%xl@16.1.1-8 ^autoconf%gcc@8-os ^automake%gcc@8-os ^cmake%gcc@8-os ^libfabric%gcc@8-os ^libzmq%gcc@8-os ^m4%gcc@8-os ^numactl%gcc@8-os ^perl%gcc@8-os ^pkgconf%gcc@8-os does not satisfy unkno\r\nwn\r\n```\r\n\r\n[concretize_simplified_stacktrace_debug.log](https://github.com/spack/spack/files/5680186/concretize_simplified_stacktrace_debug.log)\r\n\r\nThe full `spack.yaml` with a simplified list under the `specs:` key that was used to produce the above output is contained in this [clingo_bug.zip](https://github.com/spack/spack/files/5680226/clingo_bug.zip) archive. The archive also contains additional logs showing the expected output of `spack spec -lINt \"netlib-lapack%xl@16.1.1-8\" \"^cmake%gcc@8-os\"` produced by the original concretizer as well as the output of `spack spec -lINt \"netlib-lapack%xl@16.1.1-8\" \"^autoconf%gcc@8-os\" \"^automake%gcc@8-os\" \"^cmake%gcc@8-os\" \"^libfabric%gcc@8-os\" \"^libzmq%gcc@8-os\" \"^m4%gcc@8-os\" \"^numactl%gcc@8-os\" \"^perl%gcc@8-os\" \"^pkgconf%gcc@8-os\"` showing similar output as `spack concretize -f` in this environment under the ASP concretizer.\r\n\r\n### Expected output\r\n\r\nI expect that superfluous dependency specs in a matrix would continue to be ignored but also expect that our approach to constructing a list of specs using re-usable lists of desired targets would have to change under the new concretizer. So if my expectations for matrix concretization under the new concretizer is not feasible, I would like to have a discussion or guidance on how to restructure our environments to balance the complexity of maintaining large spec lists with mixed toolchain builds moving forward with the new concretizer.\r\n\r\n### Information on your system\r\n\r\n```\r\n$ spack debug report\r\n* **Spack:** 0.16.0\r\n* **Python:** 3.8.6\r\n* **Platform:** linux-rhel8-power9le\r\n```\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "performed_via_github_app": null
}