{
    "url": "https://api.github.com/repos/spack/spack/issues/20005",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/20005/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/20005/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/20005/events",
    "html_url": "https://github.com/spack/spack/issues/20005",
    "id": 746896277,
    "node_id": "MDU6SXNzdWU3NDY4OTYyNzc=",
    "number": 20005,
    "title": "module 'spack.hooks' has no attribute 'sbang'",
    "user": {
        "login": "eugeneswalker",
        "id": 38933153,
        "node_id": "MDQ6VXNlcjM4OTMzMTUz",
        "avatar_url": "https://avatars.githubusercontent.com/u/38933153?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/eugeneswalker",
        "html_url": "https://github.com/eugeneswalker",
        "followers_url": "https://api.github.com/users/eugeneswalker/followers",
        "following_url": "https://api.github.com/users/eugeneswalker/following{/other_user}",
        "gists_url": "https://api.github.com/users/eugeneswalker/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/eugeneswalker/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/eugeneswalker/subscriptions",
        "organizations_url": "https://api.github.com/users/eugeneswalker/orgs",
        "repos_url": "https://api.github.com/users/eugeneswalker/repos",
        "events_url": "https://api.github.com/users/eugeneswalker/events{/privacy}",
        "received_events_url": "https://api.github.com/users/eugeneswalker/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 759411369,
            "node_id": "MDU6TGFiZWw3NTk0MTEzNjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/buildcache",
            "name": "buildcache",
            "color": "bf354c",
            "default": false,
            "description": null
        },
        {
            "id": 1474769306,
            "node_id": "MDU6TGFiZWwxNDc0NzY5MzA2",
            "url": "https://api.github.com/repos/spack/spack/labels/e4s",
            "name": "e4s",
            "color": "5224ad",
            "default": false,
            "description": ""
        },
        {
            "id": 966031931,
            "node_id": "MDU6TGFiZWw5NjYwMzE5MzE=",
            "url": "https://api.github.com/repos/spack/spack/labels/ecp",
            "name": "ecp",
            "color": "79d7ea",
            "default": false,
            "description": ""
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 28,
    "created_at": "2020-11-19T20:23:42Z",
    "updated_at": "2021-04-28T01:10:55Z",
    "closed_at": "2021-04-27T23:55:08Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "Trying to install some packages from build cache is giving this error:\r\n* `module 'spack.hooks' has no attribute 'sbang'`\r\n\r\nUsing\r\n* `spack@develop`\r\n* c41782795433cc3241d9a6038c68bcadbb12b838\r\n* `Thu Nov 19 17:43:52 2020 +0100`\r\n* Docker container `ecpe4s/ubuntu18.04-runner-x86_64:2020-09-01`\r\n\r\nConcrete spec: [kokkos-p3br7p.yml.txt](https://github.com/spack/spack/files/5569476/kokkos-p3br7p.yml.txt)\r\n\r\nUse this `config.yaml`:\r\n```\r\nconfig:\r\n  install_tree:\r\n    root: /spack-software\r\n    padded_length: 64\r\n```\r\n\r\nSetup Spack this way:\r\n```\r\n$> git clone https://github.com/spack/spack /builds/uo/e4s/spack\r\n\r\n$> (cd /builds/uo/e4s/spack && git checkout c417827)\r\n\r\n$> spack mirror add E4S https://cache.e4s.io\r\n\r\n$> wget https://oaciss.uoregon.edu/e4s/e4s.pub\r\n\r\n$> spack gpg trust e4s.pub\r\n\r\n$> spack config edit config\r\n# use the config.yaml pasted above\r\n```\r\n\r\nInstall fails:\r\n```\r\n$> spack install --cache-only -f ./kokkos-p3br7p.yml\r\n==> Installing kokkos-3.2.00-2ryuvoz7s4zl7pjmcd5egs6oev2bgcfk\r\n==> Fetching https://cache.e4s.io/build_cache/linux-ubuntu18.04-x86_64/gcc-7.5.0/kokkos-3.2.00/linux-ubuntu18.04-x86_64-gcc-7.5.0-kokkos-3.2.00-2ryuvoz7s4zl7pjmcd5egs6oev2bgcfk.spack\r\n################################################################################################################################################## 100.0%\r\n==> Extracting kokkos-3.2.00-2ryuvoz7s4zl7pjmcd5egs6oev2bgcfk from binary cache\r\ngpgconf: socketdir is '/run/user/0/gnupg'\r\ngpg: Signature made Thu 19 Nov 2020 06:51:21 PM UTC\r\ngpg:                using RSA key 7D344E2992071B0AAAE1EDB0E68DE2A80314303D\r\ngpg: Good signature from \"prl\" [unknown]\r\ngpg: WARNING: This key is not certified with a trusted signature!\r\ngpg:          There is no indication that the signature belongs to the owner.\r\nPrimary key fingerprint: 7D34 4E29 9207 1B0A AAE1  EDB0 E68D E2A8 0314 303D\r\n[+] /spack-software/spack_path_placeholder/spack_path_placeholder/sp/linux-ubuntu18.04-x86_64/gcc-7.5.0/kokkos-3.2.00-2ryuvoz7s4zl7pjmcd5egs6oev2bgcfk\r\n==> Error: Failed to install kokkos due to AttributeError: module 'spack.hooks' has no attribute 'sbang'\r\n==> Error: module 'spack.hooks' has no attribute 'sbang'\r\n```\r\n\r\nInstall fails w/ stack trace:\r\n```\r\n$> spack -d install --cache-only -f ./kokkos-p3br7p.yml\r\n...\r\n==> [2020-11-19-20:22:34.676428] Flagging kokkos-3.2.00-2ryuvoz7s4zl7pjmcd5egs6oev2bgcfk as failed: module 'spack.hooks' has no attribute 'sbang'\r\n==> [2020-11-19-20:22:34.677820] Error: Failed to install kokkos due to AttributeError: module 'spack.hooks' has no attribute 'sbang'\r\nTraceback (most recent call last):\r\n  File \"/builds/uo/e4s/spack/bin/spack\", line 66, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/cmd/install.py\", line 370, in install\r\n    install_specs(args, kwargs, zip(abstract_specs, specs))\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/cmd/install.py\", line 212, in install_specs\r\n    builder.install()\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/installer.py\", line 1496, in install\r\n    self._install_task(task)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/installer.py\", line 1064, in _install_task\r\n    full_hash_match):\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/installer.py\", line 276, in _install_from_cache\r\n    spack.hooks.post_install(pkg.spec)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/hooks/__init__.py\", line 59, in __call__\r\n    hook(*args, **kwargs)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/hooks/module_file_generation.py\", line 30, in post_install\r\n    _for_each_enabled(spec, 'write')\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/hooks/module_file_generation.py\", line 22, in _for_each_enabled\r\n    getattr(generator, method_name)()\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/modules/common.py\", line 819, in write\r\n    context = self.context.to_dict()\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/tengine.py\", line 63, in to_dict\r\n    d = [(name, getattr(self, name)) for name in self.context_properties]\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/tengine.py\", line 63, in <listcomp>\r\n    d = [(name, getattr(self, name)) for name in self.context_properties]\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/modules/common.py\", line 672, in environment_modifications\r\n    build_environment.set_module_variables_for_package(self.spec.package)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/build_environment.py\", line 539, in set_module_variables_for_package\r\n    _set_variables_for_single_module(pkg, mod)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/build_environment.py\", line 482, in _set_variables_for_single_module\r\n    m.std_cmake_args = spack.build_systems.cmake.CMakePackage._std_args(pkg)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/build_systems/cmake.py\", line 170, in _std_args\r\n    if pkg.spec.satisfies('^cmake@3.9:'):\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/spec.py\", line 3108, in satisfies\r\n    return self.satisfies_dependencies(other, strict=deps_strict)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/spec.py\", line 3141, in satisfies_dependencies\r\n    if not self[name].satisfies(other[name], deps=False):\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/spec.py\", line 3395, in __getitem__\r\n    return SpecBuildInterface(value, name, query_parameters)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/spec.py\", line 954, in __init__\r\n    is_virtual = spack.repo.path.is_virtual(name)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 713, in is_virtual\r\n    return have_name and pkg_name in self.provider_index\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 571, in provider_index\r\n    self._provider_index.merge(repo.provider_index)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 981, in provider_index\r\n    return self.index['providers']\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 403, in __getitem__\r\n    self._build_all_indexes()\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 418, in _build_all_indexes\r\n    self.indexes[name] = self._build_index(name, indexer)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 448, in _build_index\r\n    indexer.update(namespaced_name)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 330, in update\r\n    if spack.repo.path.is_virtual(name, use_index=False):\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 716, in is_virtual\r\n    self.get_pkg_class(pkg_name).virtual)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 679, in get_pkg_class\r\n    return self.repo_for_pkg(pkg_name).get_pkg_class(pkg_name)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 1126, in get_pkg_class\r\n    module = self._get_pkg_module(pkg_name)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/repo.py\", line 1099, in _get_pkg_module\r\n    prepend=_package_prepend)\r\n  File \"/builds/uo/e4s/spack/lib/spack/spack/util/imp/importlib_importer.py\", line 48, in load_source\r\n    return loader.load_module()\r\n  File \"<frozen importlib._bootstrap_external>\", line 399, in _check_name_wrapper\r\n  File \"<frozen importlib._bootstrap_external>\", line 823, in load_module\r\n  File \"<frozen importlib._bootstrap_external>\", line 682, in load_module\r\n  File \"<frozen importlib._bootstrap>\", line 265, in _load_module_shim\r\n  File \"<frozen importlib._bootstrap>\", line 684, in _load\r\n  File \"<frozen importlib._bootstrap>\", line 665, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 678, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/builds/uo/e4s/spack/var/spack/repos/builtin/packages/gobject-introspection/package.py\", line 8, in <module>\r\n\r\nAttributeError: module 'spack.hooks' has no attribute 'sbang'\r\n```\r\n\r\n<b>There is no problem if I change SPACK_ROOT to `/builds/uo/e4s/spac` !!! I think this is a big clue... Why would the value of $SPACK_ROOT affect whether or not a package can `import spack.hooks.sbang` ? </b>\r\n\r\nAdditionally, moving the `import spack.hooks.sbang as sbang` out of global-scope and into method-scope as is done in the following commit *solves this problem* , although I expect this would just push the ball further down the road.\r\n* 7fb300075c00375aa36b6c96a81dc31539094843\r\n\r\n@becker33 @scheibelp @tgamblin ",
    "performed_via_github_app": null
}