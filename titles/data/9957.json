{
    "url": "https://api.github.com/repos/spack/spack/issues/9957",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/9957/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/9957/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/9957/events",
    "html_url": "https://github.com/spack/spack/issues/9957",
    "id": 384568165,
    "node_id": "MDU6SXNzdWUzODQ1NjgxNjU=",
    "number": 9957,
    "title": "spack package (regcm) is 4 times slower than the hand-built one",
    "user": {
        "login": "bebosudo",
        "id": 1922124,
        "node_id": "MDQ6VXNlcjE5MjIxMjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1922124?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bebosudo",
        "html_url": "https://github.com/bebosudo",
        "followers_url": "https://api.github.com/users/bebosudo/followers",
        "following_url": "https://api.github.com/users/bebosudo/following{/other_user}",
        "gists_url": "https://api.github.com/users/bebosudo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bebosudo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bebosudo/subscriptions",
        "organizations_url": "https://api.github.com/users/bebosudo/orgs",
        "repos_url": "https://api.github.com/users/bebosudo/repos",
        "events_url": "https://api.github.com/users/bebosudo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bebosudo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 460427403,
            "node_id": "MDU6TGFiZWw0NjA0Mjc0MDM=",
            "url": "https://api.github.com/repos/spack/spack/labels/performance",
            "name": "performance",
            "color": "c2e0c6",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2018-11-27T00:27:47Z",
    "updated_at": "2020-02-06T13:07:15Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I'm using spack to build regcm (f602fd8ea4ee5f4e759e15627a67468294cc11e5).\r\nComparing the spack-built with the hand-built version, the spack one is more than 4 times slower.\r\n\r\n\r\n### Steps to reproduce the issue\r\n\r\nI've installed regcm with spack with the following dependencies:\r\n```console\r\n# spack spec -Il regcm  ^hdf5/nbrjtor ^zlib/vonxam4 ^netcdf/7th67uc ^netcdf-fortran/vmbrd6f\r\nInput spec\r\n--------------------------------\r\n...\r\n\r\nConcretized\r\n--------------------------------\r\n[+]  6oggmvo  regcm@4.7.1-SVN6884%intel@18.0.3~debug extension= ~profile~singleprecision arch=linux-centos7-x86_64 \r\n[+]  nbrjtor      ^hdf5@1.10.3%intel@18.0.3~cxx~debug~fortran+hl+mpi+pic+shared~szip~threadsafe arch=linux-centos7-x86_64 \r\n[+]  35ityo3          ^intel-parallel-studio@cluster.2018.3%intel@18.0.3~advisor~clck+daal~gdb~ilp64~inspector+ipp~itac+mkl+mpi~newdtags+rpath+shared+tbb threads=none ~vtune arch=linux-centos7-x86_64 \r\n[+]  vonxam4          ^zlib@1.2.11%intel@18.0.3+optimize+pic+shared arch=linux-centos7-x86_64 \r\n[+]  7th67uc      ^netcdf@4.6.1%intel@18.0.3~dap~hdf4 maxdims=1024 maxvars=8192 +mpi~parallel-netcdf+pic+shared arch=linux-centos7-x86_64 \r\n[+]  vmbrd6f      ^netcdf-fortran@4.4.4%intel@18.0.3+pic arch=linux-centos7-x86_64 \r\n```\r\n\r\nThen I've taken the same dependencies to manually build the package, using also the same configure line (I've only added those CC and FC flags because the configure was choosing the system versions; maybe sourcing the intel shell setup script could help):\r\n```console\r\n$ module load intel-parallel-studio/cluster.2018.3/intel-18.0.3-35ityo3 \\\r\n              hdf5/1.10.3/intel-18.0.3-nbrjtor \\\r\n              netcdf/4.6.1/intel-18.0.3-7th67uc \\\r\n              netcdf-fortran/4.4.4/intel-18.0.3-vmbrd6f \\\r\n              zlib/1.2.11/intel-18.0.3-vonxam4\r\n\r\n$ './configure' 'LDLIBS=-lnetcdff -lnetcdf -lhdf5_hl -lhdf5 -lz' \\\r\n    '--prefix=/path/to/dir/regcm-4.7.1-SVN6884-intel-parallel-studio'  \\\r\n    '--enable-shared' \\\r\n    'MPIFC=/opt/cluster/spack/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-parallel-studio-cluster.2018.3-35ityo3mbfsfhgvtlodnkslmaryj5ezp/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin/mpiifort' \\\r\n    CC=icc FC=ifort\r\n```\r\n\r\nRunning the application causes the time difference in the output files:\r\n```console\r\n$ diff runs_regcm-4.7.1-SVN6884_intel-by_hand_again_1d/submit.o205 runs_regcm-4.7.1-SVN6884_intel-parallel-studio_again_1d/submit.o203\r\n\r\n<  : Total elapsed seconds of run :    96.5349999959545     \r\n---\r\n>  : Total elapsed seconds of run :    401.504635012146     \r\n```\r\nThe computation performed is the same, because the output files are the same.\r\n\r\nI can provide you some input files to regcm, to test this behavior.\r\nThe RegCM version used isn't released yet, but it can be obtained as specified in #9934.\r\n\r\n### Information on your system\r\n\r\nCentos 7, spack git-version 3557b6e14903c02bcc0a19b34c8b4c64f3d05ca3 (but I can update it anytime)\r\n\r\n`compilers.yaml`:\r\n```yaml\r\ncompilers:\r\n... other compilers\r\n\r\n- compiler:\r\n    target:     x86_64\r\n    operating_system:   centos7\r\n    modules:    []\r\n    spec:       intel@18.0.3\r\n    paths:\r\n      cc: /opt/cluster/spack/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-parallel-studio-cluster.2018.3-35ityo3mbfsfhgvtlodnkslmaryj5ezp/compilers_and_libraries_2018.3.222/linux/bin/intel64/icc\r\n      cxx: /opt/cluster/spack/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-parallel-studio-cluster.2018.3-35ityo3mbfsfhgvtlodnkslmaryj5ezp/compilers_and_libraries_2018.3.222/linux/bin/intel64/icpc\r\n      f77: /opt/cluster/spack/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-parallel-studio-cluster.2018.3-35ityo3mbfsfhgvtlodnkslmaryj5ezp/compilers_and_libraries_2018.3.222/linux/bin/intel64/ifort\r\n      fc: /opt/cluster/spack/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-parallel-studio-cluster.2018.3-35ityo3mbfsfhgvtlodnkslmaryj5ezp/compilers_and_libraries_2018.3.222/linux/bin/intel64/ifort\r\n    extra_rpaths:\r\n      - /opt/cluster/spack/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-parallel-studio-cluster.2018.3-35ityo3mbfsfhgvtlodnkslmaryj5ezp/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64/\r\n```\r\n\r\nThis seems to be related to #6712, even though the performance drop is greater than those 30% reported.\r\n\r\nAny idea why are spack executables so slow?",
    "performed_via_github_app": null
}