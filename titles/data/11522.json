{
    "url": "https://api.github.com/repos/spack/spack/issues/11522",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/11522/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/11522/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/11522/events",
    "html_url": "https://github.com/spack/spack/issues/11522",
    "id": 446419992,
    "node_id": "MDU6SXNzdWU0NDY0MTk5OTI=",
    "number": 11522,
    "title": "Issue setting up Spack on Stampede2",
    "user": {
        "login": "qobilidop",
        "id": 5176695,
        "node_id": "MDQ6VXNlcjUxNzY2OTU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5176695?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/qobilidop",
        "html_url": "https://github.com/qobilidop",
        "followers_url": "https://api.github.com/users/qobilidop/followers",
        "following_url": "https://api.github.com/users/qobilidop/following{/other_user}",
        "gists_url": "https://api.github.com/users/qobilidop/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/qobilidop/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/qobilidop/subscriptions",
        "organizations_url": "https://api.github.com/users/qobilidop/orgs",
        "repos_url": "https://api.github.com/users/qobilidop/repos",
        "events_url": "https://api.github.com/users/qobilidop/events{/privacy}",
        "received_events_url": "https://api.github.com/users/qobilidop/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 512483297,
            "node_id": "MDU6TGFiZWw1MTI0ODMyOTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/impact-low",
            "name": "impact-low",
            "color": "fef2c0",
            "default": false,
            "description": ""
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 7,
    "created_at": "2019-05-21T05:13:07Z",
    "updated_at": "2019-07-16T15:54:34Z",
    "closed_at": "2019-07-16T15:54:34Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I'm trying to set up Spack on Stampede2, with system Intel compiler and MPI, but couldn't make it work. I have asked for help [on the mailing list](https://groups.google.com/d/msg/spack/VSZqELYczok/09O4TV13AgAJ), but didn't get it resolved there. Probably email is not as effective a media as GitHub issue tracker for this kind of discussion. So I decided to report it here.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install mpi\r\n==> intel-mpi@2018.2.199 : has external module in impi/18.0.2\r\n==> intel-mpi@2018.2.199 : is actually installed in /opt/intel/compilers_and_libraries_2018.2.199/linux/mpi/intel64\r\n==> intel-mpi@2018.2.199 : generating module file\r\n('debug', '() {  if [ -z \"${LMOD_SH_DBG_ON+x}\" ]; then\\n case \"$-\" in \\n *v*x*)\\n __lmod_sh_dbg=\\'vx\\'\\n ;;\\n *v*)\\n __lmod_sh_dbg=\\'v\\'\\n ;;\\n *x*)\\n __lmod_sh_dbg=\\'x\\'\\n ;;\\n esac;\\n fi;\\n if [ -n \"${__lmod_sh_dbg')\r\n==> Error: Error: unterminated ${ in format:'() {  if [ -z \"${LMOD_SH_DBG_ON+x}\" ]; then\r\n case \"$-\" in \r\n *v*x*)\r\n __lmod_sh_dbg='vx'\r\n ;;\r\n *v*)\r\n __lmod_sh_dbg='v'\r\n ;;\r\n *x*)\r\n __lmod_sh_dbg='x'\r\n ;;\r\n esac;\r\n fi;\r\n if [ -n \"${__lmod_sh_dbg'\r\n```\r\n\r\n### Error Message\r\n\r\n```console\r\n$ spack -d --stacktrace install mpi\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.068180] Reading config file /home1/03560/tg828592/opt/spack/etc/spack/defaults/modules.yaml\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.075014] Reading config file /home1/03560/tg828592/opt/spack/etc/spack/defaults/linux/modules.yaml\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.077788] Reading config file /home1/03560/tg828592/opt/spack/etc/spack/defaults/config.yaml\r\nlib/spack/spack/cmd/__init__.py:98 ==> [2019-05-21-00:04:23.092772] Imported install from built-in commands\r\nlib/spack/spack/cmd/__init__.py:98 ==> [2019-05-21-00:04:23.093802] Imported install from built-in commands\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.102649] Reading config file /home1/03560/tg828592/opt/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.175080] READ LOCK: /home1/03560/tg828592/.spack/cache/tags/.builtin-index.json.lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.175764] READ LOCK: /home1/03560/tg828592/.spack/cache/tags/.builtin-index.json.lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.176624] READ LOCK: /home1/03560/tg828592/.spack/cache/tags/.builtin-index.json.lock[0:0] [Released]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.178966] READ LOCK: /home1/03560/tg828592/.spack/cache/patches/.builtin-index.json.lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.179620] READ LOCK: /home1/03560/tg828592/.spack/cache/patches/.builtin-index.json.lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.187958] READ LOCK: /home1/03560/tg828592/.spack/cache/patches/.builtin-index.json.lock[0:0] [Released]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.190317] READ LOCK: /home1/03560/tg828592/.spack/cache/providers/.builtin-index.json.lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.190948] READ LOCK: /home1/03560/tg828592/.spack/cache/providers/.builtin-index.json.lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.207350] READ LOCK: /home1/03560/tg828592/.spack/cache/providers/.builtin-index.json.lock[0:0] [Released]\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.215037] Reading config file /home1/03560/tg828592/opt/spack/etc/spack/defaults/packages.yaml\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.225054] Reading config file /home1/03560/tg828592/.spack/packages.yaml\r\nlib/spack/spack/config.py:683 ==> [2019-05-21-00:04:23.256745] Reading config file /home1/03560/tg828592/.spack/compilers.yaml\r\nlib/spack/spack/util/module_cmd.py:112 ==> [2019-05-21-00:04:23.429715] Module name: impi/18.0.2\r\nlib/spack/spack/util/module_cmd.py:119 ==> [2019-05-21-00:04:23.430045] Package directory variable prefix: IMPI\r\nlib/spack/spack/package.py:1280 ==> [2019-05-21-00:04:23.433942] intel-mpi@2018.2.199 : has external module in impi/18.0.2\r\nlib/spack/spack/package.py:1282 ==> [2019-05-21-00:04:23.434177] intel-mpi@2018.2.199 : is actually installed in /opt/intel/compilers_and_libraries_2018.2.199/linux/mpi/intel64\r\nlib/spack/spack/database.py:214 ==> [2019-05-21-00:04:23.436924] DATABASE LOCK TIMEOUT: 120s\r\nlib/spack/spack/database.py:218 ==> [2019-05-21-00:04:23.437221] PACKAGE LOCK TIMEOUT: No timeout\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.437929] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.438622] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.440015] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.440560] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.441202] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.442337] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\nlib/spack/spack/package.py:1300 ==> [2019-05-21-00:04:23.443226] intel-mpi@2018.2.199 : generating module file\r\nlib/spack/spack/hooks/sbang.py:102 ==> [2019-05-21-00:04:23.443938] SKIP: shebang filtering [external package]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.444753] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.445396] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.446628] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.447245] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.447963] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.449151] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\nlib/spack/spack/modules/common.py:709 ==> [2019-05-21-00:04:23.450514]  WRITE: intel-mpi@2018.2.199%intel@18.0.2 arch=linux-centos7-x86_64/gzav7jv [/home1/03560/tg828592/opt/spack/share/spack/modules/linux-centos7-x86_64/intel-mpi-2018.2.199-intel-18.0.2-gzav7jv]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.466402] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquiring]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.467111] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Acquired]\r\nlib/spack/llnl/util/lock.py:334 ==> [2019-05-21-00:04:23.468208] READ LOCK: /home1/03560/tg828592/opt/spack/opt/spack/.spack-db/lock[0:0] [Released]\r\nlib/spack/spack/build_systems/intel.py:41 ==> [2019-05-21-00:04:23.501325] normalize_path.normalize_suite_dir:  /opt/intel/compilers_and_libraries_2018.2.199\r\nlib/spack/spack/build_systems/intel.py:41 ==> [2019-05-21-00:04:23.502480] file_to_source.normalize_path:       /opt/intel/compilers_and_libraries_2018.2.199/linux/mpi/intel64/bin/mpivars.sh\r\nlib/spack/spack/build_systems/intel.py:1002 ==> [2019-05-21-00:04:23.502765] sourcing /opt/intel/compilers_and_libraries_2018.2.199/linux/mpi/intel64/bin/mpivars.sh\r\n('debug', '() {  if [ -z \"${LMOD_SH_DBG_ON+x}\" ]; then\\n case \"$-\" in \\n *v*x*)\\n __lmod_sh_dbg=\\'vx\\'\\n ;;\\n *v*)\\n __lmod_sh_dbg=\\'v\\'\\n ;;\\n *x*)\\n __lmod_sh_dbg=\\'x\\'\\n ;;\\n esac;\\n fi;\\n if [ -n \"${__lmod_sh_dbg')\r\nTraceback (most recent call last):\r\n  File \"/home1/03560/tg828592/opt/spack/bin/spack\", line 48, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/main.py\", line 695, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/main.py\", line 446, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/cmd/install.py\", line 334, in install\r\n    install_spec(args, kwargs, abstract, concrete)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/cmd/install.py\", line 206, in install_spec\r\n    install(spec, kwargs)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/cmd/install.py\", line 195, in install\r\n    spec.package.do_install(**kwargs)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/package.py\", line 1406, in do_install\r\n    return self._process_external_package(explicit)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/package.py\", line 1301, in _process_external_package\r\n    spack.hooks.post_install(self.spec)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/hooks/__init__.py\", line 54, in __call__\r\n    hook(*args, **kwargs)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/hooks/module_file_generation.py\", line 29, in <lambda>\r\n    post_install = lambda spec: _for_each_enabled(spec, 'write')\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/hooks/module_file_generation.py\", line 22, in _for_each_enabled\r\n    getattr(generator, method_name)()\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/modules/common.py\", line 735, in write\r\n    context = self.context.to_dict()\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/tengine.py\", line 67, in to_dict\r\n    d = [(name, getattr(self, name)) for name in self.context_properties]\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/modules/common.py\", line 615, in environment_modifications\r\n    x.value = self.spec.format(x.value)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/spec.py\", line 3107, in format\r\n    return self.old_format(format_string, **kwargs)\r\n  File \"/home1/03560/tg828592/opt/spack/lib/spack/spack/spec.py\", line 3419, in old_format\r\n    \"'%s'\" % format_string)\r\nValueError: Error: unterminated ${ in format:'() {  if [ -z \"${LMOD_SH_DBG_ON+x}\" ]; then\r\n case \"$-\" in \r\n *v*x*)\r\n __lmod_sh_dbg='vx'\r\n ;;\r\n *v*)\r\n __lmod_sh_dbg='v'\r\n ;;\r\n *x*)\r\n __lmod_sh_dbg='x'\r\n ;;\r\n esac;\r\n fi;\r\n if [ -n \"${__lmod_sh_dbg'\r\n```\r\n\r\n### Information on your system\r\n\r\nplatform: [Stampede2](https://www.tacc.utexas.edu/systems/stampede2)\r\n\r\n```console\r\n$ module list\r\n\r\nCurrently Loaded Modules:\r\n  1) git/2.9.0       3) cmake/3.10.2   5) TACC           7) libfabric/1.7.0   9) python2/2.7.15\r\n  2) autotools/1.1   4) xalt/2.6.5     6) intel/18.0.2   8) impi/18.0.2\r\n```\r\n\r\n`compilers.yaml`:\r\n```yaml\r\ncompilers:\r\n- compiler:\r\n    environment: {}\r\n    extra_rpaths: []\r\n    flags: {}\r\n    modules: []\r\n    operating_system: centos7\r\n    paths:\r\n      cc: /opt/intel/compilers_and_libraries_2018.2.199/linux/bin/intel64/icc\r\n      cxx: /opt/intel/compilers_and_libraries_2018.2.199/linux/bin/intel64/icpc\r\n      f77: /opt/intel/compilers_and_libraries_2018.2.199/linux/bin/intel64/ifort\r\n      fc: /opt/intel/compilers_and_libraries_2018.2.199/linux/bin/intel64/ifort\r\n    spec: intel@18.0.2\r\n    target: x86_64\r\n```\r\n\r\n`packages.yaml`:\r\n```yaml\r\npackages:\r\n  all:\r\n    compiler: [intel]\r\n    providers:\r\n      mpi: [intel-mpi]\r\n  intel-mpi:\r\n    buildable: False\r\n    modules:\r\n      intel-mpi@2018.2.199: impi/18.0.2\r\n```\r\n",
    "performed_via_github_app": null
}