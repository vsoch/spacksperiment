{
    "url": "https://api.github.com/repos/spack/spack/issues/24049",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24049/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24049/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24049/events",
    "html_url": "https://github.com/spack/spack/pull/24049",
    "id": 907750048,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NjU4NTQ2NTI1",
    "number": 24049,
    "title": "Ensure uniqueness of install prefixes in the database",
    "user": {
        "login": "haampie",
        "id": 194764,
        "node_id": "MDQ6VXNlcjE5NDc2NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/194764?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/haampie",
        "html_url": "https://github.com/haampie",
        "followers_url": "https://api.github.com/users/haampie/followers",
        "following_url": "https://api.github.com/users/haampie/following{/other_user}",
        "gists_url": "https://api.github.com/users/haampie/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/haampie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/haampie/subscriptions",
        "organizations_url": "https://api.github.com/users/haampie/orgs",
        "repos_url": "https://api.github.com/users/haampie/repos",
        "events_url": "https://api.github.com/users/haampie/events{/privacy}",
        "received_events_url": "https://api.github.com/users/haampie/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 456341797,
            "node_id": "MDU6TGFiZWw0NTYzNDE3OTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/tests",
            "name": "tests",
            "color": "b60205",
            "default": false,
            "description": "General test capability(ies)"
        },
        {
            "id": 729584669,
            "node_id": "MDU6TGFiZWw3Mjk1ODQ2Njk=",
            "url": "https://api.github.com/repos/spack/spack/labels/update-package",
            "name": "update-package",
            "color": "c68137",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 4,
    "created_at": "2021-05-31T23:07:10Z",
    "updated_at": "2021-06-30T08:16:25Z",
    "closed_at": "2021-06-29T21:44:56Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/24049",
        "html_url": "https://github.com/spack/spack/pull/24049",
        "diff_url": "https://github.com/spack/spack/pull/24049.diff",
        "patch_url": "https://github.com/spack/spack/pull/24049.patch"
    },
    "body": "This pr handles install prefix collisions slightly better, and makes it such that the database can be used better as the 'source of truth' for what packages are installed.\r\n\r\nWith this PR if you install 2 packages `zlib~shared` and `zlib+shared` with projections that map these packages to the same directory, you get this:\r\n\r\n```\r\n$ spack -c \"config:install_tree:root:$PWD\" -c 'config:install_tree:projections:all:${PACKAGE}' install zlib~shared\r\n...\r\n==> zlib: Successfully installed zlib-1.2.11-k5l7ccyobzhdyxt3wpzzxgyy5va636sq\r\n  Fetch: 0.16s.  Build: 0.58s.  Total: 0.74s.\r\n[+] /tmp/tmp.EvXHRNxOxj/zlib\r\n\r\n$ spack -c \"config:install_tree:root:$PWD\" -c 'config:install_tree:projections:all:${PACKAGE}' install zlib+shared\r\n==> Error: <not overwriting install prefix from different spec>\r\n```\r\n\r\nPreviously spack would delete the prefix directory of `zlib~shared` without warning, and you would end up with a missing install and a corrupted database where two zlib's would share the same install prefix.\r\n\r\nThis PR still handles partial installs (running spack install --keep-prefix xyz multiple times for a failing build where the build touches the install dir and you want to keep all that), since in that case the spec is not marked installed in the db, nor is the prefix path listed as available.\r\n\r\nFinally it supersedes https://github.com/spack/spack/pull/24005, since with the install prefix collision check, we can discriminate between \"the directory looks like a spack install of some package\" and \"the directory belongs to an installed spec\".\r\n\r\nEdit: would be nice to get some feedback to see if this is going in the right direction before adding better error handling and tests.\r\n",
    "performed_via_github_app": null
}