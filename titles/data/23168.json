{
    "url": "https://api.github.com/repos/spack/spack/issues/23168",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/23168/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/23168/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/23168/events",
    "html_url": "https://github.com/spack/spack/issues/23168",
    "id": 863912199,
    "node_id": "MDU6SXNzdWU4NjM5MTIxOTk=",
    "number": 23168,
    "title": "Spack re-installing an already-installed dependency then complaining about same SHA-1",
    "user": {
        "login": "mdorier",
        "id": 598250,
        "node_id": "MDQ6VXNlcjU5ODI1MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/598250?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mdorier",
        "html_url": "https://github.com/mdorier",
        "followers_url": "https://api.github.com/users/mdorier/followers",
        "following_url": "https://api.github.com/users/mdorier/following{/other_user}",
        "gists_url": "https://api.github.com/users/mdorier/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mdorier/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mdorier/subscriptions",
        "organizations_url": "https://api.github.com/users/mdorier/orgs",
        "repos_url": "https://api.github.com/users/mdorier/repos",
        "events_url": "https://api.github.com/users/mdorier/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mdorier/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 512483390,
            "node_id": "MDU6TGFiZWw1MTI0ODMzOTA=",
            "url": "https://api.github.com/repos/spack/spack/labels/impact-medium",
            "name": "impact-medium",
            "color": "fef2c0",
            "default": false,
            "description": ""
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 5,
    "created_at": "2021-04-21T13:47:36Z",
    "updated_at": "2021-04-23T21:49:28Z",
    "closed_at": "2021-04-23T21:49:28Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "Note: I'm filing this issue as a bug report rather than an installation issue of the argobots package because I do think the package is correct and Spack is actually faulty here.\r\n\r\nSince the recent change to the Argobots package (https://github.com/spack/spack/pull/23133) which in particular added the `stackguard` variant, I see the following problem when installing any package that depends on argobots: the first package I install will build and install fine, building the following spec of argobots as a dependency:\r\n\r\n```\r\nargobots@1.1%gcc@8.2.1~affinity~debug+perf~stackunwind~tool~valgrind stackguard=no arch=linux-ubuntu16.04-skylake\r\n```\r\nWhich ends up installed as `argobots-1.1-u2glvj7qojowtqmzi4j6us3gxikg72ke`.\r\n\r\nThen I install a second package that depends on argobots. I see the exact same argobots dependency needed, yet spack is rebuilding it and reinstalling it, with the same hash. During this installation process, I get a warning:\r\n\r\n```\r\n==> Warning: Module file already exists : skipping creation\r\nfile : /nfs2/mdorier/spack/share/spack/modules/linux-ubuntu16.04-skylake/argobots-1.1-gcc-8.2.1-u2glvj7\r\nspec : argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackunwind~tool~valgrind stackguard=no arch=linux-ubuntu16.04-skylake\r\n```\r\n\r\nThen I install a third package that depends on argobots. This time it fails right away with this error:\r\n```\r\n==> Error: Specs argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackunwind~tool~valgrind stackguard=no arch=linux-ubuntu16.04-skylake and argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackguard~stackunwind~tool~valgrind arch=linux-ubuntu16.04-skylake have the same SHA-1 prefix!\r\n```\r\n\r\nThis is a fresh installation of spack, and nothing in my packages.yaml or other configuration files to interfere. I have no idea why spack talks about a `~stackguard` variant in the last error message even though `stackguard` is a value-based variant, not a boolean one.\r\n\r\n\r\n### Steps to reproduce the issue\r\n\r\nYou can easily reproduce this issue for instance by taking multiple versions of the mochi-margo package, which depends on argobots, as follows (though I have experienced this problem with pretty much any package that depends on argobots).\r\n\r\n```console\r\n$ spack install mochi-margo@0.9.4 ^mercury~boostsys\r\n$ spack install mochi-margo@0.9.3 ^mercury~boostsys\r\n$ spack install mochi-margo@0.9.2 ^mercury~boostsys\r\n```\r\n\r\n### Error Message\r\n\r\n<!-- If Spack reported an error, provide the error message. If it did not report an error but the output appears incorrect, provide the incorrect output. If there was no error message and no output but the result is incorrect, describe how it does not match what you expect. -->\r\n```console\r\n$ spack --debug --stacktrace install mochi-margo@0.9.2 ^mercury~boostsys\r\n\r\nnfs2/mdorier/spack/lib/spack/spack/installer.py:1872 ==> [2021-04-21-08:45:20.168908] - mercury-2.0.0-tpsjnnzzvnoa6fu7plgscmaggzizliy5\r\nnfs2/mdorier/spack/lib/spack/spack/installer.py:1870 ==> [2021-04-21-08:45:20.182918] Pkg id mercury-2.0.0-tpsjnnzzvnoa6fu7plgscmaggzizliy5 has the following dependents:\r\nnfs2/mdorier/spack/lib/spack/spack/installer.py:1872 ==> [2021-04-21-08:45:20.183178] - mochi-margo-0.9.2-xvj7oakacuvsigkxudndfdywp2ekggir\r\nnfs2/mdorier/spack/lib/spack/spack/installer.py:1870 ==> [2021-04-21-08:45:20.229337] Pkg id mochi-margo-0.9.2-xvj7oakacuvsigkxudndfdywp2ekggir has the following dependents:\r\nnfs2/mdorier/spack/lib/spack/spack/installer.py:1407 ==> [2021-04-21-08:45:20.230897] Ensure all dependencies know all dependents across specs\r\nnfs2/mdorier/spack/lib/spack/spack/installer.py:961 ==> [2021-04-21-08:45:20.246422] Acquiring a write lock on argobots-1.1-u2glvj7qojowtqmzi4j6us3gxikg72ke with timeout 1e-09\r\nnfs2/mdorier/spack/lib/spack/spack/stage.py:313 ==> [2021-04-21-08:45:20.266243] Creating stage lock spack-stage-argobots-1.1-u2glvj7qojowtqmzi4j6us3gxikg72ke\r\nnfs2/mdorier/spack/lib/spack/spack/main.py:775 ==> [2021-04-21-08:45:20.285905] SpecHashCollisionError: Specs argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackunwind~tool~valgrind stackguard=no arch=linux-ubuntu16.04-skylake and argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackguard~stackunwind~tool~valgrind arch=linux-ubuntu16.04-skylake have the same SHA-1 prefix!\r\nnfs2/mdorier/spack/lib/spack/spack/error.py:55 ==> [2021-04-21-08:45:20.300089] Error: Specs argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackunwind~tool~valgrind stackguard=no arch=linux-ubuntu16.04-skylake and argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackguard~stackunwind~tool~valgrind arch=linux-ubuntu16.04-skylake have the same SHA-1 prefix!\r\nTraceback (most recent call last):\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/main.py\", line 772, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/main.py\", line 496, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/cmd/install.py\", line 406, in install\r\n    install_specs(args, kwargs, zip(abstract_specs, specs))\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/cmd/install.py\", line 216, in install_specs\r\n    builder.install()\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/installer.py\", line 1513, in install\r\n    self._prepare_for_install(task)\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/installer.py\", line 832, in _prepare_for_install\r\n    if not partial and self.layout.check_installed(task.pkg.spec) and (\r\n  File \"/nfs2/mdorier/spack/lib/spack/spack/directory_layout.py\", line 375, in check_installed\r\n    raise SpecHashCollisionError(spec, installed_spec)\r\nspack.directory_layout.SpecHashCollisionError: Specs argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackunwind~tool~valgrind stackguard=no arch=linux-ubuntu16.04-skylake and argobots@1.1%gcc@8.2.1~affinity~debug+perf~stackguard~stackunwind~tool~valgrind arch=linux-ubuntu16.04-skylake have the same SHA-1 prefix!\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.1-2330-8182994\r\n* **Python:** 3.5.2\r\n* **Platform:** linux-ubuntu16.04-skylake\r\n* **Concretizer:** original\r\n\r\nThis problem was repeated on multiple other systems.\r\n\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "performed_via_github_app": null
}