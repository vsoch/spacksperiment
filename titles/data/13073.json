{
    "url": "https://api.github.com/repos/spack/spack/issues/13073",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/13073/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/13073/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/13073/events",
    "html_url": "https://github.com/spack/spack/issues/13073",
    "id": 504119759,
    "node_id": "MDU6SXNzdWU1MDQxMTk3NTk=",
    "number": 13073,
    "title": "zen vs zen2 inconsitency breaks modules() in spack load",
    "user": {
        "login": "bassenj",
        "id": 16454215,
        "node_id": "MDQ6VXNlcjE2NDU0MjE1",
        "avatar_url": "https://avatars.githubusercontent.com/u/16454215?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bassenj",
        "html_url": "https://github.com/bassenj",
        "followers_url": "https://api.github.com/users/bassenj/followers",
        "following_url": "https://api.github.com/users/bassenj/following{/other_user}",
        "gists_url": "https://api.github.com/users/bassenj/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bassenj/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bassenj/subscriptions",
        "organizations_url": "https://api.github.com/users/bassenj/orgs",
        "repos_url": "https://api.github.com/users/bassenj/repos",
        "events_url": "https://api.github.com/users/bassenj/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bassenj/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1574436554,
            "node_id": "MDU6TGFiZWwxNTc0NDM2NTU0",
            "url": "https://api.github.com/repos/spack/spack/labels/microarchitectures",
            "name": "microarchitectures",
            "color": "011970",
            "default": false,
            "description": ""
        },
        {
            "id": 446632829,
            "node_id": "MDU6TGFiZWw0NDY2MzI4Mjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/modules",
            "name": "modules",
            "color": "fef2c0",
            "default": false,
            "description": null
        },
        {
            "id": 446623896,
            "node_id": "MDU6TGFiZWw0NDY2MjM4OTY=",
            "url": "https://api.github.com/repos/spack/spack/labels/platform-support",
            "name": "platform-support",
            "color": "bfdadc",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2019-10-08T15:34:51Z",
    "updated_at": "2019-10-21T18:20:06Z",
    "closed_at": "2019-10-21T18:20:06Z",
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "After having some problem with the latest release, I was trying the current develop 66b9009a0713f9ce1d63f518ab1528af7587eaa5 branch.\r\n\r\nHowever, on develop, there seems to be an inconsistency with the architecture, that prohibits the use of `modules`. As a consequence, `spack load` does not work anymore. The issue is related to my architecture, Ubuntu 19.04 with kernel 5.3.0-050300rc3-generic, running on a Ryzen 3900X processor. I did not have the issue with a previous commit from the develop branch from one or two months ago. At that time my architecture was recognized as `linux-ubuntu19.04-x86_64`.\r\n\r\n### Steps to reproduce the issue\r\n\r\nI started with a fresh clone and did the bootstrapping. The first use of `spack load` fails\r\n```console\r\n$ git clone https://github.com/spack/spack.git\r\n$ export SPACK_ROOT=/opt/spack\r\n$ export PATH=$SPACK_ROOT/bin:$PATH\r\n$ source $SPACK_ROOT/share/spack/setup-env.sh\r\n$ export SPACK_SHELL=\"bash\"\r\n$ export EDITOR=\"vim\"\r\n$ spack bootstrap\r\n...\r\n$ spack load tcl\r\nmodule: command not found\r\n```\r\n\r\n### Error Message\r\n\r\n`module` should be a bash function, which it isn't here.\r\n```console\r\n$ type module\r\n-bash: type: module: not found\r\n$ spack find\r\n==> 3 installed packages\r\n-- linux-ubuntu19.04-zen / gcc@8.3.0 ----------------------------\r\nenvironment-modules@4.3.1  tcl@8.6.8  zlib@1.2.11\r\n$ spack --print-shell-vars modules\r\n_sp_sys_type='linux-ubuntu19.04-zen2'\r\n_sp_compatible_sys_types='linux-ubuntu19.04-zen2:linux-ubuntu19.04-zen:linux-ubuntu19.04-x86_64'\r\n_sp_tcl_roots='/opt/spack/share/spack/modules'\r\n_sp_lmod_roots='/opt/spack/share/spack/lmod'\r\n_sp_module_prefix='not_installed'\r\n```\r\nIt is notable, that `find` shows the architecture as `zen`, whereas `--print-shell-vars modules` shows the architecture as `zen2`. 'not_installed' is the result of this inconsistency and breaks `spack load`.\r\n\r\nChecking the difference in `main.py` reveals:\r\n```python\r\nprint('specs=%s' % spack.store.db.query('environment-modules arch=linux-ubuntu19.04-zen'))\r\n>> specs=[environment-modules@4.3.1%gcc@8.3.0~X arch=linux-ubuntu19.04-zen ^tcl@8.6.8%gcc@8.3.0 arch=linux-ubuntu19.04-zen ^zlib@1.2.11%gcc@8.3.0+optimize+pic+shared arch=linux-ubuntu19.04-zen]\r\n```\r\n```python\r\nprint('specs=%s' % spack.store.db.query('environment-modules arch=linux-ubuntu19.04-zen2'))\r\n>> specs=[]\r\n```\r\nThe latter happens in my case. The architecture is checked since e5b86c5527c458df7434c499842d659dd086b7f8 and microarchitectures are available since 3c4322bf1abb7af691179434652188b64e90e4dc.\r\n\r\nI don't know where the decision about the architecture is made but the inconsistency, that I have shown, prevents `spack load` from working.",
    "performed_via_github_app": null
}