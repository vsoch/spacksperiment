{
    "url": "https://api.github.com/repos/spack/spack/issues/17679",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/17679/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/17679/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/17679/events",
    "html_url": "https://github.com/spack/spack/issues/17679",
    "id": 664579841,
    "node_id": "MDU6SXNzdWU2NjQ1Nzk4NDE=",
    "number": 17679,
    "title": "spack pipeline issue with spack env activate",
    "user": {
        "login": "shahzebsiddiqui",
        "id": 12942230,
        "node_id": "MDQ6VXNlcjEyOTQyMjMw",
        "avatar_url": "https://avatars.githubusercontent.com/u/12942230?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/shahzebsiddiqui",
        "html_url": "https://github.com/shahzebsiddiqui",
        "followers_url": "https://api.github.com/users/shahzebsiddiqui/followers",
        "following_url": "https://api.github.com/users/shahzebsiddiqui/following{/other_user}",
        "gists_url": "https://api.github.com/users/shahzebsiddiqui/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/shahzebsiddiqui/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/shahzebsiddiqui/subscriptions",
        "organizations_url": "https://api.github.com/users/shahzebsiddiqui/orgs",
        "repos_url": "https://api.github.com/users/shahzebsiddiqui/repos",
        "events_url": "https://api.github.com/users/shahzebsiddiqui/events{/privacy}",
        "received_events_url": "https://api.github.com/users/shahzebsiddiqui/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2020-07-23T15:37:57Z",
    "updated_at": "2020-07-23T17:16:29Z",
    "closed_at": "2020-07-23T17:16:28Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "@scottwittenburg \r\nThis is my .gitlab-ci.yml trying to build at Cori \r\n\r\n\r\n```\r\nvariables:\r\n  SCHEDULER_PARAMETERS: \"-C haswell -M escori -q xfer -N1 -t 48:00:00\"\r\n  SPACK_REPO: \"https://github.com/spack/spack.git\"\r\n  SPACK_REF: \"develop\"  \r\n   \r\nstages:\r\n  - build\r\n  - prod\r\n\r\nsetup-spackpipeline:\r\n  stage: build\r\n  tags: [cori]\r\n  before_script:\r\n  - pwd\r\n  - git clone ${SPACK_REPO} --branch ${SPACK_REF} --depth=1\r\n  - cd spack\r\n  - git log  --oneline -1\r\n  - . share/spack/setup-env.sh\r\n  script:\r\n  - hostname\r\n  - spack env activate .\r\n  - spack concretize -f 2>&1 | tee concretize.log\r\n  - spack -d ci generate --optimize --output-file pipeline.yml \r\n  after_script:\r\n  - rm -rf ./spack/\r\n  artifacts:\r\n    paths:\r\n    - concretize.log\r\n    - pipeline.yml\r\n\r\n\r\nbuild-spackpipeline:\r\n  stage: prod\r\n  trigger:\r\n    include:\r\n    - artifact: \"pipeline.yml\"\r\n      job: setup-spackpipeline\r\n    strategy: depend\r\n\r\n```\r\n\r\nShown below is my `spack.yaml`\r\n\r\n```\r\n# This is a Spack Environment file.\r\n#\r\n# It describes a set of packages to be installed, along with\r\n# configuration settings.\r\nspack:\r\n  concretization: separately\r\n  view: false\r\n  config:\r\n    install_tree: $spack/$padding:512\r\n    build_stage: $tempdir/$user/spack-stage\r\n  mirrors:\r\n    local: /global/common/software/spackecp/mirror\r\n\r\n  definitions:\r\n  - e4s:    \r\n    # - adios\r\n    #- adios2\r\n    #- aml\r\n    #- bolt\r\n    #- caliper\r\n    #- darshan-runtime\r\n    #- darshan-util\r\n    #- dyninst\r\n    #- faodel\r\n    #- flecsi+cinch\r\n    #- globalarrays\r\n    #- gotcha\r\n    #- hdf5\r\n    #- hpctoolkit\r\n    #- hypre\r\n    #- kokkos-kernels\r\n    #- kokkos+openmp\r\n    #- libnrm\r\n    #- libquo\r\n    #- mercury\r\n    #- mfem\r\n    #- ninja\r\n    #- openmpi\r\n    #- openpmd-api\r\n    #- papi\r\n    #- papyrus@develop\r\n    #- parallel-netcdf\r\n    #- pdt\r\n    #- petsc\r\n    #- py-jupyterhub\r\n    #- py-libensemble\r\n    #- qthreads\r\n    #- raja\r\n    #- rempi\r\n    #- scr\r\n    #- strumpack\r\n    #- sundials\r\n    #- superlu\r\n    #- superlu-dist\r\n    #- sz\r\n    #- tasmanian\r\n    #- tau\r\n    #- trilinos\r\n    #- turbine\r\n    #- umpire\r\n    #- unifyfs\r\n    #- upcxx\r\n    #- veloc\r\n    #- zfp\r\n    - aml\r\n    - darshan-runtime\r\n    - darshan-util\r\n  \r\n  - arch:\r\n    - '%intel@19.0.3.199 arch=cray-cnl7-haswell'\r\n  \r\n  specs:\r\n    - matrix:\r\n      - - $e4s\r\n      - - $arch\r\n \r\n\r\n  packages:\r\n    all:\r\n      compiler: [intel@19.0.3.199]\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      paths: {}\r\n      modules: {}\r\n      buildable: true\r\n\r\n  gitlab-ci:\r\n    mappings:\r\n      - match: ['os=cnl7']\r\n        runner-attributes:\r\n          tags:\r\n          - cori\r\n          script:\r\n          - export SPACK_GNUPGHOME=$HOME/.gnugpghome-spack\r\n          - hostname\r\n          - mkdir -p artifacts\r\n          - env > artifacts/env.sh\r\n          - git clone ${SPACK_REPO} --branch ${SPACK_REF}\r\n          - . spack/share/spack/setup-env.sh\r\n          - spack compiler find\r\n          - spack -d -e . ci rebuild\r\n  \r\n    enable-artifacts-buildcache: False\r\n```\r\n\r\nThe ``spack env activate .`` doesn't work anymore .\r\n\r\nHere is the snapshot build at https://software.nersc.gov/ecp/spack-ecp/-/jobs/17290\r\n\r\n```\r\n$ cd spack\r\n$ git log  --oneline -1\r\nf42394d csa-c: added new package at master (#17676)\r\n$ . share/spack/setup-env.sh\r\n$ hostname\r\ncori01\r\n$ spack env activate .\r\n==> Error: No such environment: '.'\r\n$ spack concretize -f 2>&1 | tee concretize.log\r\n==> Error: `spack concretize` requires an environment\r\n  activate an environment first:\r\n      spack env activate ENV\r\n  or use:\r\n      spack -e ENV concretize ...\r\nRunning after script...\r\n$ rm -rf ./spack/\r\n```\r\n\r\nI am trying to figure out if i should create an environment name, if so can it be same name?  Should i run ``spack env create e4s spack.yaml``. Will this work for every spack build, i presume each gitlab job will invoke ``before_script`` which will clone spack in a unique path.\r\n\r\nDue to some changes with `spack env activate` the documentation examples in https://spack.readthedocs.io/en/latest/pipelines.html will not work and require update.",
    "performed_via_github_app": null
}