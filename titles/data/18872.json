{
    "url": "https://api.github.com/repos/spack/spack/issues/18872",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/18872/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/18872/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/18872/events",
    "html_url": "https://github.com/spack/spack/issues/18872",
    "id": 706621425,
    "node_id": "MDU6SXNzdWU3MDY2MjE0MjU=",
    "number": 18872,
    "title": "py-torchvision and CUDA",
    "user": {
        "login": "glennpj",
        "id": 16138574,
        "node_id": "MDQ6VXNlcjE2MTM4NTc0",
        "avatar_url": "https://avatars.githubusercontent.com/u/16138574?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glennpj",
        "html_url": "https://github.com/glennpj",
        "followers_url": "https://api.github.com/users/glennpj/followers",
        "following_url": "https://api.github.com/users/glennpj/following{/other_user}",
        "gists_url": "https://api.github.com/users/glennpj/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/glennpj/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/glennpj/subscriptions",
        "organizations_url": "https://api.github.com/users/glennpj/orgs",
        "repos_url": "https://api.github.com/users/glennpj/repos",
        "events_url": "https://api.github.com/users/glennpj/events{/privacy}",
        "received_events_url": "https://api.github.com/users/glennpj/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2020-09-22T19:02:55Z",
    "updated_at": "2021-04-12T21:12:35Z",
    "closed_at": "2021-04-12T21:12:35Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "<!-- Explain, in a clear and concise way, the command you ran and the result you were trying to achieve.\r\nExample: \"I ran `spack find` to list all the installed packages and ...\" -->\r\n\r\nNot sure if this should be a Bug Report or a Build Error issue. My build host has the nvidia driver and CUDA libraries installed and I build cuda enabled packages on it. When building py-torchvision, there is a check to see if `+cuda` is enabled with py-torch and if so, enable `FORCE_CUDA` for py-torchvision. The problem with that is that will not install on a machine that does not have a CUDA device.\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install py-torchvision\r\n...\r\n==> Installing py-torchvision\r\n==> No binary for py-torchvision found: installing from source\r\n==> Using cached archive: /opt/packages/gpjohnsn/argon_stack/spack/var/spack/cache/_source-cache/archive/fa/fa0a6f44a50451115d1499b3f2aa597e0092a07afce1068750260fa7dd2c85cb.tar.gz\r\n==> py-torchvision: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 1:\r\n    '/opt/ssoft/apps/2020.2/linux-centos7-x86_64/gcc-8.4.0/python-3.8.5-whujrdz/bin/python3.8' '-s' 'setup.py' '--no-user-cfg' 'build'\r\nSee build log for details:\r\n  /dev/shm/gpjohnsn/spack-stage-py-torchvision-0.7.0-kyskniy3puzlf5dox34jktreskz5ie2x/spack-build-out.txt\r\n```\r\n```console\r\ntail   /dev/shm/gpjohnsn/spack-stage-py-torchvision-0.7.0-kyskniy3puzlf5dox34jktreskz5ie2x/spack-build-out.txt\r\n...\r\nRuntimeError: cuda runtime error (100) : no CUDA-capable device is detected at ../aten/src/THC/THCGeneral.cpp:47\r\n```\r\n\r\nCommenting out the following code allows installation:\r\n```python\r\n        if '+cuda' in self.spec['py-torch']:                                                                            \r\n            env.set('FORCE_CUDA', 1)                                                                                    \r\n            env.set('CUDA_HOME', self.spec['cuda'].prefix)                                                              \r\n        else:                                                                                                           \r\n            env.set('FORCE_CUDA', 0)            \r\n```\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n```console\r\n* **Spack:** 0.15.4-927-f1652e8\r\n* **Python:** 2.7.5\r\n* **Platform:** linux-centos7-skylake_avx512\r\n```\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\nSpec:\r\n```\r\nInput spec\r\n--------------------------------\r\npy-torchvision%gcc@8.4.0\r\n\r\nConcretized\r\n--------------------------------\r\npy-torchvision@0.7.0%gcc@8.4.0 backend=pil arch=linux-centos7-x86_64\r\n    ^ffmpeg@4.2.2%gcc@8.4.0~X~avresample+bzlib~drawtext+gpl~libaom~libmp3lame~libopenjpeg~libopus~libsnappy~libspeex~libssh~libvorbis~libwebp~libzmq~lzma~nonfree+openssl~sdl2+shared+version3 arch=linux-centos7-x86_64\r\n        ^alsa-lib@1.2.3.2%gcc@8.4.0~python arch=linux-centos7-x86_64\r\n        ^bzip2@1.0.8%gcc@8.4.0+shared arch=linux-centos7-x86_64\r\n            ^diffutils@3.7%gcc@8.4.0 arch=linux-centos7-x86_64\r\n                ^libiconv@1.16%gcc@8.4.0 arch=linux-centos7-x86_64\r\n        ^openssl@1.1.1g%gcc@8.4.0+systemcerts arch=linux-centos7-x86_64\r\n            ^perl@5.30.3%gcc@8.4.0+cpanm+shared+threads arch=linux-centos7-x86_64\r\n                ^berkeley-db@18.1.40%gcc@8.4.0 arch=linux-centos7-x86_64\r\n                ^gdbm@1.18.1%gcc@8.4.0 arch=linux-centos7-x86_64\r\n                    ^readline@8.0%gcc@8.4.0 arch=linux-centos7-x86_64\r\n                        ^ncurses@6.2%gcc@8.4.0~symlinks+termlib arch=linux-centos7-x86_64\r\n                            ^pkgconf@1.7.3%gcc@8.4.0 arch=linux-centos7-x86_64\r\n            ^zlib@1.2.11%gcc@8.4.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n        ^yasm@1.3.0%gcc@8.4.0 arch=linux-centos7-x86_64\r\n    ^ninja@1.10.1%gcc@8.4.0 arch=linux-centos7-x86_64\r\n        ^python@3.8.5%gcc@8.4.0+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4+uuid+zlib patches=0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87 arch=linux-centos7-x86_64\r\n            ^expat@2.2.9%gcc@8.4.0+libbsd arch=linux-centos7-x86_64\r\n                ^libbsd@0.10.0%gcc@8.4.0 arch=linux-centos7-x86_64\r\n            ^gettext@0.21%gcc@8.4.0+bzip2+curses+git~libunistring+libxml2+tar+xz arch=linux-centos7-x86_64\r\n                ^libxml2@2.9.10%gcc@8.4.0~python arch=linux-centos7-x86_64\r\n                    ^xz@5.2.5%gcc@8.4.0~pic arch=linux-centos7-x86_64\r\n                ^tar@1.32%gcc@8.4.0 arch=linux-centos7-x86_64\r\n            ^libffi@3.3%gcc@8.4.0 patches=26f26c6f29a7ce9bf370ad3ab2610f99365b4bdd7b82e7c31df41a3370d685c0 arch=linux-centos7-x86_64\r\n            ^libuuid@1.0.3%gcc@8.4.0 arch=linux-centos7-x86_64\r\n            ^sqlite@3.33.0%gcc@8.4.0+column_metadata+fts~functions~rtree arch=linux-centos7-x86_64\r\n    ^py-numpy@1.18.5%gcc@8.4.0+blas+lapack arch=linux-centos7-x86_64\r\n        ^intel-mkl@2020.2.254%gcc@8.4.0~ilp64+shared threads=none arch=linux-centos7-x86_64\r\n        ^py-cython@0.29.21%gcc@8.4.0 arch=linux-centos7-x86_64\r\n            ^py-setuptools@50.1.0%gcc@8.4.0 arch=linux-centos7-x86_64\r\n    ^py-pillow-simd@7.0.0.post3%gcc@8.4.0~freetype~imagequant+jpeg~jpeg2000~lcms~tiff~webp~webpmux~xcb+zlib arch=linux-centos7-x86_64\r\n        ^libjpeg-turbo@2.0.4%gcc@8.4.0 arch=linux-centos7-x86_64\r\n            ^cmake@3.18.2%gcc@8.4.0~doc+ncurses+openssl+ownlibs~qt arch=linux-centos7-x86_64\r\n            ^nasm@2.14.02%gcc@8.4.0 arch=linux-centos7-x86_64\r\n    ^py-torch@1.6.0%gcc@8.4.0~binary~caffe2+cuda+cudnn~distributed~fbgemm~ffmpeg~gloo~leveldb~lmdb+magma~miopen+mkldnn+nccl~nnpack~opencv+openmp~qnnpack~redis~rocm~tbb~test~xnnpack~zstd cuda_arch=35,60,61,70,75 arch=linux-centos7-x86_64\r\n        ^cuda@10.2.89%gcc@8.4.0 arch=linux-centos7-x86_64\r\n        ^cudnn@7.6.5.32-10.2-linux-x64%gcc@8.4.0 arch=linux-centos7-x86_64\r\n        ^eigen@3.3.7%gcc@8.4.0 build_type=RelWithDebInfo arch=linux-centos7-x86_64\r\n        ^magma@2.5.3%gcc@8.4.0+cuda+fortran+shared build_type=RelWithDebInfo cuda_arch=35,60,61,70,75 arch=linux-centos7-x86_64\r\n        ^nccl@2.7.8-1%gcc@8.4.0+cuda cuda_arch=none arch=linux-centos7-x86_64\r\n            ^rdma-core@20%gcc@8.4.0 build_type=RelWithDebInfo arch=linux-centos7-x86_64\r\n        ^protobuf@3.12.2%gcc@8.4.0+shared build_type=Release arch=linux-centos7-x86_64\r\n        ^py-pybind11@2.5.0%gcc@8.4.0 build_type=RelWithDebInfo arch=linux-centos7-x86_64\r\n        ^py-pyyaml@5.3.1%gcc@8.4.0+libyaml arch=linux-centos7-x86_64\r\n            ^libyaml@0.2.4%gcc@8.4.0 arch=linux-centos7-x86_64\r\n```\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [ ] I have run the failing commands in debug mode and reported the output\r\n\r\n<!-- We encourage you to try, as much as possible, to reduce your problem to the minimal example that still reproduces the issue. That would help us a lot in fixing it quickly and effectively!\r\n\r\nIf you want to ask a question about the tool (how to use it, what it can currently do, etc.), try the `#general` channel on our Slack first. We have a welcoming community and chances are you'll get your reply faster and without opening an issue.\r\n\r\nOther than that, thanks for taking the time to contribute to Spack! -->\r\n",
    "performed_via_github_app": null
}