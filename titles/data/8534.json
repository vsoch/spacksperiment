{
    "url": "https://api.github.com/repos/spack/spack/issues/8534",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/8534/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/8534/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/8534/events",
    "html_url": "https://github.com/spack/spack/issues/8534",
    "id": 334268516,
    "node_id": "MDU6SXNzdWUzMzQyNjg1MTY=",
    "number": 8534,
    "title": "htop won't build on Ubuntu 14.04",
    "user": {
        "login": "hartzell",
        "id": 312978,
        "node_id": "MDQ6VXNlcjMxMjk3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/312978?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hartzell",
        "html_url": "https://github.com/hartzell",
        "followers_url": "https://api.github.com/users/hartzell/followers",
        "following_url": "https://api.github.com/users/hartzell/following{/other_user}",
        "gists_url": "https://api.github.com/users/hartzell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hartzell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hartzell/subscriptions",
        "organizations_url": "https://api.github.com/users/hartzell/orgs",
        "repos_url": "https://api.github.com/users/hartzell/repos",
        "events_url": "https://api.github.com/users/hartzell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hartzell/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2018-06-20T22:12:38Z",
    "updated_at": "2018-07-27T21:12:20Z",
    "closed_at": "2018-07-27T21:12:20Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "**TL;DR**: htop seems to be expecting us to be installing our ncurses@6 libraries with a '6' suffix but we're not.  What's the proper fix?\r\n\r\n## Summary\r\n\r\nOn a minimally configured (git, build-essentials, unzip) AWS Ubuntu 14.04 instance, Spack can not build *htop*.\r\n\r\n```\r\nhartzell@ubuntu-spack-test:~/spack$ spack install htop\r\n==> pkgconf is already installed in /home/hartzell/spack/opt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/pkgconf-1.4.2-w4jy3vpkv7mj4xx4swylm5ofrztzit3w\r\n==> ncurses is already installed in /home/hartzell/spack/opt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr\r\n==> Installing htop\r\n==> Using cached archive: /home/hartzell/spack/var/spack/cache/htop/htop-2.0.2.tar.gz\r\n==> Staging archive: /home/hartzell/spack/var/spack/stage/htop-2.0.2-n32omwlgkkuhp32h6gbt5rjw2bohmret/htop-2.0.2.tar.gz\r\n==> Created stage in /home/hartzell/spack/var/spack/stage/htop-2.0.2-n32omwlgkkuhp32h6gbt5rjw2bohmret\r\n==> No patches needed for htop\r\n==> Building htop [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Executing phase: 'configure'\r\n==> Error: ProcessError: Command exited with status 1:\r\n    '/home/hartzell/spack/var/spack/stage/htop-2.0.2-n32omwlgkkuhp32h6gbt5rjw2bohmret/htop-2.0.2/configure' '--prefix=/home/hartzell/spack/opt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/htop-2.0.2-n32omwlgkkuhp32h6gbt5rjw2bohmret' '--enable-shared'\r\n\r\n1 error found in build log:\r\n     116    checking for addnwstr in -lncursesw6... no\r\n     117    checking for addnwstr in -lncursesw... no\r\n     118    checking for addnwstr in -lncurses... no\r\n     119    checking for addnwstr in -lncursesw6... (cached) no\r\n     120    checking for addnwstr in -lncursesw... (cached) no\r\n     121    checking for addnwstr in -lncurses... (cached) no\r\n  >> 122    configure: error: You may want to use --disable-unicode or install libncursesw.\r\n\r\nSee build log for details:\r\n  /home/hartzell/spack/var/spack/stage/htop-2.0.2-n32omwlgkkuhp32h6gbt5rjw2bohmret/htop-2.0.2/spack-build.out\r\n```\r\n\r\nI see something similar was reported in #3126. \r\n\r\n*htop* does depend on ncurses:\r\n\r\n```\r\nhartzell@ubuntu-spack-test:~/spack$ spack spec htop\r\nInput spec\r\n--------------------------------\r\nhtop\r\n\r\nConcretized\r\n--------------------------------\r\nhtop@2.0.2%gcc@5.5.0 arch=linux-ubuntu14.04-x86_64\r\n    ^ncurses@6.1%gcc@5.5.0~symlinks~termlib arch=linux-ubuntu14.04-x86_64\r\n        ^pkgconf@1.4.2%gcc@5.5.0 arch=linux-ubuntu14.04-x86_64\r\n```\r\n\r\nand (unlike in #3126) the library with the `w` suffix is present:\r\n\r\n```\r\nhartzell@ubuntu-spack-test:~/spack$ find opt/ | grep libncursesw\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-4.8/ncurses-6.1-mges4os4itr27x33pvonrcst22t5eroe/lib/libncursesw_g.a\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-4.8/ncurses-6.1-mges4os4itr27x33pvonrcst22t5eroe/lib/libncursesw.a\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-4.8/ncurses-6.1-mges4os4itr27x33pvonrcst22t5eroe/lib/libncursesw.so.6.1\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-4.8/ncurses-6.1-mges4os4itr27x33pvonrcst22t5eroe/lib/libncursesw.so\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-4.8/ncurses-6.1-mges4os4itr27x33pvonrcst22t5eroe/lib/libncursesw.so.6\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr/lib/libncursesw_g.a\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr/lib/libncursesw.a\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr/lib/libncursesw.so.6.1\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr/lib/libncursesw.so\r\nopt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr/lib/libncursesw.so.6\r\nhartzell@ubuntu-spack-test:~/spack$\r\n```\r\n\r\nHere's the test that failed from the `config.log`:\r\n\r\n```\r\nconfigure:12673: checking for addnwstr in -lncursesw6\r\nconfigure:12698: /home/hartzell/spack/lib/spack/env/gcc/gcc -o conftest -g -O2  -L/home/hartzell/spack/opt/spack/linux-ubuntu14.04-x86_64/gcc-5.5.0/ncurses-6.1-o6v4a6q52safi4w4x6mh7z2rwkzyjblr/lib -lncursesw  conftest.c -lncursesw6  -lm  >&5\r\n/usr/bin/ld: cannot find -lncursesw6\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n\r\nHere's the bit of the configure script.  \r\n\r\n\r\n```\r\nif test \"x$enable_unicode\" = xyes; then\r\n\r\n   if test ! -z \"$HTOP_NCURSESW6_CONFIG_SCRIPT\"; then\r\n      # to be used to set the path to ncurses*-config when cross-compiling\r\n      htop_config_script=$($HTOP_NCURSESW6_CONFIG_SCRIPT --libs 2> /dev/null)\r\n   else\r\n      htop_config_script=$(\"ncursesw6-config\" --libs 2> /dev/null)\r\n   fi\r\n   htop_script_success=no\r\n   htop_save_LDFLAGS=\"$LDFLAGS\"\r\n   if test ! \"x$htop_config_script\" = x; then\r\n      LDFLAGS=\"$htop_config_script $LDFLAGS\"\r\n      { $as_echo \"$as_me:${as_lineno-$LINENO}: checking for addnwstr in -lncursesw6\" >&5\r\n$as_echo_n \"checking for addnwstr in -lncursesw6... \" >&6; }\r\nif ${ac_cv_lib_ncursesw6_addnwstr+:} false; then :\r\n  $as_echo_n \"(cached) \" >&6\r\nelse\r\n  ac_check_lib_save_LIBS=$LIBS\r\nLIBS=\"-lncursesw6  $LIBS\"\r\ncat confdefs.h - <<_ACEOF >conftest.$ac_ext\r\n/* end confdefs.h.  */\r\n```\r\n\r\nIt's finding and calling `ncursesw6-config` successfully (which give it *both* the `-L` and `-l` that it's using, but then it goes on and tacks on it's own `-lncursesw6`.  We don't install a copy of the library with the `6` ending.\r\n\r\nSetting `force_autoreconf=True` does not work.\r\n\r\nThis edit of the configure script *does* work:\r\n\r\n```\r\n--- configure.ac.orig   2018-06-20 22:10:44.012015788 +0000\r\n+++ configure.ac        2018-06-20 22:10:57.304015788 +0000\r\n@@ -185,7 +185,7 @@\r\n\r\n AC_ARG_ENABLE(unicode, [AS_HELP_STRING([--enable-unicode], [enable Unicode support])], ,enable_unicode=\"yes\")\r\n if test \"x$enable_unicode\" = xyes; then\r\n-   HTOP_CHECK_SCRIPT([ncursesw6], [addnwstr], [HAVE_LIBNCURSESW], \"ncursesw6-config\",\r\n+   HTOP_CHECK_SCRIPT([ncursesw], [addnwstr], [HAVE_LIBNCURSESW], \"ncursesw6-config\",\r\n     HTOP_CHECK_SCRIPT([ncursesw], [addnwstr], [HAVE_LIBNCURSESW], \"ncursesw5-config\",\r\n      HTOP_CHECK_SCRIPT([ncurses], [addnwstr], [HAVE_LIBNCURSESW], \"ncurses5-config\",\r\n       HTOP_CHECK_LIB([ncursesw6], [addnwstr], [HAVE_LIBNCURSESW],\r\n```\r\n\r\nIs the fix to patch htop or to install ncursesw libs with a '6' suffix?",
    "performed_via_github_app": null
}