{
    "url": "https://api.github.com/repos/spack/spack/issues/19667",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/19667/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/19667/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/19667/events",
    "html_url": "https://github.com/spack/spack/issues/19667",
    "id": 734173973,
    "node_id": "MDU6SXNzdWU3MzQxNzM5NzM=",
    "number": 19667,
    "title": "Installation issue: cmake/curl's openssl dependency is influenced by user environment",
    "user": {
        "login": "rowanworth",
        "id": 2315064,
        "node_id": "MDQ6VXNlcjIzMTUwNjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2315064?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rowanworth",
        "html_url": "https://github.com/rowanworth",
        "followers_url": "https://api.github.com/users/rowanworth/followers",
        "following_url": "https://api.github.com/users/rowanworth/following{/other_user}",
        "gists_url": "https://api.github.com/users/rowanworth/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/rowanworth/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/rowanworth/subscriptions",
        "organizations_url": "https://api.github.com/users/rowanworth/orgs",
        "repos_url": "https://api.github.com/users/rowanworth/repos",
        "events_url": "https://api.github.com/users/rowanworth/events{/privacy}",
        "received_events_url": "https://api.github.com/users/rowanworth/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2020-11-02T04:42:24Z",
    "updated_at": "2020-11-02T04:42:24Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "### Steps to reproduce the issue\r\n\r\nThe actual problem was encountered trying to install `rocprim` -- the cmake phase tries to download stuff from github and fails.\r\n\r\n```console\r\n$ spack install rocprim\r\n...\r\nCMake Error at cmake/Dependencies.cmake:104 (message):\r\n  Error: downloading\r\n  https://github.com/RadeonOpenCompute/rocm-cmake/archive/master.zip failed\r\n  error_code: 35 log: Trying 13.236.229.21:443...\r\n\r\n  Connected to github.com (13.236.229.21) port 443 (#0)\r\n\r\n  Cipher selection:\r\n  ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH\r\n\r\n  successfully set certificate verify locations:\r\n\r\n    CAfile: /etc/pki/tls/certs/ca-bundle.crt\r\n    CApath: none\r\n\r\n  TLSv1.0 (OUT), TLS handshake, Client hello (1):\r\n\r\n  [86 bytes data]\r\n\r\n  error:1407742E:SSL routines:SSL23_GET_SERVER_HELLO:tlsv1 alert protocol\r\n  version\r\n\r\n  Closing connection 0\r\n...\r\n```\r\n\r\nA bit of research reveals that cmake uses curl under the covers, and indeed I can reproduce the issue using the curl built by spack:\r\n\r\n```\r\n$ eval $(spack load --sh curl)\r\n$ curl -L https://github.com/RadeonOpenCompute/rocm-cmake/archive/master.zip >/dev/null\r\ncurl: (35) error:1407742E:SSL routines:SSL23_GET_SERVER_HELLO:tlsv1 alert protocol version\r\n$ \r\n```\r\n\r\nThe system's /usr/bin/curl works fine to download this URL -- until I eval the above `spack load` at which point it picks up `libcurl.so.4` from spack's build.\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.15.4\r\n* **Python:** 2.7.5\r\n* **Platform:** linux-centos7-sandybridge\r\n\r\nI have packages.yaml configured to use the system's openssl build (via `spack external find`):\r\n\r\n```\r\n  openssl:\r\n    externals: [{spec: openssl@1.0.2k-fips, prefix: /usr}, {spec: openssl@0.9.8o,\r\n        prefix: /d/sw/openssl/0.9.8o}]\r\n    buildable: false\r\n```\r\n\r\n### Additional information\r\n\r\nI've never specified a custom spec for cmake or curl; `spack spec` suggests openssl@1.0.2k-fips is in use:\r\n\r\n```\r\n$ spack spec cmake\r\nConcretized\r\n--------------------------------\r\ncmake@3.18.2%gcc@9.2.0~doc+ncurses+openssl+ownlibs~qt arch=linux-centos7-sandybridge\r\n    ^ncurses@5.9.20130511%gcc@9.2.0~symlinks+termlib patches=f84b2708a42777aadcc7f502a261afe10ca5646a51c1ef8b5e60d2070d926b57 arch=linux-centos7-sandybridge\r\n    ^openssl@1.0.2k-fips%gcc@9.2.0+systemcerts arch=linux-centos7-sandybridge\r\n\r\n$ spack spec curl\r\nConcretized\r\n--------------------------------\r\ncurl@7.72.0%gcc@9.2.0~darwinssl~gssapi~libssh~libssh2~nghttp2 arch=linux-centos7-sandybridge\r\n    ^libidn2@2.3.0%gcc@9.2.0 arch=linux-centos7-sandybridge\r\n        ^libunistring@0.9.10%gcc@9.2.0 arch=linux-centos7-sandybridge\r\n            ^libiconv@1.16%gcc@9.2.0 arch=linux-centos7-sandybridge\r\n    ^openssl@1.0.2k-fips%gcc@9.2.0+systemcerts arch=linux-centos7-sandybridge\r\n    ^zlib@1.2.11%gcc@9.2.0+optimize+pic+shared arch=linux-centos7-sandybridge\r\n```\r\n\r\n... ahhh, but `curl --version` from the spack build shows a different openssl was actually used:\r\n\r\n```\r\n$ curl --version\r\ncurl 7.72.0 (x86_64-pc-linux-gnu) libcurl/7.72.0 OpenSSL/0.9.8o zlib/1.2.11 libidn2/2.3.0\r\nRelease-Date: 2020-08-19\r\nProtocols: dict file ftp ftps gopher http https imap imaps pop3 pop3s rtsp smb smbs smtp smtps telnet tftp \r\nFeatures: AsynchDNS HTTPS-proxy IDN IPv6 Largefile libz NTLM NTLM_WB SSL UnixSockets\r\n```\r\n\r\nFor unknown reasons openssl 0.9.8o is in my default environment (in PATH and PKG_CONFIG_PATH), and it seems the curl build has picked up that instead of the system's openssl 1.0.2k. Possibly that is unavoidable given the circumstances, or possibly PKG_CONFIG_PATH should be included in --clean but I can imagine that causing problems for external packages in non-standard locations...\r\n\r\nAnyway, removing the old openssl from my environment and issuing `spack install --overwrite cmake` (and the same for curl) ultimately fixed the problem.\r\n\r\n### General information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [ ] I have uploaded the build log and environment files\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n",
    "performed_via_github_app": null
}