{
    "url": "https://api.github.com/repos/spack/spack/issues/13357",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/13357/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/13357/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/13357/events",
    "html_url": "https://github.com/spack/spack/issues/13357",
    "id": 510095006,
    "node_id": "MDU6SXNzdWU1MTAwOTUwMDY=",
    "number": 13357,
    "title": "Unify the construction of environment modifications from config",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446615135,
            "node_id": "MDU6TGFiZWw0NDY2MTUxMzU=",
            "url": "https://api.github.com/repos/spack/spack/labels/configuration",
            "name": "configuration",
            "color": "bfd4f2",
            "default": false,
            "description": null
        },
        {
            "id": 73908756,
            "node_id": "MDU6TGFiZWw3MzkwODc1Ng==",
            "url": "https://api.github.com/repos/spack/spack/labels/feature",
            "name": "feature",
            "color": "84b6eb",
            "default": false,
            "description": null
        },
        {
            "id": 466955297,
            "node_id": "MDU6TGFiZWw0NjY5NTUyOTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/proposal",
            "name": "proposal",
            "color": "0e8a16",
            "default": false,
            "description": null
        },
        {
            "id": 456121338,
            "node_id": "MDU6TGFiZWw0NTYxMjEzMzg=",
            "url": "https://api.github.com/repos/spack/spack/labels/refactoring",
            "name": "refactoring",
            "color": "f28f2a",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 0,
    "created_at": "2019-10-21T16:21:48Z",
    "updated_at": "2020-01-27T16:40:48Z",
    "closed_at": "2020-01-27T16:40:48Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "As a Spack developer I want a unique way to construct a list of modifications to the environment starting from information stored in a configuration file so that I'll avoid code duplication and be ensured we treat this problem coherently across different files.\r\n\r\n### Rationale\r\nCurrently there are at least two different places where we can prescribe modifications to the environment in a configuration file: \r\n1. `compilers.yaml` where we can specify custom modifications needed to use a given compiler\r\n2. `modules.yaml` where we can attach custom modifications to each module file being generated\r\n\r\nBoth the schema and the code that handle these parts are duplicated and the implementation has slight differences in the two cases. As soon as we integrate better with container runtimes we'll surely have at hand a third case in which setting custom environment variables from configuration files is needed. \r\n\r\nWhat is proposed here is thus a refactor of this part so that we can unify:\r\n1. The schema for that portion of the configuration file\r\n2. The construction of a list of environment modifications from a dictionary conforming to the schema\r\n\r\nThis should improve code quality and speed-up development for any other case in which we need to parse environment modifications from config files.\r\n\r\n### Description\r\n\r\nThe task should be to go through the `compilers.yaml` schema:\r\n\r\nhttps://github.com/spack/spack/blob/f2d91f7e3c826011e1e6a47a598cda4acca8c8a6/lib/spack/spack/schema/compilers.py#L71-L114\r\n\r\nand the `modules.yaml` schema:\r\n\r\nhttps://github.com/spack/spack/blob/f2d91f7e3c826011e1e6a47a598cda4acca8c8a6/lib/spack/spack/schema/modules.py#L69-L79\r\n\r\nand merge them into a unique schema that will be used in both places. Likewise we should unify the construction of the corresponding `EnvironmentModifications` object in memory that is currently replicated in `build_environment.py`:\r\n\r\nhttps://github.com/spack/spack/blob/f2d91f7e3c826011e1e6a47a598cda4acca8c8a6/lib/spack/spack/build_environment.py#L336-L350\r\n\r\nand in `modules/common.py`:\r\n\r\nhttps://github.com/spack/spack/blob/f2d91f7e3c826011e1e6a47a598cda4acca8c8a6/lib/spack/spack/modules/common.py#L383-L402\r\n\r\n\r\n### Additional information\r\nWhile doing so we can also take the chance to implement a way to store information in the configuration files that preserves total ordering of the modifications:\r\n```yaml\r\nenvironment:\r\n- action: prepend_path\r\n  variable: PATH\r\n  value: /opt/usr/bin\r\n...\r\n- action: set\r\n  variable: MYENV\r\n  value: foo\r\n ```\r\nThis should be an additional way to write the configuration file and the current one should be preserved for backward compatibility.",
    "performed_via_github_app": null
}