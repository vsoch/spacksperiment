{
    "url": "https://api.github.com/repos/spack/spack/issues/15274",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/15274/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/15274/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/15274/events",
    "html_url": "https://github.com/spack/spack/issues/15274",
    "id": 573076946,
    "node_id": "MDU6SXNzdWU1NzMwNzY5NDY=",
    "number": 15274,
    "title": "`spack install` output is being inserted into autoconf generated `configure` script",
    "user": {
        "login": "hartzell",
        "id": 312978,
        "node_id": "MDQ6VXNlcjMxMjk3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/312978?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hartzell",
        "html_url": "https://github.com/hartzell",
        "followers_url": "https://api.github.com/users/hartzell/followers",
        "following_url": "https://api.github.com/users/hartzell/following{/other_user}",
        "gists_url": "https://api.github.com/users/hartzell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hartzell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hartzell/subscriptions",
        "organizations_url": "https://api.github.com/users/hartzell/orgs",
        "repos_url": "https://api.github.com/users/hartzell/repos",
        "events_url": "https://api.github.com/users/hartzell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hartzell/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 7,
    "created_at": "2020-02-29T00:17:22Z",
    "updated_at": "2020-03-01T04:58:14Z",
    "closed_at": "2020-03-01T04:58:14Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I'm trying to add a newer release of the kallisto package, ideally 0.46.2.\r\n\r\nKallisto is a CMakePackage and/but is \"interesting\" (may you live in interesting times) because it has vendored its own copy of the `htslib` library and runs `autoheader` and `autoconf` and `configure` in the `htslib` dir via this bit of the toplevel `CMakeLists.txt`:\r\n\r\n```\r\ninclude(ExternalProject)\r\nExternalProject_Add(htslib\r\n    PREFIX ${PROJECT_SOURCE_DIR}/ext/htslib\r\n    SOURCE_DIR ${PROJECT_SOURCE_DIR}/ext/htslib\r\n    BUILD_IN_SOURCE 1\r\n    CONFIGURE_COMMAND autoheader && autoconf && ${PROJECT_SOURCE_DIR}/ext/htslib/configure\r\n        --prefix=${PREFIX} --disable-bz2 --disable-lzma --disable-libcurl\r\n    BUILD_COMMAND make lib-static\r\n    INSTALL_COMMAND \"\"\r\n)\r\n```\r\n\r\nAnything newer than the version we have in the tree (0.43.1) dies with a similar problem, it seems like the output of the `spack` command is being included in the generated files.\r\n\r\nHere's the first few lines of the generated `configure` script\r\n\r\n```\r\n#! /bin/sh\r\n# Guess values for system-dependent variables and create Makefiles.\r\n# Generated by GNU Autoconf 2.69 for HTSlib make3: Entering directory `/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib'\r\n1.4.1\r\nmake3: Leaving directory `/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib'.\r\n#\r\n# Report bugs to <samtools-help@lists.sourceforge.net>.\r\n#\r\n```\r\n\r\nThe build dies when cmake tries to build the vendored `htslib` lib and stubs its toe on the line tht only contains `1.4.1`:\r\n\r\n```\r\n[...]\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\n\r\n4 errors found in build log:\r\n     109    configure.ac:26: 1.4.1\r\n     110    configure.ac:26: make3: Leaving directory `/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib'\r\n     111    configure.ac:26: warning: AC_INIT: not a literal: make3: Entering directory `/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spac\r\n            k-src/ext/htslib'\r\n     112    configure.ac:26: 1.4.1\r\n     113    configure.ac:26: make3: Leaving directory `/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib'\r\n     114    /tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib/configure: line 4: 1.4.1: command not found\r\n  >> 115    /tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib/configure: line 34: syntax error near unexpected token `('\r\n     116    /tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib/configure: line 34: `  case `(set -o) 2>/dev/null` in #('\r\n  >> 117    make[2]: *** [/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-src/ext/htslib/src/htslib-stamp/htslib-configure] Error 2\r\n     118    make[2]: Leaving directory `/tmp/ghartzell/spack-stage/spack-stage-kallisto-0.46.2-2cya5t4j2epry6ttce7w2bm5eeoqurjf/spack-build'\r\n  >> 119    make[1]: *** [CMakeFiles/htslib.dir/all] Error 2\r\n     120    make[1]: *** Waiting for unfinished jobs....\r\n[...]\r\n```\r\n\r\nOn the theory that I was picking up old CentOS versions of the tools, I tried (unconditionally, for now) adding dependencies on the usual autotools suspects, to no avail.  Here's the changes:\r\n\r\n```\r\n$ git diff\r\ndiff --git a/var/spack/repos/builtin/packages/kallisto/package.py b/var/spack/repos/builtin/packages/kallisto/package.py\r\nindex 337b50f18..81d509cb4 100644\r\n--- a/var/spack/repos/builtin/packages/kallisto/package.py\r\n+++ b/var/spack/repos/builtin/packages/kallisto/package.py\r\n@@ -13,8 +13,14 @@ class Kallisto(CMakePackage):\r\n     homepage = \"http://pachterlab.github.io/kallisto\"\r\n     url      = \"https://github.com/pachterlab/kallisto/archive/v0.43.1.tar.gz\"\r\n\r\n+    version('0.46.2', sha256='c447ca8ddc40fcbd7d877d7c868bc8b72807aa8823a8a8d659e19bdd515baaf2')\r\n     version('0.43.1', sha256='7baef1b3b67bcf81dc7c604db2ef30f5520b48d532bf28ec26331cb60ce69400')\r\n\r\n     depends_on('zlib')\r\n     depends_on('hdf5')\r\n     depends_on('mpich')\r\n+\r\n+    depends_on('autoconf', type='build')\r\n+    depends_on('automake', type='build')\r\n+    depends_on('libtool',  type='build')\r\n+    depends_on('m4',       type='build')\r\n$\r\n```",
    "performed_via_github_app": null
}