{
    "url": "https://api.github.com/repos/spack/spack/issues/19670",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/19670/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/19670/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/19670/events",
    "html_url": "https://github.com/spack/spack/issues/19670",
    "id": 734277350,
    "node_id": "MDU6SXNzdWU3MzQyNzczNTA=",
    "number": 19670,
    "title": "Patching stages relies on side effects from memoization",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1369661382,
            "node_id": "MDU6TGFiZWwxMzY5NjYxMzgy",
            "url": "https://api.github.com/repos/spack/spack/labels/maintainers",
            "name": "maintainers",
            "color": "f2d76a",
            "default": false,
            "description": ""
        },
        {
            "id": 620268714,
            "node_id": "MDU6TGFiZWw2MjAyNjg3MTQ=",
            "url": "https://api.github.com/repos/spack/spack/labels/patch",
            "name": "patch",
            "color": "5319e7",
            "default": false,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2020-11-02T07:50:54Z",
    "updated_at": "2020-11-02T07:50:54Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "While debugging #19501 I ran into issues evaluating the `Spec.patches` properties. Trying to debug those issues I noticed that our mechanism for applying patches relies on side effects from memoization to change the `Patch.path` attribute to the right object.\r\n\r\nThis behavior has been introduced in #10150 The line that adds the path to the patch objects is:\r\n\r\nhttps://github.com/spack/spack/blob/b2d6c634216a0ee2f0532372456ad389dd6fb427/lib/spack/spack/patch.py#L210\r\n\r\nWithout memoization a temporary object is returned and the path applied to it is not reflected in the spec from which it originated.\r\n\r\n### Steps to reproduce the issue\r\nRemove `lang.memoized` from the following lines in `spec.py`:\r\n\r\nhttps://github.com/spack/spack/blob/b2d6c634216a0ee2f0532372456ad389dd6fb427/lib/spack/spack/spec.py#L3065-L3067\r\n\r\nand then try to apply patches to any package that needs them:\r\n```console\r\n$ spack  patch findutils\r\n==> Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/de/ded4c9f73731cd48fec3b6bdaccce896473b6d8e337e9612e16cf1431bb1169d.tar.gz\r\n==> Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/84/84b916c0bf8c51b7e7b28417692f0ad3e7030d1f3c248ba77c42ede5c1c5d11e\r\n==> Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/bd/bd9e4e5cc280f9753ae14956c4e4aa17fe7a210f55dd6c84aa60b12d106d47a2\r\n==> Error: Path for patch not set in apply: https://src.fedoraproject.org/rpms/findutils/raw/97ba2d7a18d1f9ae761b6ff0b4f1c4d33d7a8efc/f/findutils-4.6.0-gnulib-fflush.patch\r\n```\r\n\r\n### Error Message\r\nThe stacktrace for the failing command is:\r\n\r\n<details>\r\n<summary> spack -d --stacktrace patch findutils</summary>\r\n\r\n```console\r\n$ spack -d --stacktrace patch findutils\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-11-02-08:42:42.396634] Imported patch from built-in commands\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-11-02-08:42:42.397771] Imported patch from built-in commands\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:42.401526] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/config.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:42.420934] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/config.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:42.421465] Reading config file /home/culpo/.spack/config.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:42.423318] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:42.516144] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/packages.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:42.548992] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/compilers.yaml\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.674482] ncurses applying constraint pkgconfig\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.675302] readline applying constraint ncurses\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.676141] gdbm applying constraint readline\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.678408] perl applying constraint gdbm\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.679164] perl applying constraint berkeley-db\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.679957] autoconf applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.680734] autoconf applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.683592] automake applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.684398] automake applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.689418] libtool applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.690602] findutils applying constraint m4\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.694274] texinfo applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.695181] findutils applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.696079] findutils applying constraint automake\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.696891] findutils applying constraint libtool\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.697641] findutils applying constraint m4\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.698399] findutils applying constraint texinfo\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.769016] findutils applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.769856] autoconf applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.770652] autoconf applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.771359] perl applying constraint gdbm\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.772075] gdbm applying constraint readline\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.772833] readline applying constraint ncurses\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.773536] ncurses applying constraint pkgconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.774282] perl applying constraint berkeley-db\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.775068] findutils applying constraint automake\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.775816] automake applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.776670] automake applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.777354] findutils applying constraint libtool\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.778099] libtool applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.779129] findutils applying constraint m4\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.779875] findutils applying constraint texinfo\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.780967] texinfo applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.852062] findutils applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.852898] autoconf applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.856322] m4 applying constraint libsigsegv\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.857054] autoconf applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.857978] perl applying constraint gdbm\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.858743] gdbm applying constraint readline\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.859574] readline applying constraint ncurses\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.860627] ncurses applying constraint pkgconf@1.7.3%gcc@10.2.0 arch=linux-ubuntu18.04-broadwell\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.861665] perl applying constraint berkeley-db\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.862481] autoconf applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.863263] autoconf applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.864291] findutils applying constraint automake\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.865135] automake applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.866011] automake applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.866724] findutils applying constraint libtool\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.867496] libtool applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.868530] findutils applying constraint m4\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.869237] findutils applying constraint texinfo\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.869977] texinfo applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.870781] findutils applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.871482] findutils applying constraint automake\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.872173] findutils applying constraint libtool\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.872923] findutils applying constraint m4\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.873624] findutils applying constraint texinfo\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.940126] findutils applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.941015] autoconf applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.941858] m4 applying constraint libsigsegv\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.942665] autoconf applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.943529] perl applying constraint gdbm\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.944274] gdbm applying constraint readline\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.945050] readline applying constraint ncurses\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.946029] ncurses applying constraint pkgconf@1.7.3%gcc@10.2.0 arch=linux-ubuntu18.04-broadwell\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.947081] perl applying constraint berkeley-db\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.947811] findutils applying constraint automake\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.948574] automake applying constraint autoconf\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.949303] automake applying constraint perl\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.950001] findutils applying constraint libtool\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.950818] libtool applying constraint m4@1.4.6:\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.951927] findutils applying constraint m4\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.953080] findutils applying constraint texinfo\r\nlib/spack/spack/spec.py:2597 ==> [2020-11-02-08:42:42.954042] texinfo applying constraint perl\r\nlib/spack/spack/spec.py:2316 ==> [2020-11-02-08:42:43.018010] Ordered hashes [findutils]: findutils/0/84b916c0bf8c51b7e7b28417692f0ad3e7030d1f3c248ba77c42ede5c1c5d11e, findutils/1/bd9e4e5cc280f9753ae14956c4e4aa17fe7a210f55dd6c84aa60b12d106d47a2\r\nlib/spack/spack/spec.py:2316 ==> [2020-11-02-08:42:43.018454] Ordered hashes [m4]: m4/3/3877ab548f88597ab2327a2230ee048d2d07ace1062efe81fc92e91b7f39cd00, m4/9/fc9b61654a3ba1a8d6cd78ce087e7c96366c290bc8d2c299f09828d793b853c8\r\nlib/spack/spack/spec.py:2316 ==> [2020-11-02-08:42:43.018814] Ordered hashes [gdbm]: gdbm/14/7f569b9287e9e5a4236636eef32ff3428f0462ec17aea359e0ebee07649f1f16\r\nlib/spack/spack/spec.py:2316 ==> [2020-11-02-08:42:43.019267] Ordered hashes [texinfo]: texinfo/20/1732115f651cff98989cb0215d8f64da5e0f7911ebf0c13b064920f088f2ffe1, texinfo/23/12f6edb0c6b270b8c8dba2ce17998c580db01182d871ee32b7b6e4129bd1d23a\r\nlib/spack/spack/database.py:362 ==> [2020-11-02-08:42:43.021835] DATABASE LOCK TIMEOUT: 3s\r\nlib/spack/spack/database.py:366 ==> [2020-11-02-08:42:43.022112] PACKAGE LOCK TIMEOUT: No timeout\r\nlib/spack/spack/stage.py:312 ==> [2020-11-02-08:42:43.106177] Creating stage lock spack-stage-findutils-4.6.0-6wex3ldlbkrkb5xx4hublbfo4gg2ahfq\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:43.107382] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/mirrors.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:43.109470] Reading config file /home/culpo/.spack/mirrors.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-08:42:43.111579] Reading config file /home/culpo/.spack/linux/mirrors.yaml\r\nlib/spack/spack/fetch_strategy.py:582 ==> [2020-11-02-08:42:43.128733] Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/de/ded4c9f73731cd48fec3b6bdaccce896473b6d8e337e9612e16cf1431bb1169d.tar.gz\r\nlib/spack/spack/stage.py:312 ==> [2020-11-02-08:42:43.146652] Creating stage lock spack-stage-zizdxm8j\r\nlib/spack/spack/fetch_strategy.py:582 ==> [2020-11-02-08:42:43.148120] Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/84/84b916c0bf8c51b7e7b28417692f0ad3e7030d1f3c248ba77c42ede5c1c5d11e\r\nlib/spack/spack/stage.py:312 ==> [2020-11-02-08:42:43.148617] Creating stage lock spack-stage-r_iuxl61\r\nlib/spack/spack/fetch_strategy.py:582 ==> [2020-11-02-08:42:43.149896] Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/bd/bd9e4e5cc280f9753ae14956c4e4aa17fe7a210f55dd6c84aa60b12d106d47a2\r\nlib/spack/spack/stage.py:593 ==> [2020-11-02-08:42:43.150274] Already staged spack-stage-findutils-4.6.0-6wex3ldlbkrkb5xx4hublbfo4gg2ahfq in /tmp/pytest-of-culpo/pytest-89/mock-stage0/spack-stage-findutils-4.6.0-6wex3ldlbkrkb5xx4hublbfo4gg2ahfq\r\nTraceback (most recent call last):\r\n  File \"/home/culpo/PycharmProjects/spack/bin/spack\", line 64, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/cmd/patch.py\", line 32, in patch\r\n    package.do_patch()\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/package.py\", line 1346, in do_patch\r\n    patch.apply(self.stage)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/patch.py\", line 81, in apply\r\n    \"Path for patch not set in apply: %s\" % self.path_or_url)\r\nAssertionError: Path for patch not set in apply: https://src.fedoraproject.org/rpms/findutils/raw/97ba2d7a18d1f9ae761b6ff0b4f1c4d33d7a8efc/f/findutils-4.6.0-gnulib-fflush.patch\r\n```\r\n</details>\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.15.4-1768-b2d6c63421\r\n* **Python:** 3.8.5\r\n* **Platform:** linux-ubuntu18.04-broadwell\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "performed_via_github_app": null
}