{
    "url": "https://api.github.com/repos/spack/spack/issues/16340",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/16340/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/16340/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/16340/events",
    "html_url": "https://github.com/spack/spack/issues/16340",
    "id": 607990901,
    "node_id": "MDU6SXNzdWU2MDc5OTA5MDE=",
    "number": 16340,
    "title": "PostgreSQL client (psql) links against system libpq and etc...",
    "user": {
        "login": "hartzell",
        "id": 312978,
        "node_id": "MDQ6VXNlcjMxMjk3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/312978?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hartzell",
        "html_url": "https://github.com/hartzell",
        "followers_url": "https://api.github.com/users/hartzell/followers",
        "following_url": "https://api.github.com/users/hartzell/following{/other_user}",
        "gists_url": "https://api.github.com/users/hartzell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hartzell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hartzell/subscriptions",
        "organizations_url": "https://api.github.com/users/hartzell/orgs",
        "repos_url": "https://api.github.com/users/hartzell/repos",
        "events_url": "https://api.github.com/users/hartzell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hartzell/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 446779717,
            "node_id": "MDU6TGFiZWw0NDY3Nzk3MTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/rpath",
            "name": "rpath",
            "color": "bfdadc",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2020-04-28T03:12:31Z",
    "updated_at": "2020-04-28T09:46:49Z",
    "closed_at": "2020-04-28T09:46:49Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "There seems to be a problem with RPATH and the postgresql build.\r\n\r\nThe `pqsl` executable that I built with Spack failed to connect to a database with this error\r\n\r\n```\r\nundefined symbol: PQsetErrorContextVisibility\r\n```\r\n\r\nI ran the install again with `--keep-stage` and started poking around in the post-build source tree.\r\n\r\nI noticed that the copy of `psql` in the tree was linking to all kinds of system libraries:\r\n\r\n```\r\n$ ldd /local_scratch/hartzell/spack-20200426193415/var/spack/stage/spack-stage-postgresql-11.2-t6stpub2qdi6b5sjlnjb5xox7actdmbu/spack-src/src/bin/psql/psql\r\n\tlinux-vdso.so.1 =>  (0x00007fff76d3e000)\r\n\tlibpq.so.5 => /usr/lib64/libpq.so.5 (0x00007f91bf41b000)\r\n\tlibpthread.so.0 => /usr/lib64/libpthread.so.0 (0x00007f91bf1ff000)\r\n\tlibreadline.so.8 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/readline-8.0-azrv37bcttoms3mkosvgsueaz6fwirjk/lib/libreadline.so.8 (0x00007f91befb1000)\r\n\tlibrt.so.1 => /usr/lib64/librt.so.1 (0x00007f91beda9000)\r\n\tlibm.so.6 => /usr/lib64/libm.so.6 (0x00007f91beaa7000)\r\n\tlibc.so.6 => /usr/lib64/libc.so.6 (0x00007f91be6d9000)\r\n\tlibssl.so.10 => /usr/lib64/libssl.so.10 (0x00007f91be467000)\r\n\tlibcrypto.so.10 => /usr/lib64/libcrypto.so.10 (0x00007f91be004000)\r\n\tlibkrb5.so.3 => /usr/lib64/libkrb5.so.3 (0x00007f91bdd1b000)\r\n\tlibcom_err.so.2 => /usr/lib64/libcom_err.so.2 (0x00007f91bdb17000)\r\n\tlibgssapi_krb5.so.2 => /usr/lib64/libgssapi_krb5.so.2 (0x00007f91bd8ca000)\r\n\tlibldap_r-2.4.so.2 => /usr/lib64/libldap_r-2.4.so.2 (0x00007f91bd66b000)\r\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f91bf64a000)\r\n\tlibncursesw.so.6 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/ncurses-6.2-va5blkrulxmh5bmlwhgpbtchg2x5jm2h/lib/libncursesw.so.6 (0x00007f91bd432000)\r\n\tlibk5crypto.so.3 => /usr/lib64/libk5crypto.so.3 (0x00007f91bd1ff000)\r\n\tlibdl.so.2 => /usr/lib64/libdl.so.2 (0x00007f91bcffb000)\r\n\tlibz.so.1 => /usr/lib64/libz.so.1 (0x00007f91bcde5000)\r\n\tlibkrb5support.so.0 => /usr/lib64/libkrb5support.so.0 (0x00007f91bcbd5000)\r\n\tlibkeyutils.so.1 => /usr/lib64/libkeyutils.so.1 (0x00007f91bc9d1000)\r\n\tlibresolv.so.2 => /usr/lib64/libresolv.so.2 (0x00007f91bc7b8000)\r\n\tliblber-2.4.so.2 => /usr/lib64/liblber-2.4.so.2 (0x00007f91bc5a9000)\r\n\tlibsasl2.so.3 => /usr/lib64/libsasl2.so.3 (0x00007f91bc38c000)\r\n\tlibssl3.so => /usr/lib64/libssl3.so (0x00007f91bc133000)\r\n\tlibsmime3.so => /usr/lib64/libsmime3.so (0x00007f91bbf0b000)\r\n\tlibnss3.so => /usr/lib64/libnss3.so (0x00007f91bbbdc000)\r\n\tlibnssutil3.so => /usr/lib64/libnssutil3.so (0x00007f91bb9ac000)\r\n\tlibplds4.so => /usr/lib64/libplds4.so (0x00007f91bb7a8000)\r\n\tlibplc4.so => /usr/lib64/libplc4.so (0x00007f91bb5a3000)\r\n\tlibnspr4.so => /usr/lib64/libnspr4.so (0x00007f91bb365000)\r\n\tlibtinfow.so.6 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/ncurses-6.2-va5blkrulxmh5bmlwhgpbtchg2x5jm2h/lib/libtinfow.so.6 (0x00007f91bb128000)\r\n\tlibselinux.so.1 => /usr/lib64/libselinux.so.1 (0x00007f91baf01000)\r\n\tlibcrypt.so.1 => /usr/lib64/libcrypt.so.1 (0x00007f91bacca000)\r\n\tlibpcre.so.1 => /usr/lib64/libpcre.so.1 (0x00007f91baa68000)\r\n\tlibfreebl3.so => /usr/lib64/libfreebl3.so (0x00007f91ba865000)\r\n```\r\n\r\nBut (I took the long way around to this realization), I discovered that if I was in a shell in the build environment, then the executable linked to the things that I'd expect.\r\n\r\n```\r\n$ ./bin/spack build-env postgresql ldd /local_scratch/hartzell/spack-20200426193415/var/spack/stage/spack-stage-postgresql-11.2-t6stpub2qdi6b5sjlnjb5xox7actdmbu/spack-src/src/bin/psql/psql\r\n\tlinux-vdso.so.1 =>  (0x00007ffe81dcf000)\r\n\tlibpq.so.5 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/postgresql-11.2-t6stpub2qdi6b5sjlnjb5xox7actdmbu/lib/libpq.so.5 (0x00007f3f46141000)\r\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f3f45f25000)\r\n\tlibreadline.so.8 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/readline-8.0-azrv37bcttoms3mkosvgsueaz6fwirjk/lib/libreadline.so.8 (0x00007f3f45cd7000)\r\n\tlibrt.so.1 => /lib64/librt.so.1 (0x00007f3f45acf000)\r\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f3f457cd000)\r\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f3f453ff000)\r\n\tlibssl.so.1.1 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/openssl-1.1.1f-ke67wkwx3s7utnudleklpnwzjs4hq4tn/lib/libssl.so.1.1 (0x00007f3f4516c000)\r\n\tlibcrypto.so.1.1 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/openssl-1.1.1f-ke67wkwx3s7utnudleklpnwzjs4hq4tn/lib/libcrypto.so.1.1 (0x00007f3f44c85000)\r\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f3f46387000)\r\n\tlibncursesw.so.6 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/ncurses-6.2-va5blkrulxmh5bmlwhgpbtchg2x5jm2h/lib/libncursesw.so.6 (0x00007f3f44a4c000)\r\n\tlibz.so.1 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/zlib-1.2.11-iode5iweyrwrwqi7vc4wbtvtszsqba5g/lib/libz.so.1 (0x00007f3f44835000)\r\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f3f44631000)\r\n\tlibtinfow.so.6 => /local_scratch/hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/ncurses-6.2-va5blkrulxmh5bmlwhgpbtchg2x5jm2h/lib/libtinfow.so.6 (0x00007f3f443f4000)\r\n$\r\n```\r\n\r\nHere's the actual compilation line that was used (from the `spack-build-out.txt`) file:\r\n\r\n```\r\n /local_scratch/george.hartzell/spack-20200426193415/lib/spack/env/gcc/gcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -Wno-format-truncation -Wno-stringop-truncation -O2 command.o common.o copy.o crosstabview.o describe.o help.o input.o large_obj.o mainloop.o prompt.o psqlscanslash.o sql_help.o startup.o stringutils.o tab-complete.o variables.o  -L../../../src/port -L../../../src/common -L../../../src/fe_utils -lpgfeutils -L../../../src/common -lpgcommon -L../../../src/port -lpgport -L../../../src/interfaces/libpq -lpq   -Wl,--as-needed -Wl,-rpath,'/local_scratch/george.hartzell/spack-20200426193415/opt/spack/linux-centos7-skylake_avx512/gcc-8.4.0/postgresql-11.2-t6stpub2qdi6b5sjlnjb5xox7actdmbu/lib',--enable-new-dtags  -lpgcommon -lpgport -lpthread -lssl -lcrypto -lz -lreadline -lrt -lcrypt -ldl -lm  -o psql-gh\r\n````\r\n\r\n### Steps to reproduce the issue\r\n\r\nOn a system with postgres installed in the base (and a lot of other things...):\r\n\r\n```console\r\n$ spack install postgresql\r\n$ ldd $(spack location -i postgresql)/bin/psql\r\n```\r\n\r\n### Information on your system\r\n\r\n```\r\n$ spack debug  report\r\n* **Spack:** 0.14.1-684-f912cce7e\r\n* **Python:** 2.7.5\r\n* **Platform:** linux-centos7-skylake_avx512\r\n```\r\n\r\n### General information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [NA] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [?] I have uploaded the build log and environment files\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n",
    "performed_via_github_app": null
}