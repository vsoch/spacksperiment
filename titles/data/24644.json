{
    "url": "https://api.github.com/repos/spack/spack/issues/24644",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24644/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24644/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24644/events",
    "html_url": "https://github.com/spack/spack/issues/24644",
    "id": 934215064,
    "node_id": "MDU6SXNzdWU5MzQyMTUwNjQ=",
    "number": 24644,
    "title": "Python 3.9.6: Error calling urllib.parse",
    "user": {
        "login": "branchvincent",
        "id": 19800529,
        "node_id": "MDQ6VXNlcjE5ODAwNTI5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19800529?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/branchvincent",
        "html_url": "https://github.com/branchvincent",
        "followers_url": "https://api.github.com/users/branchvincent/followers",
        "following_url": "https://api.github.com/users/branchvincent/following{/other_user}",
        "gists_url": "https://api.github.com/users/branchvincent/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/branchvincent/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/branchvincent/subscriptions",
        "organizations_url": "https://api.github.com/users/branchvincent/orgs",
        "repos_url": "https://api.github.com/users/branchvincent/repos",
        "events_url": "https://api.github.com/users/branchvincent/events{/privacy}",
        "received_events_url": "https://api.github.com/users/branchvincent/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2021-06-30T23:59:42Z",
    "updated_at": "2021-07-03T05:20:09Z",
    "closed_at": "2021-07-03T05:20:09Z",
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "With Python 3.9.6, [this change](https://github.com/python/cpython/blob/db3ff76da19004f266b62e98a81bdfd322861436/Lib/urllib/parse.py#L462) in `urllib.parse` causes an error using `urllib.parse.urlparse(..., scheme=None)` like here: https://github.com/spack/spack/blob/59028aa0a5d4f106c33955a9779ea3ae19864dd9/lib/spack/spack/util/url.py#L167-L168\r\n\r\nI don't think this is a Python bug since the [docs](https://docs.python.org/3/library/urllib.parse.html#urllib.parse.urlparse) state:\r\n\r\n> [scheme] should be the same type (text or bytes) as urlstring\r\n\r\nHowever, [typeshed](https://github.com/python/typeshed/blob/c6b78354e6b9f979bb5b83044060b67e9c55a0ae/stdlib/urllib/parse.pyi#L125-L126) does have it typed as `Optional[str]` so I'm not sure.\r\n\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ python3 --version\r\nPython 3.9.6\r\n$ spack install zlib\r\n==> Installing zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga\r\n==> Error: Failed to install zlib due to AttributeError: 'NoneType' object has no attribute 'replace'\r\n==> Error: 'NoneType' object has no attribute 'replace'\r\n$ python3 -c \"from urllib.parse import urlparse; urlparse('', scheme=None)\"\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/urllib/parse.py\", line 393, in urlparse\r\n    splitresult = urlsplit(url, scheme, allow_fragments)\r\n  File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/urllib/parse.py\", line 462, in urlsplit\r\n    scheme = scheme.replace(b, \"\")\r\nAttributeError: 'NoneType' object has no attribute 'replace'\r\n```\r\n\r\n### Error Message\r\n\r\n<details>\r\n  <summary>Stacktrace</summary>\r\n\r\n```console\r\n$ spack --debug --stacktrace install zlib\r\nCellar/spack/0.16.2/lib/spack/spack/cmd/__init__.py:122 ==> [2021-06-30-19:23:27.332263] Imported install from built-in commands\r\nCellar/spack/0.16.2/lib/spack/spack/config.py:905 ==> [2021-06-30-19:23:27.336600] Reading config file /usr/local/Cellar/spack/0.16.2/etc/spack/defaults/config.yaml\r\nCellar/spack/0.16.2/lib/spack/spack/cmd/__init__.py:122 ==> [2021-06-30-19:23:27.370003] Imported install from built-in commands\r\nCellar/spack/0.16.2/lib/spack/spack/config.py:905 ==> [2021-06-30-19:23:27.379310] Reading config file /usr/local/Cellar/spack/0.16.2/etc/spack/defaults/repos.yaml\r\nCellar/spack/0.16.2/lib/spack/spack/config.py:905 ==> [2021-06-30-19:23:27.431903] Reading config file /usr/local/Cellar/spack/0.16.2/etc/spack/defaults/packages.yaml\r\nCellar/spack/0.16.2/lib/spack/spack/config.py:905 ==> [2021-06-30-19:23:27.463903] Reading config file /usr/local/Cellar/spack/0.16.2/etc/spack/defaults/darwin/packages.yaml\r\nCellar/spack/0.16.2/lib/spack/spack/config.py:905 ==> [2021-06-30-19:23:27.473058] Reading config file /Users/Branch/.spack/darwin/compilers.yaml\r\nCellar/spack/0.16.2/lib/spack/spack/database.py:361 ==> [2021-06-30-19:23:27.525082] DATABASE LOCK TIMEOUT: 3s\r\nCellar/spack/0.16.2/lib/spack/spack/database.py:365 ==> [2021-06-30-19:23:27.525475] PACKAGE LOCK TIMEOUT: No timeout\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:1371 ==> [2021-06-30-19:23:27.532093] Initializing the build queue from the build requests\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:989 ==> [2021-06-30-19:23:27.532547] Initializing the build queue for zlib\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:2054 ==> [2021-06-30-19:23:27.533780] Processing dependencies for zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga: ('build', 'link', 'run')\r\nCellar/spack/0.16.2/lib/spack/spack/database.py:461 ==> [2021-06-30-19:23:27.553180] Removing failure marking for zlib\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:1793 ==> [2021-06-30-19:23:27.553894] Pkg id zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga has the following dependents:\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:1377 ==> [2021-06-30-19:23:27.555060] Ensure all dependencies know all dependents across specs\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:935 ==> [2021-06-30-19:23:27.556576] Acquiring a write lock on zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga with timeout 1e-09\r\nCellar/spack/0.16.2/lib/spack/spack/stage.py:312 ==> [2021-06-30-19:23:27.561416] Creating stage lock spack-stage-zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:1095 ==> [2021-06-30-19:23:27.563466] Installing zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:393 ==> [2021-06-30-19:23:27.563803] Searching for binary cache of zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga\r\nCellar/spack/0.16.2/lib/spack/spack/config.py:905 ==> [2021-06-30-19:23:27.565923] Reading config file /usr/local/Cellar/spack/0.16.2/etc/spack/defaults/mirrors.yaml\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:1301 ==> [2021-06-30-19:23:27.569783] Flagging zlib-1.2.11-74mwnxgn6nujehpyyalhwizwojwn5zga as failed: 'NoneType' object has no attribute 'replace'\r\nCellar/spack/0.16.2/lib/spack/spack/installer.py:1577 ==> [2021-06-30-19:23:27.571197] Error: Failed to install zlib due to AttributeError: 'NoneType' object has no attribute 'replace'\r\nTraceback (most recent call last):\r\n  File \"/usr/local/bin/spack\", line 66, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/cmd/install.py\", line 365, in install\r\n    install_specs(args, kwargs, zip(abstract_specs, specs))\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/cmd/install.py\", line 207, in install_specs\r\n    builder.install()\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/installer.py\", line 1535, in install\r\n    self._install_task(task)\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/installer.py\", line 1101, in _install_task\r\n    _install_from_cache(pkg, cache_only, explicit, unsigned,\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/installer.py\", line 273, in _install_from_cache\r\n    installed_from_cache = _try_install_from_binary_cache(\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/installer.py\", line 394, in _try_install_from_binary_cache\r\n    matches = binary_distribution.get_mirrors_for_spec(\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/binary_distribution.py\", line 1396, in get_mirrors_for_spec\r\n    results = try_direct_fetch(spec,\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/binary_distribution.py\", line 1336, in try_direct_fetch\r\n    buildcache_fetch_url = url_util.join(\r\n  File \"/usr/local/Cellar/spack/0.16.2/lib/spack/spack/util/url.py\", line 156, in join\r\n    obj = urllib_parse.urlparse(\r\n  File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/urllib/parse.py\", line 393, in urlparse\r\n    splitresult = urlsplit(url, scheme, allow_fragments)\r\n  File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/urllib/parse.py\", line 462, in urlsplit\r\n    scheme = scheme.replace(b, \"\")\r\nAttributeError: 'NoneType' object has no attribute 'replace'\r\n```\r\n</details>\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.2\r\n* **Python:** 3.9.6\r\n* **Platform:** darwin-bigsur-skylake\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n",
    "performed_via_github_app": null
}