{
    "url": "https://api.github.com/repos/spack/spack/issues/2502",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/2502/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/2502/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/2502/events",
    "html_url": "https://github.com/spack/spack/pull/2502",
    "id": 194037853,
    "node_id": "MDExOlB1bGxSZXF1ZXN0OTY5MTQ5MjM=",
    "number": 2502,
    "title": "unit tests: replace nose with pytest ",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 455855856,
            "node_id": "MDU6TGFiZWw0NTU4NTU4NTY=",
            "url": "https://api.github.com/repos/spack/spack/labels/external-packages",
            "name": "external-packages",
            "color": "c5def5",
            "default": false,
            "description": null
        },
        {
            "id": 446620033,
            "node_id": "MDU6TGFiZWw0NDY2MjAwMzM=",
            "url": "https://api.github.com/repos/spack/spack/labels/ready",
            "name": "ready",
            "color": "0e8a16",
            "default": false,
            "description": null
        },
        {
            "id": 456121338,
            "node_id": "MDU6TGFiZWw0NTYxMjEzMzg=",
            "url": "https://api.github.com/repos/spack/spack/labels/refactoring",
            "name": "refactoring",
            "color": "f28f2a",
            "default": false,
            "description": null
        },
        {
            "id": 456341797,
            "node_id": "MDU6TGFiZWw0NTYzNDE3OTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/tests",
            "name": "tests",
            "color": "b60205",
            "default": false,
            "description": "General test capability(ies)"
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "tgamblin",
        "id": 299842,
        "node_id": "MDQ6VXNlcjI5OTg0Mg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/299842?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tgamblin",
        "html_url": "https://github.com/tgamblin",
        "followers_url": "https://api.github.com/users/tgamblin/followers",
        "following_url": "https://api.github.com/users/tgamblin/following{/other_user}",
        "gists_url": "https://api.github.com/users/tgamblin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tgamblin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tgamblin/subscriptions",
        "organizations_url": "https://api.github.com/users/tgamblin/orgs",
        "repos_url": "https://api.github.com/users/tgamblin/repos",
        "events_url": "https://api.github.com/users/tgamblin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tgamblin/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "tgamblin",
            "id": 299842,
            "node_id": "MDQ6VXNlcjI5OTg0Mg==",
            "avatar_url": "https://avatars.githubusercontent.com/u/299842?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tgamblin",
            "html_url": "https://github.com/tgamblin",
            "followers_url": "https://api.github.com/users/tgamblin/followers",
            "following_url": "https://api.github.com/users/tgamblin/following{/other_user}",
            "gists_url": "https://api.github.com/users/tgamblin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tgamblin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tgamblin/subscriptions",
            "organizations_url": "https://api.github.com/users/tgamblin/orgs",
            "repos_url": "https://api.github.com/users/tgamblin/repos",
            "events_url": "https://api.github.com/users/tgamblin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tgamblin/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 25,
    "created_at": "2016-12-07T12:32:34Z",
    "updated_at": "2016-12-29T21:56:02Z",
    "closed_at": "2016-12-29T15:48:49Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/2502",
        "html_url": "https://github.com/spack/spack/pull/2502",
        "diff_url": "https://github.com/spack/spack/pull/2502.diff",
        "patch_url": "https://github.com/spack/spack/pull/2502.patch"
    },
    "body": "##### TLDR\r\n\r\nThis PR changes the testing framework from [nose](http://nose.readthedocs.io/en/latest/) to [pytest](http://doc.pytest.org/en/latest/) for the reasons discussed in #2368. \r\n\r\nAdded benefits:\r\n- fixtures fit well the combinatorial problem we will be facing when adding install tests for packages\r\n- using fixtures scope the execution time for tests has been trimmed down to 3-4 minutes \r\n\r\n##### Modifications\r\n\r\n- [x] removed nose from `lib/spack/external/`\r\n- [x] made `spack test` a wrapper around `pytest`\r\n- [x] rewrote all the mocking classes as a set of fixtures\r\n- [x] removed the mocking classes\r\n- [x] ported all the tests that required mocking to pytest syntax\r\n\r\nI left the port of tests that are written as plain `unittest.TestCase` for future PRs: this one is already huge as it is, and tests that just depend on `unittest.TestCase` can be ported one module at a time.\r\n\r\n##### Miscellaneous Notes\r\n\r\n- `pytest` is better run from spack root directory\r\n- `spack test` is just a wrapper around `pytest` that can be used everywhere\r\n- if coverage is needed run `pytest --cov`, as `spack test` will give wrong results (for any other thing the two commands are equivalent)\r\n\r\n\r\n##### Running `spack test` without `pytest`:\r\n```console\r\n$ spack test\r\n==> Error: Install 'pytest' to have the 'spack test' command available\r\n```\r\n\r\n##### Running the entire test suite\r\n```console\r\n$ spack test\r\n=============================================================================================== test session starts ===============================================================================================\r\nplatform linux2 -- Python 2.7.6, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack, inifile: pytest.ini\r\nplugins: cov-2.4.0\r\ncollected 470 items \r\n\r\nlib/spack/spack/test/architecture.py .......\r\n<more output skipped>\r\nlib/spack/spack/test/cmd/uninstall.py .\r\n\r\n============================================================================================ slowest 20 test durations ============================================================================================\r\n4.35s setup    lib/spack/spack/test/database.py::test_005_db_exists\r\n4.19s teardown lib/spack/spack/test/database.py::test_030_db_sanity_from_another_process\r\n3.94s setup    lib/spack/spack/test/cmd/uninstall.py::test_uninstall\r\n3.93s setup    lib/spack/spack/test/cmd/module.py::test_exit_with_failure[failure_args0]\r\n2.45s call     lib/spack/spack/test/python_version.py::PythonVersionTest::test_core_module_compatibility\r\n1.80s call     lib/spack/spack/test/python_version.py::PythonVersionTest::test_package_module_compatibility\r\n1.03s call     lib/spack/spack/test/mirror.py::TestMirror::test_all_mirror\r\n0.84s call     lib/spack/spack/test/spec_yaml.py::test_ordered_read_not_required_for_consistent_dag_hash\r\n0.79s call     lib/spack/spack/test/directory_layout.py::test_read_and_write_spec\r\n0.76s call     lib/spack/spack/test/lock.py::LockTest::test_complex_acquire_and_release_chain\r\n0.71s call     lib/spack/spack/test/modules.py::TestTcl::test_autoload\r\n0.61s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize_with_restricted_virtual\r\n0.54s call     lib/spack/spack/test/database.py::test_025_reindex\r\n0.42s call     lib/spack/spack/test/architecture.py::test_user_input_combination\r\n0.42s call     lib/spack/spack/test/modules.py::TestTcl::test_prerequisites\r\n0.42s setup    lib/spack/spack/test/hg_fetch.py::test_fetch[default]\r\n0.38s call     lib/spack/spack/test/install.py::test_store\r\n0.37s setup    lib/spack/spack/test/mirror.py::TestMirror::test_svn_mirror\r\n0.36s call     lib/spack/spack/test/modules.py::TestLmod::test_autoload\r\n0.35s call     lib/spack/spack/test/modules.py::TestTcl::test_blacklist\r\n=========================================================================================== 470 passed in 50.75 seconds ===========================================================================================\r\n```\r\n\r\n##### Run a few tests selectively\r\n```console\r\n$ spack test -k 'spec_dag or concretize'\r\n=============================================================================================== test session starts ===============================================================================================\r\nplatform linux2 -- Python 2.7.6, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack, inifile: pytest.ini\r\nplugins: cov-2.4.0\r\ncollected 470 items \r\n\r\nlib/spack/spack/test/concretize.py ...........................................\r\nlib/spack/spack/test/concretize_preferences.py .....\r\nlib/spack/spack/test/spec_dag.py .............................\r\n\r\n============================================================================================ slowest 20 test durations ============================================================================================\r\n0.65s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize_with_restricted_virtual\r\n0.42s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_compilers\r\n0.30s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_variants\r\n0.28s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal\r\n0.28s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal_run\r\n0.25s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal_full\r\n0.24s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_providers\r\n0.24s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_copy_concretized\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_preorder_edge_traversal\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_postorder_edge_traversal\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_preorder_node_traversal\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal_with_builddeps\r\n0.20s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_normalize_twice\r\n0.19s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_preorder_path_traversal\r\n0.18s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize_link_dep_of_build_dep\r\n0.18s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_postorder_node_traversal\r\n0.18s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_postorder_path_traversal\r\n0.17s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize[callpath]\r\n0.16s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_versions\r\n0.15s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_normalize_mpileaks\r\n============================================================================================== 393 tests deselected ===============================================================================================\r\n==================================================================================== 77 passed, 393 deselected in 8.46 seconds ====================================================================================\r\n```\r\n\r\n##### Show the setup plan for a set of tests\r\n```console\r\n$ spack test -k test_05 --setup-plan\r\n=============================================================================================== test session starts ===============================================================================================\r\nplatform linux2 -- Python 2.7.6, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack, inifile: pytest.ini\r\nplugins: cov-2.4.0\r\ncollected 470 items \r\n\r\nlib/spack/spack/test/database.py \r\n      SETUP    F monkeypatch\r\n      SETUP    F mock_fetch_cache (fixtures used: monkeypatch)\r\n      SETUP    F no_stdin_duplication (fixtures used: monkeypatch)\r\nSETUP    S tmpdir_factory\r\nSETUP    S repo_path\r\n  SETUP    M builtin_mock (fixtures used: repo_path)\r\nSETUP    S linux_os\r\nSETUP    S configuration_dir (fixtures used: linux_os, tmpdir_factory)\r\n  SETUP    M config (fixtures used: configuration_dir)\r\n  SETUP    M database (fixtures used: builtin_mock, config, tmpdir_factory)\r\n        lib/spack/spack/test/database.py::test_050_basic_query (fixtures used: builtin_mock, config, configuration_dir, database, linux_os, mock_fetch_cache, monkeypatch, no_stdin_duplication, repo_path, tmpdir_factory)\r\n      TEARDOWN F no_stdin_duplication\r\n      TEARDOWN F mock_fetch_cache\r\n      TEARDOWN F monkeypatch\r\n  TEARDOWN M database\r\n  TEARDOWN M config\r\n  TEARDOWN M builtin_mock\r\nTEARDOWN S configuration_dir\r\nTEARDOWN S linux_os\r\nTEARDOWN S repo_path\r\nTEARDOWN S tmpdir_factory\r\n\r\n============================================================================================ slowest 20 test durations ============================================================================================\r\n0.00s setup    lib/spack/spack/test/database.py::test_050_basic_query\r\n0.00s teardown lib/spack/spack/test/database.py::test_050_basic_query\r\n============================================================================================== 469 tests deselected ===============================================================================================\r\n========================================================================================= 469 deselected in 0.50 seconds ==========================================================================================\r\n```\r\n\r\n##### Getting help on the ton of options that are not above\r\n```console\r\n$ spack test -h\r\n...\r\n```\r\n\r\n\r\n",
    "performed_via_github_app": null
}