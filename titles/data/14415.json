{
    "url": "https://api.github.com/repos/spack/spack/issues/14415",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/14415/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/14415/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/14415/events",
    "html_url": "https://github.com/spack/spack/issues/14415",
    "id": 546444300,
    "node_id": "MDU6SXNzdWU1NDY0NDQzMDA=",
    "number": 14415,
    "title": "Installation error: Python can't find _iconv symbol",
    "user": {
        "login": "coreyjadams",
        "id": 6619961,
        "node_id": "MDQ6VXNlcjY2MTk5NjE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6619961?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/coreyjadams",
        "html_url": "https://github.com/coreyjadams",
        "followers_url": "https://api.github.com/users/coreyjadams/followers",
        "following_url": "https://api.github.com/users/coreyjadams/following{/other_user}",
        "gists_url": "https://api.github.com/users/coreyjadams/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/coreyjadams/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/coreyjadams/subscriptions",
        "organizations_url": "https://api.github.com/users/coreyjadams/orgs",
        "repos_url": "https://api.github.com/users/coreyjadams/repos",
        "events_url": "https://api.github.com/users/coreyjadams/events{/privacy}",
        "received_events_url": "https://api.github.com/users/coreyjadams/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 537065486,
            "node_id": "MDU6TGFiZWw1MzcwNjU0ODY=",
            "url": "https://api.github.com/repos/spack/spack/labels/environments",
            "name": "environments",
            "color": "d4c5f9",
            "default": false,
            "description": null
        },
        {
            "id": 446614839,
            "node_id": "MDU6TGFiZWw0NDY2MTQ4Mzk=",
            "url": "https://api.github.com/repos/spack/spack/labels/macOS",
            "name": "macOS",
            "color": "c5def5",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 32,
    "created_at": "2020-01-07T18:41:51Z",
    "updated_at": "2020-04-21T04:47:05Z",
    "closed_at": "2020-04-21T04:47:05Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I have been trying to build packages with spack on mac os Mojave for awhile now and I have been struggling.  I've simplified my software stack as much as possible to reproduce one of the issues I keep seeing.\r\n\r\nI created an environment (called `nexus`, here) with the following commands:\r\n```\r\n$ spack env create nexus nexus.yaml\r\n```\r\nWhere nexus.yaml is:\r\n```\r\nspack:\r\n  specs:\r\n    - python\r\n```\r\n\r\nFrom here, I activate, concretize and install:\r\n```\r\n$ spack env activate nexus\r\n$ spack concretize\r\n==> Warning: clang@11.0.0-apple cannot build optimized binaries for \"skylake\". Using best target possible: \"x86_64\"\r\n==> Warning: clang@11.0.0-apple cannot build optimized binaries for \"skylake\". Using best target possible: \"x86_64\"\r\n==> Concretized python\r\n -   hpjs6nz  python@3.7.4%clang@11.0.0-apple+bz2+ctypes+dbm+lzma~nis~optimizations patches=210df3f28cde02a8135b58cc4168e70ab91dbf9097359d05938f1e2843875e57 +pic+pyexpat+pythoncmd+readline~shared+sqlite3+ssl~tix~tkinter~ucs4~uuid+zlib arch=darwin-mojave-x86_64\r\n -   ysmjykg      ^bzip2@1.0.8%clang@11.0.0-apple+shared arch=darwin-mojave-x86_64\r\n -   yn2yzi3          ^diffutils@3.7%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   jg6ekuh              ^libiconv@1.16%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   l4gxq46      ^expat@2.2.9%clang@11.0.0-apple~libbsd arch=darwin-mojave-x86_64\r\n -   3t4dwsv      ^gdbm@1.18.1%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   h2bjtz2          ^readline@8.0%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   zbgxvxi              ^ncurses@6.1%clang@11.0.0-apple~symlinks~termlib arch=darwin-mojave-x86_64\r\n -   f3libie                  ^pkgconf@1.6.3%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   msyeqht      ^gettext@0.20.1%clang@11.0.0-apple+bzip2+curses+git~libunistring+libxml2+tar+xz arch=darwin-mojave-x86_64\r\n -   w354vrb          ^libxml2@2.9.9%clang@11.0.0-apple~python arch=darwin-mojave-x86_64\r\n -   b7n722h              ^xz@5.2.4%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   xj36ejk              ^zlib@1.2.11%clang@11.0.0-apple+optimize+pic+shared arch=darwin-mojave-x86_64\r\n -   2e6sifw          ^tar@1.32%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   7yg7qah      ^libffi@3.2.1%clang@11.0.0-apple arch=darwin-mojave-x86_64\r\n -   ugvknwc      ^openssl@1.1.1d%clang@11.0.0-apple+systemcerts arch=darwin-mojave-x86_64\r\n -   l6fc2zw          ^perl@5.30.0%clang@11.0.0-apple+cpanm+shared+threads arch=darwin-mojave-x86_64\r\n -   hsmq6ou      ^sqlite@3.30.1%clang@11.0.0-apple~column_metadata+fts~functions~rtree arch=darwin-mojave-x86_64\r\n\r\n==> Updating view at /Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view\r\n```\r\n\r\nThe install process reported no errors whatsoever.  Ran for awhile and then afterwards, `python` executable is active and available, but spack itself is broken:\r\n\r\n```Traceback (most recent call last):\r\n  File \"/Users/corey.adams/spack/spack/bin/spack\", line 63, in <module>\r\n    import spack.main  # noqa\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/main.py\", line 29, in <module>\r\n    import spack.architecture\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/architecture.py\", line 69, in <module>\r\n    import spack.compiler\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/compiler.py\", line 19, in <module>\r\n    import spack.spec\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/spec.py\", line 105, in <module>\r\n    import spack.repo\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/repo.py\", line 36, in <module>\r\n    import spack.caches\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/caches.py\", line 15, in <module>\r\n    import spack.fetch_strategy\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/fetch_strategy.py\", line 42, in <module>\r\n    import spack.util.web as web_util\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/spack/util/web.py\", line 18, in <module>\r\n    from six.moves.urllib.request import urlopen, Request\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/external/six.py\", line 92, in __get__\r\n    result = self._resolve()\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/external/six.py\", line 160, in _resolve\r\n    module = _import_module(self.mod)\r\n  File \"/Users/corey.adams/spack/spack/lib/spack/external/six.py\", line 82, in _import_module\r\n    __import__(name)\r\n  File \"/Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/python3.7/urllib/request.py\", line 2583, in <module>\r\n    from _scproxy import _get_proxy_settings, _get_proxies\r\nImportError: dlopen(/Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/python3.7/lib-dynload/_scproxy.cpython-37m-darwin.so, 2): Symbol not found: _iconv\r\n  Referenced from: /usr/lib/libcups.2.dylib\r\n  Expected in: /Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/libiconv.2.dylib\r\n in /usr/lib/libcups.2.dylib\r\n```\r\n\r\nI am using clang11:\r\n```\r\n$ spack config get compilers\r\ncompilers:\r\n- compiler:\r\n    spec: clang@11.0.0-apple\r\n    paths:\r\n      cc: /usr/bin/clang\r\n      cxx: /usr/bin/clang++\r\n      f77:\r\n      fc:\r\n    flags: {}\r\n    operating_system: mojave\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\n\r\n\r\nI note a few things here:\r\nThe library that causes the issue doesn't directly link against `libcups`:\r\n```\r\n$ otool -L /Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/python3.7/lib-dynload/_scproxy.cpython-37m-darwin.so\r\n/Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/python3.7/lib-dynload/_scproxy.cpython-37m-darwin.so:\r\n\t/System/Library/Frameworks/SystemConfiguration.framework/Versions/A/SystemConfiguration (compatibility version 1.0.0, current version 1061.40.2)\r\n\t/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1673.126.0)\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.0.0)\r\n```\r\n\r\nI am not enough of a linking expert to track down where the dependency is coming from.  I also note that the library it finds for libcups that spack has build does *not* link to a library that has `_iconv` symbols defined:\r\n```\r\ncorey.adams@cadams2 : ~/NEXT\r\n$ otool -L /Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/libiconv.2.dylib\r\n/Users/corey.adams/spack/spack/var/spack/environments/nexus/.spack-env/view/lib/libiconv.2.dylib:\r\n\t/Users/corey.adams/spack/spack/opt/spack/darwin-mojave-x86_64/clang-11.0.0-apple/libiconv-1.16-jg6ekuhbklculym7pyjpx6l5jetym7wp/lib/libiconv.2.dylib (compatibility version 9.0.0, current version 9.1.0)\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.0.0)\r\n\r\ncorey.adams@cadams2 : ~/NEXT\r\n$ nm /Users/corey.adams/spack/spack/opt/spack/darwin-mojave-x86_64/clang-11.0.0-apple/libiconv-1.16-jg6ekuhbklculym7pyjpx6l5jetym7wp/lib/libiconv.2.dylib | grep _iconv\r\n0000000000003360 T _iconv_canonicalize\r\n```\r\n\r\nHowever, the library available at system level does:\r\n```\r\n$ otool -L /usr/lib/libcups.2.dylib\r\n/usr/lib/libcups.2.dylib:\r\n\t/usr/lib/libcups.2.dylib (compatibility version 2.0.0, current version 2.13.0)\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.250.1)\r\n\t/System/Library/Frameworks/Kerberos.framework/Versions/A/Kerberos (compatibility version 5.0.0, current version 6.0.0)\r\n\t/System/Library/Frameworks/GSS.framework/Versions/A/GSS (compatibility version 1.0.0, current version 1.0.0)\r\n\t/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1575.17.0)\r\n\t/System/Library/Frameworks/SystemConfiguration.framework/Versions/A/SystemConfiguration (compatibility version 1.0.0, current version 963.255.3)\r\n\t/usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)\r\n\t/System/Library/Frameworks/Security.framework/Versions/A/Security (compatibility version 1.0.0, current version 58286.255.3)\r\n\t/usr/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)\r\n\t/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)\r\n\r\ncorey.adams@cadams2 : ~/NEXT\r\n$ nm /usr/lib/libiconv.2.dylib | grep _iconv\r\n0000000000002360 T _iconv\r\n00000000000f0da0 s _iconv_2VersionNumber\r\n00000000000f0d70 s _iconv_2VersionString\r\n000000000000267a T _iconv_canonicalize\r\n0000000000002382 T _iconv_close\r\n0000000000001049 T _iconv_open\r\n000000000000238f T _iconvctl\r\n0000000000002488 T _iconvlist\r\n```\r\n\r\nI don't have anything special on LD_LIBRARY_PATH - it is unset before spack env activate.\r\n\r\nSomehow, spack seems to be building a package that links against the system version of libcups (which in turn links to system iconv) while at run time it is picking up it's own libcups (and it's own libiconv) which is missing symbols that it needs.\r\n\r\nThis is macOS mojave.\r\n\r\nThoughts?",
    "performed_via_github_app": null
}