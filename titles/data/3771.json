{
    "url": "https://api.github.com/repos/spack/spack/issues/3771",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/3771/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/3771/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/3771/events",
    "html_url": "https://github.com/spack/spack/issues/3771",
    "id": 220486145,
    "node_id": "MDU6SXNzdWUyMjA0ODYxNDU=",
    "number": 3771,
    "title": "mosh won't build for me, protobuf can't find it's input file.",
    "user": {
        "login": "hartzell",
        "id": 312978,
        "node_id": "MDQ6VXNlcjMxMjk3OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/312978?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hartzell",
        "html_url": "https://github.com/hartzell",
        "followers_url": "https://api.github.com/users/hartzell/followers",
        "following_url": "https://api.github.com/users/hartzell/following{/other_user}",
        "gists_url": "https://api.github.com/users/hartzell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hartzell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hartzell/subscriptions",
        "organizations_url": "https://api.github.com/users/hartzell/orgs",
        "repos_url": "https://api.github.com/users/hartzell/repos",
        "events_url": "https://api.github.com/users/hartzell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hartzell/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2017-04-09T17:39:17Z",
    "updated_at": "2017-04-10T16:13:06Z",
    "closed_at": "2017-04-10T16:13:06Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "On a CentOS 7 system with a spack tree from yesterday afternoon, I'm unable to `spack install mosh`.\r\n\r\nJump down to **TL;DR** for an explicit question...\r\n\r\nHere's the juicy but of `spack-build.log`:\r\n\r\n```\r\n[...]\r\n==> 'make' '-j28'\r\nmake  all-recursive\r\nmake[1]: Entering directory `/tmp/hartzelg/spack-stage/spack-stage-qPQ1ET/mosh-1.3.0'\r\nMaking all in scripts\r\nmake[2]: Entering directory `/tmp/hartzelg/spack-stage/spack-stage-qPQ1ET/mosh-1.3.0/scripts'\r\nmake[2]: Leaving directory `/tmp/hartzelg/spack-stage/spack-stage-qPQ1ET/mosh-1.3.0/scripts'\r\nMaking all in src\r\nmake[2]: Entering directory `/tmp/hartzelg/spack-stage/spack-stage-qPQ1ET/mosh-1.3.0/src'\r\nMaking all in protobufs\r\nmake[3]: Entering directory `/tmp/hartzelg/spack-stage/spack-stage-qPQ1ET/mosh-1.3.0/src/protobufs'\r\n  GEN      userinput.pb.cc\r\n  GEN      hostinput.pb.cc\r\n  GEN      transportinstruction.pb.cc\r\ntransportinstruction.protohostinput.proto: File does not reside within any path specified using --proto_path (or -I).  You must specify a --proto_path which encompasses this file.  Note that the proto_path must be an exact prefix of the .proto file names -- protoc is too dumb to figure out when two paths (e.g. absolute and relative) are equivalent (it's harder than you think).: File does not reside within any path specified using --proto_path (or -I).  You must specify a --proto_path which encompasses this file.  Note that the proto_path must be an exact prefix of the .proto file names -- protoc is too dumb to figure out when two paths (e.g. absolute and relative) are equivalent (it's harder than you think).\r\n\r\nuserinput.proto: File does not reside within any path specified using --proto_path (or -I).  You must specify a --proto_path which encompasses this file.  Note that the proto_path must be an exact prefix of the .proto file names -- protoc is too dumb to figure out when two paths (e.g. absolute and relative) are equivalent (it's harder than you think).\r\nmake[3]: *** [transportinstruction.pb.cc] Error 1\r\n[...]\r\n```\r\n\r\nI can start a shell w/ the right environment (`spack env mosh bash`) and replicate the failure:\r\n\r\n```\r\n[hartzelg@lb046dev protobufs]$ make V=1\r\n/home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I/home/hartzelg/tmp/spack-mosh/var/spack/stage/mosh-1.3.0-fwqhl7dbr67goilqwklz6aqrlxixmakz/mosh-1.3.0/src/protobufs userinput.proto\r\nuserinput.proto: File does not reside within any path specified using --proto_path (or -I).  You must specify a --proto_path which encompasses this file.  Note that the proto_path must be an exact prefix of the .proto file names -- protoc is too dumb to figure out when two paths (e.g. absolute and relative) are equivalent (it's harder than you think).\r\nmake: *** [userinput.pb.cc] Error 1\r\n```\r\n\r\nWhat's \"funny\" is that all three of the invocations below work.  It seems that the pathname for the source really has to match, *exactly*, the pathname supplied via `-I` (even to the point of dealing with the fact that the build dir is a symlink).\r\n\r\n```\r\n[hartzelg@lb046dev protobufs]$ /home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I/home/hartzelg/tmp/spack-mosh/var/spack/stage/mosh-1.3.0-fwqhl7dbr67goilqwklz6aqrlxixmakz/mosh-1.3.0/src/protobufs /home/hartzelg/tmp/spack-mosh/var/spack/stage/mosh-1.3.0-fwqhl7dbr67goilqwklz6aqrlxixmakz/mosh-1.3.0/src/protobufs/userinput.proto\r\n[hartzelg@lb046dev protobufs]$ /home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I. userinput.proto\r\n[hartzelg@lb046dev protobufs]$ /home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I`pwd` `pwd`/userinput.proto\r\n[hartzelg@lb046dev protobufs]$\r\n```\r\n\r\nHere's the bit of the `Makefile.am` that generates the `Makefile.in` that generates the Makefile.  If/when $(srcdir) is anything other than `.`, I don't see how this works.\r\n\r\n```\r\n.proto.pb.cc:\r\n    $(AM_V_GEN)$(PROTOC) --cpp_out=. -I$(srcdir) $<\r\n```\r\n\r\nIf I jump up to the top of the src tree, `make clean`, and then `./configure --prefix=/tmp/moose`, `make` will succeed.  Investigating futher, if I cd into the `src/protobuf` directory and run `make V=1` it ends up invoking `protoc` like so:\r\n\r\n```\r\n[hartzelg@lb046dev protobufs]$ make V=1\r\n/home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I. userinput.proto\r\n/home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I. hostinput.proto\r\n/home/hartzelg/tmp/spack-mosh/opt/spack/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.2.0-czzwxzs2ugdrauo4z6lhxvuyqfxz6zsu/bin/protoc --cpp_out=. -I. transportinstruction.proto\r\nmake  all-am\r\n```\r\n\r\nNotice that now the include path and the source file name are \"agreeable\".\r\n\r\n### TL;DR\r\n\r\nIt turns out that making this change:\r\n\r\n```diff\r\n@@ -43,3 +44,5 @@ class Mosh(AutotoolsPackage):\r\n     depends_on('openssl')\r\n\r\n     depends_on('perl', type='run')\r\n+\r\n+    configure_directory='.'\r\n```\r\n\r\nto `.../mosh/package.py` allows it to build.\r\n\r\nThat seems nasty though.  What's the Right Thing To Do?  Does it work on other systems as is?\r\n",
    "performed_via_github_app": null
}