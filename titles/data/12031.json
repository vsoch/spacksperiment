{
    "url": "https://api.github.com/repos/spack/spack/issues/12031",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/12031/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/12031/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/12031/events",
    "html_url": "https://github.com/spack/spack/pull/12031",
    "id": 468341467,
    "node_id": "MDExOlB1bGxSZXF1ZXN0Mjk3NzkyMzM2",
    "number": 12031,
    "title": " Speed-up tests that rely on the database fixture",
    "user": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 456341797,
            "node_id": "MDU6TGFiZWw0NTYzNDE3OTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/tests",
            "name": "tests",
            "color": "b60205",
            "default": false,
            "description": "General test capability(ies)"
        },
        {
            "id": 671550628,
            "node_id": "MDU6TGFiZWw2NzE1NTA2Mjg=",
            "url": "https://api.github.com/repos/spack/spack/labels/travis",
            "name": "travis",
            "color": "bfdadc",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 9,
    "created_at": "2019-07-15T21:21:38Z",
    "updated_at": "2019-07-20T17:50:57Z",
    "closed_at": "2019-07-20T17:18:50Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/12031",
        "html_url": "https://github.com/spack/spack/pull/12031",
        "diff_url": "https://github.com/spack/spack/pull/12031.diff",
        "patch_url": "https://github.com/spack/spack/pull/12031.patch"
    },
    "body": "The `database` and `mutable_database` fixtures were installing and uninstalling the same specs multiple times to maintain the test database in a consistent state. This PR optimizes the procedure by:\r\n- Installing specs only the first time the fixtures are requested\r\n- Caching the installation path into a persistent folder\r\n- Erasing the installation path and copying the cache back into it when needed\r\n\r\nThe results on my laptop:\r\n```console\r\n$ uname -a\r\nLinux nuvolari 4.15.0-54-generic #58-Ubuntu SMP Mon Jun 24 10:55:24 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n are the following. On `develop` (with 2 tests not marked):\r\n```console\r\n$ python3.7 bin/spack test -m db\r\n============================================================== test session starts ===============================================================\r\nplatform linux -- Python 3.7.4, pytest-3.2.5, py-1.4.34, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack/lib/spack/spack/test, inifile: pytest.ini\r\ncollected 1553 items                                                                                                                              \r\n\r\ndatabase.py .......................\r\nspec_syntax.py .......\r\ncmd/dependencies.py ..\r\ncmd/dependents.py ..\r\ncmd/find.py ....\r\ncmd/graph.py .....\r\ncmd/location.py .......\r\ncmd/module.py ............................\r\ncmd/uninstall.py ...\r\nmodules/tcl.py ..\r\n\r\n=========================================================== slowest 20 test durations ============================================================\r\n4.01s setup    cmd/location.py::test_location_install_dir\r\n4.00s setup    cmd/module.py::test_exit_with_failure[dotkit-failure_args0]\r\n3.88s setup    cmd/graph.py::test_graph_ascii\r\n3.85s setup    cmd/dependencies.py::test_immediate_installed_dependencies\r\n3.82s setup    cmd/dependents.py::test_immediate_installed_dependents\r\n3.82s setup    cmd/find.py::test_tag1\r\n3.81s teardown database.py::test_old_external_entries_prefix\r\n3.81s setup    spec_syntax.py::TestSpecSyntax::test_spec_by_hash\r\n3.80s teardown database.py::test_regression_issue_8036\r\n3.76s teardown database.py::test_030_db_sanity_from_another_process\r\n3.75s teardown database.py::test_115_reindex_with_packages_not_in_repo\r\n3.33s setup    modules/tcl.py::TestTcl::test_blacklist_implicits\r\n3.22s teardown cmd/module.py::test_setdefault_command\r\n3.21s setup    cmd/uninstall.py::test_multiple_matches\r\n2.59s setup    database.py::test_default_queries\r\n0.79s call     cmd/module.py::test_setdefault_command\r\n0.63s call     database.py::test_025_reindex\r\n0.55s call     cmd/module.py::test_remove_and_add[dotkit]\r\n0.51s call     database.py::test_115_reindex_with_packages_not_in_repo\r\n0.50s call     spec_syntax.py::TestSpecSyntax::test_spec_by_hash\r\n============================================================= 1470 tests deselected ==============================================================\r\n================================================== 83 passed, 1470 deselected in 64.46 seconds ===================================================\r\n```\r\nwhile with this PR:\r\n```console\r\n$ python3.7 bin/spack test -m db\r\n============================================================== test session starts ===============================================================\r\nplatform linux -- Python 3.7.4, pytest-3.2.5, py-1.4.34, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack/lib/spack/spack/test, inifile: pytest.ini\r\ncollected 1553 items                                                                                                                              \r\n\r\ndatabase.py .......................\r\nspec_syntax.py .......\r\ncmd/buildcache.py .\r\ncmd/debug.py .\r\ncmd/dependencies.py ..\r\ncmd/dependents.py ..\r\ncmd/find.py ....\r\ncmd/graph.py .....\r\ncmd/location.py .......\r\ncmd/module.py ............................\r\ncmd/uninstall.py ...\r\nmodules/tcl.py ..\r\n\r\n=========================================================== slowest 20 test durations ============================================================\r\n2.45s setup    database.py::test_default_queries\r\n0.74s call     cmd/module.py::test_setdefault_command\r\n0.65s call     database.py::test_025_reindex\r\n0.56s call     cmd/buildcache.py::test_buildcache_preview_just_runs\r\n0.55s call     cmd/module.py::test_remove_and_add[dotkit]\r\n0.54s call     cmd/module.py::test_remove_and_add[tcl]\r\n0.54s call     spec_syntax.py::TestSpecSyntax::test_spec_by_hash\r\n0.52s call     database.py::test_115_reindex_with_packages_not_in_repo\r\n0.45s call     modules/tcl.py::TestTcl::test_autoload_with_constraints\r\n0.28s call     cmd/uninstall.py::test_recursive_uninstall\r\n0.25s call     database.py::test_060_remove_and_add_root_package\r\n0.23s call     database.py::test_030_db_sanity_from_another_process\r\n0.22s call     database.py::test_070_remove_and_add_dependency_package\r\n0.21s call     database.py::test_010_all_install_sanity\r\n0.20s call     database.py::test_090_non_root_ref_counts\r\n0.19s call     database.py::test_020_db_sanity\r\n0.15s call     database.py::test_015_write_and_read\r\n0.15s call     database.py::test_080_root_ref_counts\r\n0.14s call     cmd/module.py::test_find_recursive\r\n0.13s call     cmd/dependents.py::test_transitive_installed_dependents\r\n============================================================= 1468 tests deselected ==============================================================\r\n================================================== 85 passed, 1468 deselected in 15.72 seconds ===================================================\r\n```\r\n ",
    "performed_via_github_app": null
}