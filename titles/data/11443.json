{
    "url": "https://api.github.com/repos/spack/spack/issues/11443",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/11443/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/11443/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/11443/events",
    "html_url": "https://github.com/spack/spack/issues/11443",
    "id": 444034306,
    "node_id": "MDU6SXNzdWU0NDQwMzQzMDY=",
    "number": 11443,
    "title": "spack aborts while processing a library list file when creating a module environment variable",
    "user": {
        "login": "jgalarowicz",
        "id": 630197,
        "node_id": "MDQ6VXNlcjYzMDE5Nw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/630197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jgalarowicz",
        "html_url": "https://github.com/jgalarowicz",
        "followers_url": "https://api.github.com/users/jgalarowicz/followers",
        "following_url": "https://api.github.com/users/jgalarowicz/following{/other_user}",
        "gists_url": "https://api.github.com/users/jgalarowicz/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jgalarowicz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jgalarowicz/subscriptions",
        "organizations_url": "https://api.github.com/users/jgalarowicz/orgs",
        "repos_url": "https://api.github.com/users/jgalarowicz/repos",
        "events_url": "https://api.github.com/users/jgalarowicz/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jgalarowicz/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-05-14T17:22:06Z",
    "updated_at": "2019-05-17T01:20:57Z",
    "closed_at": "2019-05-17T01:20:57Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I'm trying to build and install openspeedshop.  spack gets to the end where it is creating the module file, but apparently something has changed recently and spack aborts when processing a LibraryList file for a module environment variable setting.   I have a smaller test case that recreates the issue, so that there is not so much time spent trying to get to the issue.\r\nThe issue results in this output after typing in \"spack install openspeedshop +cuda+openmpi\":\r\n```\r\n==> Installing openspeedshop\r\n==> Searching for binary cache of openspeedshop\r\n==> Warning: No Spack mirrors are currently configured\r\n==> No binary for openspeedshop found: installing from source\r\n==> Cloning git repository: https://github.com/OpenSpeedShop/openspeedshop.git on branch 2.4.1\r\n==> No checksum needed when fetching with git\r\n==> Already staged openspeedshop-2.4.1-umryg2mzynqr2ytrdsnnutaz2ohjd5ic in /home/jeg/spack/var/spack/stage/openspeedshop-2.4.1-umryg2mzynqr2ytrdsnnutaz2ohjd5ic\r\n==> No patches needed for openspeedshop\r\n==> Building openspeedshop [CMakePackage]\r\n==> Executing phase: 'cmake'\r\n==> Executing phase: 'build'\r\n==> Executing phase: 'install'\r\n==> Error: TypeError: expected string or buffer\r\n\r\n/home/jeg/spack/lib/spack/spack/package.py:1544, in build_process:\r\n       1541                    echo = logger.echo\r\n       1542                    self.log()\r\n       1543\r\n  >>   1544                # Run post install hooks before build stage is removed.\r\n       1545                spack.hooks.post_install(self.spec)\r\n       1546\r\n       1547            # Stop timer.\r\n```\r\nI narrowed it down to these two lines when setting up the runtime module file for openspeedshop in the setup_environment function.  If I comment out these lines I do not get the TypeError:\r\n```\r\ndyninst_libdir = find_libraries('libdyninstAPI_RT', root=self.spec['dyninst'].prefix, shared=True, recursive=True)\r\nrun_env.set('DYNINSTAPI_RT_LIB', dyninst_libdir)\r\n```\r\nWith the lines not commented out, spack or python fails to properly do the re.search command coming from line ~3106 in  ..../spack/lib/spack/spack/spec.py\r\nHere are the output lines from my debug that I inserted in a number of places to isolate what was occurring:\r\n```\r\n ('format, format_string=', '/home/jeg/spack/opt/spack/linux-fedora27-x86_64/gcc-7.2.1/openspeedshop-2.4.1-y5jqrjlliujiz32dfbcz4nqmlxwmxac4/')\r\n('format, format_string=', 'XLOCALEDIR')\r\n('format, format_string=', '/home/jeg/spack/opt/spack/linux-fedora27-x86_64/gcc-7.2.1/libx11-1.6.7-fhs7gx35mkgmro62rfburcm2xmz772ws/share/X11/locale')\r\n('format, format_string=', 'DYNINSTAPI_RT_LIB')\r\n('format, format_string=', LibraryList(['/home/jeg/spack/opt/spack/linux-fedora27-x86_64/gcc-7.2.1/dyninst-10.0.0-wk7nj3m7upj5dhkb7pcy7dv6claeo5mf/lib/libdyninstAPI_RT.so']))\r\n==> [2019-05-13-14:14:44.658365] WRITE LOCK: /home/jeg/spack/opt/spack/.spack-db/prefix_lock[7181416571588479302:1] [Released]\r\n==> [2019-05-13-14:14:44.658501] WRITE LOCK: /home/jeg/spack/var/spack/stage/.lock[7480844701735694514:1] [Released]\r\n('make_child_error, module =', 'exceptions')\r\n('make_child_error, name =', 'TypeError')\r\n('make_child_error, msg =', 'TypeError: expected string or buffer')\r\n('make_child_error, context =', ['/home/jeg/spack/lib/spack/spack/package.py:1544, in build_process:', '       1541                    echo = logger.echo', '       1542                    self.log()', ' 1543', '\\x1b[0;91m  >>   1544                # Run post install hooks before build stage is removed.\\x1b[0m', ' 1545                spack.hooks.post_install(self.spec)', ' 1546', '       1547            # Stop timer.'])\r\n==> [2019-05-13-14:14:44.665056] Error: TypeError: expected string or buffer (edited) \r\n```\r\nI created a dummied up smaller test case to recreate the problem.    I create a dummy directory called jegprob and add the following package.py file into that directory and then run: \"spack install jegprob\" to recreate the issue.\r\nHere is the package.py file:\r\n```\r\n# Copyright 2013-2019 Lawrence Livermore National Security, LLC and other\r\n# Spack Project Developers. See the top-level COPYRIGHT file for details.\r\n#\r\n# SPDX-License-Identifier: (Apache-2.0 OR MIT)\r\nfrom spack import *\r\nclass Jegprob(CMakePackage):\r\n    \"\"\"CBTF project contains the base code for CBTF that supports creating\r\n       components, component networks and the support to connect these\r\n       components and component networks into sequential and distributed\r\n       network tools.\r\n\r\n    \"\"\"\r\n    homepage = \"http://sourceforge.net/p/cbtf/wiki/Home\"\r\n    git      = \"https://github.com/OpenSpeedShop/cbtf.git\"\r\n    version('develop', branch='master')\r\n    version('1.9.3', branch='1.9.3')\r\n    version('1.9.2', branch='1.9.2')\r\n    variant('cti', default=False,\r\n            description=\"Build MRNet with the CTI startup option\")\r\n    variant('runtime', default=False,\r\n            description=\"build only the runtime libraries and collectors.\")\r\n    variant('build_type', default='None', values=('None'),\r\n            description='CMake build type')\r\n    depends_on(\"cmake@3.0.2:\", type='build')\r\n    # For Xerces-C\r\n    depends_on(\"xerces-c\")\r\n    parallel = False\r\n    build_directory = 'build_cbtf'\r\n    def setup_environment(self, spack_env, run_env):\r\n        \"\"\"Set up the compile and runtime environments for a package.\"\"\"\r\n        xercesc_libdir = find_libraries('libxerces-c',\r\n                                        root=self.spec['xerces-c'].prefix,\r\n                                        shared=True, recursive=True)\r\n        # Set Dyninst RT library path to support OSS loop resolution code\r\n        run_env.set('XERCESC_RT_LIB', xercesc_libdir)\r\n        run_env.set('OPENSS_RAWDATA_DIR', '.')\r\n```\r\nMy packages.py external file looks like this:\r\n```\r\npackages:\r\n   all:\r\n      providers:\r\n         pkgconfig: [pkg-config]\r\n   mpich:\r\n      buildable: False\r\n      paths:\r\n         mpich@3.2.0%gcc@7.3.1 arch=linux-fedora27-x86_64: /opt/mpich-3.2\r\n   openmpi:\r\n      buildable: False\r\n      paths:\r\n         openmpi@3.1.3%gcc@7.3.1 arch=linux-fedora27-x86_64: /opt/openmpi-3.1.3\r\n         openmpi@2.0.3%gcc@7.3.1 arch=linux-fedora27-x86_64: /opt/openmpi-2.0.3\r\n         openmpi@1.8.2%gcc@7.3.1 arch=linux-fedora27-x86_64: /opt/openmpi-1.8.2\r\n   qt:\r\n      paths:\r\n         qt3@3.3.8b%gcc@7.3.1 arch=linux-fedora27-x86_64: /usr/lib64/qt-3.3\r\n   cmake:\r\n      paths:\r\n         cmake@3.10.0%gcc@7.3.1 arch=linux-fedora27-x86_64: /usr\r\n```\r\n\r\n",
    "performed_via_github_app": null
}