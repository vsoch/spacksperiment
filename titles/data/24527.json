{
    "url": "https://api.github.com/repos/spack/spack/issues/24527",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24527/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24527/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24527/events",
    "html_url": "https://github.com/spack/spack/issues/24527",
    "id": 930367948,
    "node_id": "MDU6SXNzdWU5MzAzNjc5NDg=",
    "number": 24527,
    "title": "Installation issue: Packages with Python dependency fail to build if two interpreters present",
    "user": {
        "login": "christoph-conrads",
        "id": 22275833,
        "node_id": "MDQ6VXNlcjIyMjc1ODMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/22275833?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/christoph-conrads",
        "html_url": "https://github.com/christoph-conrads",
        "followers_url": "https://api.github.com/users/christoph-conrads/followers",
        "following_url": "https://api.github.com/users/christoph-conrads/following{/other_user}",
        "gists_url": "https://api.github.com/users/christoph-conrads/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/christoph-conrads/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/christoph-conrads/subscriptions",
        "organizations_url": "https://api.github.com/users/christoph-conrads/orgs",
        "repos_url": "https://api.github.com/users/christoph-conrads/repos",
        "events_url": "https://api.github.com/users/christoph-conrads/events{/privacy}",
        "received_events_url": "https://api.github.com/users/christoph-conrads/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2021-06-25T17:25:39Z",
    "updated_at": "2021-06-27T14:22:45Z",
    "closed_at": "2021-06-27T14:20:39Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "A dummy CMake package with a Python dependency may fail to build on Debian 9 / Devuan Ascii when there is a Python3 interpreter installed on the host and a Spack-built Python3 interpreter. When CMake is run, the host interpreter is called and crashes.\r\n\r\n### Steps to reproduce the issue\r\n\r\nThe issue can be reproduced in a Linux container. The first step shows how to set up the container, the second step sets up a dummy package and builds it successfully with Spack. The third step shows how to break the build.\r\n\r\n#### Step 1: Container setup\r\n\r\nLXD commands for creating a new Debian 9 LXD container with a user called john:\r\n```sh\r\n#!/bin/bash\r\n\r\nset -e\r\nset -u\r\n\r\nlxc launch images:debian/9 d9\r\nlxc exec d9 -- apt-get update\r\nlxc exec d9 -- apt-get install -y \\\r\n    build-essential \\\r\n    bzip2 \\\r\n    curl \\\r\n    git \\\r\n    gzip \\\r\n    patch \\\r\n    python3 \\\r\n    python3-dev \\\r\n    tar \\\r\n    unzip \\\r\n    xz-utils \\\r\n    zstd \\\r\n    cmake \\\r\n    libssl-dev \\\r\n    pkg-config \\\r\n    sudo\r\nlxc exec d9 -- adduser --disabled-password --gecos '' john\r\n```\r\n\r\n#### Step 2: Package Build\r\n\r\nLogin with `lxc exec d9 -- login -f john` and execute these Spack commands (or pipe them into Bash with `lxc exec d9 -- sudo --login --user john -- /bin/bash <commands.txt`):\r\n```sh\r\n#!/bin/bash\r\n\r\nset -e\r\nset -u\r\n\r\ncd\r\nif [ ! -d py3-clash/ ]; then\r\n    mkdir py3-clash\r\n    cd py3-clash/\r\n    cat >CMakeLists.txt <<EOF\r\ncmake_minimum_required(VERSION 3.7.2)\r\nproject(py3-cmake-spack-clash VERSION 1.0 LANGUAGES C)\r\nfind_package(PythonInterp 3.5.3 REQUIRED)\r\ninstall(CODE \"message(\\\"dummy installation\\\")\")\r\nEOF\r\nfi\r\n\r\ncd\r\nif [ ! -d spack/ ]; then\r\n    git clone --depth=1 -- 'https://github.com/spack/spack.git'\r\n    mkdir ~/spack/var/spack/repos/builtin/packages/py3-clash/\r\n    cat >~/spack/var/spack/repos/builtin/packages/py3-clash/package.py <<EOF\r\nfrom spack import *\r\n\r\nclass Py3Clash(CMakePackage):\r\n    git      = 'git@gitlab.com:example/py3-cmake-spack-clash.git'\r\n    version('master', branch='master')\r\n    depends_on('cmake')\r\n    depends_on('python')\r\nEOF\r\nfi\r\n\r\ncd\r\n. ~/spack/share/spack/setup-env.sh \r\nspack external find\r\ncd py3-clash/\r\nspack dev-build py3-clash@master\r\n```\r\nSpack complains that nothing was installed but this does not matter.\r\n\r\n\r\n#### Step 3: Breaking the Build\r\n\r\nThe error message by the Python interpreter itself is usually suppressed by the CMake `FindPythonInterpreter` module but I patched it to show the error:\r\n```diff\r\n--- FindPythonInterp.cmake\t2021-06-25 17:02:00.769962740 +0000\r\n+++ /usr/share/cmake-3.7/Modules/FindPythonInterp.cmake\t2021-06-25 17:02:32.310635796 +0000\r\n@@ -106,8 +106,7 @@\r\n     execute_process(COMMAND \"${PYTHON_EXECUTABLE}\" -c\r\n                             \"import sys; sys.stdout.write(';'.join([str(x) for x in sys.version_info[:3]]))\"\r\n                     OUTPUT_VARIABLE _VERSION\r\n-                    RESULT_VARIABLE _PYTHON_VERSION_RESULT\r\n-                    ERROR_QUIET)\r\n+                    RESULT_VARIABLE _PYTHON_VERSION_RESULT)\r\n     if(NOT _PYTHON_VERSION_RESULT)\r\n         string(REPLACE \";\" \".\" PYTHON_VERSION_STRING \"${_VERSION}\")\r\n         list(GET _VERSION 0 PYTHON_VERSION_MAJOR)\r\n```\r\n\r\n\r\n```console\r\n$ spack dev-build py3-clash ^python@3.5.4:\r\n[...]\r\n2 errors found in build log:\r\n     4     -- Check for working C compiler: /home/john/spack/lib/spack/env/gcc/\r\n           gcc\r\n     5     -- Check for working C compiler: /home/john/spack/lib/spack/env/gcc/\r\n           gcc -- works\r\n     6     -- Detecting C compiler ABI info\r\n     7     -- Detecting C compiler ABI info - done\r\n     8     -- Detecting C compile features\r\n     9     -- Detecting C compile features - done\r\n  >> 10    Fatal Python error: Py_Initialize: Unable to get the locale encoding\r\n     11    ImportError: No module named 'encodings'\r\n     12    \r\n     13    Current thread 0x00007f56f7e3c700 (most recent call first):\r\n  >> 14    CMake Error at /usr/share/cmake-3.7/Modules/FindPackageHandleStandar\r\n           dArgs.cmake:138 (message):\r\n     15      Could NOT find PythonInterp: Found unsuitable version \"1.4\", but r\r\n           equired\r\n     16      is at least \"3.5.3\" (found /usr/bin/python3.5)\r\n     17    Call Stack (most recent call first):\r\n     18      /usr/share/cmake-3.7/Modules/FindPackageHandleStandardArgs.cmake:3\r\n           76 (_FPHSA_FAILURE_MESSAGE)\r\n     19      /usr/share/cmake-3.7/Modules/FindPythonInterp.cmake:150 (FIND_PACK\r\n           AGE_HANDLE_STANDARD_ARGS)\r\n     20      CMakeLists.txt:3 (find_package)\r\n```\r\nThe `CMakeCache.txt` makes it obvious that the host Python interpreter was called:\r\n```\r\nPYTHON_EXECUTABLE:FILEPATH=/usr/bin/python3.5\r\n```\r\n\r\n\r\n### Information on your system\r\n\r\n```console\r\njohn@d9:~/spack$ spack debug report\r\n* **Spack:** 0.16.1\r\n* **Python:** 3.5.3\r\n* **Platform:** linux-debian9-haswell\r\n* **Concretizer:** original\r\njohn@d9:~/spack$ git rev-parse HEAD\r\n843c38e69e8b17b5f7585748e9b7ba4a316bb986\r\n```\r\n\r\n### Additional information\r\n\r\n* `spack-configure-args.txt` is empty\r\n* [spack-build-out.txt](https://github.com/spack/spack/files/6717803/spack-build-out.txt)\r\n* [spack-build-01-cmake-out.txt](https://github.com/spack/spack/files/6717801/spack-build-01-cmake-out.txt)\r\n* [spack-build-env.txt](https://github.com/spack/spack/files/6717802/spack-build-env.txt)\r\n* [CMakeCache.txt](https://github.com/spack/spack/files/6717873/CMakeCache.txt)\r\n\r\nquerying @adamjstewart @skosukhin because this seems to be Python-related\r\n\r\nThis issue is very similar to #23436 except that the dummy package is explicitly listing its Python dependency:\r\n> When trying to build zfp on my system, I encountered a bunch of odd python errors. Upon deeper investigation, it appears that the CMake configuration tool zfp was using found/decided to use the system installed python instead of the spack installed python. Looking at the zfp recipe, it had dependencies on py-numpy and py-cython, but no explicit dependency on python.\r\n\r\n### General information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [x] I have uploaded the build log and environment files\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate (found #23436 but the fix did not work)\r\n\r\n\r\n### Remarks\r\n\r\nOP ran into the issue when working around #24526.",
    "performed_via_github_app": null
}