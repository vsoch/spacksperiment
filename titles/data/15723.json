{
    "url": "https://api.github.com/repos/spack/spack/issues/15723",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/15723/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/15723/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/15723/events",
    "html_url": "https://github.com/spack/spack/pull/15723",
    "id": 589497967,
    "node_id": "MDExOlB1bGxSZXF1ZXN0Mzk1MDM4OTAy",
    "number": 15723,
    "title": "`spack install` gracefully handles foreground/background",
    "user": {
        "login": "tgamblin",
        "id": 299842,
        "node_id": "MDQ6VXNlcjI5OTg0Mg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/299842?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tgamblin",
        "html_url": "https://github.com/tgamblin",
        "followers_url": "https://api.github.com/users/tgamblin/followers",
        "following_url": "https://api.github.com/users/tgamblin/following{/other_user}",
        "gists_url": "https://api.github.com/users/tgamblin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tgamblin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tgamblin/subscriptions",
        "organizations_url": "https://api.github.com/users/tgamblin/orgs",
        "repos_url": "https://api.github.com/users/tgamblin/repos",
        "events_url": "https://api.github.com/users/tgamblin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tgamblin/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 1566617052,
            "node_id": "MDU6TGFiZWwxNTY2NjE3MDUy",
            "url": "https://api.github.com/repos/spack/spack/labels/bugfix",
            "name": "bugfix",
            "color": "c4aaef",
            "default": false,
            "description": ""
        },
        {
            "id": 73908756,
            "node_id": "MDU6TGFiZWw3MzkwODc1Ng==",
            "url": "https://api.github.com/repos/spack/spack/labels/feature",
            "name": "feature",
            "color": "84b6eb",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 19,
    "created_at": "2020-03-28T03:15:03Z",
    "updated_at": "2020-04-15T18:25:32Z",
    "closed_at": "2020-04-15T18:05:42Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/15723",
        "html_url": "https://github.com/spack/spack/pull/15723",
        "diff_url": "https://github.com/spack/spack/pull/15723.diff",
        "patch_url": "https://github.com/spack/spack/pull/15723.patch"
    },
    "body": "Fixes #15620.\r\n\r\nThis resolves the second issue in #15620 by reworking #14682.\r\n\r\nWith the addition of #13100, people are going to try to run Spack in the background more often.  This makes Spack handle that situation gracefully, the way a good POSIX program should.\r\n\r\nSpecifically:\r\n1. When `spack install` is running, we disable echo and canonical input so that users can type `v` to toggle build output.  We do that in a safe way now, so that it does not generate `SIGTTOU` in the background (#14682 did this).\r\n\r\n2. We properly disable keyboard input mode when Spack is placed in the background, and re-enable it when Spack is in the foreground.  This means that if you Ctrl-Z a spack install, your terminal won't be left in a weird state.\r\n\r\n3. ~~Spack won't write verbose install output in the background.  This is mostly because we already write a log file -- that's what the log is for (if this is controversial, we can re-enable it, but it's fairly convenient to be able to ctrl-Z/bg/fg a running spack install without getting build spew).~~\r\n\r\n   We'll continue writing verbose output when Spack is in the background. If you have `stty +tostop` on, it'll end up stopping the build when you try to run in the background, unless you redirect output. This is normal POSIX behavior, and it allows you to `spack install -v &> log.txt &`, which our users do.  You may want this for parallel build output as well.\r\n\r\n4. Spack works fine when stopped in the background or when running in the background.\r\n\r\n(2) is handled mostly with signal handlers (the way things like `vi` and `emacs` do it) -- see the code for how that's done -- it's a bit tricky in Python, as Python did not support blocking signals with masks until 3.8.  It turns out we can still make it work.\r\n\r\nThis means you can do stuff like this (use `libiconv` b/c the build is long but not too long, and `--overwrite` to test it multiple times):\r\n```console\r\nspack install --overwrite -y libiconv\r\n...\r\n[type v]\r\nchecking for /Users/gamblin2/src/spack/lib/spack/env/clang/clang option to produce PIC... -fno-common -DPIC\r\nchecking if /Users/gamblin2/src/spack/lib/spack/env/clang/clang PIC flag -fno-common -DPIC works... yes\r\nchecking if /Users/gamblin2/src/spack/lib/spack/env/clang/clang static flag -static works... no\r\n[Ctrl-Z]\r\n\r\n[1]+  Stopped                 spack install --overwrite -y libiconv\r\n$ bg\r\n[1]+ spack install --overwrite -y libiconv &\r\nchecking for archiver @FILE support... no\r\nchecking for strip... strip\r\n$ fg\r\nspack install --overwrite -y libiconv\r\nchecking for ranlib... ranlib\r\nchecking for gawk... no\r\n...\r\n==> 29825: libiconv: Successfully installed libiconv\r\n  Fetch: 0.02s.  Build: 1m 10.03s.  Total: 1m 10.04s.\r\n[+] /Users/gamblin2/src/spack/opt/spack/darwin-mojave-x86_64/clang-11.0.0-apple/libiconv-1.16-jg6ekuhbklculym7pyjpx6l5jetym7wp\r\n```\r\n\r\nYou should be able to do any combination of transitions and have output work as you expect, e.g.:\r\n\r\n1. start in foreground, ctrl-z, fg, v, ctrl-z, fg, v, v, v, ctrl-z, bg, fg, v\r\n2. start in background, fg, v, ctrl-z, fg, v, v, v, ctrl-z, bg, fg, v\r\n\r\nI think that covers all the transitions.  Maybe @adamjstewart can try hard to break it.",
    "performed_via_github_app": null
}