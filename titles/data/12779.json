{
    "url": "https://api.github.com/repos/spack/spack/issues/12779",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/12779/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/12779/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/12779/events",
    "html_url": "https://github.com/spack/spack/issues/12779",
    "id": 491673550,
    "node_id": "MDU6SXNzdWU0OTE2NzM1NTA=",
    "number": 12779,
    "title": "Spack is very slow with a large number of packages",
    "user": {
        "login": "ajw1980",
        "id": 1461301,
        "node_id": "MDQ6VXNlcjE0NjEzMDE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1461301?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajw1980",
        "html_url": "https://github.com/ajw1980",
        "followers_url": "https://api.github.com/users/ajw1980/followers",
        "following_url": "https://api.github.com/users/ajw1980/following{/other_user}",
        "gists_url": "https://api.github.com/users/ajw1980/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ajw1980/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ajw1980/subscriptions",
        "organizations_url": "https://api.github.com/users/ajw1980/orgs",
        "repos_url": "https://api.github.com/users/ajw1980/repos",
        "events_url": "https://api.github.com/users/ajw1980/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ajw1980/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 460427403,
            "node_id": "MDU6TGFiZWw0NjA0Mjc0MDM=",
            "url": "https://api.github.com/repos/spack/spack/labels/performance",
            "name": "performance",
            "color": "c2e0c6",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 12,
    "created_at": "2019-09-10T13:29:53Z",
    "updated_at": "2019-12-19T00:07:29Z",
    "closed_at": "2019-12-19T00:07:29Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I've built python and and R with many packages for each of them and spack becomes very slow to install packages (or also spack spec -I). When I strace spack while it is running, it looks like it repeatedly gets locks and reads the index.json for each package. It seems like maybe the locking and DB read should just be done once.\r\n\r\nHere's a couple of seconds of strace on `spack spec -I r-caret`:\r\n```\r\n08:29:18 stat(\"/shared/spack/opt/spack\", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0\r\n08:29:18 mkdir(\"/shared/spack/opt/spack/.spack-db\", 0777) = -1 EEXIST (File exists)\r\n08:29:18 stat(\"/shared/spack/opt/spack/.spack-db\", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0\r\n08:29:18 stat(\"/shared/spack/opt/spack/.spack-db/lock\", {st_mode=S_IFREG|0755, st_size=0, ...}) = 0\r\n08:29:18 access(\"/shared/spack/opt/spack/.spack-db/lock\", W_OK) = 0\r\n08:29:18 open(\"/shared/spack/opt/spack/.spack-db/lock\", O_RDWR|O_CREAT, 0777) = 3\r\n08:29:18 fcntl(3, F_GETFL)              = 0x8002 (flags O_RDWR|O_LARGEFILE)\r\n08:29:18 fstat(3, {st_mode=S_IFREG|0755, st_size=0, ...}) = 0\r\n08:29:18 mmap(NULL, 8388608, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f93dc278000\r\n08:29:18 lseek(3, 0, SEEK_CUR)          = 0\r\n08:29:18 fstat(3, {st_mode=S_IFREG|0755, st_size=0, ...}) = 0\r\n08:29:18 fcntl(3, F_SETLK, {l_type=F_RDLCK, l_whence=SEEK_SET, l_start=0, l_len=0}) = 0\r\n08:29:18 stat(\"/shared/spack/opt/spack/.spack-db/index.json\", {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:18 open(\"/shared/spack/opt/spack/.spack-db/index.json\", O_RDONLY) = 4\r\n08:29:18 fstat(4, {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:18 fstat(4, {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:18 lseek(4, 0, SEEK_CUR)          = 0\r\n08:29:18 fstat(4, {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:18 mmap(NULL, 8388608, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f93dba78000\r\n08:29:18 lseek(4, 0, SEEK_CUR)          = 0\r\n08:29:18 read(4, \"{\\n \\\"database\\\": {\\n  \\\"installs\\\": {\"..., 8388608) = 743955\r\n08:29:18 read(4, \"\", 8388608)           = 0\r\n08:29:19 close(4)                       = 0\r\n08:29:19 munmap(0x7f93dba78000, 8388608) = 0\r\n08:29:19 fcntl(3, F_SETLKW, {l_type=F_UNLCK, l_whence=SEEK_SET, l_start=0, l_len=0}) = 0\r\n08:29:19 close(3)                       = 0\r\n08:29:19 munmap(0x7f93dc278000, 8388608) = 0\r\n08:29:19 stat(\"/shared/spack/opt/spack\", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0\r\n08:29:19 mkdir(\"/shared/spack/opt/spack/.spack-db\", 0777) = -1 EEXIST (File exists)\r\n08:29:19 stat(\"/shared/spack/opt/spack/.spack-db\", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0\r\n08:29:19 stat(\"/shared/spack/opt/spack/.spack-db/lock\", {st_mode=S_IFREG|0755, st_size=0, ...}) = 0\r\n08:29:19 access(\"/shared/spack/opt/spack/.spack-db/lock\", W_OK) = 0\r\n08:29:19 open(\"/shared/spack/opt/spack/.spack-db/lock\", O_RDWR|O_CREAT, 0777) = 3\r\n08:29:19 fcntl(3, F_GETFL)              = 0x8002 (flags O_RDWR|O_LARGEFILE)\r\n08:29:19 fstat(3, {st_mode=S_IFREG|0755, st_size=0, ...}) = 0\r\n08:29:19 mmap(NULL, 8388608, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f93dc278000\r\n08:29:19 lseek(3, 0, SEEK_CUR)          = 0\r\n08:29:19 fstat(3, {st_mode=S_IFREG|0755, st_size=0, ...}) = 0\r\n08:29:19 fcntl(3, F_SETLK, {l_type=F_RDLCK, l_whence=SEEK_SET, l_start=0, l_len=0}) = 0\r\n08:29:19 stat(\"/shared/spack/opt/spack/.spack-db/index.json\", {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:19 open(\"/shared/spack/opt/spack/.spack-db/index.json\", O_RDONLY) = 4\r\n08:29:19 fstat(4, {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:19 fstat(4, {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:19 lseek(4, 0, SEEK_CUR)          = 0\r\n08:29:19 fstat(4, {st_mode=S_IFREG|0644, st_size=743955, ...}) = 0\r\n08:29:19 mmap(NULL, 8388608, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f93dba78000\r\n08:29:19 lseek(4, 0, SEEK_CUR)          = 0\r\n08:29:19 read(4, \"{\\n \\\"database\\\": {\\n  \\\"installs\\\": {\"..., 8388608) = 743955\r\n08:29:19 read(4, \"\", 8388608)           = 0\r\n08:29:20 close(4)                       = 0\r\n```\r\n\r\nWith profiling turned on for `spack spec -I r-caret`:\r\n```\r\n         581360413 function calls (514772064 primitive calls) in 313.928 CPU seconds\r\n\r\n   Ordered by: internal time\r\n   List reduced from 1439 to 20 due to restriction <20>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n32668189/5878144   67.459    0.000  125.206    0.000 /shared/spack/lib/spack/spack/spec.py:1143(traverse_edges)\r\n2017614/369   27.344    0.000  134.369    0.364 /usr/lib64/python2.6/json/decoder.py:162(JSONObject)\r\n19260894/738   20.656    0.000  134.373    0.182 /usr/lib64/python2.6/json/scanner.py:38(iterscan)\r\n18690042/2017980   18.318    0.000   33.818    0.000 /shared/spack/lib/spack/spack/util/spack_json.py:40(_strify)\r\n 10570044   14.352    0.000   21.527    0.000 /shared/spack/lib/spack/spack/dependency.py:20(canonical_deptype)\r\n67861316/67861315   11.328    0.000   11.615    0.000 {isinstance}\r\n 11881485    8.450    0.000    8.450    0.000 {_json.scanstring}\r\n1838949/1838639    8.174    0.000   24.866    0.000 /usr/lib64/python2.6/json/decoder.py:206(JSONArray)\r\n16638831/16638432    7.953    0.000    8.089    0.000 {sorted}\r\n  5487136    6.824    0.000   11.091    0.000 /usr/lib64/python2.6/_abcoll.py:362(items)\r\n 18549071    5.592    0.000    5.592    0.000 {built-in method scanner}\r\n  5874765    5.221    0.000  131.176    0.000 /shared/spack/lib/spack/spack/spec.py:1128(traverse)\r\n 11901204    5.073    0.000    5.073    0.000 {method 'encode' of 'unicode' objects}\r\n  4839501    5.044    0.000   10.021    0.000 /usr/lib64/python2.6/json/decoder.py:152(JSONString)\r\n 66980134    5.001    0.000    5.003    0.000 {method 'get' of 'dict' objects}\r\n  9059595    4.707    0.000   24.955    0.000 /shared/spack/lib/spack/spack/util/spack_json.py:53(<genexpr>)\r\n 31707642    4.414    0.000    4.414    0.000 /shared/spack/lib/spack/spack/spec.py:1198(validate)\r\n 43138508    4.118    0.000    4.118    0.000 {built-in method end}\r\n 10087620    3.348    0.000    3.348    0.000 {built-in method match}\r\n 20272794    3.314    0.000    3.314    0.000 /shared/spack/lib/spack/spack/spec.py:1245(<genexpr>)\r\n```",
    "performed_via_github_app": null
}