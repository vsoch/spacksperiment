{
    "url": "https://api.github.com/repos/spack/spack/issues/18049",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/18049/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/18049/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/18049/events",
    "html_url": "https://github.com/spack/spack/issues/18049",
    "id": 678465704,
    "node_id": "MDU6SXNzdWU2Nzg0NjU3MDQ=",
    "number": 18049,
    "title": "Regression in environment matrix spec resolution",
    "user": {
        "login": "dennisklein",
        "id": 297548,
        "node_id": "MDQ6VXNlcjI5NzU0OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/297548?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dennisklein",
        "html_url": "https://github.com/dennisklein",
        "followers_url": "https://api.github.com/users/dennisklein/followers",
        "following_url": "https://api.github.com/users/dennisklein/following{/other_user}",
        "gists_url": "https://api.github.com/users/dennisklein/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/dennisklein/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/dennisklein/subscriptions",
        "organizations_url": "https://api.github.com/users/dennisklein/orgs",
        "repos_url": "https://api.github.com/users/dennisklein/repos",
        "events_url": "https://api.github.com/users/dennisklein/events{/privacy}",
        "received_events_url": "https://api.github.com/users/dennisklein/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 512483390,
            "node_id": "MDU6TGFiZWw1MTI0ODMzOTA=",
            "url": "https://api.github.com/repos/spack/spack/labels/impact-medium",
            "name": "impact-medium",
            "color": "fef2c0",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "scheibelp",
        "id": 1659704,
        "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scheibelp",
        "html_url": "https://github.com/scheibelp",
        "followers_url": "https://api.github.com/users/scheibelp/followers",
        "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
        "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
        "organizations_url": "https://api.github.com/users/scheibelp/orgs",
        "repos_url": "https://api.github.com/users/scheibelp/repos",
        "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scheibelp/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "scheibelp",
            "id": 1659704,
            "node_id": "MDQ6VXNlcjE2NTk3MDQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1659704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/scheibelp",
            "html_url": "https://github.com/scheibelp",
            "followers_url": "https://api.github.com/users/scheibelp/followers",
            "following_url": "https://api.github.com/users/scheibelp/following{/other_user}",
            "gists_url": "https://api.github.com/users/scheibelp/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/scheibelp/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scheibelp/subscriptions",
            "organizations_url": "https://api.github.com/users/scheibelp/orgs",
            "repos_url": "https://api.github.com/users/scheibelp/repos",
            "events_url": "https://api.github.com/users/scheibelp/events{/privacy}",
            "received_events_url": "https://api.github.com/users/scheibelp/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2020-08-13T14:06:42Z",
    "updated_at": "2020-09-01T22:00:10Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "[One of our spack environments](https://github.com/FairRootGroup/FairSoft/blob/7ebe61adcb0ddbf65cba21e1c93fce5728a2fbbb/test/env/fairlogger.yaml) that has worked with spack `0.14` no longer works with spack `0.15`:\r\n\r\n```yaml\r\nspack:\r\n  definitions:\r\n  - no_pretty: ['@1.1.0', '@1.2.0', '@1.3.0']\r\n  - all:\r\n    - $no_pretty\r\n    - matrix:\r\n      -\r\n        - '@1.4.0'\r\n        - '@1.5.0'\r\n        - '@1.6.0'\r\n        - '@1.6.1'\r\n        - '@1.6.2'\r\n        - '@1.7.0'\r\n        - '@1.8.0'\r\n        - '@develop'\r\n      - ['+pretty', '~pretty']\r\n  specs:\r\n  - matrix:\r\n    - ['fairlogger']\r\n    - [$all]\r\n  view: false\r\n```\r\n\r\n### Error Message\r\n\r\nWith the activated [environment](https://github.com/FairRootGroup/FairSoft/blob/7ebe61adcb0ddbf65cba21e1c93fce5728a2fbbb/test/env/fairlogger.yaml) from above:\r\n\r\n```\r\n$ spack --debug --stacktrace concretize -f\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-08-13-15:53:09.661670] Imported concretize from built-in commands\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-08-13-15:53:09.662179] Imported concretize from built-in commands\r\nlib/spack/spack/config.py:835 ==> [2020-08-13-15:53:09.769914] Reading config file /home/dklein/projects/FairSoft2/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/spack/config.py:835 ==> [2020-08-13-15:53:09.771156] Reading config file /home/dklein/projects/FairSoft2/spack/etc/spack/repos.yaml\r\nlib/spack/spack/config.py:835 ==> [2020-08-13-15:53:09.771772] Reading config file /home/dklein/projects/FairSoft2/test/env/fairlogger/spack.yaml\r\nlib/spack/spack/main.py:765 ==> [2020-08-13-15:53:09.804206] InvalidModuleNameError: Invalid module name:\r\nlib/spack/spack/error.py:55 ==> [2020-08-13-15:53:09.804383] Error: Invalid module name:\r\nTraceback (most recent call last):\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/cmd/concretize.py\", line 22, in concretize\r\n    concretized_specs = env.concretize(force=args.force)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/environment.py\", line 1005, in concretize\r\n    return self._concretize_separately()\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/environment.py\", line 1071, in _concretize_separately\r\n    self.user_specs, self.user_specs.specs_as_constraints):\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/spec_list.py\", line 58, in specs_as_constraints\r\n    constraints.extend(_expand_matrix_constraints(item))\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/spec_list.py\", line 184, in _expand_matrix_constraints\r\n    for c in _expand_matrix_constraints(r, specify=False)])\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/spec_list.py\", line 206, in _expand_matrix_constraints\r\n    spack.variant.substitute_abstract_variants(test_spec)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/variant.py\", line 608, in substitute_abstract_variants\r\n    pkg_variant = spec.package_class.variants.get(name, None)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/spec.py\", line 1185, in package_class\r\n    return spack.repo.path.get_pkg_class(self.fullname)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/repo.py\", line 654, in get_pkg_class\r\n    return self.repo_for_pkg(pkg_name).get_pkg_class(pkg_name)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/repo.py\", line 1081, in get_pkg_class\r\n    class_name = nm.mod_to_class(pkg_name)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/util/naming.py\", line 52, in mod_to_class\r\n    validate_module_name(mod_name)\r\n  File \"/home/dklein/projects/FairSoft2/spack/lib/spack/spack/util/naming.py\", line 154, in validate_module_name\r\n    raise InvalidModuleNameError(mod_name)\r\nspack.util.naming.InvalidModuleNameError: Invalid module name:\r\n```\r\n\r\n### Information on your system\r\n\r\n```\r\n$ spack debug report\r\n* **Spack:** 0.15.3-508-5512340a5\r\n* **Python:** 3.8.5\r\n* **Platform:** linux-fedora32-skylake\r\n```\r\n\r\nThe `/home/dklein/projects/FairSoft2` directory in the error output above is this git repo: https://github.com/dennisklein/FairSoft/tree/spack_0_15_3\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n### Quick fix\r\n\r\n`git bisect`ing reveals https://github.com/spack/spack/commit/2795414a80839208c3463e49f197fee25f2be0f8 to introduce the regression. I have *fixed* it in our spack fork like this for now: https://github.com/FairRootGroup/spack/commit/5668256776fb07b0ac88c9f65fc8832fac5d1c60. If you want this fix, I can prepare a PR and some unit test coverage.\r\n\r\n---\r\n\r\ncc: @ChristianTackeGSI",
    "performed_via_github_app": null
}