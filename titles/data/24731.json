{
    "url": "https://api.github.com/repos/spack/spack/issues/24731",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24731/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24731/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24731/events",
    "html_url": "https://github.com/spack/spack/issues/24731",
    "id": 938149778,
    "node_id": "MDU6SXNzdWU5MzgxNDk3Nzg=",
    "number": 24731,
    "title": "Rake not working during package installation",
    "user": {
        "login": "mdorier",
        "id": 598250,
        "node_id": "MDQ6VXNlcjU5ODI1MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/598250?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mdorier",
        "html_url": "https://github.com/mdorier",
        "followers_url": "https://api.github.com/users/mdorier/followers",
        "following_url": "https://api.github.com/users/mdorier/following{/other_user}",
        "gists_url": "https://api.github.com/users/mdorier/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mdorier/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mdorier/subscriptions",
        "organizations_url": "https://api.github.com/users/mdorier/orgs",
        "repos_url": "https://api.github.com/users/mdorier/repos",
        "events_url": "https://api.github.com/users/mdorier/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mdorier/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 663894889,
            "node_id": "MDU6TGFiZWw2NjM4OTQ4ODk=",
            "url": "https://api.github.com/repos/spack/spack/labels/ruby",
            "name": "ruby",
            "color": "e99695",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2021-07-06T18:23:10Z",
    "updated_at": "2021-07-07T12:24:57Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I'm trying to make a spack package for [mruby](http://mruby.org), an implementation of Ruby for embedded systems. This package depends on `ruby` and on `rake`. I can easily build it manually as follows (provided the ruby and ruby-rake packages are installed and loaded):\r\n\r\n```\r\ngit clone https://github.com/mruby/mruby.git\r\ncd mruby\r\nrake\r\n```\r\n\r\n(it doesn't have a `rake install` target so the next step if I want the headers and libs in another location is to copy them manually).\r\n\r\nI have tried to reproduce this build process as a spack package as follows:\r\n\r\n```\r\nfrom spack import *\r\n\r\n\r\nclass Mruby(RubyPackage):\r\n    \"\"\"mruby is the lightweight implementation of the Ruby language complying\r\n    to (part of) the ISO standard. Its syntax is Ruby 2.x compatible.\"\"\"\r\n\r\n    homepage = \"https://mruby.org/\"\r\n    url      = \"https://github.com/mruby/mruby/archive/refs/tags/3.0.0.tar.gz\"\r\n\r\n    version('3.0.0', sha256='95b798cdd931ef29d388e2b0b267cba4dc469e8722c37d4ef8ee5248bc9075b0')\r\n\r\n    depends_on('ruby', type=('build'))\r\n    depends_on('ruby-rake', type=('build'))\r\n    depends_on('bison', type=('build'))\r\n\r\n    def install(self, spec, prefix):\r\n        rake()\r\n        # mkdir/install files here ...\r\n```\r\n\r\nHowever I'm getting this error from the `rake` step:\r\n\r\n```\r\n==> Error: ProcessError: Command exited with status 1:\r\n    '/projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/ruby-3.0.0-6hobkj5ntaqidqjlt4njvp3pyba2f42k/bin/rake'\r\n\r\n1 error found in build log:\r\n     6       Successfully built RubyGem\r\n     7       Name: mruby-source\r\n     8       Version: 3.0.0\r\n     9       File: mruby-source-3.0.0.gem\r\n     10    ==> mruby: Executing phase: 'install'\r\n     11    ==> [2021-07-06-18:13:15.730770] '/projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/ruby-3.0.0-6hobkj5ntaqidqjlt4n\r\n           jvp3pyba2f42k/bin/rake'\r\n  >> 12    /projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/ruby-3.0.0-6hobkj5ntaqidqjlt4njvp3pyba2f42k/lib/ruby/3.0.0/rubyg\r\n           ems.rb:281:in `find_spec_for_exe': can't find gem rake (>= 0.a) with executable rake (Gem::GemNotFoundException)\r\n     13    \tfrom /projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/ruby-3.0.0-6hobkj5ntaqidqjlt4njvp3pyba2f42k/lib/ruby/3.0.0\r\n           /rubygems.rb:300:in `activate_bin_path'\r\n     14    \tfrom /projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/ruby-3.0.0-6hobkj5ntaqidqjlt4njvp3pyba2f42k/bin/rake:23:in\r\n            `<main>'\r\n```\r\n\r\n(ignore lines 6 to 9, they stem from the fact that the package inherits from RubyPackage, but the source is not actually a gem)\r\n\r\nThe `rake` binary invoked is actually a small ruby script in ruby's installation directory, which loads the rake gem. It seems it is unable to do so within the context of this install function.\r\n\r\nAgain, the whole process works fine when I build manually. That said, I'm not sure that ruby's `rake` script actually uses the spack-install `ruby-rake` package; it might very well be using the system's.\r\n\r\nHow can I make ruby correctly find the rake gem in this context?\r\n\r\nThere must be something related to the `GEM_HOME` or `GEM_PATH` environment variables, but I'm not familiar enough with Ruby to know how to set those variables. The value of `GEM_PATH` in the install function is as follows:\r\n\r\n```\r\n/projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/mruby-3.0.0-zqrfyx42dplkmnimvbahfhmdu6hgobek:/projects/spack/opt/spack/linux-ubuntu21.04-sandybridge/gcc-10.3.0/ruby-rake-13.0.1-2pf7szotsnolhiwv45jwi6bu3uqghfyh\r\n```\r\nso it seems to already correctly have the path to ruby-rake.",
    "performed_via_github_app": null
}