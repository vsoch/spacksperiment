{
    "url": "https://api.github.com/repos/spack/spack/issues/22954",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/22954/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/22954/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/22954/events",
    "html_url": "https://github.com/spack/spack/issues/22954",
    "id": 856586529,
    "node_id": "MDU6SXNzdWU4NTY1ODY1Mjk=",
    "number": 22954,
    "title": "Clingo concretization fails when compiler flags propagated to dependents",
    "user": {
        "login": "omor1",
        "id": 4326436,
        "node_id": "MDQ6VXNlcjQzMjY0MzY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4326436?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/omor1",
        "html_url": "https://github.com/omor1",
        "followers_url": "https://api.github.com/users/omor1/followers",
        "following_url": "https://api.github.com/users/omor1/following{/other_user}",
        "gists_url": "https://api.github.com/users/omor1/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/omor1/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/omor1/subscriptions",
        "organizations_url": "https://api.github.com/users/omor1/orgs",
        "repos_url": "https://api.github.com/users/omor1/repos",
        "events_url": "https://api.github.com/users/omor1/events{/privacy}",
        "received_events_url": "https://api.github.com/users/omor1/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446623646,
            "node_id": "MDU6TGFiZWw0NDY2MjM2NDY=",
            "url": "https://api.github.com/repos/spack/spack/labels/concretization",
            "name": "concretization",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 5,
    "created_at": "2021-04-13T05:33:55Z",
    "updated_at": "2021-04-14T07:23:03Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "`libgcrypt` is installed with `gcc@8.3.1`:\r\n```console\r\n$ spack find -lvd libgcrypt\r\n==> 1 installed package\r\n-- linux-centos8-zen / gcc@8.3.1 --------------------------------\r\n6dooye5 libgcrypt@1.8.5\r\n4jezmqq     libgpg-error@1.37\r\n```\r\n\r\nI want to install `ccache` with `gcc@10.2.0` and this existing `libgcrypt`:\r\n```console\r\n$ spack solve -Il ccache %gcc@10.2.0 ^/6dooye5\r\n==> Warning: Intel's compilers may or may not optimize to the same degree for non-Intel microprocessors for optimizations that are not unique to Intel microprocessors\r\n==> Error:\r\n```\r\n\r\nThe original concretizer handles this flawlessly:\r\n```console\r\n$ spack spec -Il ccache %gcc@10.2.0 ^/6dooye5\r\nInput spec\r\n--------------------------------\r\n -   ccache%gcc@10.2.0\r\n[^]      ^libgcrypt@1.8.5%gcc@8.3.1 cflags=\"-O2 -march=core-avx2\" cxxflags=\"-O2 -march=core-avx2\" fflags=\"-O2 -march=core-avx2\"  arch=linux-centos8-zen\r\n[^]          ^libgpg-error@1.37%gcc@8.3.1 cflags=\"-O2 -march=core-avx2\" cxxflags=\"-O2 -march=core-avx2\" fflags=\"-O2 -march=core-avx2\"  arch=linux-centos8-zen\r\n\r\nConcretized\r\n--------------------------------\r\n -   ktsmbuo  ccache@3.7.11%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\"  arch=linux-centos8-zen2\r\n[^]  o2beapv      ^gperf@3.1%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\"  arch=linux-centos8-zen2\r\n -   wtsq5lb      ^libxslt@1.1.33%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\" +crypto~python arch=linux-centos8-zen2\r\n[^]  6dooye5          ^libgcrypt@1.8.5%gcc@8.3.1 cflags=\"-O2 -march=core-avx2\" cxxflags=\"-O2 -march=core-avx2\" fflags=\"-O2 -march=core-avx2\"  arch=linux-centos8-zen\r\n[^]  4jezmqq              ^libgpg-error@1.37%gcc@8.3.1 cflags=\"-O2 -march=core-avx2\" cxxflags=\"-O2 -march=core-avx2\" fflags=\"-O2 -march=core-avx2\"  arch=linux-centos8-zen\r\n[^]  f5eijhm          ^libiconv@1.16%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\"  arch=linux-centos8-zen2\r\n[^]  52hv55d          ^libxml2@2.9.10%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\" ~python arch=linux-centos8-zen2\r\n[^]  sq6fdwt              ^pkgconf@1.7.3%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\"  arch=linux-centos8-zen2\r\n[^]  dsly4qm              ^xz@5.2.5%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\" ~pic arch=linux-centos8-zen2\r\n[^]  rchx6la              ^zlib@1.2.11%gcc@10.2.0 cflags=\"-O2 -march=znver2\" cxxflags=\"-O2 -march=znver2\" fflags=\"-O2 -march=znver2\" +optimize+pic+shared arch=linux-centos8-zen2\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\nI'm not sure what exact setup will reproduce this; I believe it has to do with mixed-compiler setups where the compilers have different `cflags`, `cxxflags`, `fflags`, etc. It also maybe has something to do with the flags containing an `-march` different from that specified by `target` (so that the identical flags aren't collapsed).\r\n\r\n### Error Message\r\n\r\n```console\r\n$ spack --debug --stacktrace solve -Il ccache %gcc@10.2.0 ^/6dooye5\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2021-04-12-22:23:51.303533] Imported solve from built-in commands\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2021-04-12-22:23:51.304433] Imported solve from built-in commands\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:51.308832] Reading config file /home/omor1/spack/etc/spack/defaults/config.yaml\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:51.327092] Reading config file /home/omor1/.spack/config.yaml\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:51.328696] Reading config file /home/omor1/.spack/upstreams.yaml\r\nlib/spack/spack/database.py:363 ==> [2021-04-12-22:23:51.331821] DATABASE LOCK TIMEOUT: 3s\r\nlib/spack/spack/database.py:367 ==> [2021-04-12-22:23:51.332083] PACKAGE LOCK TIMEOUT: No timeout\r\nlib/spack/spack/database.py:363 ==> [2021-04-12-22:23:51.455313] DATABASE LOCK TIMEOUT: 3s\r\nlib/spack/spack/database.py:367 ==> [2021-04-12-22:23:51.455531] PACKAGE LOCK TIMEOUT: No timeout\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:51.458050] Reading config file /home/omor1/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:51.459911] Reading config file /home/omor1/.spack/repos.yaml\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:52.253150] Reading config file /home/omor1/.spack/linux/compilers.yaml\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:52.296843] Reading config file /home/omor1/spack/etc/spack/defaults/packages.yaml\r\nlib/spack/spack/config.py:981 ==> [2021-04-12-22:23:52.321079] Reading config file /home/omor1/.spack/packages.yaml\r\nhome/omor1/spack/lib/spack/spack/main.py:431 ==> [2021-04-12-22:23:53.068202] Warning: Intel's compilers may or may not optimize to the same degree for non-Intel microprocessors for optimizations that are not unique to Intel microprocessors\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557150] opt_criterion(15, version weight)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557315] opt_criterion(14, number of non-default variants (roots))\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557426] opt_criterion(13, multi-valued variants + preferred providers for roots)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557538] opt_criterion(11, number of non-default variants (non-roots))\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557645] opt_criterion(9, number of non-default providers (non-roots))\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557750] opt_criterion(8, count of non-root multi-valued variants)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557854] opt_criterion(7, compiler matches + number of nodes)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.557959] opt_criterion(6, version badness)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.558063] opt_criterion(5, non-preferred compilers)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.558167] opt_criterion(4, target matches)\r\nlib/spack/spack/solver/asp.py:1566 ==> [2021-04-12-22:23:53.558271] opt_criterion(3, non-preferred targets)\r\nTraceback (most recent call last):\r\n  File \"/home/omor1/spack/bin/spack\", line 76, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/home/omor1/spack/lib/spack/spack/main.py\", line 772, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/omor1/spack/lib/spack/spack/main.py\", line 496, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/omor1/spack/lib/spack/spack/cmd/solve.py\", line 105, in solve\r\n    result = asp.solve(\r\n  File \"/home/omor1/spack/lib/spack/spack/solver/asp.py\", line 1652, in solve\r\n    return driver.solve(setup, specs, dump, models, timers, stats, tests)\r\n  File \"/home/omor1/spack/lib/spack/spack/solver/asp.py\", line 367, in solve\r\n    answers = builder.build_specs(tuples)\r\n  File \"/home/omor1/spack/lib/spack/spack/solver/asp.py\", line 1586, in build_specs\r\n    self.reorder_flags()\r\n  File \"/home/omor1/spack/lib/spack/spack/solver/asp.py\", line 1517, in reorder_flags\r\n    check_same_flags(spec.compiler_flags, compiler_flags)\r\n  File \"/home/omor1/spack/lib/spack/spack/solver/asp.py\", line 178, in check_same_flags\r\n    assert values1 == values2\r\nAssertionErrors\r\n```\r\n\r\n### Information on your system\r\n\r\nSDSC Expanse\r\n\r\n```console\r\n$ spack debug report\r\n* **Spack:** 0.16.1-2177-03e3a4e40d\r\n* **Python:** 3.8.5\r\n* **Platform:** linux-centos8-zen2\r\n* **Concretizer:** original\r\n```\r\n\r\n```yaml\r\n- compiler:\r\n    spec: gcc@8.3.1\r\n    paths:\r\n      cc: /usr/bin/gcc\r\n      cxx: /usr/bin/g++\r\n      f77: /usr/bin/gfortran\r\n      fc: /usr/bin/gfortran\r\n    flags:\r\n      cflags: -O2 -march=core-avx2\r\n      cxxflags: -O2 -march=core-avx2\r\n      fflags: -O2 -march=core-avx2\r\n    operating_system: centos8\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n- compiler:\r\n    spec: gcc@10.2.0\r\n    paths:\r\n      cc: /cm/shared/apps/spack/cpu/opt/spack/linux-centos8-zen/gcc-8.3.1/gcc-10.2.0-n7su7jf54rc7l2ozegds5xksy6qhrjin/bin/gcc\r\n      cxx: /cm/shared/apps/spack/cpu/opt/spack/linux-centos8-zen/gcc-8.3.1/gcc-10.2.0-n7su7jf54rc7l2ozegds5xksy6qhrjin/bin/g++\r\n      f77: /cm/shared/apps/spack/cpu/opt/spack/linux-centos8-zen/gcc-8.3.1/gcc-10.2.0-n7su7jf54rc7l2ozegds5xksy6qhrjin/bin/gfortran\r\n      fc: /cm/shared/apps/spack/cpu/opt/spack/linux-centos8-zen/gcc-8.3.1/gcc-10.2.0-n7su7jf54rc7l2ozegds5xksy6qhrjin/bin/gfortran\r\n    flags:\r\n      cflags: -O2 -march=znver2\r\n      cxxflags: -O2 -march=znver2\r\n      fflags: -O2 -march=znver2\r\n    operating_system: centos8\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\n\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "performed_via_github_app": null
}