{
    "url": "https://api.github.com/repos/spack/spack/issues/14323",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/14323/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/14323/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/14323/events",
    "html_url": "https://github.com/spack/spack/issues/14323",
    "id": 544013432,
    "node_id": "MDU6SXNzdWU1NDQwMTM0MzI=",
    "number": 14323,
    "title": "Installation issue: hpcx - how to integrate binary package provided modulefile?",
    "user": {
        "login": "mkiernan",
        "id": 24193619,
        "node_id": "MDQ6VXNlcjI0MTkzNjE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/24193619?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mkiernan",
        "html_url": "https://github.com/mkiernan",
        "followers_url": "https://api.github.com/users/mkiernan/followers",
        "following_url": "https://api.github.com/users/mkiernan/following{/other_user}",
        "gists_url": "https://api.github.com/users/mkiernan/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mkiernan/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mkiernan/subscriptions",
        "organizations_url": "https://api.github.com/users/mkiernan/orgs",
        "repos_url": "https://api.github.com/users/mkiernan/repos",
        "events_url": "https://api.github.com/users/mkiernan/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mkiernan/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 446632829,
            "node_id": "MDU6TGFiZWw0NDY2MzI4Mjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/modules",
            "name": "modules",
            "color": "fef2c0",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-12-30T21:14:59Z",
    "updated_at": "2020-01-02T07:43:33Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "I setup a package to install hpcx  (http://www.mellanox.com/downloads/hpc/hpc-x/v2.5/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64.tbz). \r\n\r\nThe installation works fine, but the problem I'm having is that the package contains a lengthy modulefile that needs to be integrated. Is there any way to reference the modulefile from the package and have that copied into the spack generated modulefile, or simply create a one-liner to add the module load for the modulefile from the package ?  \r\n\r\nThe workaround I attempted was to implement it by referencing a system image external module version of hpcx via a packages.yaml file, but spack only picks up some of the contents from the hpcx package modulefile and inserts them into the generated modulefile, and leaves the rest behind. \r\n\r\nI guess what is really needed here is the ability to have the package maintainer be able to add a module load line into the generated modulefile via the package definition file. In the meantime are there any smarter workarounds or other ways to control the contents of the generated modulefile ?\r\n\r\nWe are seeing extremely good results with hpcx, so would be great to get this properly integrated into spack. \r\n\r\nThanks,\r\nMike\r\n\r\nThis is the partially complete module that spack generates from  /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/modulefiles/hpcx: \r\n\r\n```\r\nmodule show hpcx-2.5.0-gcc-9.2.0-rjslnhs\r\n\r\n/shared/home/mk/azure-spack/spack/share/spack/modules/linux-centos7-zen/hpcx-2.5.0-gcc-9.2.0-rjslnhs:\r\n\r\nmodule-whatis    Mellanox HPC-X Scalable HPC Software Toolkit.\r\nprepend-path     PATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/bin\r\nprepend-path     MANPATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/share/man\r\nprepend-path     LD_LIBRARY_PATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/lib\r\nprepend-path     LIBRARY_PATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/lib\r\nprepend-path     CPATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/include\r\nprepend-path     PKG_CONFIG_PATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/lib/pkgconfig\r\nprepend-path     CMAKE_PREFIX_PATH /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/ompi/\r\n````\r\nAnd this is the system module I attempted to pick up via the packages.conf as a workaround: \r\n```\r\n  hpcx:\r\n    modules:\r\n#       hpcx@2.5.0: mpi/hpcx-v2.5.0\r\n       hpcx@2.5.0: /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/modulefiles/hpcx\r\n    buildable: False\r\n```\r\n\r\nNote that spack doesn't pickup the embedded module load from this module, so you have to explicitly reference the original modulefile directly, but then it generates only the partial set of variables above. \r\n```\r\n$ module show mpi/hpcx-v2.5.0\r\n/usr/share/Modules/modulefiles/mpi/hpcx-v2.5.0:\r\n\r\nconflict         mpi\r\nmodule           load /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/modulefiles/hpcx\r\n```\r\nThis is the content of the original hpcx package provided modulefile\r\n```\r\n[mk@buildhb osu]$ cat /opt/hpcx-v2.5.0-gcc-MLNX_OFED_LINUX-4.7-1.0.0.1-redhat7.6-x86_64/modulefiles/hpcx\r\n#%Module\r\n\r\nset fn      $ModulesCurrentModulefile\r\nset fn      [file normalize $ModulesCurrentModulefile]\r\n\r\nif {[file type $fn] eq \"link\"} {\r\n   set fn [ exec readlink -f $fn]\r\n}\r\n\r\nset mydir_base  [ file dirname $fn ]\r\nset mydir_base  [ file dirname $mydir_base ]\r\nset mydir       [ file normalize $mydir_base ]\r\nset hpcx_dir        $mydir\r\nset hpcx_mpi_dir    $hpcx_dir/ompi\r\n\r\nmodule-whatis   Mellanox HPC-X toolkit\r\n\r\nsetenv HPCX_DIR             $hpcx_dir\r\nsetenv HPCX_HOME            $hpcx_dir\r\n\r\nsetenv HPCX_UCX_DIR         $hpcx_dir/ucx\r\nsetenv HPCX_SHARP_DIR       $hpcx_dir/sharp\r\nsetenv HPCX_HCOLL_DIR       $hpcx_dir/hcoll\r\nsetenv HPCX_NCCL_RDMA_SHARP_PLUGIN_DIR  $hpcx_dir/nccl_rdma_sharp_plugin\r\n\r\nsetenv HPCX_CLUSTERKIT_DIR  $hpcx_dir/clusterkit\r\nsetenv HPCX_MPI_DIR         $hpcx_mpi_dir\r\nsetenv HPCX_OSHMEM_DIR      $hpcx_mpi_dir\r\nsetenv HPCX_IPM_DIR         $hpcx_mpi_dir/tests/ipm-2.0.6\r\nsetenv HPCX_IPM_LIB         $hpcx_mpi_dir/tests/ipm-2.0.6/lib/libipm.so\r\nsetenv HPCX_MPI_TESTS_DIR   $hpcx_mpi_dir/tests\r\nsetenv HPCX_OSU_DIR         $hpcx_mpi_dir/tests/osu-micro-benchmarks-5.3.2\r\nsetenv HPCX_OSU_CUDA_DIR    $hpcx_mpi_dir/tests/osu-micro-benchmarks-5.3.2-cuda\r\n\r\n\r\nprepend-path    PATH    $hpcx_dir/ucx/bin\r\nprepend-path    PATH    $hpcx_dir/hcoll/bin\r\nprepend-path    PATH    $hpcx_dir/bupc/bin\r\nprepend-path    PATH    $hpcx_mpi_dir/tests/imb\r\nprepend-path    PATH    $hpcx_dir/clusterkit/bin\r\n\r\nprepend-path    LD_LIBRARY_PATH $hpcx_dir/ucx/lib\r\nprepend-path    LD_LIBRARY_PATH $hpcx_dir/ucx/lib/ucx\r\nprepend-path    LD_LIBRARY_PATH $hpcx_dir/hcoll/lib\r\nprepend-path    LD_LIBRARY_PATH $hpcx_dir/sharp/lib\r\nprepend-path    LD_LIBRARY_PATH $hpcx_dir/nccl_rdma_sharp_plugin/lib\r\n\r\nprepend-path    LIBRARY_PATH $hpcx_dir/ucx/lib\r\nprepend-path    LIBRARY_PATH $hpcx_dir/hcoll/lib\r\nprepend-path    LIBRARY_PATH $hpcx_dir/sharp/lib\r\nprepend-path    LIBRARY_PATH $hpcx_dir/nccl_rdma_sharp_plugin/lib\r\n\r\nprepend-path    CPATH   $hpcx_dir/hcoll/include\r\nprepend-path    CPATH   $hpcx_dir/sharp/include\r\nprepend-path    CPATH   $hpcx_dir/ucx/include\r\nprepend-path    CPATH   $hpcx_mpi_dir/include\r\n\r\nprepend-path    PKG_CONFIG_PATH $hpcx_dir/hcoll/lib/pkgconfig\r\nprepend-path    PKG_CONFIG_PATH $hpcx_dir/sharp/lib/pkgconfig\r\nprepend-path    PKG_CONFIG_PATH $hpcx_dir/ucx/lib/pkgconfig\r\nprepend-path    PKG_CONFIG_PATH $hpcx_dir/ompi/lib/pkgconfig\r\n\r\nprepend-path    MANPATH         $hpcx_mpi_dir/share/man\r\n\r\n# Adding MPI runtime\r\n\r\nsetenv OPAL_PREFIX          $hpcx_mpi_dir\r\nsetenv PMIX_INSTALL_PREFIX  $hpcx_mpi_dir\r\nsetenv OMPI_HOME            $hpcx_mpi_dir\r\nsetenv MPI_HOME             $hpcx_mpi_dir\r\nsetenv OSHMEM_HOME          $hpcx_mpi_dir\r\nsetenv SHMEM_HOME           $hpcx_mpi_dir\r\n\r\nprepend-path    PATH    $hpcx_mpi_dir/bin\r\nprepend-path    LD_LIBRARY_PATH $hpcx_mpi_dir/lib\r\nprepend-path    LIBRARY_PATH $hpcx_mpi_dir/lib\r\n[mk@buildhb osu]$\r\n```\r\n\r\nAnd this is what a \"healthy\" output from a loaded module should look like: \r\n```\r\n/shared/home/mk/azure-spack/spack/share/spack/modules/linux-centos7-zen/hpcx-2.5.0-gcc-9.2.0-rjslnhs:\r\n\r\nmodule-whatis    Mellanox HPC-X toolkit\r\n\r\nsetenv           HPCX_DIR /shared/home/mk/azure-spack/spack/share/spack/modules\r\n\r\nsetenv           HPCX_HOME /shared/home/mk/azure-spack/spack/share/spack/modules\r\n\r\nsetenv           HPCX_UCX_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ucx\r\n\r\nsetenv           HPCX_SHARP_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/sharp\r\n\r\nsetenv           HPCX_HCOLL_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/hcoll\r\n\r\nsetenv           HPCX_NCCL_RDMA_SHARP_PLUGIN_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/nccl_rdma_sharp_plugin\r\n\r\nsetenv           HPCX_CLUSTERKIT_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/clusterkit\r\n\r\nsetenv           HPCX_MPI_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           HPCX_OSHMEM_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           HPCX_IPM_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/tests/ipm-2.0.6\r\n\r\nsetenv           HPCX_IPM_LIB /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/tests/ipm-2.0.6/lib/libipm.so\r\n\r\nsetenv           HPCX_MPI_TESTS_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/tests\r\n\r\nsetenv           HPCX_OSU_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/tests/osu-micro-benchmarks-5.3.2\r\n\r\nsetenv           HPCX_OSU_CUDA_DIR /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/tests/osu-micro-benchmarks-5.3.2-cuda\r\n\r\nprepend-path     PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ucx/bin\r\n\r\nprepend-path     PATH /shared/home/mk/azure-spack/spack/share/spack/modules/hcoll/bin\r\n\r\nprepend-path     PATH /shared/home/mk/azure-spack/spack/share/spack/modules/bupc/bin\r\n\r\nprepend-path     PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/tests/imb\r\n\r\nprepend-path     PATH /shared/home/mk/azure-spack/spack/share/spack/modules/clusterkit/bin\r\n\r\nprepend-path     LD_LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ucx/lib\r\n\r\nprepend-path     LD_LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ucx/lib/ucx\r\n\r\nprepend-path     LD_LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/hcoll/lib\r\n\r\nprepend-path     LD_LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/sharp/lib\r\n\r\nprepend-path     LD_LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/nccl_rdma_sharp_plugin/lib\r\n\r\nprepend-path     LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ucx/lib\r\n\r\nprepend-path     LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/hcoll/lib\r\n\r\nprepend-path     LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/sharp/lib\r\n\r\nprepend-path     LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/nccl_rdma_sharp_plugin/lib\r\n\r\nprepend-path     CPATH /shared/home/mk/azure-spack/spack/share/spack/modules/hcoll/include\r\n\r\nprepend-path     CPATH /shared/home/mk/azure-spack/spack/share/spack/modules/sharp/include\r\n\r\nprepend-path     CPATH /shared/home/mk/azure-spack/spack/share/spack/modules/ucx/include\r\n\r\nprepend-path     CPATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/include\r\n\r\nprepend-path     PKG_CONFIG_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/hcoll/lib/pkgconfig\r\n\r\nprepend-path     PKG_CONFIG_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/sharp/lib/pkgconfig\r\n\r\nprepend-path     PKG_CONFIG_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ucx/lib/pkgconfig\r\n\r\nprepend-path     PKG_CONFIG_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/lib/pkgconfig\r\n\r\nprepend-path     MANPATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/share/man\r\n\r\nsetenv           OPAL_PREFIX /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           PMIX_INSTALL_PREFIX /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           OMPI_HOME /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           MPI_HOME /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           OSHMEM_HOME /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nsetenv           SHMEM_HOME /shared/home/mk/azure-spack/spack/share/spack/modules/ompi\r\n\r\nprepend-path     PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/bin\r\n\r\nprepend-path     LD_LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/lib\r\n\r\nprepend-path     LIBRARY_PATH /shared/home/mk/azure-spack/spack/share/spack/modules/ompi/lib\r\n```\r\n",
    "performed_via_github_app": null
}