{
    "url": "https://api.github.com/repos/spack/spack/issues/7803",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/7803/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/7803/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/7803/events",
    "html_url": "https://github.com/spack/spack/issues/7803",
    "id": 315253168,
    "node_id": "MDU6SXNzdWUzMTUyNTMxNjg=",
    "number": 7803,
    "title": "OpenBLAS build error on macOS",
    "user": {
        "login": "JohnWGrove",
        "id": 33465019,
        "node_id": "MDQ6VXNlcjMzNDY1MDE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/33465019?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/JohnWGrove",
        "html_url": "https://github.com/JohnWGrove",
        "followers_url": "https://api.github.com/users/JohnWGrove/followers",
        "following_url": "https://api.github.com/users/JohnWGrove/following{/other_user}",
        "gists_url": "https://api.github.com/users/JohnWGrove/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/JohnWGrove/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/JohnWGrove/subscriptions",
        "organizations_url": "https://api.github.com/users/JohnWGrove/orgs",
        "repos_url": "https://api.github.com/users/JohnWGrove/repos",
        "events_url": "https://api.github.com/users/JohnWGrove/events{/privacy}",
        "received_events_url": "https://api.github.com/users/JohnWGrove/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446754070,
            "node_id": "MDU6TGFiZWw0NDY3NTQwNzA=",
            "url": "https://api.github.com/repos/spack/spack/labels/blas-lapack-scalapack",
            "name": "blas-lapack-scalapack",
            "color": "4477a8",
            "default": false,
            "description": null
        },
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        },
        {
            "id": 446615135,
            "node_id": "MDU6TGFiZWw0NDY2MTUxMzU=",
            "url": "https://api.github.com/repos/spack/spack/labels/configuration",
            "name": "configuration",
            "color": "bfd4f2",
            "default": false,
            "description": null
        },
        {
            "id": 446614839,
            "node_id": "MDU6TGFiZWw0NDY2MTQ4Mzk=",
            "url": "https://api.github.com/repos/spack/spack/labels/macOS",
            "name": "macOS",
            "color": "c5def5",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 16,
    "created_at": "2018-04-17T21:47:59Z",
    "updated_at": "2018-04-23T20:54:47Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "Summary\r\n\r\nThe installation for hypre fails for spack on Mac OS 10.13.4. The failure occurs when openblas 0.2.20 installation is attempted. This failure occurs for both gcc7.3 and intel 18.0.2. The problem is not spack directly but really openblas-0.2.20 which tries to use assembler commands that do not exist for this system. I don't give a hoot about openblas since I really want to use the system versions of blas and lapack. The problem is that the spack default configuration for hypre tries to build openblas. When I build hypre by hand, the configure options --with-blas and --with-lapack  will use the system files in /usr/lib, which works. I cannot for the life of me figure out from the spack documentation how to tell it to use these options, much less how to write a package.yaml specialization to tell all packages to use the system versions of blas and lapack. I tried using blas : [system] and lapack : [system] in my user packages.yaml and this didn't help. I also tried removing these lines entires. In either case spack still tries to build openblas.\r\n\r\n### Expected Result\r\n\r\nspack install hypre %gcc@7.3.0\r\nand\r\nspack install hypre %intel@18.0.2\r\n\r\nwork\r\n\r\n### Actual Result\r\n\r\nThe command spack install hypre %gcc7.3.0 fails with the error message\r\n==> Installing openblas\r\n==> Using cached archive: /Users/jgrove/spack/var/spack/cache/openblas/openblas-0.2.20.tar.gz\r\n==> Staging archive: /Users/jgrove/spack/var/spack/stage/openblas-0.2.20-cqu36bmxblsej2t4vro52tvfxhhmwbg5/v0.2.20.tar.gz\r\n==> Created stage in /Users/jgrove/spack/var/spack/stage/openblas-0.2.20-cqu36bmxblsej2t4vro52tvfxhhmwbg5\r\n==> Applied patch make.patch\r\n==> Building openblas [MakefilePackage]\r\n==> Executing phase: 'edit'\r\n==> Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' 'CC=/Users/jgrove/spack/lib/spack/env/gcc/gcc' 'FC=/Users/jgrove/spack/lib/spack/env/gcc/gfortran' 'MAKE_NO_J=1' 'USE_OPENMP=0' 'USE_THREAD=0' 'libs' 'netlib' 'shared'\r\n\r\n1 error found in build log:\r\n     2337    ../kernel/x86_64/saxpy_microk_sandy-2.c:82:no such instruction: `vaddps %ymm11, %ymm7,%ymm15'\r\n     2338    ../kernel/x86_64/saxpy_microk_sandy-2.c:83:no such instruction: `vmovups %ymm12, -128(%rdx,%rax,4)'\r\n     2339    ../kernel/x86_64/saxpy_microk_sandy-2.c:84:no such instruction: `vmovups %ymm13, -96(%rdx,%rax,4)'\r\n     2340    ../kernel/x86_64/saxpy_microk_sandy-2.c:85:no such instruction: `vmovups %ymm14, -64(%rdx,%rax,4)'\r\n     2341    ../kernel/x86_64/saxpy_microk_sandy-2.c:86:no such instruction: `vmovups %ymm15, -32(%rdx,%rax,4)'\r\n     2342    ../kernel/x86_64/saxpy_microk_sandy-2.c:87:no such instruction: `vzeroupper'\r\n  >> 2343    make[1]: *** [Makefile.L1:640: saxpy_k.o] Error 1\r\n     2344    make[1]: Leaving directory '/private/var/folders/jl/9jpdtxpj67v2z2kn9x6bh0d8000c82/T/jgrove/spack-stage/sp\r\n             ack-stage-8O8TWh/OpenBLAS-0.2.20/kernel'\r\n     2345    make: *** [Makefile:139: libs] Error 1\r\n\r\nSee build log for details:\r\n  /Users/jgrove/spack/var/spack/stage/openblas-0.2.20-cqu36bmxblsej2t4vro52tvfxhhmwbg5/OpenBLAS-0.2.20/spack-build.out\r\n\r\nThis is really a problem with OpenBLAS-0.2.20 which apparently does not properly support Macs. I don't want to use OpenBLAS anyway, just to tell hypre to use the system versions of blas and lapack. I expect this issue occurs for all packages that try to use blas or lapack, directly or indirectly and the correct configuration in my opinion is that for Mac darwin, use the system provided versions of these libraries.\r\n\r\n\r\n### Steps to reproduce the issue\r\n\r\nOn a Mac running OS 10.13.4 run\r\n\r\n```console\r\n$ spack install hypre %gcc@7.3.0\r\nand/or\r\n$ spack install hypre %intel@18.0.2\r\n...\r\n```\r\n\r\n### Information on your system\r\n\r\nThis includes:\r\n\r\n 1. Late 2013 MacPro running OS 10.13.4\r\n 2. I tried modifying packages.yaml as follow but this had no effect\r\n```yaml\r\npackages:\r\n  all:\r\n    compiler: [gcc, intel, pgi, clang, xl, nag]\r\n    providers:\r\n      awk: [gawk]\r\n      blas: [system]\r\n      daal: [intel-daal]\r\n      elf: [elfutils]\r\n      gl: [mesa, opengl]\r\n      golang: [gcc]\r\n      ipp: [intel-ipp]\r\n      java: [jdk]\r\n      lapack: [system]\r\n      mkl: [intel-mkl]\r\n      mpe: [mpe2]\r\n      mpi: [openmpi, mpich]\r\n      opencl: [pocl]\r\n      openfoam: [openfoam-com, openfoam-org, foam-extend]\r\n      pil: [py-pillow]\r\n      pkgconfig: [pkgconf, pkg-config]\r\n      scalapack: [netlib-scalapack]\r\n      szip: [libszip, libaec]\r\n      tbb: [intel-tbb]\r\n      jpeg: [libjpeg-turbo, libjpeg]\r\n```",
    "performed_via_github_app": null
}