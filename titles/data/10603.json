{
    "url": "https://api.github.com/repos/spack/spack/issues/10603",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/10603/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/10603/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/10603/events",
    "html_url": "https://github.com/spack/spack/issues/10603",
    "id": 410282578,
    "node_id": "MDU6SXNzdWU0MTAyODI1Nzg=",
    "number": 10603,
    "title": "Installation issue: expat (but the root cause is likely libbsd-related)",
    "user": {
        "login": "HadrienG2",
        "id": 1305080,
        "node_id": "MDQ6VXNlcjEzMDUwODA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1305080?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HadrienG2",
        "html_url": "https://github.com/HadrienG2",
        "followers_url": "https://api.github.com/users/HadrienG2/followers",
        "following_url": "https://api.github.com/users/HadrienG2/following{/other_user}",
        "gists_url": "https://api.github.com/users/HadrienG2/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/HadrienG2/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/HadrienG2/subscriptions",
        "organizations_url": "https://api.github.com/users/HadrienG2/orgs",
        "repos_url": "https://api.github.com/users/HadrienG2/repos",
        "events_url": "https://api.github.com/users/HadrienG2/events{/privacy}",
        "received_events_url": "https://api.github.com/users/HadrienG2/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2019-02-14T12:45:07Z",
    "updated_at": "2019-02-14T16:35:42Z",
    "closed_at": "2019-02-14T16:35:42Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "The default variant of expat does not pass the configure stage with current Spack master on openSUSE Tumbleweed.\r\n\r\nThe configure log suggests that this happens as a result of unexpected preprocessing of libbsd headers, emerging from a combination of three factors:\r\n\r\n1. There is a header called `bsd/stdio.h` in libbsd which includes `<stdio.h>` early on.\r\n2. This include is resolved to the libbsd `bsd/stdio.h` that did the include, instead of the glibc version as the libbsd developer most likely expected.\r\n3. The header guard is located after this include, so unwanted recursion insanity ensues.\r\n\r\nUntil this is fixed, people who encounter this problem are advised to try disabling the `libbsd` variant of the expat package, as libbsd is clearly playing with fire, and [this library is only used as a compatibility workaround for CentOS' ancient package base](https://github.com/spack/spack/pull/4945) that should not be needed on modern Linux distributions.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install expat\r\n==> Installing libbsd\r\n==> Searching for binary cache of libbsd\r\n==> Warning: No Spack mirrors are currently configured\r\n==> No binary for libbsd found: installing from source\r\n==> Warning: A dependency has updated CPATH, this may lead pkg-config to assume that the package is part of the system includes and omit it when invoked with '--cflags'.\r\n==> Fetching https://libbsd.freedesktop.org/releases/libbsd-0.9.1.tar.xz\r\n#=#=-  #       #                                                                                                                                                                                                                                               #=O=#     #        #                                                                                                                                                                                                                                           -#O=- #      #          #                                                                                                   ######################################################################################################################################################################################################################################################### 100.0%\r\n==> Staging archive: /opt/spack/var/spack/stage/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/libbsd-0.9.1.tar.xz\r\n==> Created stage in /opt/spack/var/spack/stage/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f\r\n==> No patches needed for libbsd\r\n==> Building libbsd [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Executing phase: 'configure'\r\n==> Executing phase: 'build'\r\n==> Executing phase: 'install'\r\n==> Successfully installed libbsd\r\n  Fetch: 1.54s.  Build: 14.45s.  Total: 16.00s.\r\n[+] /opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f\r\n==> Installing expat\r\n==> Searching for binary cache of expat\r\n==> Warning: No Spack mirrors are currently configured\r\n==> No binary for expat found: installing from source\r\n==> Warning: A dependency has updated CPATH, this may lead pkg-config to assume that the package is part of the system includes and omit it when invoked with '--cflags'.\r\n==> Fetching https://github.com/libexpat/libexpat/releases/download/R_2_2_5/expat-2.2.5.tar.bz2\r\n#=#=-  #       #                                                                                                                                                                                                                                               #=O=#     #        #                                                                                                                                                                                                                                           -#O=- #      #          #                                                                                                   ######################################################################################################################################################################################################################################################### 100.0%\r\n==> Staging archive: /opt/spack/var/spack/stage/expat-2.2.5-rlu65lhrklurdk2lmo2nidwj6p3f7z4c/expat-2.2.5.tar.bz2\r\n==> Created stage in /opt/spack/var/spack/stage/expat-2.2.5-rlu65lhrklurdk2lmo2nidwj6p3f7z4c\r\n==> No patches needed for expat\r\n==> Building expat [AutotoolsPackage]\r\n==> Executing phase: 'autoreconf'\r\n==> Executing phase: 'configure'\r\n==> Error: ProcessError: Command exited with status 1:\r\n    '/opt/spack/var/spack/stage/expat-2.2.5-rlu65lhrklurdk2lmo2nidwj6p3f7z4c/expat-2.2.5/configure' '--prefix=/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/expat-2.2.5-rlu65lhrklurdk2lmo2nidwj6p3f7z4c' '--with-libbsd'\r\n\r\n2 errors found in build log:\r\n     12    checking how to print strings... printf\r\n     13    checking for style of include used by make... GNU\r\n     14    checking for gcc... /opt/spack/lib/spack/env/gcc/gcc\r\n     15    checking whether the C compiler works... yes\r\n     16    checking for C compiler default output file name... a.out\r\n     17    checking for suffix of executables...\r\n  >> 18    checking whether we are cross compiling... configure: error: in `/tmp/root/spack-stage/spack-stage-mJnNyc/expat-2.2.5':\r\n  >> 19    configure: error: cannot run C compiled programs.\r\n     20    If you meant to cross compile, use `--host'.\r\n     21    See `config.log' for more details\r\n\r\nSee build log for details:\r\n  /opt/spack/var/spack/stage/expat-2.2.5-rlu65lhrklurdk2lmo2nidwj6p3f7z4c/expat-2.2.5/spack-build.out\r\n```\r\n\r\nRelevant part of `config.log`:\r\n\r\n```\r\n    [ ... removed for brevity ...]\r\n\r\nconfigure:4073: checking whether we are cross compiling\r\nconfigure:4081: /opt/spack/lib/spack/env/gcc/gcc -o conftest   -DHAVE_EXPAT_CONFIG_H  conftest.c  >&5\r\nIn file included from /opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:34,\r\n                 from /opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:34,\r\n                 from /opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:34,\r\n\r\n        [ ... abriged about a hundred repetitions ... ]\r\n\r\n                 from /opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:34,\r\n                 from /opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:34,\r\n                 from conftest.c:11:\r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:34:19: error: #include nested too deeply\r\n #include <stdio.h>\r\n                   ^\r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:44:27: error: #include nested too deeply\r\n #include <bsd/sys/cdefs.h>\r\n                           ^\r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:46:23: error: #include nested too deeply\r\n #include <sys/types.h>\r\n                       ^\r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:48:14: error: expected ';' before 'const'\r\n __BEGIN_DECLS\r\n              ^\r\n              ;\r\n const char *fmtcheck(const char *, const char *);\r\n ~~~~~         \r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:53:14: error: unknown type name 'FILE'\r\n char *fgetln(FILE *fp, size_t *lenp)\r\n              ^~~~\r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:53:14: note: 'FILE' is defined in header '<stdio.h>'; did you forget to '#include <stdio.h>'?\r\n/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h:1:1:\r\n+#include <stdio.h>\r\n /*\r\n\r\n    [ ... removed for brevity ... ]\r\n```\r\nHead of `/opt/spack/opt/spack/linux-opensuse_tumbleweed20190209-x86_64/gcc-8.2.1/libbsd-0.9.1-3n5p7tb72l6uj2xecjmcw76tpw5luo6f/include/bsd/stdio.h`:\r\n\r\n```\r\n    [ ... removed license header for brevity ... ]\r\n\r\n#if defined(__need_FILE) || defined(__need___FILE)\r\n#define LIBBSD_STDIO_H_SKIP\r\n#endif\r\n\r\n#ifdef LIBBSD_OVERLAY\r\n#include_next <stdio.h>\r\n#else\r\n#include <stdio.h>\r\n#endif\r\n\r\n#ifndef LIBBSD_STDIO_H_SKIP\r\n#ifndef LIBBSD_STDIO_H\r\n#define LIBBSD_STDIO_H\r\n\r\n    [... header continues, but rest is not needed to understand this problem ...]\r\n```\r\n\r\n### Platform and user environment\r\n\r\nPlease report your OS here:\r\n```commandline\r\n$ uname -a \r\nLinux 3a0ac58dac29 4.20.6-1-default #1 SMP PREEMPT Thu Jan 31 07:37:50 UTC 2019 (463cfd2) x86_64 x86_64 x86_64 GNU/Linux\r\n$ lsb_release -d\r\nDescription:    openSUSE Tumbleweed\r\n``` ",
    "performed_via_github_app": null
}