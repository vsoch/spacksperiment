{
    "url": "https://api.github.com/repos/spack/spack/issues/4421",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/4421/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/4421/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/4421/events",
    "html_url": "https://github.com/spack/spack/pull/4421",
    "id": 233028270,
    "node_id": "MDExOlB1bGxSZXF1ZXN0MTIzNjA3MjI3",
    "number": 4421,
    "title": "Allow packages to control handling of compiler flags",
    "user": {
        "login": "becker33",
        "id": 13971568,
        "node_id": "MDQ6VXNlcjEzOTcxNTY4",
        "avatar_url": "https://avatars.githubusercontent.com/u/13971568?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/becker33",
        "html_url": "https://github.com/becker33",
        "followers_url": "https://api.github.com/users/becker33/followers",
        "following_url": "https://api.github.com/users/becker33/following{/other_user}",
        "gists_url": "https://api.github.com/users/becker33/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/becker33/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/becker33/subscriptions",
        "organizations_url": "https://api.github.com/users/becker33/orgs",
        "repos_url": "https://api.github.com/users/becker33/repos",
        "events_url": "https://api.github.com/users/becker33/events{/privacy}",
        "received_events_url": "https://api.github.com/users/becker33/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "tgamblin",
        "id": 299842,
        "node_id": "MDQ6VXNlcjI5OTg0Mg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/299842?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tgamblin",
        "html_url": "https://github.com/tgamblin",
        "followers_url": "https://api.github.com/users/tgamblin/followers",
        "following_url": "https://api.github.com/users/tgamblin/following{/other_user}",
        "gists_url": "https://api.github.com/users/tgamblin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tgamblin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tgamblin/subscriptions",
        "organizations_url": "https://api.github.com/users/tgamblin/orgs",
        "repos_url": "https://api.github.com/users/tgamblin/repos",
        "events_url": "https://api.github.com/users/tgamblin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tgamblin/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "tgamblin",
            "id": 299842,
            "node_id": "MDQ6VXNlcjI5OTg0Mg==",
            "avatar_url": "https://avatars.githubusercontent.com/u/299842?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tgamblin",
            "html_url": "https://github.com/tgamblin",
            "followers_url": "https://api.github.com/users/tgamblin/followers",
            "following_url": "https://api.github.com/users/tgamblin/following{/other_user}",
            "gists_url": "https://api.github.com/users/tgamblin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tgamblin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tgamblin/subscriptions",
            "organizations_url": "https://api.github.com/users/tgamblin/orgs",
            "repos_url": "https://api.github.com/users/tgamblin/repos",
            "events_url": "https://api.github.com/users/tgamblin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tgamblin/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": {
        "url": "https://api.github.com/repos/spack/spack/milestones/3",
        "html_url": "https://github.com/spack/spack/milestone/3",
        "labels_url": "https://api.github.com/repos/spack/spack/milestones/3/labels",
        "id": 2905687,
        "node_id": "MDk6TWlsZXN0b25lMjkwNTY4Nw==",
        "number": 3,
        "title": "v0.11.0",
        "description": "",
        "creator": {
            "login": "tgamblin",
            "id": 299842,
            "node_id": "MDQ6VXNlcjI5OTg0Mg==",
            "avatar_url": "https://avatars.githubusercontent.com/u/299842?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tgamblin",
            "html_url": "https://github.com/tgamblin",
            "followers_url": "https://api.github.com/users/tgamblin/followers",
            "following_url": "https://api.github.com/users/tgamblin/following{/other_user}",
            "gists_url": "https://api.github.com/users/tgamblin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tgamblin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tgamblin/subscriptions",
            "organizations_url": "https://api.github.com/users/tgamblin/orgs",
            "repos_url": "https://api.github.com/users/tgamblin/repos",
            "events_url": "https://api.github.com/users/tgamblin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tgamblin/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 1,
        "closed_issues": 57,
        "state": "closed",
        "created_at": "2017-11-12T00:25:40Z",
        "updated_at": "2018-07-05T15:21:20Z",
        "due_on": "2018-01-17T08:00:00Z",
        "closed_at": "2018-01-17T23:02:16Z"
    },
    "comments": 0,
    "created_at": "2017-06-01T22:27:24Z",
    "updated_at": "2017-11-12T01:00:35Z",
    "closed_at": "2017-07-20T03:12:01Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/4421",
        "html_url": "https://github.com/spack/spack/pull/4421",
        "diff_url": "https://github.com/spack/spack/pull/4421.diff",
        "patch_url": "https://github.com/spack/spack/pull/4421.patch"
    },
    "body": "Fixes #3998 \r\n\r\nThis introduces a method for packages to modify their compiler flags. These modifications do NOT become a part of the spec.\r\n\r\nA package can define a function <flag>_handler(self, env, flag_val) for each compiler flag (current values are 'cflags', 'cxxflags', 'cppflags', 'fflags', 'ldflags', 'ldlibs'). The package can also define a function default_flag_handler(self, env, flag_val) that will be called for each flag for which a specific function is not defined.\r\n\r\nThe env parameter to these functions is an EnvironmentModifications object, as in setup_environment(). This environment can be used to \"trap\" the compiler flags so that they are presented to the build system through environment variables, rather than injected directly by the compiler wrapper. The flag_val parameter is a tuple, with the first value being the flag name and the second being a list of set flags. These functions should return a list, which is the set of flags to inject via the compiler wrappers.\r\n\r\nWe expect there to be three primary idioms for these functions. \r\n\r\n1) This is the default behavior\r\n```\r\ndef default_flag_handler(self, env, flag_val):\r\n    return flag_val[1]\r\n```\r\n\r\n2) This default function is defined in the autotools and cmake build systems classes, and is the default for those packages\r\n```\r\ndef default_flag_handler(self, env, flag_val):\r\n    env.append_flags(flag_val[0].upper(), ' '.join(flag_val[1]))\r\n    return []\r\n```\r\n\r\n3) Packages may have additional flags to add to the build. These flags can be added to either idiom above. For example:\r\n```\r\ndef default_flag_handler(self, env, flag_val):\r\n    flags = flag_val[1]\r\n    flags.append('-flag')\r\n    return flags\r\n```\r\nOR\r\n```\r\ndef default_flag_handler(self, env, flag_val):\r\n    env.append_flags(flag_val[0].upper(), ' '.join(flag_val[1]))\r\n    env.append_flags(flag_val[0].upper(), '-flag')\r\n    return []\r\n```\r\n\r\nPackages may also opt for methods that include aspects of any of the idioms above. E.g.\r\n```\r\ndef default_flag_handler(self, env, flag_val):\r\n    flags = []\r\n    if len(flag_val[1]) > 3:\r\n        env.append_flags(flag_val[0].upper(), ' '.join(flag_val[1][3:]))\r\n        flags = flag_val[1][:3]\r\n    else:\r\n        flags = flag_val[1]\r\n    flags.append('-flag')\r\n    return flags\r\n```\r\n\r\nAlso note the addition of the append_flags() method on the EnvironmentModifications class. This method should be used in any situation in the package file in which we are not certain that we want any previous value of this variable to be wiped. This is particularly important in cmake and autotools packages, where the default behavior now is to pre-populate the environment with the values from the spack compiler flags.\r\n\r\nThis PR does not yet contain documentation. I will mark it as WIP until documentation is complete. I will leave this for the rest of this week for comments and suggestions and begin working on documentation on Monday.",
    "performed_via_github_app": null
}