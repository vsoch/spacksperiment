{
    "url": "https://api.github.com/repos/spack/spack/issues/25043",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/25043/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/25043/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/25043/events",
    "html_url": "https://github.com/spack/spack/issues/25043",
    "id": 951019505,
    "node_id": "MDU6SXNzdWU5NTEwMTk1MDU=",
    "number": 25043,
    "title": "Installation issue: intel-tbb %nvhpc build issues",
    "user": {
        "login": "payerle",
        "id": 19287807,
        "node_id": "MDQ6VXNlcjE5Mjg3ODA3",
        "avatar_url": "https://avatars.githubusercontent.com/u/19287807?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/payerle",
        "html_url": "https://github.com/payerle",
        "followers_url": "https://api.github.com/users/payerle/followers",
        "following_url": "https://api.github.com/users/payerle/following{/other_user}",
        "gists_url": "https://api.github.com/users/payerle/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/payerle/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/payerle/subscriptions",
        "organizations_url": "https://api.github.com/users/payerle/orgs",
        "repos_url": "https://api.github.com/users/payerle/repos",
        "events_url": "https://api.github.com/users/payerle/events{/privacy}",
        "received_events_url": "https://api.github.com/users/payerle/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2021-07-22T20:20:37Z",
    "updated_at": "2021-07-22T20:20:37Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "When attempting to build intel-tbb with %nvhpc, I am running into a several issues:\r\n1) a number of compiler flags are not recognized by the nvc compilers\r\n2) in several places, the commands to link the code into shared libs is using ld version scripts and complaining about syntax errors in such.\r\n\r\nThe first issue is common when building with %nvhpc (and truth be told, I \"cheat\" and have spack pass --noswitcherror to all of the compilers, preprocessor, and linker to avoid these errors, but since I was writing a patch for the second issue, I figured would bring this up as well).\r\n\r\nThe second issue appears to be due to how the Makefiles are generating the version scripts, and some differences between the g++ and nvc++ commands when running as a preprocessor (with -E flag).  Indeed, the nvc++ version appears to be automagically including a couple of header files (_cplus_macros.h, _cplus_preinclude.h), as can be seen in the tbb.def file\r\nattached in the \"Additional information\" section.\r\n\r\n### Steps to reproduce the issue\r\n\r\n<!-- Fill in the exact spec you are trying to build and the relevant part of the error message -->\r\n```console\r\n$ spack install intel-tbb@2018.3%nvhpc@21.5 cxxstd=default +shared +tm arch=linux-rhel8-x86_64\r\n...\r\n/software/spack/git.2021.04.28/lib/spack/env/nvhpc/nvc++ -E -x c++ ../../src/tbb/lin64-tbb-export.def -DTBB_USE_DEBUG -DDO_ITT_NOTIFY -g -O0 -DUSE_PTHREAD -m64 -mrtm  -fPIC -flifetime-dse=1 -D__TBB_BUILD=1 -Wall -Wno-parentheses -Wno-non-virtual-dtor  -I../../src -I../../src/rml/include -I../../include > tbb.def\r\nnvc++-Warning-Unknown switch: -flifetime-dse=1\r\nnvc++-Warning-Unknown switch: -Wno-parentheses\r\nnvc++-Warning-Unknown switch: -Wno-non-virtual-dtor\r\n/software/spack/git.2021.04.28/lib/spack/env/nvhpc/nvc++ -fPIC -o libtbb_debug.so.2 concurrent_hash_map.o concurrent_queue.o concurrent_vector.o dynamic_link.o itt_notify.o cache_aligned_allocator.o pipeline.o queuing_mutex.o queuing_rw_mutex.o reader_writer_lock.o spin_rw_mutex.o x86_rtm_rw_mutex.o spin_mutex.o critical_section.o mutex.o recursive_mutex.o condition_variable.o tbb_thread.o concurrent_monitor.o semaphore.o private_server.o rml_tbb.o tbb_misc.o tbb_misc_ex.o task.o task_group_context.o governor.o market.o arena.o scheduler.o observer_proxy.o tbb_statistics.o tbb_main.o concurrent_vector_v2.o concurrent_queue_v2.o spin_rw_mutex_v2.o task_v2.o   -ldl -lpthread -lrt -shared -Wl,-soname=libtbb_debug.so.2 -m64  -Wl,--version-script,tbb.def\r\n/bin/ld:tbb.def:12: syntax error in VERSION script\r\nmake[1]: *** [../../build/Makefile.tbb:107: libtbb_debug.so.2] Error 2\r\nmake[1]: Leaving directory '/tmp/spackswinst/spack-stage/spack-stage-intel-tbb-2018.3-24wu2fazsj5qgxocxoixqcphnrdieogl/spack-src/build/linux_intel64_gcc_cc8.4.0_libc2.28_kernel4.18.0_debug'\r\nmake: *** [Makefile:32: tbb] Error 2\r\n```\r\n\r\n### Information on your system\r\n\r\n```console\r\n$spack debug report\r\n* **Spack:** 0.16.1-2429-f5e6c32495\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rhel8-x86_64\r\n* **Concretizer:** original\r\n```\r\n\r\nI have nvhpc@21.5 set up as an external package in spack, and as compilers.yaml has --noswitcherror set for cppflags (and \r\neverything else), the unknown compiler flags are only warnings, not errors.\r\n\r\n\r\n### Additional information\r\n\r\n\r\n* [spack-build-out.txt](https://github.com/spack/spack/files/6864996/spack-build-out.txt)\r\n* [spack-build-env.txt](https://github.com/spack/spack/files/6864997/spack-build-env.txt)\r\n* [tbb.def.txt](https://github.com/spack/spack/files/6864995/tbb.def.txt) This is one of the problematic version scripts (originally named tbb.def, renamed to tbb.def.txt to allow attaching)\r\n\r\nNo maintainers for intel-tbb found.\r\n\r\n### General information\r\n\r\n\r\n- [x ] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x ] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [x ] I have uploaded the build log and environment files\r\n- [x ] I have searched the issues of this repo and believe this is not a duplicate\r\n",
    "performed_via_github_app": null
}