{
    "url": "https://api.github.com/repos/spack/spack/issues/22585",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/22585/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/22585/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/22585/events",
    "html_url": "https://github.com/spack/spack/issues/22585",
    "id": 842311931,
    "node_id": "MDU6SXNzdWU4NDIzMTE5MzE=",
    "number": 22585,
    "title": "config update: updating from install_tree/install_naming_scheme format fails with `spack install -j >1`",
    "user": {
        "login": "cyrush",
        "id": 1194526,
        "node_id": "MDQ6VXNlcjExOTQ1MjY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1194526?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/cyrush",
        "html_url": "https://github.com/cyrush",
        "followers_url": "https://api.github.com/users/cyrush/followers",
        "following_url": "https://api.github.com/users/cyrush/following{/other_user}",
        "gists_url": "https://api.github.com/users/cyrush/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/cyrush/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cyrush/subscriptions",
        "organizations_url": "https://api.github.com/users/cyrush/orgs",
        "repos_url": "https://api.github.com/users/cyrush/repos",
        "events_url": "https://api.github.com/users/cyrush/events{/privacy}",
        "received_events_url": "https://api.github.com/users/cyrush/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2021-03-26T21:36:58Z",
    "updated_at": "2021-04-24T03:36:21Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "Context: I activated an environment and tried `spack install -j 20`, received an error about using an old config file:\r\n\r\n```\r\n==> Error: The \"config\" section of the configuration needs to be written to disk, but is currently using a deprecated format. Please update it using:\r\n\r\n        spack config [--scope=<scope] update config\r\n\r\n```\r\n\r\nI then tried the above suggestion. \r\n\r\n`spack config update config`\r\n\r\nThis fails b/c it says spack can't write to the file -- the perms are bad.\r\n\r\nPerms are fine in this case.  Looks like there is an issue with how the perms are checked when `spack.yaml` is used. \r\n\r\nMore details below. \r\n\r\n### Steps to reproduce the issue\r\n\r\nenv file:\r\n\r\n```\r\n# tested against: spack develop\r\nspack:\r\n  specs:\r\n  - zlib\r\n  concretization: together\r\n  config:\r\n    install_tree: spack-build\r\n    install_path_scheme: spack-libs/${COMPILERNAME}-${COMPILERVER}/${PACKAGE}-${VERSION}\r\n  compilers:\r\n  - compiler:\r\n      paths:\r\n        cc: /usr/bin/gcc\r\n        cxx: /usr/bin/g++\r\n        f77: /usr/bin/gfortran\r\n        fc: /usr/bin/gfortran\r\n      operating_system: ubuntu18.04\r\n      target: x86_64\r\n      modules: []\r\n      environment: {}\r\n      extra_rpaths: []\r\n      flags: {}\r\n      spec: gcc@7.5.0\r\n```\r\n\r\n\r\n```console\r\nspack env activate .\r\nspack concretize\r\nspack install -j 20\r\nspack -d config update config\r\n```\r\n\r\nThe old nature has something to do with the compilers entry, but that's orthogonal to the problem here. \r\n\r\n\r\nNote: `spack install` does not fail out of the gate if I omit the `-j 20`, but `spack config update config` always fails once when in this state. \r\n\r\nThe fact that `spack install -j 20` fails with the message about bad config, but `spack install` doesn't worries me.\r\n\r\nI am trying to build and install to a subdir of where I am using the env file, not inside the spack dir. \r\n\r\nI also modified the `_can_update_config_file` in spack/lib/spack/spack/cmd/config.py see what was going on:\r\n\r\n```\r\ndef _can_update_config_file(scope_dir, cfg_file):\r\n    print(\"checking dir  = {0}\".format(scope_dir))\r\n    print(\"checking file = {0}\".format(cfg_file))\r\n    dir_ok = fs.can_write_to_dir(scope_dir)\r\n    cfg_ok = fs.can_access(cfg_file)\r\n    return dir_ok and cfg_ok\r\n```\r\nFrom the print out below, it seems like both the `scope_dir` and `cfg_file` point to the yaml file. \r\nI suspect since the yaml file is not a dir, the `fs.can_write_to_dir(scope_dir)` fails, thinking it can't update the file.\r\n\r\n### Error Message\r\n\r\n`spack install -j 20` error:\r\n\r\n```\r\nroot@8dbfcc640e3f:/ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel# spack env activate . \r\nroot@8dbfcc640e3f:/ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel# spack concretize \r\n==> Warning: gcc@7.5.0 cannot build optimized binaries for \"zen3\". Using best target possible: \"zen\"\r\n==> Concretized zlib\r\n -   egwcgg2  zlib@1.2.11%gcc@7.5.0+optimize+pic+shared arch=linux-ubuntu18.04-zen\r\n\r\n==> Updating view at /ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel/.spack-env/view\r\nroot@8dbfcc640e3f:/ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel# spack -d install -j 20 \r\n==> [2021-03-26-21:46:31.828289] Imported install from built-in commands\r\n==> [2021-03-26-21:46:31.830771] Reading config file /ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel/spack.yaml\r\n==> [2021-03-26-21:46:31.837162] Imported install from built-in commands\r\nTraceback (most recent call last):\r\n  File \"/_t/spack/bin/spack\", line 76, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/_t/spack/lib/spack/spack/main.py\", line 754, in main\r\n    args, unknown = parser.parse_known_args()\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1754, in parse_known_args\r\n    namespace, args = self._parse_known_args(args, namespace)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1942, in _parse_known_args\r\n    positionals_end_index = consume_positionals(start_index)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1919, in consume_positionals\r\n    take_action(action, args)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1828, in take_action\r\n    action(self, namespace, argument_values, option_string)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1128, in __call__\r\n    namespace, arg_strings = parser.parse_known_args(arg_strings, namespace)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1754, in parse_known_args\r\n    namespace, args = self._parse_known_args(args, namespace)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1960, in _parse_known_args\r\n    start_index = consume_optional(start_index)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1900, in consume_optional\r\n    take_action(action, args, option_string)\r\n  File \"/_t/spack/lib/spack/external/argparse.py\", line 1828, in take_action\r\n    action(self, namespace, argument_values, option_string)\r\n  File \"/_t/spack/lib/spack/spack/cmd/common/arguments.py\", line 106, in __call__\r\n    spack.config.set('config:build_jobs', jobs, scope='command_line')\r\n  File \"/_t/spack/lib/spack/spack/config.py\", line 902, in set\r\n    return config.set(path, value, scope)\r\n  File \"/_t/spack/lib/spack/spack/config.py\", line 393, in _method\r\n    return method(self, *args, **kwargs)\r\n  File \"/_t/spack/lib/spack/spack/config.py\", line 690, in set\r\n    self.update_config(section, section_data, scope=scope)\r\n  File \"/_t/spack/lib/spack/spack/config.py\", line 393, in _method\r\n    return method(self, *args, **kwargs)\r\n  File \"/_t/spack/lib/spack/spack/config.py\", line 537, in update_config\r\n    raise RuntimeError(msg)\r\nRuntimeError: The \"config\" section of the configuration needs to be written to disk, but is currently using a deprecated format. Please update it using:\r\n\r\n        spack config [--scope=<scope] update config\r\n\r\nNote that previous versions of Spack will not be able to use the updated configuration.\r\n```\r\n\r\n`spack config update config` error:\r\n\r\n```\r\nroot@8dbfcc640e3f:/ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel# spack -d config update config\r\n==> [2021-03-26-21:49:11.101191] Imported config from built-in commands\r\n==> [2021-03-26-21:49:11.103302] Imported config from built-in commands\r\n==> [2021-03-26-21:49:11.105243] Reading config file /ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel/spack.yaml\r\nchecking dir  = /ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel/spack.yaml\r\nchecking file = /ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel/spack.yaml\r\n==> [2021-03-26-21:49:11.111383] Error: Detected permission issues with the following scopes:\r\n\r\n        [scope=env:/ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel, cfg=/ascent/scripts/uberenv/spack_envs/ci/ubuntu_18_devel/spack.yaml]\r\n\r\nEither ensure that you have sufficient permissions to modify these files or do not include these scopes in the update.\r\nTraceback (most recent call last):\r\n  File \"/_t/spack/lib/spack/spack/main.py\", line 768, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/_t/spack/lib/spack/spack/main.py\", line 496, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/_t/spack/lib/spack/spack/cmd/config.py\", line 474, in config\r\n    action[args.config_command](args)\r\n  File \"/_t/spack/lib/spack/spack/cmd/config.py\", line 274, in config_update\r\n    tty.die(msg)\r\n  File \"/_t/spack/lib/spack/llnl/util/tty/__init__.py\", line 239, in die\r\n    sys.exit(1)\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.1-1912-58ad774773\r\n* **Python:** 2.7.17\r\n* **Platform:** linux-ubuntu18.04-zen3\r\n* **Concretizer:** original\r\nroot@8dbfcc640e3f:/ascent/s\r\n\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n",
    "performed_via_github_app": null
}