{
    "url": "https://api.github.com/repos/spack/spack/issues/18073",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/18073/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/18073/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/18073/events",
    "html_url": "https://github.com/spack/spack/issues/18073",
    "id": 679386504,
    "node_id": "MDU6SXNzdWU2NzkzODY1MDQ=",
    "number": 18073,
    "title": "Installation issue: rocm-opencl",
    "user": {
        "login": "SirRujak",
        "id": 5132268,
        "node_id": "MDQ6VXNlcjUxMzIyNjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5132268?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/SirRujak",
        "html_url": "https://github.com/SirRujak",
        "followers_url": "https://api.github.com/users/SirRujak/followers",
        "following_url": "https://api.github.com/users/SirRujak/following{/other_user}",
        "gists_url": "https://api.github.com/users/SirRujak/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/SirRujak/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/SirRujak/subscriptions",
        "organizations_url": "https://api.github.com/users/SirRujak/orgs",
        "repos_url": "https://api.github.com/users/SirRujak/repos",
        "events_url": "https://api.github.com/users/SirRujak/events{/privacy}",
        "received_events_url": "https://api.github.com/users/SirRujak/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2020-08-14T20:29:39Z",
    "updated_at": "2020-08-18T16:50:32Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "<!-- Thanks for taking the time to report this build failure. To proceed with the report please:\r\n\r\n1. Title the issue \"Installation issue: <name-of-the-package>\".\r\n2. Provide the information required below.\r\n\r\nWe encourage you to try, as much as possible, to reduce your problem to the minimal example that still reproduces the issue. That would help us a lot in fixing it quickly and effectively! -->\r\n\r\n### Steps to reproduce the issue\r\n\r\n<!-- Fill in the exact spec you are trying to build and the relevant part of the error message -->\r\n```console\r\n$ spack install rocm-opencl\r\n$ clinfo\r\nERROR: clGetPlatformIDs(-1001)\r\n\r\n```\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n* **Spack:** 0.15.4-521-1d152a44f\r\n* **Python:** 3.7.8\r\n* **Platform:** linux-solus4-zen2\r\n\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\n\r\n### Additional information\r\n\r\n<!-- Please upload the following files. They should be present in the stage directory of the failing build. Also upload any config.log or similar file if one exists. -->\r\n* [spack-build-out.txt](https://github.com/spack/spack/files/5076810/spack-build-env.txt)\r\n* [spack-build-out.txt](https://github.com/spack/spack/files/5076811/spack-build-out.txt)\r\n\r\n<!-- Some packages have maintainers who have volunteered to debug build failures. Run `spack maintainers <name-of-the-package>` and @mention them here if they exist. -->\r\n@arjun-raj-kuppala @srekolam \r\n\r\n### General information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [x] I have uploaded the build log and environment files\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n\r\n\r\n### Extra Information\r\nI've been watching the recently merged pull request https://github.com/spack/spack/pull/17422 to try and  get OpenCL running on my system. The installation step of the rocm-opencl package completes properly but clinfo crashes for a couple reasons.\r\n\r\nFirst, it appears that the OpenCL vendors path is hard coded into the rocm build as \"/etc/OpenCL/vendors/\" which seems to be a general issue as noted in https://github.com/RadeonOpenCompute/ROCm-OpenCL-Runtime/pull/111. Using the suggestion in https://github.com/RadeonOpenCompute/ROCm/issues/511#issuecomment-415609121 I was able to create the amdocl64.icd using the libamdocl64.so file in the rocm-opencl lib directory. I am not yet familiar enough with Spack to understand the proper way to fix such a path issue. I have seen the RPATH feature but still couldn't quite come up with how to go about it properly. \r\n\r\nSecond, even after hackily making it find the proper vendors files it still crashes out due to a necessary runtime dependency on comgr. Changing `depends_on('comgr@3.5.0', type='build', when='@3.5.0')` to `depends_on('comgr@3.5.0', type=('build', 'run'), when='@3.5.0')` in the rocm-opencl package.yaml allows clinfo to run and correctly identifies my RX480 as a OpenCL device. The clinfo output is here:\r\n\r\n<details>\r\n  <summary>clinfo output</summary>\r\n\r\n  ```\r\n$ clinfo\r\nNumber of platforms:\t\t\t\t 1\r\n  Platform Profile:\t\t\t\t FULL_PROFILE\r\n  Platform Version:\t\t\t\t OpenCL 2.0 AMD-APP (3137.0)\r\n  Platform Name:\t\t\t\t AMD Accelerated Parallel Processing\r\n  Platform Vendor:\t\t\t\t Advanced Micro Devices, Inc.\r\n  Platform Extensions:\t\t\t\t cl_khr_icd cl_amd_event_callback \r\n\r\n\r\n  Platform Name:\t\t\t\t AMD Accelerated Parallel Processing\r\nNumber of devices:\t\t\t\t 1\r\n  Device Type:\t\t\t\t\t CL_DEVICE_TYPE_GPU\r\n  Vendor ID:\t\t\t\t\t 1002h\r\n  Board name:\t\t\t\t\t Ellesmere [Radeon RX 470/480/570/570X/580/580X/590]\r\n  Device Topology:\t\t\t\t PCI[ B#45, D#0, F#0 ]\r\n  Max compute units:\t\t\t\t 36\r\n  Max work items dimensions:\t\t\t 3\r\n    Max work items[0]:\t\t\t\t 1024\r\n    Max work items[1]:\t\t\t\t 1024\r\n    Max work items[2]:\t\t\t\t 1024\r\n  Max work group size:\t\t\t\t 256\r\n  Preferred vector width char:\t\t\t 4\r\n  Preferred vector width short:\t\t\t 2\r\n  Preferred vector width int:\t\t\t 1\r\n  Preferred vector width long:\t\t\t 1\r\n  Preferred vector width float:\t\t\t 1\r\n  Preferred vector width double:\t\t 1\r\n  Native vector width char:\t\t\t 4\r\n  Native vector width short:\t\t\t 2\r\n  Native vector width int:\t\t\t 1\r\n  Native vector width long:\t\t\t 1\r\n  Native vector width float:\t\t\t 1\r\n  Native vector width double:\t\t\t 1\r\n  Max clock frequency:\t\t\t\t 1266Mhz\r\n  Address bits:\t\t\t\t\t 64\r\n  Max memory allocation:\t\t\t 7301444403\r\n  Image support:\t\t\t\t No\r\n  Max size of kernel argument:\t\t\t 1024\r\n  Alignment (bits) of base address:\t\t 1024\r\n  Minimum alignment (bytes) for any datatype:\t 128\r\n  Single precision floating point capability\r\n    Denorms:\t\t\t\t\t No\r\n    Quiet NaNs:\t\t\t\t\t Yes\r\n    Round to nearest even:\t\t\t Yes\r\n    Round to zero:\t\t\t\t Yes\r\n    Round to +ve and infinity:\t\t\t Yes\r\n    IEEE754-2008 fused multiply-add:\t\t Yes\r\n  Cache type:\t\t\t\t\t Read/Write\r\n  Cache line size:\t\t\t\t 64\r\n  Cache size:\t\t\t\t\t 16384\r\n  Global memory size:\t\t\t\t 8589934592\r\n  Constant buffer size:\t\t\t\t 7301444403\r\n  Max number of constant args:\t\t\t 8\r\n  Local memory type:\t\t\t\t Scratchpad\r\n  Local memory size:\t\t\t\t 65536\r\n  Max pipe arguments:\t\t\t\t 16\r\n  Max pipe active reservations:\t\t\t 16\r\n  Max pipe packet size:\t\t\t\t 3006477107\r\n  Max global variable size:\t\t\t 7301444403\r\n  Max global variable preferred total size:\t 8589934592\r\n  Max read/write image args:\t\t\t 0\r\n  Max on device events:\t\t\t\t 1024\r\n  Queue on device max size:\t\t\t 8388608\r\n  Max on device queues:\t\t\t\t 1\r\n  Queue on device preferred size:\t\t 262144\r\n  SVM capabilities:\t\t\t\t \r\n    Coarse grain buffer:\t\t\t Yes\r\n    Fine grain buffer:\t\t\t\t Yes\r\n    Fine grain system:\t\t\t\t No\r\n    Atomics:\t\t\t\t\t No\r\n  Preferred platform atomic alignment:\t\t 0\r\n  Preferred global atomic alignment:\t\t 0\r\n  Preferred local atomic alignment:\t\t 0\r\n  Kernel Preferred work group size multiple:\t 64\r\n  Error correction support:\t\t\t 0\r\n  Unified memory for Host and Device:\t\t 0\r\n  Profiling timer resolution:\t\t\t 1\r\n  Device endianess:\t\t\t\t Little\r\n  Available:\t\t\t\t\t Yes\r\n  Compiler available:\t\t\t\t Yes\r\n  Execution capabilities:\t\t\t\t \r\n    Execute OpenCL kernels:\t\t\t Yes\r\n    Execute native function:\t\t\t No\r\n  Queue on Host properties:\t\t\t\t \r\n    Out-of-Order:\t\t\t\t No\r\n    Profiling :\t\t\t\t\t Yes\r\n  Queue on Device properties:\t\t\t\t \r\n    Out-of-Order:\t\t\t\t Yes\r\n    Profiling :\t\t\t\t\t Yes\r\n  Platform ID:\t\t\t\t\t 0x7fae78e09c90\r\n  Name:\t\t\t\t\t\t gfx803\r\n  Vendor:\t\t\t\t\t Advanced Micro Devices, Inc.\r\n  Device OpenCL C version:\t\t\t OpenCL C 2.0 \r\n  Driver version:\t\t\t\t 3137.0 (HSA1.1,LC)\r\n  Profile:\t\t\t\t\t FULL_PROFILE\r\n  Version:\t\t\t\t\t OpenCL 1.2 \r\n  Extensions:\t\t\t\t\t cl_khr_fp64 cl_khr_global_int32_base_atomics cl_khr_global_int32_extended_atomics cl_khr_local_int32_base_atomics cl_khr_local_int32_extended_atomics cl_khr_int64_base_atomics cl_khr_int64_extended_atomics cl_khr_3d_image_writes cl_khr_byte_addressable_store cl_khr_fp16 cl_khr_gl_sharing cl_amd_device_attribute_query cl_amd_media_ops cl_amd_media_ops2 cl_khr_image2d_from_buffer cl_khr_subgroups cl_khr_depth_images cl_amd_copy_buffer_p2p cl_amd_assembly_program \r\n\r\n```\r\n</details>\r\n\r\nThis is at the point where things really stopped working though. The build is missing image support which makes testing it difficult. At the very least running darktable-cltest while in a Spack environment where rocm-opencl is installed appears to miss the GPU altogether as seen here:\r\n\r\n<details>\r\n  <summary>darktable-cltest output</summary>\r\n\r\n```\r\n\r\n $ darktable-cltest \r\n0.019987 [opencl_init] opencl related configuration options:\r\n0.019997 [opencl_init] \r\n0.019999 [opencl_init] opencl: 1\r\n0.020000 [opencl_init] opencl_scheduling_profile: 'default'\r\n0.020002 [opencl_init] opencl_library: ''\r\n0.020008 [opencl_init] opencl_memory_requirement: 768\r\n0.020013 [opencl_init] opencl_memory_headroom: 400\r\n0.020015 [opencl_init] opencl_device_priority: '*/!0,*/*/*/!0,*'\r\n0.020017 [opencl_init] opencl_mandatory_timeout: 200\r\n0.020019 [opencl_init] opencl_size_roundup: 16\r\n0.020021 [opencl_init] opencl_async_pixelpipe: 0\r\n0.020022 [opencl_init] opencl_synch_cache: active module\r\n0.020024 [opencl_init] opencl_number_event_handles: 25\r\n0.020026 [opencl_init] opencl_micro_nap: 1000\r\n0.020028 [opencl_init] opencl_use_pinned_memory: 0\r\n0.020030 [opencl_init] opencl_use_cpu_devices: 0\r\n0.020031 [opencl_init] opencl_avoid_atomics: 0\r\n0.020033 [opencl_init] \r\n0.023562 [opencl_init] found opencl runtime library 'libOpenCL'\r\n0.023591 [opencl_init] opencl library 'libOpenCL' found on your system and loaded\r\n0.023595 [opencl_init] found 1 platform\r\n0.042325 [opencl_init] found 1 device\r\n0.042358 [opencl_init] discarding CPU device 0 `pthread-AMD Ryzen 9 3900X 12-Core Processor'.\r\n0.042364 [opencl_init] no suitable devices found.\r\n0.042367 [opencl_init] FINALLY: opencl is NOT AVAILABLE on this system.\r\n0.042369 [opencl_init] initial status of opencl enabled flag is OFF.\r\n\r\n```\r\n</details>\r\n\r\nAttempting to run Blender from the command prompt seems to get it stuck in a never ending loop with one thread running at 100%. Unfortunately the strace for Blender wasn't particularly helpful due to the large number of commands it was running. The last application I tried was plaidml which, similar to darktable, was able to find my CPU somehow but appeared to never load the configuration for the GPU. With strace I was able to find something that possibly is causing the issue though. It appears that the rocm-opencl build creates both a lib and a lib64 folder and both contain a libOpenCL.so file. Plaidml appears to find the lib64 version first as seen here \r\n\r\n`openat(AT_FDCWD, \"/mnt/fe9dcbea-9428-40db-8650-4a941be01d52/Documents/spack/var/spack/environments/cltest/.spack-env/view/lib64/libOpenCL.so\", O_RDONLY|O_CLOEXEC) = 4`\r\n\r\nI am guessing this is the problem because only the lib folder contains libamdocl64.so which I believe means that it never tries to pull in the vendor file but I am a bit out of my depth here.\r\n\r\nAny assistance would be greatly appreciated, I understand the rocm components just got pulled in and issues were to be expected, I have just hit the end of my knowledge and am not quite sure how to progress from here. ",
    "performed_via_github_app": null
}