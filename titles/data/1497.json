{
    "url": "https://api.github.com/repos/spack/spack/issues/1497",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/1497/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/1497/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/1497/events",
    "html_url": "https://github.com/spack/spack/issues/1497",
    "id": 170658030,
    "node_id": "MDU6SXNzdWUxNzA2NTgwMzA=",
    "number": 1497,
    "title": "spack.util.web._spider is broken for max_depth >= 3",
    "user": {
        "login": "tobbez",
        "id": 9334,
        "node_id": "MDQ6VXNlcjkzMzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/9334?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tobbez",
        "html_url": "https://github.com/tobbez",
        "followers_url": "https://api.github.com/users/tobbez/followers",
        "following_url": "https://api.github.com/users/tobbez/following{/other_user}",
        "gists_url": "https://api.github.com/users/tobbez/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tobbez/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tobbez/subscriptions",
        "organizations_url": "https://api.github.com/users/tobbez/orgs",
        "repos_url": "https://api.github.com/users/tobbez/repos",
        "events_url": "https://api.github.com/users/tobbez/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tobbez/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446643530,
            "node_id": "MDU6TGFiZWw0NDY2NDM1MzA=",
            "url": "https://api.github.com/repos/spack/spack/labels/fetching",
            "name": "fetching",
            "color": "fbca04",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2016-08-11T14:22:46Z",
    "updated_at": "2017-09-01T12:14:20Z",
    "closed_at": "2017-04-13T16:09:09Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "As first noted here: https://github.com/LLNL/spack/issues/1225#issuecomment-232378291\n\nThe problematic code is at https://github.com/LLNL/spack/blob/develop/lib/spack/spack/util/web.py#L134:\n\n``` python\n        if subcalls:                                                                                                                       \n            try:    \n                pool = Pool(processes=len(subcalls))\n                results = pool.map(_spider, subcalls)\n                for sub_pages, sub_links in results:\n                    pages.update(sub_pages)\n                    links.update(sub_links)\n            finally:\n                pool.terminate()\n                pool.join()\n```\n\nThe problem is that you're not allowed to create daemonic processes from daemonic processes, and map creates daemonic subprocesses, so when recursing from one of those subprocesses we get an exception.\n\nThe reason it hasn't been caught before is that the exception is silently dropped unless you run spack in debug mode. This made it hard to notice, especially if some versions are returned (i.e. if there are archives at multiple levels of the tree), where archives at the two first levels of the hierarchy would be returned, but not ones further down.\n\nRunning in debug mode (for a package with list_depth=3) shows:\n\n``` console\n$ spack -d versions hdf5\n==> ignoring page http://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.13/src/hdf5-1.8.13.tar.md5 with content type application/x-tar\n==> ignoring page http://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.13/src/hdf5-1.8.13-RELEASE.txt with content type text/plain\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Error in _spider: local variable 'pool' referenced before assignment\n==> Safe versions (already checksummed):\n  1.10.0-patch1  1.10.0  1.8.16  1.8.15  1.8.13\n==> Remote versions (not yet checksummed):\n  1.6.5  1.6.4  1.6.3  1.6.2  1.6.1  1.6.0  1.4.4  1.4.3  1.4.2  1.4.1  1.4.0  1.2.2\n```\n\nWhich I believe might be happening when the code in the finally clause is executed.\n\nModifying the code slightly, as follows:\n\n``` diff\ndiff --git a/lib/spack/spack/util/web.py b/lib/spack/spack/util/web.py\nindex 25f1e60..285c53b 100644\n--- a/lib/spack/spack/util/web.py\n+++ b/lib/spack/spack/util/web.py\n@@ -132,8 +132,8 @@ def _spider(args):\n                 visited.add(abs_link)\n\n         if subcalls:\n+            pool = Pool(processes=len(subcalls))\n             try:\n-                pool = Pool(processes=len(subcalls))\n                 results = pool.map(_spider, subcalls)\n                 for sub_pages, sub_links in results:\n                     pages.update(sub_pages)\n```\n\nInstead shows us the first/real exception:\n\n``` console\n$ spack -d versions hdf5\n==> ignoring page http://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.13/src/hdf5-1.8.13.tar.md5 with content type application/x-tar\n==> ignoring page http://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.13/src/hdf5-1.8.13-RELEASE.txt with content type text/plain\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Error in _spider: daemonic processes are not allowed to have children\n==> Safe versions (already checksummed):\n  1.10.0-patch1  1.10.0  1.8.16  1.8.15  1.8.13\n==> Remote versions (not yet checksummed):\n  1.6.5  1.6.4  1.6.3  1.6.2  1.6.1  1.6.0  1.4.4  1.4.3  1.4.2  1.4.1  1.4.0  1.2.2\n```\n\nFurther changing the code to give us a full stack trace:\n\n``` diff\ndiff --git a/lib/spack/spack/util/web.py b/lib/spack/spack/util/web.py\nindex 25f1e60..a3de476 100644\n--- a/lib/spack/spack/util/web.py\n+++ b/lib/spack/spack/util/web.py\n@@ -132,8 +132,8 @@ def _spider(args):\n                 visited.add(abs_link)\n\n         if subcalls:\n+            pool = Pool(processes=len(subcalls))\n             try:\n-                pool = Pool(processes=len(subcalls))\n                 results = pool.map(_spider, subcalls)\n                 for sub_pages, sub_links in results:\n                     pages.update(sub_pages)\n@@ -157,9 +157,9 @@ def _spider(args):\n\n         tty.warn(msg, url, \"HTMLParseError: \" + str(e))\n\n-    except Exception as e:\n-        # Other types of errors are completely ignored, except in debug mode.\n-        tty.debug(\"Error in _spider: %s\" % e)\n+    #except Exception as e:\n+    #    # Other types of errors are completely ignored, except in debug mode.\n+    #    tty.debug(\"Error in _spider: %s\" % e)\n\n     return pages, links\n```\n\ngives:\n\n``` console\n$ spack -d versions hdf5\n==> ignoring page http://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.13/src/hdf5-1.8.13-RELEASE.txt with content type text/plain\n==> ignoring page http://www.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.13/src/hdf5-1.8.13.tar.md5 with content type application/x-tar\nTraceback (most recent call last):\n  File \"/home/ketl/spack/bin/spack\", line 184, in <module>\n    main()\n  File \"/home/ketl/spack/bin/spack\", line 161, in main\n    return_val = command(parser, args)\n  File \"/home/ketl/spack/lib/spack/spack/cmd/versions.py\", line 41, in versions\n    fetched_versions = pkg.fetch_remote_versions()\n  File \"/home/ketl/spack/lib/spack/spack/package.py\", line 1383, in fetch_remote_versions\n    list_depth=self.list_depth)\n  File \"/home/ketl/spack/lib/spack/spack/util/web.py\", line 215, in find_versions_of_archive\n    p, l = spider(lurl, depth=list_depth)\n  File \"/home/ketl/spack/lib/spack/spack/util/web.py\", line 177, in spider\n    1, max_depth, False))\n  File \"/home/ketl/spack/lib/spack/spack/util/web.py\", line 137, in _spider\n    results = pool.map(_spider, subcalls)\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 251, in map\n    return self.map_async(func, iterable, chunksize).get()\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 567, in get\n    raise self._value\nAssertionError: daemonic processes are not allowed to have children\n```\n",
    "performed_via_github_app": null
}