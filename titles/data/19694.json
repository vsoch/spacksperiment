{
    "url": "https://api.github.com/repos/spack/spack/issues/19694",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/19694/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/19694/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/19694/events",
    "html_url": "https://github.com/spack/spack/issues/19694",
    "id": 734912989,
    "node_id": "MDU6SXNzdWU3MzQ5MTI5ODk=",
    "number": 19694,
    "title": "bug: spack install from multiple spec hashes fails",
    "user": {
        "login": "sethrj",
        "id": 741229,
        "node_id": "MDQ6VXNlcjc0MTIyOQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/741229?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sethrj",
        "html_url": "https://github.com/sethrj",
        "followers_url": "https://api.github.com/users/sethrj/followers",
        "following_url": "https://api.github.com/users/sethrj/following{/other_user}",
        "gists_url": "https://api.github.com/users/sethrj/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/sethrj/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sethrj/subscriptions",
        "organizations_url": "https://api.github.com/users/sethrj/orgs",
        "repos_url": "https://api.github.com/users/sethrj/repos",
        "events_url": "https://api.github.com/users/sethrj/events{/privacy}",
        "received_events_url": "https://api.github.com/users/sethrj/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446623646,
            "node_id": "MDU6TGFiZWw0NDY2MjM2NDY=",
            "url": "https://api.github.com/repos/spack/spack/labels/concretization",
            "name": "concretization",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "tldahlgren",
        "id": 35777542,
        "node_id": "MDQ6VXNlcjM1Nzc3NTQy",
        "avatar_url": "https://avatars.githubusercontent.com/u/35777542?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tldahlgren",
        "html_url": "https://github.com/tldahlgren",
        "followers_url": "https://api.github.com/users/tldahlgren/followers",
        "following_url": "https://api.github.com/users/tldahlgren/following{/other_user}",
        "gists_url": "https://api.github.com/users/tldahlgren/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tldahlgren/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tldahlgren/subscriptions",
        "organizations_url": "https://api.github.com/users/tldahlgren/orgs",
        "repos_url": "https://api.github.com/users/tldahlgren/repos",
        "events_url": "https://api.github.com/users/tldahlgren/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tldahlgren/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "tldahlgren",
            "id": 35777542,
            "node_id": "MDQ6VXNlcjM1Nzc3NTQy",
            "avatar_url": "https://avatars.githubusercontent.com/u/35777542?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tldahlgren",
            "html_url": "https://github.com/tldahlgren",
            "followers_url": "https://api.github.com/users/tldahlgren/followers",
            "following_url": "https://api.github.com/users/tldahlgren/following{/other_user}",
            "gists_url": "https://api.github.com/users/tldahlgren/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tldahlgren/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tldahlgren/subscriptions",
            "organizations_url": "https://api.github.com/users/tldahlgren/orgs",
            "repos_url": "https://api.github.com/users/tldahlgren/repos",
            "events_url": "https://api.github.com/users/tldahlgren/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tldahlgren/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 0,
    "created_at": "2020-11-02T23:43:55Z",
    "updated_at": "2020-11-02T23:45:04Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "When I try to install a package using explicit dependencies `foo ^bar/abcdef ^baz/012345` it fails to concretize and claims to detect uninstalled dependencies (the common dependents of `bar` and `baz`). However, installing `foo` works, even when both `bar/abcdef` and `baz/012345` are direct (and installed) dependencies.\r\n\r\nI think this is related to #15219.\r\n\r\n### Steps to reproduce the issue\r\n\r\nI added a new package `foo` with\r\n```python\r\n    depends_on('hdf5~mpi')\r\n    depends_on('libpng')\r\n```\r\n\r\nThe concretized spec for `foo` is:\r\n```console\r\n -   5iwbwrj  foo@1.2.3%apple-clang@12.0.0 arch=darwin-catalina-x86_64\r\n[+]  ge6mzmk      ^hdf5@1.10.7%apple-clang@12.0.0~cxx~debug~fortran~hl~java~mpi+pic+shared~szip~threadsafe api=none arch=darwin-catalina-x86_64\r\n[+]  x2anksg          ^zlib@1.2.11%apple-clang@12.0.0+optimize+pic+shared arch=darwin-catalina-x86_64\r\n[+]  mt5wqvh      ^libpng@1.6.37%apple-clang@12.0.0 arch=darwin-catalina-x86_64\r\n```\r\n\r\nInstalling works (until the actual mock `make` command anyway) for `foo`, `foo ^hdf5/ge6mzmk`, `foo ^zlib/x2anksg`, and \r\n`foo ^libpng/mt5wqvh`, but fails when `foo ^hdf5/ge6mzmk ^libpng/mt5wqvh`.\r\n\r\n\r\n### Error Message\r\n\r\n```console\r\n$ spack --debug --stacktrace install foo ^hdf5/ge6mzmk ^libpng/mt5wqvh\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-11-02-18:39:16.762346] Imported install from built-in commands\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.769411] Reading config file /rnsdhpc/code/spack/etc/spack/defaults/config.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.786831] Reading config file /rnsdhpc/code/spack/etc/spack/config.yaml\r\nlib/spack/spack/config.py:602 ==> [2020-11-02-18:39:16.788908] OUTDATED CONFIGURATION FILE [section=config, scope=site, dir=/rnsdhpc/code/spack/etc/spack]\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-11-02-18:39:16.789385] Imported install from built-in commands\r\nlib/spack/spack/database.py:361 ==> [2020-11-02-18:39:16.794409] DATABASE LOCK TIMEOUT: 3s\r\nlib/spack/spack/database.py:365 ==> [2020-11-02-18:39:16.794694] PACKAGE LOCK TIMEOUT: No timeout\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.825528] Reading config file /rnsdhpc/code/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.827463] Reading config file /rnsdhpc/code/spack/etc/spack/repos.yaml\r\nlib/spack/spack/spec.py:2632 ==> [2020-11-02-18:39:16.902038] foo applying constraint hdf5~mpi\r\nlib/spack/spack/spec.py:2632 ==> [2020-11-02-18:39:16.903320] foo applying constraint libpng\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.907435] Reading config file /rnsdhpc/code/spack/etc/spack/defaults/packages.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.928496] Reading config file /rnsdhpc/code/spack/etc/spack/defaults/darwin/packages.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.933057] Reading config file /rnsdhpc/code/spack/etc/spack/packages.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.960574] Reading config file /Users/s3j/.spack/packages.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.989061] Reading config file /rnsdhpc/code/spack/etc/spack/compilers.yaml\r\nlib/spack/spack/config.py:909 ==> [2020-11-02-18:39:16.998410] Reading config file /Users/s3j/.spack/darwin/compilers.yaml\r\nlib/spack/spack/spec.py:2632 ==> [2020-11-02-18:39:17.021217] foo applying constraint hdf5~mpi\r\nlib/spack/spack/spec.py:2632 ==> [2020-11-02-18:39:17.032756] foo applying constraint libpng\r\nlib/spack/spack/installer.py:1013 ==> [2020-11-02-18:39:17.041312] Initializing the build queue for foo\r\nlib/spack/spack/installer.py:960 ==> [2020-11-02-18:39:17.061970] Acquiring a write lock on zlib with timeout 1e-09\r\nlib/spack/spack/stage.py:312 ==> [2020-11-02-18:39:17.064047] Creating stage lock spack-stage-zlib-1.2.11-x2anksgssxsxa7pcnhzg5k3dhgacglze\r\nlib/spack/spack/installer.py:1406 ==> [2020-11-02-18:39:17.068035] Flagging zlib as installed\r\nlib/spack/spack/installer.py:1411 ==> [2020-11-02-18:39:17.068241] Removing zlib from hdf5's uninstalled dependencies.\r\nlib/spack/spack/installer.py:1779 ==> [2020-11-02-18:39:17.068399] hdf5: Removed zlib from uninstalled deps list: set()\r\nlib/spack/spack/installer.py:976 ==> [2020-11-02-18:39:17.069012] Downgrading to a read lock on zlib with timeout 1e-09\r\nlib/spack/spack/installer.py:1406 ==> [2020-11-02-18:39:17.069243] Flagging zlib as installed\r\nlib/spack/spack/installer.py:1411 ==> [2020-11-02-18:39:17.069440] Removing zlib from hdf5's uninstalled dependencies.\r\n[+] /rnsdhpc/code/spack/opt/spack/apple-clang/zlib/x2anksg\r\nlib/spack/spack/installer.py:960 ==> [2020-11-02-18:39:17.070664] Acquiring a write lock on hdf5 with timeout 1e-09\r\nlib/spack/spack/stage.py:312 ==> [2020-11-02-18:39:17.071725] Creating stage lock spack-stage-hdf5-1.10.7-ge6mzmkatyxcasyznj2bnmvmvwgytu7r\r\nlib/spack/spack/installer.py:1406 ==> [2020-11-02-18:39:17.080558] Flagging hdf5 as installed\r\nlib/spack/spack/installer.py:1411 ==> [2020-11-02-18:39:17.080755] Removing hdf5 from foo's uninstalled dependencies.\r\nlib/spack/spack/installer.py:1779 ==> [2020-11-02-18:39:17.080919] foo: Removed hdf5 from uninstalled deps list: {'libpng'}\r\nlib/spack/spack/installer.py:976 ==> [2020-11-02-18:39:17.081499] Downgrading to a read lock on hdf5 with timeout 1e-09\r\nlib/spack/spack/installer.py:1406 ==> [2020-11-02-18:39:17.081715] Flagging hdf5 as installed\r\nlib/spack/spack/installer.py:1411 ==> [2020-11-02-18:39:17.081854] Removing hdf5 from foo's uninstalled dependencies.\r\n[+] /rnsdhpc/code/spack/opt/spack/apple-clang/hdf5/ge6mzmk\r\nlib/spack/spack/installer.py:1481 ==> [2020-11-02-18:39:17.082446] Error: Detected uninstalled dependencies for libpng: {'zlib'}\r\nlib/spack/spack/main.py:765 ==> [2020-11-02-18:39:17.082607] InstallError: Cannot proceed with libpng: 1 uninstalled dependency: zlib\r\nlib/spack/spack/error.py:55 ==> [2020-11-02-18:39:17.083894] Error: Cannot proceed with libpng: 1 uninstalled dependency: zlib\r\nTraceback (most recent call last):\r\n  File \"/rnsdhpc/code/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/rnsdhpc/code/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/rnsdhpc/code/spack/lib/spack/spack/cmd/install.py\", line 405, in install\r\n    install_spec(args, kwargs, abstract, concrete)\r\n  File \"/rnsdhpc/code/spack/lib/spack/spack/cmd/install.py\", line 256, in install_spec\r\n    spec.package.do_install(**kwargs)\r\n  File \"/rnsdhpc/code/spack/lib/spack/spack/package.py\", line 1602, in do_install\r\n    builder.install(**kwargs)\r\n  File \"/rnsdhpc/code/spack/lib/spack/spack/installer.py\", line 1484, in install\r\n    raise InstallError(\r\nspack.installer.InstallError: Cannot proceed with libpng: 1 uninstalled dependency: zlib\r\n```\r\n\r\nInterestingly, when concretizing with the offending spec, `zlib` is written in the concretization twice:\r\n```\r\n$ spack spec -Il foo ^hdf5/ge6mzmk ^libpng/mt5wqvh\r\nInput spec\r\n--------------------------------\r\n -   foo\r\n[+]      ^hdf5@1.10.7%apple-clang@12.0.0~cxx~debug~fortran~hl~java~mpi+pic+shared~szip~threadsafe api=none arch=darwin-catalina-x86_64\r\n[+]          ^zlib@1.2.11%apple-clang@12.0.0+optimize+pic+shared arch=darwin-catalina-x86_64\r\n[+]      ^libpng@1.6.37%apple-clang@12.0.0 arch=darwin-catalina-x86_64\r\n[+]          ^zlib@1.2.11%apple-clang@12.0.0+optimize+pic+shared arch=darwin-catalina-x86_64\r\n\r\nConcretized\r\n--------------------------------\r\n -   5iwbwrj  foo@1.2.3%apple-clang@12.0.0 arch=darwin-catalina-x86_64\r\n[+]  ge6mzmk      ^hdf5@1.10.7%apple-clang@12.0.0~cxx~debug~fortran~hl~java~mpi+pic+shared~szip~threadsafe api=none arch=darwin-catalina-x86_64\r\n[+]  x2anksg          ^zlib@1.2.11%apple-clang@12.0.0+optimize+pic+shared arch=darwin-catalina-x86_64\r\n[+]  mt5wqvh      ^libpng@1.6.37%apple-clang@12.0.0 arch=darwin-catalina-x86_64\r\n[+]  x2anksg          ^zlib@1.2.11%apple-clang@12.0.0+optimize+pic+shared arch=darwin-catalina-x86_64\r\n```\r\n\r\n### Information on your system\r\n\r\n```\r\n$ spack debug report\r\n* **Spack:** 0.15.4-1776-b4ea74c11\r\n* **Python:** 3.8.3\r\n* **Platform:** darwin-catalina-skylake\r\n```\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output",
    "performed_via_github_app": null
}