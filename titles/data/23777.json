{
    "url": "https://api.github.com/repos/spack/spack/issues/23777",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/23777/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/23777/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/23777/events",
    "html_url": "https://github.com/spack/spack/pull/23777",
    "id": 894918975,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NjQ3MjExNDc5",
    "number": 23777,
    "title": "Adding support for spack monitor with containerize",
    "user": {
        "login": "vsoch",
        "id": 814322,
        "node_id": "MDQ6VXNlcjgxNDMyMg==",
        "avatar_url": "https://avatars.githubusercontent.com/u/814322?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vsoch",
        "html_url": "https://github.com/vsoch",
        "followers_url": "https://api.github.com/users/vsoch/followers",
        "following_url": "https://api.github.com/users/vsoch/following{/other_user}",
        "gists_url": "https://api.github.com/users/vsoch/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/vsoch/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/vsoch/subscriptions",
        "organizations_url": "https://api.github.com/users/vsoch/orgs",
        "repos_url": "https://api.github.com/users/vsoch/repos",
        "events_url": "https://api.github.com/users/vsoch/events{/privacy}",
        "received_events_url": "https://api.github.com/users/vsoch/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 719256466,
            "node_id": "MDU6TGFiZWw3MTkyNTY0NjY=",
            "url": "https://api.github.com/repos/spack/spack/labels/containers",
            "name": "containers",
            "color": "c5def5",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 6,
    "created_at": "2021-05-19T02:04:43Z",
    "updated_at": "2021-06-18T00:15:22Z",
    "closed_at": "2021-06-18T00:15:22Z",
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "pull_request": {
        "url": "https://api.github.com/repos/spack/spack/pulls/23777",
        "html_url": "https://github.com/spack/spack/pull/23777",
        "diff_url": "https://github.com/spack/spack/pull/23777.diff",
        "patch_url": "https://github.com/spack/spack/pull/23777.patch"
    },
    "body": "This should get us most of the way there to support using monitor during a spack container build, for both Singularity and Docker. Some quick notes:\r\n\r\n### Docker\r\nDocker works by way of BUILDKIT and being able to specify --secret. What this means is that you can prefix a line with a mount of type secret as follows:\r\n\r\n```bash\r\n# Install the software, remove unnecessary deps\r\nRUN --mount=type=secret,id=su --mount=type=secret,id=st cd /opt/spack-environment && spack env activate . && export SPACKMON_USER=$(cat /run/secrets/su) && export SPACKMON_TOKEN=$(cat /run/secrets/st) && spack install --monitor --fail-fast && spack gc -y\r\n```\r\nWhere the id for one or more secrets corresponds to the file mounted at `/run/secrets/<name>`. So, for example, to build this container with su (spackmon user) and sv (spackmon token) defined I would export them on my host and do:\r\n\r\n```bash\r\n$ DOCKER_BUILDKIT=1 docker build --network=\"host\" --secret id=st,env=SPACKMON_TOKEN --secret id=su,env=SPACKMON_USER -t spack/container . \r\n```\r\nAnd when we add `env` to the secret definition that tells the build to look for the secret with id \"st\" in the environment variable `SPACKMON_TOKEN` for example.\r\n\r\nIf the user is building locally with a local spack monitor, we also need to set the `--network` to be the host, otherwise you can't connect to it (a la isolation of course.)\r\n\r\n## Singularity\r\n\r\nSingularity doesn't have as nice an ability to clearly specify secrets, so (hoping this eventually gets implemented) what I'm doing now is providing the user instructions to write the credentials to a file, add it to the container to source, and remove when done.\r\n\r\n## Tags\r\n\r\nNote that the tags PR https://github.com/spack/spack/pull/23712 will need to be merged before `--monitor-tags` will actually work because I'm checking for the attribute (that doesn't exist yet):\r\n\r\n```bash\r\n\"tags\": getattr(args, \"monitor_tags\", None)\r\n```\r\nSo when that PR is merged to update the argument group, it will work here, and I can either update the PR here to not check if the attribute is there (it will be) or open another one in the case this PR is already merged. \r\n\r\nFinally, I added a bunch of documetation for how to use monitor with containerize. I say \"mostly working\" because I can't do a full test run with this new version until the container base is built with the updated spack (the request to the monitor server for an env install was missing so I had to add it here).\r\n\r\n\r\n\r\nSigned-off-by: Vanessa Sochat <sochat1@llnl.gov>",
    "performed_via_github_app": null
}