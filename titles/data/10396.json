{
    "url": "https://api.github.com/repos/spack/spack/issues/10396",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/10396/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/10396/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/10396/events",
    "html_url": "https://github.com/spack/spack/issues/10396",
    "id": 400881592,
    "node_id": "MDU6SXNzdWU0MDA4ODE1OTI=",
    "number": 10396,
    "title": "The dreaded name clash in lmod...",
    "user": {
        "login": "mforde84",
        "id": 20908622,
        "node_id": "MDQ6VXNlcjIwOTA4NjIy",
        "avatar_url": "https://avatars.githubusercontent.com/u/20908622?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mforde84",
        "html_url": "https://github.com/mforde84",
        "followers_url": "https://api.github.com/users/mforde84/followers",
        "following_url": "https://api.github.com/users/mforde84/following{/other_user}",
        "gists_url": "https://api.github.com/users/mforde84/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mforde84/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mforde84/subscriptions",
        "organizations_url": "https://api.github.com/users/mforde84/orgs",
        "repos_url": "https://api.github.com/users/mforde84/repos",
        "events_url": "https://api.github.com/users/mforde84/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mforde84/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2019-01-18T20:41:38Z",
    "updated_at": "2020-02-07T09:31:25Z",
    "closed_at": "2020-02-07T09:31:24Z",
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "I haven't been working with spack very long, but I've encountered a pain point with lmod lua file generations when either compiling variants or generating mixed toolchain installations. E.g.,\r\n\r\n```\r\n14:29:34-root@gosset:~/auto$ spack module lmod refresh -y | grep ^spec:\r\n==> Error: Name clashes detected in module files:\r\n\r\nfile: /mnt/beegfs/spackroot/share/spack/lmod/linux-centos7-x86_64/gcc/7.4.0/gettext/0.19.8.1.lua\r\nspec: gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64\r\nspec: gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64\r\nspec: gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64\r\n\r\nfile: /mnt/beegfs/spackroot/share/spack/lmod/linux-centos7-x86_64/gcc/7.4.0/libxml2/2.9.8.lua\r\nspec: libxml2@2.9.8%gcc@7.4.0~python arch=linux-centos7-x86_64\r\nspec: libxml2@2.9.8%gcc@7.4.0~python arch=linux-centos7-x86_64\r\n\r\n==> Error: Operation aborted\r\n\r\n```\r\n\r\nThe dreaded name clash! The issue on my end was primarily a lack of verbosity and information on why there were multiple copies of seemingly the same software, and it took some digging to extrapolate enough information on which packages were ripe for removal.\r\n\r\nSo given the above error, whats a quick way we can query these conflicts and determine which if any are necessary and can be removed. So I made a little bash script which I figured would be helpful to share. Idea being to find the hashes for the conflicting packages, list their dependents and then give the user the option to delete in a single automation script:\r\n\r\n\r\nSay we name this run.sh\r\n```\r\n#!/bin/bash\r\n### usage\r\n### ./run <FULL NAME CONFLICT>\r\n\r\nexport PKG=\"$1\"\r\nexport CUTT=`echo $PKG | sed 's/\\@.*//g' | sed 's/\\%.*//g'`\r\nexport INDEX=0\r\n\r\nfor f in $(spack uninstall $PKG | grep $CUTT |  awk '{print \" /\"$1}'); do\r\n echo \"dependents for $PKG \"\"$f\";\r\n spack dependents -i \"$PKG \"\"$f\";\r\n echo -ne \"wanna uninstall his package (y/n default=n): \"; read RESPONSE;\r\n if [ \"$RESPONSE\" = \"y\" ]; then\r\n  spack uninstall --dependents -y \"$PKG \"\"$f\";\r\n fi\r\ndone\r\n\r\nexit 0\r\n```\r\n\r\n\r\nSo given the above name clashes:\r\n\r\n```\r\n14:38:50-root@gosset:~/auto$ ./run.sh gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2\r\n==> Error: gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 matches multiple packages:\r\n==> Error: You can either:\r\n    a) use a more specific spec, or\r\n    b) use `spack uninstall --all` to uninstall ALL matching specs.\r\n\r\ndependents for gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 /3goeyvm\r\n==> Dependents of gettext@0.19.8.1%gcc@7.4.0/3goeyvm\r\n-- linux-centos7-x86_64 / gcc@7.4.0 -----------------------------\r\nylxqc2r binutils@2.31.1  zg3or6k glib@2.48.1\r\nwanna uninstall his package (y/n default=n):\r\ndependents for gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 /22t5wpt\r\n==> Dependents of gettext@0.19.8.1%gcc@7.4.0/22t5wpt\r\nNo dependents\r\nwanna uninstall his package (y/n default=n): y\r\n==> Successfully uninstalled gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64 /22t5wpt\r\ndependents for gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 /3bvk4iv\r\n==> Dependents of gettext@0.19.8.1%gcc@7.4.0/3bvk4iv\r\nNo dependents\r\nwanna uninstall his package (y/n default=n): y\r\n==> Successfully uninstalled gettext@0.19.8.1%gcc@7.4.0+bzip2+curses+git~libunistring+libxml2 patches=9acdb4e73f67c241b5ef32505c9ddf7cf6884ca8ea661692f21dca28483b04b8 +tar+xz arch=linux-centos7-x86_64 /3bvk4iv\r\n14:40:03-root@gosset:~/auto$ ./run.sh libxml2@2.9.8%gcc@7.4.0~python\r\n==> Error: libxml2@2.9.8%gcc@7.4.0~python matches multiple packages:\r\n==> Error: You can either:\r\n    a) use a more specific spec, or\r\n    b) use `spack uninstall --all` to uninstall ALL matching specs.\r\n\r\ndependents for libxml2@2.9.8%gcc@7.4.0~python /uplpbuc\r\n==> Dependents of libxml2@2.9.8%gcc@7.4.0/uplpbuc\r\nNo dependents\r\nwanna uninstall his package (y/n default=n): y\r\n==> Successfully uninstalled libxml2@2.9.8%gcc@7.4.0~python arch=linux-centos7-x86_64 /uplpbuc\r\ndependents for libxml2@2.9.8%gcc@7.4.0~python /dadf3ba\r\n==> Dependents of libxml2@2.9.8%gcc@7.4.0/dadf3ba\r\n-- linux-centos7-x86_64 / gcc@7.4.0 -----------------------------\r\nboogbvy fontconfig@2.12.3  3goeyvm gettext@0.19.8.1  bzokxn4 hwloc@1.11.11  tcpxh4d libarchive@3.3.2\r\nwanna uninstall his package (y/n default=n):\r\n14:40:33-root@gosset:~/auto$\r\n\r\n\r\n```\r\n\r\nJust thought this might be slightly helpful for others experiencing similar issues.\r\n\r\nm",
    "performed_via_github_app": null
}