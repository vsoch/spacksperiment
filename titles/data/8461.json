{
    "url": "https://api.github.com/repos/spack/spack/issues/8461",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/8461/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/8461/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/8461/events",
    "html_url": "https://github.com/spack/spack/issues/8461",
    "id": 332030192,
    "node_id": "MDU6SXNzdWUzMzIwMzAxOTI=",
    "number": 8461,
    "title": "opencv@3.x+dnn+cuda fails due to including the wrong header file",
    "user": {
        "login": "samfux84",
        "id": 11944875,
        "node_id": "MDQ6VXNlcjExOTQ0ODc1",
        "avatar_url": "https://avatars.githubusercontent.com/u/11944875?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/samfux84",
        "html_url": "https://github.com/samfux84",
        "followers_url": "https://api.github.com/users/samfux84/followers",
        "following_url": "https://api.github.com/users/samfux84/following{/other_user}",
        "gists_url": "https://api.github.com/users/samfux84/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/samfux84/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/samfux84/subscriptions",
        "organizations_url": "https://api.github.com/users/samfux84/orgs",
        "repos_url": "https://api.github.com/users/samfux84/repos",
        "events_url": "https://api.github.com/users/samfux84/events{/privacy}",
        "received_events_url": "https://api.github.com/users/samfux84/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 446616547,
            "node_id": "MDU6TGFiZWw0NDY2MTY1NDc=",
            "url": "https://api.github.com/repos/spack/spack/labels/build-error",
            "name": "build-error",
            "color": "ff3300",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2018-06-13T14:49:31Z",
    "updated_at": "2018-06-18T14:53:49Z",
    "closed_at": "2018-06-18T14:53:49Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "When installing OpenCV 3.4.1 (I could reproduce the same behavior also with version 3.3.0) with +cuda and +dnn, then the compilation failed, because one of the header files from the OpenCV dnn module has the same name as a cuda header file and the cuda header file is included instead of the OpenCV one.\r\n\r\nI think that the error is arising, from a conflict between\r\n\r\n`/scratch/spackapps/spack-stage/spack-stage-BRyfMH/opencv-3.4.1/modules/dnn/src/ocl4dnn/include/math_functions.hpp`\r\n\r\nand\r\n\r\n`/cluster/spack/apps/linux-centos7-x86_64/gcc-4.8.5/cuda-9.0.176-uqbi62cpkd645vbehqscqy42zhdvfvqq/include/math_functions.hpp`\r\n\r\nfor some reason, the CUDA header file is found first, when actually the header file from the dnn module would need to be included.\r\n\r\nThe cuda header file then includes another CUDA header file func_macro.h which causes the error message\r\n\r\n`#error -- incorrect inclusion of a cudart header file`\r\n\r\nAccording to\r\n\r\nhttps://devtalk.nvidia.com/default/topic/952579/when-i-compile-cuda-program-always-get-error-incorrect-inclusion-of-a-cudart-header-file/\r\n\r\nfunc_macro.h should never be included.\r\n\r\n### Expected Result\r\n\r\nOpenCV 3.4.1 with CUDA 9.0 should build fine.\r\n\r\n### Actual Result\r\n\r\n```\r\n[ 36%] Building CXX object modules/dnn/CMakeFiles/opencv_dnn.dir/src/layers/permute_layer.cpp.o\r\ncd /scratch/spackapps/spack-stage/spack-stage-BRyfMH/opencv-3.4.1/spack-build/modules/dnn && /cluster/apps/spack/lib/spack/env/gcc/g++  -DCVAPI_EXPORTS -DHAVE_PROTOBUF=1 -DOPENCV_TRAITS_ENABLE_DEPRECATED -D_USE_MATH_DEFINES -D__OPENCV_BUILD=1 -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -isystem /scratch/spackapps/spack-stage/spack-stage-BRyfMH/opencv-3.4.1/spack-build -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/src -I/scratch/spackapps/spack-stage/spack-stage-BRyfMH/opencv-3.4.1/spack-build/modules/dnn -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/cudev/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/core/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/imgproc/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/src/ocl4dnn/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/ts/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/imgcodecs/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/videoio/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/highgui/include -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/test -I/cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/perf -isystem /cluster/spack/apps/linux-centos7-x86_64/gcc-4.8.5/protobuf-3.1.0-l4okq4ruz7pclkxnr7kcsoghssoprscg/include  -fsigned-char -W -Wall -Werror=return-type  -Werror=address -Werror=sequence-point -Wformat -Werror=format-security   -Winit-self -Wpointer-arith   -Wuninitialized -Winit-self -Wno-narrowing -Wno-delete-non-virtual-dtor -Wno-comment -fdiagnostics-show-option -Wno-long-long -pthread -fomit-frame-pointer -ffunction-sections -fdata-sections  -msse -msse2 -msse3 -fvisibility=hidden -fvisibility-inlines-hidden -Wno-shadow -Wno-parentheses -Wno-maybe-uninitialized -Wno-sign-promo -Wno-missing-declarations -Wno-deprecated -Wno-missing-declarations -Wno-shadow -Wno-unused-parameter -Wno-unused-local-typedefs -Wno-sign-compare -Wno-sign-promo -Wno-undef -Wno-ignored-qualifiers -Wno-extra -Wno-unused-function -Wno-deprecated-declarations -Wno-error=non-virtual-dtor -Wno-unused-parameter -Wno-undef -Wno-ignored-qualifiers -Wno-enum-compare -Wno-deprecated-declarations -Wno-invalid-offsetof -O2 -g -DNDEBUG -fPIC   -o CMakeFiles/opencv_dnn.dir/src/layers/permute_layer.cpp.o -c /cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/src/layers/permute_layer.cpp\r\nIn file included from /cluster/spack/apps/linux-centos7-x86_64/gcc-4.8.5/cuda-8.0.61-mxdqob5lveng3f2utljrysrx4vjp7g3m/include/math_functions.hpp:1674:0,\r\n                 from /cluster/apps/spack/var/spack/stage/opencv-3.4.1-zxmgmfmwzkooupmg24dzntqp2h2dqy3k/opencv-3.4.1/modules/dnn/src/layers/mvn_layer.cpp:46:\r\n/cluster/spack/apps/linux-centos7-x86_64/gcc-4.8.5/cuda-8.0.61-mxdqob5lveng3f2utljrysrx4vjp7g3m/include/crt/func_macro.h:50:2: error: #error -- incorrect inclusion of a cudart header file\r\n #error -- incorrect inclusion of a cudart header file\r\n  ^\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\n`spack install --no-checksum opencv@3.4.1+core+cuda+dnn+gtk+png+highgui+imgproc+shared+tiff+zlib~python~eigen ^cmake@3.8.0+ncurses+openssl ^protobuf@3.1.0+shared ^cuda@8.0.61 ^gtkplus@2.24.31+X ^libtiff@4.0.6 ^libpng@1.6.27 ^python@2.7.13+tk ^libpthread-stubs@0.3 ^glib@2.49.7+libmount ^xproto@7.0.29 ^libx11@1.6.3 ^zlib@1.2.11 ^flex@2.6.1 ^gettext@0.19.8.1+bzip2+curses+git+libunistring+libxml2+tar+xz ^util-linux@2.29.1 ^freetype@2.7 ^fontconfig@2.11.1 %gcc@4.8.5 arch=linux-centos7-x86-64`\r\n\r\n### Information on your system\r\n\r\nPlattform:  CentOS Linux release 7.4.1708 (Core) \r\nKernel: 3.10.0-693.11.6.el7.x86_64\r\n\r\n-----\r\n\r\n",
    "performed_via_github_app": null
}