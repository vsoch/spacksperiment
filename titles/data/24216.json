{
    "url": "https://api.github.com/repos/spack/spack/issues/24216",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24216/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24216/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24216/events",
    "html_url": "https://github.com/spack/spack/issues/24216",
    "id": 916166995,
    "node_id": "MDU6SXNzdWU5MTYxNjY5OTU=",
    "number": 24216,
    "title": "Lmod 'hierarchy' ignored",
    "user": {
        "login": "sethrj",
        "id": 741229,
        "node_id": "MDQ6VXNlcjc0MTIyOQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/741229?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sethrj",
        "html_url": "https://github.com/sethrj",
        "followers_url": "https://api.github.com/users/sethrj/followers",
        "following_url": "https://api.github.com/users/sethrj/following{/other_user}",
        "gists_url": "https://api.github.com/users/sethrj/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/sethrj/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sethrj/subscriptions",
        "organizations_url": "https://api.github.com/users/sethrj/orgs",
        "repos_url": "https://api.github.com/users/sethrj/repos",
        "events_url": "https://api.github.com/users/sethrj/events{/privacy}",
        "received_events_url": "https://api.github.com/users/sethrj/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 446632829,
            "node_id": "MDU6TGFiZWw0NDY2MzI4Mjk=",
            "url": "https://api.github.com/repos/spack/spack/labels/modules",
            "name": "modules",
            "color": "fef2c0",
            "default": false,
            "description": null
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 6,
    "created_at": "2021-06-09T12:52:29Z",
    "updated_at": "2021-06-11T06:40:12Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "@becker33 I think this relates to #23703 . Basically, the old 'empty hierarchy' in my modules config seems to be overridden by the 'default' key in the spack lmod defaults -- but only for some packages.\r\n\r\nI haven't spent the time to reproduce this on a completely clean build, and some of the packages are installed via environments, others aren't.\r\n\r\n### Steps to reproduce the issue\r\n\r\n\r\n```console\r\n$ spack -d module lmod refresh -y trilinos%gcc@10\r\n==> [2021-06-09-08:50:40.872745] Imported module from built-in commands\r\n==> [2021-06-09-08:50:40.884989] Imported module from built-in commands\r\n==> [2021-06-09-08:50:40.888085] Reading config file /projects/spack2020/etc/spack/defaults/config.yaml\r\n==> [2021-06-09-08:50:40.928025] Reading config file /projects/spack2020/etc/spack/config.yaml\r\n==> [2021-06-09-08:50:40.935245] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-06-09-08:50:40.935351] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-06-09-08:50:41.101820] Reading config file /projects/spack2020/etc/spack/defaults/repos.yaml\r\n==> [2021-06-09-08:50:41.104794] Reading config file /projects/spack2020/etc/spack/repos.yaml\r\n==> [2021-06-09-08:50:42.180869] Reading config file /projects/spack2020/etc/spack/defaults/modules.yaml\r\n==> [2021-06-09-08:50:42.193172] Reading config file /projects/spack2020/etc/spack/defaults/linux/modules.yaml\r\n==> [2021-06-09-08:50:42.197015] Reading config file /projects/spack2020/etc/spack/modules.yaml\r\n==> [2021-06-09-08:50:42.316378] Reading config file /projects/spack2020/etc/spack/compilers.yaml\r\n==> [2021-06-09-08:50:42.357782] Regenerating lmod module files\r\n==> [2021-06-09-08:50:43.520019] \tWRITE: trilinos@13.0.0%gcc@10.2.0~adios2~alloptpkgs+amesos~amesos2+anasazi+aztec+belos~boost~cgns~chaco~complex~debug~dtk+epetra+epetraext~exodus+explicit_template_instantiation~float+fortran~glm~gtest+hdf5~hypre+ifpack+ifpack2+intrepid~intrepid2~isorropia+kokkos~matio~mesquite~metis~minitensor+ml~mpi~muelu~mumps~netcdf~nox~openmp~phalanx~piro~pnetcdf~python~rol~rythmos+sacado+shards+shared~shylu~stk+stratimikos~suite-sparse~superlu~superlu-dist~teko~tempus+teuchos+tpetra~x11~xsdkflags~zlib~zoltan~zoltan2 build_type=RelWithDebInfo gotype=long_long arch=linux-rhel7-haswell/wcfgufe [/projects/spack2020/share/spack/lmod/linux-rhel7-x86_64/gcc/10.2.0/trilinos/13.0.0-wcfgufe.lua]\r\n==> [2021-06-09-08:50:43.656952] Reading config file /projects/spack2020/etc/spack/defaults/packages.yaml\r\n==> [2021-06-09-08:50:43.688764] Reading config file /projects/spack2020/etc/spack/packages.yaml\r\n==> [2021-06-09-08:50:43.712536] \tWRITE: trilinos@13.0.0%gcc@10.2.0~adios2~alloptpkgs+amesos~amesos2+anasazi+aztec+belos~boost~cgns~chaco~complex~debug~dtk+epetra+epetraext~exodus+explicit_template_instantiation~float+fortran~glm~gtest+hdf5~hypre+ifpack+ifpack2+intrepid~intrepid2~isorropia+kokkos~matio~mesquite~metis~minitensor+ml+mpi~muelu~mumps~netcdf~nox~openmp~phalanx~piro~pnetcdf~python~rol~rythmos+sacado+shards+shared~shylu~stk+stratimikos~suite-sparse~superlu~superlu-dist~teko~tempus+teuchos+tpetra~x11~xsdkflags~zlib~zoltan~zoltan2 build_type=RelWithDebInfo gotype=long_long arch=linux-rhel7-haswell/rgammyu [/projects/spack2020/share/spack/lmod/linux-rhel7-x86_64/openmpi/3.1.6-vnidi5n/gcc/10.2.0/trilinos/13.0.0-rgammyu.lua]\r\n==> [2021-06-09-08:50:43.799463] \tWRITE: trilinos@13.0.1%gcc@10.2.0~adios2~alloptpkgs+amesos+amesos2~amesos2basker+anasazi+aztec+belos~boost~cgns~chaco~complex~cuda~cuda_rdc~debug~dtk+epetra+epetraext~epetraextbtf~epetraextexperimental~epetraextgraphreorderings~exodus+explicit_template_instantiation~float+fortran~glm~gtest+hdf5~hwloc~hypre+ifpack+ifpack2+intrepid~intrepid2~ipo~isorropia+kokkos~matio~mesquite~metis~minitensor+ml+mpi~muelu~mumps~netcdf~nox~openmp~phalanx~piro~pnetcdf~python~rol~rythmos+sacado~scorec+shards+shared~shylu~stk~stokhos+stratimikos~strumpack~suite-sparse~superlu~superlu-dist~teko~tempus+teuchos+tpetra~trilinoscouplings~wrapper~x11~xsdkflags~zlib~zoltan~zoltan2 build_type=RelWithDebInfo cuda_arch=none cxxstd=11 gotype=long_long arch=linux-rhel7-haswell/6o7s6hd [/projects/spack2020/share/spack/lmod/linux-rhel7-x86_64/openmpi/4.0.5-2o7q6yb/gcc/10.2.0/trilinos/13.0.1-6o7s6hd.lua]\r\n```\r\n\r\n\r\n### Information on your system\r\n\r\n```\r\n$ spack config blame modules\r\n---                                                           modules:\r\netc/spack/modules.yaml:2                    enable:\r\netc/spack/modules.yaml:3                    - lmod\r\netc/spack/modules.yaml:4                    prefix_inspections:\r\netc/spack/modules.yaml:5                      bin:\r\netc/spack/modules.yaml:6                      - PATH\r\netc/spack/modules.yaml:7                      man:\r\netc/spack/modules.yaml:8                      - MANPATH\r\netc/spack/modules.yaml:9                      share/man:\r\netc/spack/modules.yaml:10                     - MANPATH\r\netc/spack/modules.yaml:11                     share/aclocal:\r\netc/spack/modules.yaml:12                     - ACLOCAL_PATH\r\netc/spack/modules.yaml:13                     include: []\r\netc/spack/modules.yaml:14                     lib:\r\netc/spack/modules.yaml:15                     - LIBRARY_PATH\r\netc/spack/modules.yaml:16                     lib64:\r\netc/spack/modules.yaml:17                     - LIBRARY_PATH\r\netc/spack/modules.yaml:18                     lib/pkgconfig:\r\netc/spack/modules.yaml:19                     - PKG_CONFIG_PATH\r\netc/spack/modules.yaml:20                     lib64/pkgconfig:\r\netc/spack/modules.yaml:21                     - PKG_CONFIG_PATH\r\netc/spack/modules.yaml:22                     share/pkgconfig:\r\netc/spack/modules.yaml:23                     - PKG_CONFIG_PATH\r\n                                              ? ''\r\n                                              : - CMAKE_PREFIX_PATH\r\netc/spack/modules.yaml:26                       - ${PACKAGE}_ROOT\r\netc/spack/modules.yaml:26                   # These are configurations for the module set named \"default\"\r\netc/spack/modules.yaml:27                   lmod:\r\netc/spack/modules.yaml:28                     core_compilers:\r\netc/spack/modules.yaml:29                     - gcc@4.8.5\r\netc/spack/modules.yaml:30                     hash_length: 4\r\netc/spack/modules.yaml:31                     hierarchy: []\r\netc/spack/modules.yaml:32                     ^python:\r\netc/spack/modules.yaml:33                       autoload: direct\r\netc/spack/modules.yaml:34                     all:\r\netc/spack/modules.yaml:35                       suffixes:\r\netc/spack/modules.yaml:36                         ^python@2: py2\r\netc/spack/modules.yaml:37                         +cuda: cuda\r\netc/spack/modules.yaml:38                         +debug: debug\r\netc/spack/modules.yaml:39                         +mpi: mpi\r\netc/spack/modules.yaml:40                         +multithreaded: mt\r\netc/spack/modules.yaml:41                         +openmp: mt\r\netc/spack/modules.yaml:42                         +threads: mt\r\netc/spack/modules.yaml:43                         ~shared: static\r\netc/spack/modules.yaml:44                         cxxstd=98: c++98\r\netc/spack/modules.yaml:45                         cxxstd=14: c++14\r\netc/spack/modules.yaml:46                         cxxstd=17: c++17\r\netc/spack/modules.yaml:47                     lava:\r\netc/spack/modules.yaml:48                       template: group-restricted.lua\r\netc/spack/modules.yaml:49                     mcnp:\r\netc/spack/modules.yaml:48                       template: group-restricted.lua\r\netc/spack/modules.yaml:50                     mcnp-data:\r\netc/spack/modules.yaml:48                       template: group-restricted.lua\r\netc/spack/modules.yaml:51                     scale:\r\netc/spack/modules.yaml:48                       template: group-restricted.lua\r\netc/spack/modules.yaml:52                     scale-data:\r\netc/spack/modules.yaml:48                       template: group-restricted.lua\r\netc/spack/defaults/linux/modules.yaml:17    default:\r\netc/spack/defaults/linux/modules.yaml:18      prefix_inspections:\r\netc/spack/defaults/linux/modules.yaml:19        lib:\r\netc/spack/defaults/linux/modules.yaml:20        - LD_LIBRARY_PATH\r\netc/spack/defaults/linux/modules.yaml:21        lib64:\r\netc/spack/defaults/linux/modules.yaml:22        - LD_LIBRARY_PATH\r\netc/spack/defaults/modules.yaml:46            enable:\r\netc/spack/defaults/modules.yaml:46            - tcl\r\netc/spack/defaults/modules.yaml:47            # Default configurations if lmod is enabled\r\netc/spack/defaults/modules.yaml:50            lmod:\r\netc/spack/defaults/modules.yaml:51              hierarchy:\r\netc/spack/defaults/modules.yaml:52              - mpi\r\n```\r\n\r\nModule file:\r\n```\r\n$ cat etc/spack/modules.yaml\r\nmodules:\r\n  enable::\r\n    - lmod\r\n  prefix_inspections:\r\n    bin:\r\n    - PATH\r\n    man:\r\n    - MANPATH\r\n    share/man:\r\n    - MANPATH\r\n    share/aclocal:\r\n    - ACLOCAL_PATH\r\n    include:: []\r\n    lib:\r\n    - LIBRARY_PATH\r\n    lib64:\r\n    - LIBRARY_PATH\r\n    lib/pkgconfig:\r\n    - PKG_CONFIG_PATH\r\n    lib64/pkgconfig:\r\n    - PKG_CONFIG_PATH\r\n    share/pkgconfig:\r\n    - PKG_CONFIG_PATH\r\n    '':\r\n    - CMAKE_PREFIX_PATH\r\n    - '${PACKAGE}_ROOT'\r\n  lmod:\r\n    core_compilers:\r\n      - 'gcc@4.8.5'\r\n    hash_length: 4\r\n    hierarchy:: []\r\n    ^python:\r\n      autoload:  'direct'\r\n    all:\r\n      suffixes:\r\n        '^python@2': py2\r\n        '+cuda': 'cuda'\r\n        '+debug': debug\r\n        '+mpi': mpi\r\n        '+multithreaded': mt\r\n        '+openmp': mt\r\n        '+threads': mt\r\n        '~shared': 'static'\r\n        'cxxstd=98': 'c++98'\r\n        'cxxstd=14': 'c++14'\r\n        'cxxstd=17': 'c++17'\r\n    lava: &restricted\r\n      template: 'group-restricted.lua'\r\n    mcnp: *restricted\r\n    mcnp-data: *restricted\r\n    scale: *restricted\r\n    scale-data: *restricted\r\n```\r\n\r\n### Additional information\r\n\r\n* **Spack:** 0.16.2-3016-1fd1f1c93f\r\n* **Python:** 3.8.6\r\n* **Platform:** linux-rhel7-haswell\r\n* **Concretizer:** clingo",
    "performed_via_github_app": null
}