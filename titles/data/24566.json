{
    "url": "https://api.github.com/repos/spack/spack/issues/24566",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/24566/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/24566/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/24566/events",
    "html_url": "https://github.com/spack/spack/issues/24566",
    "id": 931751022,
    "node_id": "MDU6SXNzdWU5MzE3NTEwMjI=",
    "number": 24566,
    "title": "When clause in version directive",
    "user": {
        "login": "birnbera",
        "id": 11324360,
        "node_id": "MDQ6VXNlcjExMzI0MzYw",
        "avatar_url": "https://avatars.githubusercontent.com/u/11324360?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/birnbera",
        "html_url": "https://github.com/birnbera",
        "followers_url": "https://api.github.com/users/birnbera/followers",
        "following_url": "https://api.github.com/users/birnbera/following{/other_user}",
        "gists_url": "https://api.github.com/users/birnbera/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/birnbera/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/birnbera/subscriptions",
        "organizations_url": "https://api.github.com/users/birnbera/orgs",
        "repos_url": "https://api.github.com/users/birnbera/repos",
        "events_url": "https://api.github.com/users/birnbera/events{/privacy}",
        "received_events_url": "https://api.github.com/users/birnbera/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908756,
            "node_id": "MDU6TGFiZWw3MzkwODc1Ng==",
            "url": "https://api.github.com/repos/spack/spack/labels/feature",
            "name": "feature",
            "color": "84b6eb",
            "default": false,
            "description": null
        },
        {
            "id": 466955297,
            "node_id": "MDU6TGFiZWw0NjY5NTUyOTc=",
            "url": "https://api.github.com/repos/spack/spack/labels/proposal",
            "name": "proposal",
            "color": "0e8a16",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": {
        "login": "alalazo",
        "id": 4199709,
        "node_id": "MDQ6VXNlcjQxOTk3MDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alalazo",
        "html_url": "https://github.com/alalazo",
        "followers_url": "https://api.github.com/users/alalazo/followers",
        "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
        "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
        "organizations_url": "https://api.github.com/users/alalazo/orgs",
        "repos_url": "https://api.github.com/users/alalazo/repos",
        "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/alalazo/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "alalazo",
            "id": 4199709,
            "node_id": "MDQ6VXNlcjQxOTk3MDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4199709?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/alalazo",
            "html_url": "https://github.com/alalazo",
            "followers_url": "https://api.github.com/users/alalazo/followers",
            "following_url": "https://api.github.com/users/alalazo/following{/other_user}",
            "gists_url": "https://api.github.com/users/alalazo/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/alalazo/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/alalazo/subscriptions",
            "organizations_url": "https://api.github.com/users/alalazo/orgs",
            "repos_url": "https://api.github.com/users/alalazo/repos",
            "events_url": "https://api.github.com/users/alalazo/events{/privacy}",
            "received_events_url": "https://api.github.com/users/alalazo/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2021-06-28T16:33:44Z",
    "updated_at": "2021-06-30T06:00:14Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "<!-- Explain, in a clear and concise way, the command you ran and the result you were trying to achieve.\r\nExample: \"I ran `spack find` to list all the installed packages and ...\" -->\r\n\r\nI\u2019m working on updating the package definition for [Nextflow](https://github.com/nextflow-io/nextflow) (currently in house, but hopefully can share out soon). Nextflow uses Github releases for new versions, but it provides a \u201cslim\u201d version that performs a bunch of additional downloads the first time it is run and a \u201cfat\u201d version with everything already included. I\u2019d like to be able to provide both as an option for downstream use, however they have different checksums. I found a couple of Spack issues addressing this question (e.g. #9910 and #11206). The most straightforward solution seems to be to use a `when` clause along with a `variant` in the `version` directive, that way whenever a variant is present (e.g. `+all`) Spack uses the fat version checksum and when it is absent it uses the slim one. Combined with version-specific URL\u2019s or a `url_for_version` function, this seems to work ok. The problem is that if you try to install both it tries to use the cached version of the other. However, if you delete the cache the checksum fails.\r\n\r\nAn example of the two `version` directives:\r\n\r\n```nextflow\r\nversion('21.04.1', sha256='840ca394237e0f4d9f34642ff77c0ac92361319bcc9d9441f3d99f7b6d48ae7d', expand=False, when='~all')\r\nversion('21.04.1', sha256='566deaf7533a2484d09f6520c677b31eff983d59b82c0816f9fe36b2886c768d', expand=False, when='+all')\r\n\r\nvariant('all', default=True, description='Use all-inclusive tarball requiring no additional downloads')\r\n\r\ndef url_for_version(self, version):\r\n    if \"+all\" in self.spec:\r\n        return f\"https://github.com/nextflow-io/nextflow/releases/download/v{version}/nextflow-{version}-all\"\r\n    else:\r\n        return f\"https://github.com/nextflow-io/nextflow/releases/download/v{version}/nextflow\"\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install nextflow@21.04.1+all\r\n$ spack clean -ds nextflow\r\n$ spack install nextflow@21.04.1~all\r\n```\r\n\r\n### Error Message\r\n\r\n```console\r\nspack.fetch_strategy.ChecksumError: sha256 checksum failed for /tmp/andrew.birnberg/spack-stage/spack-stage-nextflow-21.04.1-65uot5cmhrin7zsbhwa3h7l5klbki3qj/nextflow\r\n    Expected 566deaf7533a2484d09f6520c677b31eff983d59b82c0816f9fe36b2886c768d but got 840ca394237e0f4d9f34642ff77c0ac92361319bcc9d9441f3d99f7b6d48ae7d\r\n```\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\n\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n```\r\n* **Spack:** 0.16.2-3306-69d69cbc79\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-centos7-skylake_avx512\r\n* **Concretizer:** original\r\n```\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n",
    "performed_via_github_app": null
}