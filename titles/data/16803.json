{
    "url": "https://api.github.com/repos/spack/spack/issues/16803",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/16803/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/16803/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/16803/events",
    "html_url": "https://github.com/spack/spack/issues/16803",
    "id": 624343224,
    "node_id": "MDU6SXNzdWU2MjQzNDMyMjQ=",
    "number": 16803,
    "title": "Too long #! lines with bytecode (binary data)",
    "user": {
        "login": "scemama",
        "id": 5970658,
        "node_id": "MDQ6VXNlcjU5NzA2NTg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5970658?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/scemama",
        "html_url": "https://github.com/scemama",
        "followers_url": "https://api.github.com/users/scemama/followers",
        "following_url": "https://api.github.com/users/scemama/following{/other_user}",
        "gists_url": "https://api.github.com/users/scemama/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/scemama/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scemama/subscriptions",
        "organizations_url": "https://api.github.com/users/scemama/orgs",
        "repos_url": "https://api.github.com/users/scemama/repos",
        "events_url": "https://api.github.com/users/scemama/events{/privacy}",
        "received_events_url": "https://api.github.com/users/scemama/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908754,
            "node_id": "MDU6TGFiZWw3MzkwODc1NA==",
            "url": "https://api.github.com/repos/spack/spack/labels/bug",
            "name": "bug",
            "color": "fc2929",
            "default": true,
            "description": null
        },
        {
            "id": 1747000960,
            "node_id": "MDU6TGFiZWwxNzQ3MDAwOTYw",
            "url": "https://api.github.com/repos/spack/spack/labels/sbang",
            "name": "sbang",
            "color": "095e8c",
            "default": false,
            "description": ""
        },
        {
            "id": 1433532775,
            "node_id": "MDU6TGFiZWwxNDMzNTMyNzc1",
            "url": "https://api.github.com/repos/spack/spack/labels/triage",
            "name": "triage",
            "color": "ed9793",
            "default": false,
            "description": "The issue needs to be prioritized"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2020-05-25T14:44:37Z",
    "updated_at": "2020-05-25T18:21:11Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "OCaml can create bytecode executables. These are binary files, where the 1st line contains the path to the bytecode interpreter:\r\n```\r\n#!/path/to/ocamlrun\r\n```\r\nBytecode executables are required for the compilation of the OCaml compiler, so for the installation of the ocaml package.\r\n\r\nBecause of spack's very long paths, the length of this line can be larger than the system's limit. This is properly handled by Spack for scripts (Python for example), but for OCaml bytecode the data following the 1st ine is binary, and the workaround fails.\r\n\r\nThis problem of long paths was solved in the latest version of the OCaml compiler, but will always be present with versions of OCaml < 4.10.0.\r\n\r\n \r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ mkdir very_long_path_for_making_spack_crash\r\n$ cd very_long_path_for_making_spack_crash\r\n$ git clone spack\r\n$ spack install ocaml@4.06.0\r\n```\r\n\r\n### Error Message\r\n\r\n```console\r\n==> 12041: ocaml: Building ocaml [Package]\r\n==> 12041: ocaml: Executing phase: 'install'\r\n==> Error: UnicodeDecodeError: 'utf-8' codec can't decode byte 0xdf in position 160: invalid continuation byte\r\n\r\n/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/build_environment.py:818, in child_process:\r\n        815            tb_string = traceback.format_exc()\r\n        816\r\n        817            # build up some context from the offending package so we can\r\n  >>    818            # show that, too.\r\n        819            package_context = get_package_context(tb)\r\n        820\r\n        821            build_log = None\r\n\r\nSee build log for details:\r\n  /tmp/scemama/spack-stage/spack-stage-ocaml-4.06.0-hmsefzexeljw2eyplfhh3xl7jydyrchd/spack-build-out.txt\r\n\r\n==> Error: Failed to install ocaml due to ChildError: UnicodeDecodeError: 'utf-8' codec can't decode byte 0xdf in position 160: invalid continuation byte\r\n/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/build_environment.py:818, in child_process:\r\n        815            tb_string = traceback.format_exc()\r\n        816\r\n        817            # build up some context from the offending package so we can\r\n  >>    818            # show that, too.\r\n        819            package_context = get_package_context(tb)\r\n        820\r\n        821            build_log = None\r\n\r\nSee build log for details:\r\n  /tmp/scemama/spack-stage/spack-stage-ocaml-4.06.0-hmsefzexeljw2eyplfhh3xl7jydyrchd/spack-build-out.txt\r\nTraceback (most recent call last):\r\n  File \"/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/build_environment.py\", line 801, in child_process\r\n    return_value = function()\r\n  File \"/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/installer.py\", line 1115, in build_process\r\n    spack.hooks.post_install(pkg.spec)\r\n  File \"/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/hooks/__init__.py\", line 59, in __call__\r\n    hook(*args, **kwargs)\r\n  File \"/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/hooks/sbang.py\", line 115, in post_install\r\n    filter_shebangs_in_directory(directory, filenames)\r\n  File \"/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/hooks/sbang.py\", line 102, in filter_shebangs_in_directory\r\n    filter_shebang(path)\r\n  File \"/home/scemama/very_long_path_for_making_spack_crash/lib/spack/spack/hooks/sbang.py\", line 40, in filter_shebang\r\n    original = original.decode(encoding='UTF-8')\r\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xdf in position 160: invalid continuation byte\r\n\r\n```\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n```console\r\n$ spack debug report\r\nusage: spack debug [-h] SUBCOMMAND ...\r\nspack debug: error: argument SUBCOMMAND: invalid choice: 'report' choose from:\r\n    create-db-tarball\r\n\r\n$ git log\r\ncommit b472c1380331cc414582f8f5bcb9045e468457c9 (origin/develop)\r\nAuthor: Sergey Kosukhin <sergey.kosukhin@mpimet.mpg.de>\r\nDate:   Tue Mar 3 22:13:38 2020 +0100\r\n\r\n$ python --version\r\nPython 3.7.0\r\n\r\n$ uname -a\r\nLinux lpqlx139 4.9.0-9-amd64 #1 SMP Debian 4.9.168-1+deb9u4 (2019-07-19) x86_64 GNU/Linux\r\n\r\n$ cat /etc/issue\r\nDebian GNU/Linux 10 \\n \\l\r\n\r\n$ spack find\r\n==> 2 installed packages\r\n-- linux-debian10-haswell / gcc@8.3.0 ---------------------------\r\nncurses@6.1  pkgconf@1.6.3\r\n\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nWhen I install spack in my home directory, the path is just small enough to make things work.\r\nThis is why I installed spack in a dummy long-named directory.\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output\r\n\r\n",
    "performed_via_github_app": null
}