{
    "url": "https://api.github.com/repos/spack/spack/issues/18973",
    "repository_url": "https://api.github.com/repos/spack/spack",
    "labels_url": "https://api.github.com/repos/spack/spack/issues/18973/labels{/name}",
    "comments_url": "https://api.github.com/repos/spack/spack/issues/18973/comments",
    "events_url": "https://api.github.com/repos/spack/spack/issues/18973/events",
    "html_url": "https://github.com/spack/spack/issues/18973",
    "id": 709128500,
    "node_id": "MDU6SXNzdWU3MDkxMjg1MDA=",
    "number": 18973,
    "title": "automatic target selection on package loading",
    "user": {
        "login": "nsimakov",
        "id": 5438550,
        "node_id": "MDQ6VXNlcjU0Mzg1NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5438550?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nsimakov",
        "html_url": "https://github.com/nsimakov",
        "followers_url": "https://api.github.com/users/nsimakov/followers",
        "following_url": "https://api.github.com/users/nsimakov/following{/other_user}",
        "gists_url": "https://api.github.com/users/nsimakov/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/nsimakov/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/nsimakov/subscriptions",
        "organizations_url": "https://api.github.com/users/nsimakov/orgs",
        "repos_url": "https://api.github.com/users/nsimakov/repos",
        "events_url": "https://api.github.com/users/nsimakov/events{/privacy}",
        "received_events_url": "https://api.github.com/users/nsimakov/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 73908756,
            "node_id": "MDU6TGFiZWw3MzkwODc1Ng==",
            "url": "https://api.github.com/repos/spack/spack/labels/feature",
            "name": "feature",
            "color": "84b6eb",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2020-09-25T17:19:51Z",
    "updated_at": "2020-09-25T17:20:34Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "Hello,\r\n\r\nI think adding automatic target selection on package loading can be beneficial for several usage scenarios like loading packages on heterogeneous clusters and performance optimized containers.\r\n\r\n### Rationale\r\n\r\nMany HPC applications successfully utilize vectorized instructions and thus performance depends on both hardware and the way how application was build. Bellow is a plot to illustrate performance difference in case of NAMD executed on same compute node but using different targeted packages:\r\n\r\n![namd](https://user-images.githubusercontent.com/5438550/94293785-d37c3d00-ff2c-11ea-83f0-adeefab3e947.png)\r\n\r\nMany HPC centers have multiple generation of nodes available at the same time and although HPC-smart user can make proper selection on themselves in practice users executes common denominator on both new and old compute nodes. That is not efficient.\r\n\r\nSimilarly, in building the containers it is not known a priory what CPUs are going to be used. So again common denominator is often used.\r\n\r\nSpack addresses many of problems of building HPC codes, but last little step is missing. Namely automatic load of most compatible package.\r\n\r\n### Description\r\n\r\nRight now the package with proper target is loaded as:\r\n```\r\nspack load hpcc%intel target=skylake_avx512\r\n```\r\n\r\nThe idea is that user load packages without specifying target:\r\n```\r\nspack autoload hpcc\r\n```\r\n\r\nIn principle already now it can be done as:\r\n```\r\nspack load hpcc%intel target=`spack arch -t`\r\n```\r\nbut the issue is that all targets should be compiled which is impractical as some targets are not significantly different and impossible in case of containers.\r\n\r\nSpack already have infrastructure for target CPU comparison, so it shouldn't be that labor intensive to add such feature. In principle I can add it myself, but want to discuss it first with the developers.\r\n\r\n### Additional information\r\n\r\nIn my performance optimized containers I use spack to build targets ([example](https://github.com/nsimakov/akrr/blob/master/docker/namd/spack_builder.dockerfile))  and then select proper one by checking specific avx instructions from /proc/cpuinfo ([akrr_get_arch function](https://github.com/nsimakov/akrr/blob/master/akrr/appker_repo/execs/bin/akrr_util.bash))",
    "performed_via_github_app": null
}